#!/bin/sh
#
# <meta:header>
#   <meta:licence>
#     Copyright (c) 2023, ROE (http://www.roe.ac.uk/)
#
#     This information is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This information is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
#   </meta:licence>
# </meta:header>
#
# AIMetrics: []
#

# -----------------------------------------------------
# Settings ...

    binfile="$(basename ${0})"
    binpath="$(dirname $(readlink -f ${0}))"

    echo ""
    echo "---- ---- ----"
    echo "File [${binfile}]"
    echo "Path [${binpath}]"

    agcolour=${1:?}

    if [ "${agcolour}" == "jade" ]
    then
        cloudname=somerville-${agcolour}
        clientname=ansibler-${agcolour}
    else
        cloudname=iris-gaia-${agcolour}
        clientname=ansibler-${agcolour}
    fi

    echo "---- ---- ----"
    echo "Cloud name  [${cloudname}]"
    echo "Client name [${clientname}]"
    echo "---- ---- ----"
    echo ""

# -----------------------------------------------------
# Launch a client container.

    source "${HOME:?}/aglais.env"

    containername=kubernetes-client:2023.06.15
    containerrepo=ghcr.io/wfau/atolmis
    containerfull=ghcr.io/wfau/atolmis/${containername:?}

    kubectlproxy=8001:8001

    # Extra flags for the Edinburgh VPN.
    # (*) this doesn't work, too fragile
    #   --device /dev/net/tun \
    #   --cap-add NET_ADMIN,mknod \

    podman run \
        --rm \
        --tty \
        --interactive \
        --name     "${clientname:?}" \
        --hostname "${clientname:?}" \
        --publish  "${kubectlproxy:?}" \
        --env "cloudname=${cloudname:?}" \
        --env "SSH_AUTH_SOCK=/mnt/ssh_auth_sock" \
        --volume "${SSH_AUTH_SOCK:?}:/mnt/ssh_auth_sock:rw,z" \
        --volume "${HOME:?}/clouds.yaml:/etc/openstack/clouds.yaml:ro,z" \
        --volume "${AGLAIS_CODE:?}/deployments:/deployments:ro,z" \
        --tmpfs  "/deployments/cluster-api/bootstrap/helm/gaia-dmp/charts:rw" \
        "${containerfull:?}" \
        bash


#
# <meta:header>
#   <meta:licence>
#     Copyright (c) 2023, ROE (http://www.roe.ac.uk/)
#
#     This information is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This information is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
#   </meta:licence>
# </meta:header>
#
#zrq-notes-time
#zrq-notes-indent
#zrq-notes-crypto
#zrq-notes-ansible
#zrq-notes-osformat
#zrq-notes-zeppelin
#
# AIMetrics: []
#

    Target:

        Can we do the deploy in one go ?

    Result:

        Work in progress


# -----------------------------------------------------

    Start the VPN.

    Create the client container.

    Create the bootstrap node.

    Configure the bootstrap node.


# -----------------------------------------------------
# Run a new client.
#[user@desktop]

    agclient jade

    >   ....
    >   ....


# -----------------------------------------------------
# Check the IP routing.
#[root@ansibler]

    dnf install -y iproute

    ip route

    >   default via 10.0.2.2 dev tap0
    >   10.0.2.0/24 dev tap0 proto kernel scope link src 10.0.2.100


# -----------------------------------------------------
# Start a VPN in the client.
#[user@desktop]

    podman exec \
        --tty \
        --interactive \
        ansibler-jade \
        bash

        dnf -y install openconnect

        openconnect \
            --verbose \
            --protocol fortinet \
            --user dmorris8 \
            remote.net.ed.ac.uk:8443

    >   GET https://remote.net.ed.ac.uk:8443/
    >   Attempting to connect to server 192.41.103.209:8443
    >   Connected to 192.41.103.209:8443
    >   SSL negotiation with remote.net.ed.ac.uk
    >   Connected to HTTPS on remote.net.ed.ac.uk with ciphersuite (TLS1.3)-(ECDHE-SECP384R1)-(RSA-PSS-RSAE-SHA256)-(AES-256-GCM)
    >   Got HTTP response: HTTP/1.1 200 OK
    >   Date: Thu, 14 Sep 2023 05:34:26 GMT
    >   ....
    >   ....


# -----------------------------------------------------
# -----------------------------------------------------
# Create the bootstrap node.
#[root@ansibler]

    /deployments/openstack/bin/delete-all.sh \
        "${cloudname:?}"

    ansible-playbook \
        --inventory 'bootstrap,' \
        '/deployments/cluster-api/bootstrap/ansible/00-init-status.yml'

    ansible-playbook \
        --inventory 'bootstrap,' \
        '/deployments/cluster-api/bootstrap/ansible/01-create-keypair.yml'

    ansible-playbook \
        --inventory 'bootstrap,' \
        '/deployments/cluster-api/bootstrap/ansible/02-create-network.yml'

    ansible-playbook \
        --inventory 'bootstrap,' \
        '/deployments/cluster-api/bootstrap/ansible/03-create-bootstrap.yml'

    >   ....
    >   ....
    >   PLAY RECAP *****************************************************************************************
    >   localhost                  : ok=7    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0


# -----------------------------------------------------
# Configure our client.
#[root@ansibler]

    ansible-playbook \
        --inventory 'bootstrap,' \
        '/deployments/cluster-api/bootstrap/ansible/04-config-ansible.yml'

    >   ....
    >   ....
    >   PLAY RECAP *****************************************************************************************
    >   localhost                  : ok=5    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0


# -----------------------------------------------------
# Check we can login via ssh.
#[root@ansibler]

    ssh 'fedora@bootstrap' \
        '
        date
        hostname
        '

    >   Thu Sep 14 05:39:18 AM UTC 2023
    >   somerville-jade-20230914-bootstrap-node.novalocal


# -----------------------------------------------------
# Configure the bootstrap node.
#[root@ansibler]

    ansible-playbook \
        --inventory 'bootstrap,' \
        '/deployments/cluster-api/bootstrap/ansible/05-install-aglais.yml'


# -----------------------------------------------------
# ... and the VPN fails.
#[root@ansibler]

    >   ....
    >   ....
    >   Logout successful.
    >   Cookie was rejected by server; exiting.

    #
    # ... and the default route is gone
    #

    ip route

    >   10.0.2.0/24 dev tap0 proto kernel scope link src 10.0.2.100

    #
    # Restore the default route and restart the VPN.
    #

    ip route add default via 10.0.2.2 dev tap0

    ip route

    >   default via 10.0.2.2 dev tap0
    >   10.0.2.0/24 dev tap0 proto kernel scope link src 10.0.2.100

    openconnect \
        --verbose \
        --protocol fortinet \
        --user dmorris8 \
        remote.net.ed.ac.uk:8443

    >   GET https://remote.net.ed.ac.uk:8443/
    >   Attempting to connect to server 192.41.103.209:8443
    >   Connected to 192.41.103.209:8443
    >   SSL negotiation with remote.net.ed.ac.uk
    >   Connected to HTTPS on remote.net.ed.ac.uk with ciphersuite (TLS1.3)-(ECDHE-SECP384R1)-(RSA-PSS-RSAE-SHA256)-(AES-256-GCM)
    >   Got HTTP response: HTTP/1.1 200 OK
    >   Date: Thu, 14 Sep 2023 05:45:22 GMT
    >   ....
    >   ....


# -----------------------------------------------------
# Check we can login via ssh.
#[root@ansibler]

    ssh 'fedora@bootstrap' \
        '
        date
        hostname
        '

    >   Thu Sep 14 05:47:14 AM UTC 2023
    >   somerville-jade-20230914-bootstrap-node.novalocal


# -----------------------------------------------------
# Configure the bootstrap node.
#[root@ansibler]

    ansible-playbook \
        --inventory 'bootstrap,' \
        '/deployments/cluster-api/bootstrap/ansible/05-install-aglais.yml'


# -----------------------------------------------------
# ... and the VPN fails.
#[root@ansibler]

    >   ....
    >   ....
    >   Logout successful.
    >   Cookie was rejected by server; exiting.

    #
    # Â£$%^& the insecurity
    #




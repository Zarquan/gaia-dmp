#
# <meta:header>
#   <meta:licence>
#     Copyright (c) 2022, ROE (http://www.roe.ac.uk/)
#
#     This information is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This information is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
#   </meta:licence>
# </meta:header>
#
#zrq-notes-time
#zrq-notes-indent
#zrq-notes-crypto
#zrq-notes-ansible
#zrq-notes-osformat
#zrq-notes-zeppelin
#


    Target:

        Setup iris-gaia-data cloud

        * Create our network and router.
        * Create a new VM.
        * Assign a floating IP address.

    Result:

        Work in progress ..


# -----------------------------------------------------
# Login using the command line client ..
#[user@desktop]

    source "${HOME:?}/aglais.env"

    podman run \
        --rm \
        --tty \
        --interactive \
        --name ansibler \
        --hostname ansibler \
        --publish 3000:3000 \
        --env "SSH_AUTH_SOCK=/mnt/ssh_auth_sock" \
        --volume "${SSH_AUTH_SOCK}:/mnt/ssh_auth_sock:rw,z" \
        --volume "${HOME:?}/clouds.yaml:/etc/openstack/clouds.yaml:ro,z" \
        --volume "${AGLAIS_CODE:?}/deployments:/deployments:ro,z" \
        atolmis/ansible-client:2021.08.25 \
        bash


# -----------------------------------------------------
# Set the target cloud.
#[root@ansibler]

    cloudname=iris-gaia-data
    buildname="aglais-infra-$(date '+%Y%m%d')"
    builddate="$(date '+%Y%m%d:%H%M%S')"


# -----------------------------------------------------
# Create our SSH keypair.
#[root@ansibler]


    wget \
        -O "/tmp/${buildname:?}-keypair.pub" \
        'https://raw.githubusercontent.com/wfau/aglais/master/deployments/common/ssh/aglais-team-keys'

    >   ....
    >   ....
    >   2022-02-02 04:01:13 (5.74 MB/s) - ‘/tmp/aglais-infra-20220202-keypair.pub’ saved [1770/1770]


    openstack \
        --os-cloud "${cloudname:?}" \
        keypair create \
            --format json \
            --public-key "/tmp/${buildname:?}-keypair.pub" \
            "${buildname}-keypair" \
    | tee "/tmp/${buildname:?}-keypair.json" \
    | jq '{id, name, fingerprint}'


    aglaiskeypair=$(
        jq -r '.id' "/tmp/${buildname:?}-keypair.json"
        )

    >   {
    >     "id": "aglais-infra-20220202-keypair",
    >     "name": "aglais-infra-20220202-keypair",
    >     "fingerprint": "2e:84:98:98:df:70:06:0e:4c:ed:bd:d4:d6:6b:eb:16"
    >   }


# -----------------------------------------------------
# Create our internal network, subnet and router.
# https://docs.openstack.org/ocata/user-guide/cli-create-and-manage-networks.html
#[root@ansibler]

    aglaissubnetblock='10.10.0.0/24'

    openstack \
        --os-cloud "${cloudname:?}" \
        network create \
            --format json \
            "${buildname:?}-network" \
    | tee "/tmp/${buildname:?}-network.json" \
    | jq '{name, id, subnets}'

    aglaisnetworkid=$(
        jq -r '.id' "/tmp/${buildname:?}-network.json"
        )

    >   {
    >     "name": "aglais-infra-20220202-network",
    >     "id": "a7cbd1e0-d98d-4a33-bca1-e923ddc8605f",
    >     "subnets": []
    >   }


    openstack \
        --os-cloud "${cloudname:?}" \
        subnet create \
            --format json \
            "${buildname:?}-subnet" \
            --network "${aglaisnetworkid:?}" \
            --subnet-range "${aglaissubnetblock:?}" \
    | tee "/tmp/${buildname:?}-subnet.json" \
    | jq '{name, id, cidr, gateway_ip, allocation_pools}'

    aglaissubnetid=$(
        jq -r '.id' "/tmp/${buildname:?}-subnet.json"
        )

    >   {
    >     "name": "aglais-infra-20220202-subnet",
    >     "id": "522976a8-3bf4-4cb4-bb24-75ddc69dc102",
    >     "cidr": "10.10.0.0/24",
    >     "gateway_ip": "10.10.0.1",
    >     "allocation_pools": [
    >       {
    >         "start": "10.10.0.2",
    >         "end": "10.10.0.254"
    >       }
    >     ]
    >   }


    openstack \
        --os-cloud "${cloudname:?}" \
        router create \
            --format json \
            "${buildname:?}-router" \
    | tee "/tmp/${buildname:?}-router.json" \
    | jq '{name, id, routes}'

    aglaisrouterid=$(
        jq -r '.id' "/tmp/${buildname:?}-router.json"
        )

    >   {
    >     "name": "aglais-infra-20220202-router",
    >     "id": "c5855df3-31c3-4dc9-83a5-9f1ee6f2ebe2",
    >     "routes": []
    >   }


# -----------------------------------------------------
# Link our router to the public internet and our private subnet.
#[root@ansibler]

    openstack \
        --os-cloud "${cloudname:?}" \
        network list

    >   +--------------------------------------+-------------------------------+--------------------------------------+
    >   | ID                                   | Name                          | Subnets                              |
    >   +--------------------------------------+-------------------------------+--------------------------------------+
    >   | 2f2b65d0-5996-49d3-b2a1-b36191abde63 | pfb29-test                    | ca54eb70-d6fd-4550-bdc1-149f80da8efd |
    >   | 410920fb-5714-4447-b26a-e7b06092fc62 | cephfs                        | 5699fb5d-8316-4b88-b889-b05c8a1ec975 |
    >   | 57add367-d205-4030-a929-d75617a7c63e | CUDN-Internet                 | 3fcaa5a5-ba8e-49a9-bf94-d87fbb0afc42 |
    >   | a7cbd1e0-d98d-4a33-bca1-e923ddc8605f | aglais-infra-20220202-network | 522976a8-3bf4-4cb4-bb24-75ddc69dc102 |
    >   +--------------------------------------+-------------------------------+--------------------------------------+

    internet=$(
        openstack \
            --os-cloud "${cloudname:?}" \
            network list \
                --format json \
        | jq -r '
            .[] | select(.Name == "CUDN-Internet") | .ID
            '
        )

    # Link our router to the public internet.
    openstack \
        --os-cloud "${cloudname:?}" \
        router set \
            "${aglaisrouterid:?}" \
            --external-gateway \
                "${internet:?}"

    # Link our router to our private subnet.
    openstack \
        --os-cloud "${cloudname:?}" \
        router add subnet \
            "${aglaisrouterid:?}" \
            "${aglaissubnetid:?}"

    openstack \
        --os-cloud "${cloudname:?}" \
        router show \
            --format json \
            "${aglaisrouterid:?}" \
    | tee "/tmp/${buildname:?}-router.json" \
    | jq '{name, id, routes, interfaces_info, external_gateway_info}'

    >   {
    >     "name": "aglais-infra-20220202-router",
    >     "id": "c5855df3-31c3-4dc9-83a5-9f1ee6f2ebe2",
    >     "routes": [],
    >     "interfaces_info": [
    >       {
    >         "port_id": "52c87236-40fc-4adf-b878-b9ef703373e9",
    >         "ip_address": "10.10.0.1",
    >         "subnet_id": "522976a8-3bf4-4cb4-bb24-75ddc69dc102"
    >       }
    >     ],
    >     "external_gateway_info": {
    >       "network_id": "57add367-d205-4030-a929-d75617a7c63e",
    >       "enable_snat": true,
    >       "external_fixed_ips": [
    >         {
    >           "subnet_id": "3fcaa5a5-ba8e-49a9-bf94-d87fbb0afc42",
    >           "ip_address": "128.232.222.20"
    >         }
    >       ]
    >     }
    >   }


# -----------------------------------------------------
# Get the ID of the Fedora image.
#[root@ansibler]

    openstack \
        --os-cloud "${cloudname:?}" \
        image list

    >   +--------------------------------------+------------------------------+--------+
    >   | ID                                   | Name                         | Status |
    >   +--------------------------------------+------------------------------+--------+
    >   ....
    >   ....
    >   | 1779f380-780d-40d8-8052-b3acb91ed530 | Fedora-31-1.9                | active |
    >   | e62a71df-4bd2-4498-9eae-058ff476b5ad | Fedora-33-1.2                | active |
    >   | e5c23082-cc34-4213-ad31-ff4684657691 | Fedora-34.1.2                | active |
    >   | dcb41a5f-868a-4880-9fd5-04b95ab97c47 | FedoraAtomic29-20191126      | active |
    >   | a079781f-80b7-4d89-95ae-ef65bfb0834f | FedoraCoreOS33               | active |
    >   | 191d3d4d-60cc-4b87-b4a7-0a03cc48a51e | FedoraCoreOS34               | active |
    >   ....
    >   ....
    >   +--------------------------------------+------------------------------+--------+
    >

    imageid=$(
        openstack \
            --os-cloud "${cloudname:?}" \
            image list \
                --format json \
        | jq -r '.[] | select(.Name | test("Fedora-34.1.2")) | .ID'
        )


# -----------------------------------------------------
# Get the flavor ID.
#[root@ansibler]

    openstack \
        --os-cloud "${cloudname:?}" \
        flavor list

    >   +--------------------------------------+--------------+-------+------+-----------+-------+-----------+
    >   | ID                                   | Name         |   RAM | Disk | Ephemeral | VCPUs | Is Public |
    >   +--------------------------------------+--------------+-------+------+-----------+-------+-----------+
    >   | 2e5dc624-1d3b-4da7-8107-cc2dd4cb5073 | vm.v1.large  | 32768 |   60 |         0 |     8 | True      |
    >   | 6793b213-5efa-4b51-96bf-1340ff066499 | vm.v1.xsmall |  2048 |   20 |         0 |     1 | True      |
    >   | 698a8d46-eceb-4c55-91ff-38286bf9eabb | vm.v1.tiny   |  1024 |   10 |         0 |     1 | True      |
    >   | 6b56d6e9-5397-4543-87fb-e0c0b6d47961 | vm.v1.small  | 16384 |   20 |         0 |     4 | True      |
    >   +--------------------------------------+--------------+-------+------+-----------+-------+-----------+

    flavorid=$(
        openstack \
            --os-cloud "${cloudname:?}" \
            flavor list \
                --format json \
        | jq -r '.[] | select(.Name == "vm.v1.tiny") | .ID'
        )


# -----------------------------------------------------
# Create a security group for our VM.
#[root@ansibler]

    openstack \
        --os-cloud "${cloudname:?}" \
        security group create \
            --format json \
            "${buildname:?}-security" \
    | tee "/tmp/${buildname:?}-security.json" \
    | jq '{name, id}'

    >   {
    >     "name": "aglais-infra-20220202-security",
    >     "id": "49a88ff7-c06b-4da0-ab75-fdd40573b381"
    >   }

    aglaissecgroupid=$(
        jq -r '.id' "/tmp/${buildname:?}-security.json"
        )

    openstack \
        --os-cloud "${cloudname:?}" \
        security group rule create \
            --ingress \
            --dst-port   22 \
            --protocol  'tcp' \
            --ethertype 'IPv4' \
            "${aglaissecgroupid:?}"

    openstack \
        --os-cloud "${cloudname:?}" \
        security group rule create \
            --ingress \
            --dst-port   22 \
            --protocol  'tcp' \
            --ethertype 'IPv6' \
            "${aglaissecgroupid:?}"


# -----------------------------------------------------
# Create our virtual machine.
#[root@ansibler]

    openstack \
        --os-cloud "${cloudname:?}" \
        server create \
            --format json \
            --image "${imageid:?}" \
            --flavor "${flavorid:?}" \
            --network "${aglaisnetworkid:?}" \
            --key-name "${aglaiskeypair:?}" \
            --security-group "${aglaissecgroupid:?}" \
            "${buildname:?}-machine" \
    | tee "/tmp/${buildname:?}-machine.json" \
    | jq '{name, id, status, flavor, image, key_name}'

    vmident=$(
        jq -r '.id' "/tmp/${buildname:?}-machine.json"
        )

    >   {
    >     "name": "aglais-infra-20220202-machine",
    >     "id": "58dd70e7-c050-4c4b-8832-d05a67441ff4",
    >     "status": "BUILD",
    >     "flavor": "vm.v1.tiny (698a8d46-eceb-4c55-91ff-38286bf9eabb)",
    >     "image": "Fedora-34.1.2 (e5c23082-cc34-4213-ad31-ff4684657691)",
    >     "key_name": "aglais-infra-20220202-keypair"
    >   }


# -----------------------------------------------------
# Create a public IP address and attach it to our VM.
#[root@ansibler]

    floatip=$(
        openstack \
            --os-cloud "${cloudname:?}" \
            floating ip \
            create \
            --format json \
            "${internet:?}" \
        | jq -r '.floating_ip_address'
        )

    networkname=$(
        openstack \
            --os-cloud "${cloudname:?}" \
            network show \
                --format json \
                "${aglaisnetworkid:?}" \
        | jq -r '.name'
        )

    privateip=$(
        openstack \
            --os-cloud "${cloudname:?}" \
            server show \
                --format json \
                "${vmident:?}" \
        | jq -r ".addresses.\"${networkname:?}\"[0]"
        )

cat << EOF
Public  IP [${floatip}]
Private IP [${privateip}]
EOF

    >   Public  IP [128.232.222.142]
    >   Private IP [10.10.0.198]

    openstack \
        --os-cloud "${cloudname:?}" \
        server add \
            floating ip \
            --fixed-ip-address "${privateip:?}" \
            "${vmident:?}" \
            "${floatip:?}"


# -----------------------------------------------------
# Test ssh access.
#[root@ansibler]

    ssh -v \
        fedora@${floatip:?} \
        '
        hostname
        date
        '

    >   ....
    >   ....
    >   ssh: connect to host 128.232.222.142 port 22: Connection refused



# -----------------------------------------------------
# -----------------------------------------------------

    Created network, subnet, router and VM via the Horizin GUI.
    Not all of them worked, but found one that does.
    Comparing the settings for each of them.

# -----------------------------------------------------
# List the components we have.
#[root@ansibler]

    openstack \
        --os-cloud "${cloudname:?}" \
        server list

    >   +--------------------------------------+-------------------------------+--------+------------------------------------------------------------+---------------+-------------+
    >   | ID                                   | Name                          | Status | Networks                                                   | Image         | Flavor      |
    >   +--------------------------------------+-------------------------------+--------+------------------------------------------------------------+---------------+-------------+
    >   | efcfcea7-811a-4f1a-bd21-d3e13a834e3b | sunter                        | ACTIVE | pallib=10.11.0.42, 128.232.222.163                         | Fedora-34.1.2 | vm.v1.tiny  |
    >   | eefad14b-6024-42a1-9d8a-2f73d1254c86 | fargemp                       | ACTIVE | aglais-infra-20220202-network=10.10.0.250, 128.232.222.237 | Fedora-34.1.2 | vm.v1.tiny  |
    >   | 58dd70e7-c050-4c4b-8832-d05a67441ff4 | aglais-infra-20220202-machine | ACTIVE | aglais-infra-20220202-network=10.10.0.198, 128.232.222.142 | Fedora-34.1.2 | vm.v1.tiny  |
    >   | f7800318-a6cd-46f6-8b58-506354b13b77 | aglais-20211229-working       | ACTIVE | pfb29-test=10.0.0.140, 128.232.222.74                      | Fedora-34.1.2 | vm.v1.small |
    >   +--------------------------------------+-------------------------------+--------+------------------------------------------------------------+---------------+-------------+

    PASS    sunter
    PASS    aglais-20211229-working
    FAIL    fargemp
    FAIL    aglais-infra-20220202-machine


    There isn't something special about pfb29-test.
    It is possible to create another network that works.
    There must be some default setting I didn't set.


# -----------------------------------------------------
# Compare routers.
#[root@ansibler]

    openstack \
        --os-cloud "${cloudname:?}" \
        router list

    >   +--------------------------------------+------------------------------+--------+-------+----------------------------------+
    >   | ID                                   | Name                         | Status | State | Project                          |
    >   +--------------------------------------+------------------------------+--------+-------+----------------------------------+
    >   | 426f6903-de06-4954-ae3a-9dfbde3f18a7 | pfb29-ceph-router            | ACTIVE | UP    | e216e6b502134b6185380be6ccd0bf09 |
    >   | c5855df3-31c3-4dc9-83a5-9f1ee6f2ebe2 | aglais-infra-20220202-router | ACTIVE | UP    | e216e6b502134b6185380be6ccd0bf09 |
    >   | c87e4464-ae32-4329-a001-cb5542b28a97 | pfb29-test                   | ACTIVE | UP    | e216e6b502134b6185380be6ccd0bf09 |
    >   | eb7b22d6-7cbd-47c8-88a6-755ed691fddd | molph                        | ACTIVE | UP    | e216e6b502134b6185380be6ccd0bf09 |
    >   +--------------------------------------+------------------------------+--------+-------+----------------------------------+


    PASS    pfb29-ceph-router
    PASS    molph
    FAIL    aglais-infra-20220202-router


    openstack \
        --os-cloud "${cloudname:?}" \
        router show \
            --format json \
            aglais-infra-20220202-router \
    | tee /tmp/aglais-infra-20220202-router.json

--START--
....
....
--END--


    openstack \
        --os-cloud "${cloudname:?}" \
        router show \
            --format json \
            molph \
    | tee /tmp/molph-router.json

--START--
....
....
--END--


    diff \
        /tmp/molph-router.json \
        /tmp/aglais-infra-20220202-router.json

--START--
7c7
<   "created_at": "2022-02-02T04:44:52Z",
---
>   "created_at": "2022-02-02T04:03:26Z",
15c15
<         "ip_address": "128.232.222.30"
---
>         "ip_address": "128.232.222.20"
20c20
<   "id": "eb7b22d6-7cbd-47c8-88a6-755ed691fddd",
---
>   "id": "c5855df3-31c3-4dc9-83a5-9f1ee6f2ebe2",
23,25c23,25
<       "port_id": "d0ab5810-d5e6-4489-920b-670150f18182",
<       "ip_address": "10.11.0.1",
<       "subnet_id": "f6727fb5-7797-48b2-8aff-8c63d2bdc1fb"
---
>       "port_id": "52c87236-40fc-4adf-b878-b9ef703373e9",
>       "ip_address": "10.10.0.1",
>       "subnet_id": "522976a8-3bf4-4cb4-bb24-75ddc69dc102"
28c28
<   "name": "molph",
---
>   "name": "aglais-infra-20220202-router",
34c34
<   "updated_at": "2022-02-02T04:46:04Z"
---
>   "updated_at": "2022-02-02T04:04:26Z"
--END--


# -----------------------------------------------------
# Compare networks.
#[root@ansibler]

    openstack \
        --os-cloud "${cloudname:?}" \
        network list

    >   +--------------------------------------+-------------------------------+--------------------------------------+
    >   | ID                                   | Name                          | Subnets                              |
    >   +--------------------------------------+-------------------------------+--------------------------------------+
    >   | 2f2b65d0-5996-49d3-b2a1-b36191abde63 | pfb29-test                    | ca54eb70-d6fd-4550-bdc1-149f80da8efd |
    >   | 410920fb-5714-4447-b26a-e7b06092fc62 | cephfs                        | 5699fb5d-8316-4b88-b889-b05c8a1ec975 |
    >   | 57add367-d205-4030-a929-d75617a7c63e | CUDN-Internet                 | 3fcaa5a5-ba8e-49a9-bf94-d87fbb0afc42 |
    >   | 9a43c204-ccf3-4df8-bbb3-f3a28530584d | pallib                        | f6727fb5-7797-48b2-8aff-8c63d2bdc1fb |
    >   | a7cbd1e0-d98d-4a33-bca1-e923ddc8605f | aglais-infra-20220202-network | 522976a8-3bf4-4cb4-bb24-75ddc69dc102 |
    >   +--------------------------------------+-------------------------------+--------------------------------------+

    PASS    pfb29-test
    PASS    pallib
    FAIL    aglais-infra-20220202-network


    openstack \
        --os-cloud "${cloudname:?}" \
        network show \
            --format json \
            aglais-infra-20220202-network \
    | tee /tmp/aglais-infra-20220202-network.json

--START--
....
....
--END--


    openstack \
        --os-cloud "${cloudname:?}" \
        network show \
            --format json \
            pallib \
    | tee /tmp/pallib-network.json

--START--
....
....
--END--


    diff \
        /tmp/pallib-network.json \
        /tmp/aglais-infra-20220202-network.json


--START--
7c7
<   "created_at": "2022-02-02T04:35:57Z",
---
>   "created_at": "2022-02-02T04:02:46Z",
10c10
<   "id": "9a43c204-ccf3-4df8-bbb3-f3a28530584d",
---
>   "id": "a7cbd1e0-d98d-4a33-bca1-e923ddc8605f",
16c16
<   "name": "pallib",
---
>   "name": "aglais-infra-20220202-network",
29c29
<     "f6727fb5-7797-48b2-8aff-8c63d2bdc1fb"
---
>     "522976a8-3bf4-4cb4-bb24-75ddc69dc102"
32c32
<   "updated_at": "2022-02-02T04:35:57Z"
---
>   "updated_at": "2022-02-02T04:03:05Z"
--END--


# -----------------------------------------------------
# Compare subnets.
#[root@ansibler]

    openstack \
        --os-cloud "${cloudname:?}" \
        subnet list

    >   +--------------------------------------+------------------------------+--------------------------------------+--------------+
    >   | ID                                   | Name                         | Network                              | Subnet       |
    >   +--------------------------------------+------------------------------+--------------------------------------+--------------+
    >   | 522976a8-3bf4-4cb4-bb24-75ddc69dc102 | aglais-infra-20220202-subnet | a7cbd1e0-d98d-4a33-bca1-e923ddc8605f | 10.10.0.0/24 |
    >   | 5699fb5d-8316-4b88-b889-b05c8a1ec975 | cephfs                       | 410920fb-5714-4447-b26a-e7b06092fc62 | 10.9.0.0/16  |
    >   | ca54eb70-d6fd-4550-bdc1-149f80da8efd | pfb29-test                   | 2f2b65d0-5996-49d3-b2a1-b36191abde63 | 10.0.0.0/24  |
    >   | f6727fb5-7797-48b2-8aff-8c63d2bdc1fb | jalt                         | 9a43c204-ccf3-4df8-bbb3-f3a28530584d | 10.11.0.0/24 |
    >   +--------------------------------------+------------------------------+--------------------------------------+--------------+

    PASS    jalt
    PASS    pfb29-test
    FAIL    aglais-infra-20220202-subnet


    openstack \
        --os-cloud "${cloudname:?}" \
        subnet show \
            --format json \
            aglais-infra-20220202-subnet \
    | tee /tmp/aglais-infra-20220202-subnet.json

--START--
....
....
--END--


    openstack \
        --os-cloud "${cloudname:?}" \
        subnet show \
            --format json \
            jalt \
    | tee /tmp/jalt-subnet.json

--START--
....
....
--END--


    diff \
        /tmp/jalt-subnet.json \
        /tmp/aglais-infra-20220202-subnet.json

--START--
4,5c4,5
<       "start": "10.11.0.2",
<       "end": "10.11.0.254"
---
>       "start": "10.10.0.2",
>       "end": "10.10.0.254"
8,9c8,9
<   "cidr": "10.11.0.0/24",
<   "created_at": "2022-02-02T04:35:57Z",
---
>   "cidr": "10.10.0.0/24",
>   "created_at": "2022-02-02T04:03:05Z",
11,14c11
<   "dns_nameservers": [
<     "131.111.12.20",
<     "131.111.8.42"
<   ],
---
>   "dns_nameservers": [],
17c14
<   "gateway_ip": "10.11.0.1",
---
>   "gateway_ip": "10.10.0.1",
19c16
<   "id": "f6727fb5-7797-48b2-8aff-8c63d2bdc1fb",
---
>   "id": "522976a8-3bf4-4cb4-bb24-75ddc69dc102",
23,24c20,21
<   "name": "jalt",
<   "network_id": "9a43c204-ccf3-4df8-bbb3-f3a28530584d",
---
>   "name": "aglais-infra-20220202-subnet",
>   "network_id": "a7cbd1e0-d98d-4a33-bca1-e923ddc8605f",
32c29
<   "updated_at": "2022-02-02T04:35:57Z"
---
>   "updated_at": "2022-02-02T04:03:05Z"
--END--


    # DNS nameservers are different.

# -----------------------------------------------------
# Fix the DNS nameservers.
#[root@ansibler]

    openstack \
        --os-cloud "${cloudname:?}" \
        subnet set \
            --dns-nameserver "131.111.8.42" \
            --dns-nameserver "131.111.12.20" \
            aglais-infra-20220202-subnet \


    openstack \
        --os-cloud "${cloudname:?}" \
        subnet show \
            --format json \
            aglais-infra-20220202-subnet \
    | tee /tmp/aglais-infra-20220202-subnet.json

--START--
....
....
--END--


    diff \
        /tmp/jalt-subnet.json \
        /tmp/aglais-infra-20220202-subnet.json

--START--
4,5c4,5
<       "start": "10.11.0.2",
<       "end": "10.11.0.254"
---
>       "start": "10.10.0.2",
>       "end": "10.10.0.254"
8,9c8,9
<   "cidr": "10.11.0.0/24",
<   "created_at": "2022-02-02T04:35:57Z",
---
>   "cidr": "10.10.0.0/24",
>   "created_at": "2022-02-02T04:03:05Z",
12,13c12,13
<     "131.111.12.20",
<     "131.111.8.42"
---
>     "131.111.8.42",
>     "131.111.12.20"
17c17
<   "gateway_ip": "10.11.0.1",
---
>   "gateway_ip": "10.10.0.1",
19c19
<   "id": "f6727fb5-7797-48b2-8aff-8c63d2bdc1fb",
---
>   "id": "522976a8-3bf4-4cb4-bb24-75ddc69dc102",
23,24c23,24
<   "name": "jalt",
<   "network_id": "9a43c204-ccf3-4df8-bbb3-f3a28530584d",
---
>   "name": "aglais-infra-20220202-subnet",
>   "network_id": "a7cbd1e0-d98d-4a33-bca1-e923ddc8605f",
27c27
<   "revision_number": 0,
---
>   "revision_number": 1,
32c32
<   "updated_at": "2022-02-02T04:35:57Z"
---
>   "updated_at": "2022-02-02T06:04:03Z"
--END--



    ssh -v \
        fedora@128.232.222.237 \
        '
        hostname
        date
        '

--START--
....
debug1: Connecting to 128.232.222.237 [128.232.222.237] port 22.
debug1: connect to address 128.232.222.237 port 22: Connection refused
ssh: connect to host 128.232.222.237 port 22: Connection refused
--END--


# -----------------------------------------------------
# Compare network ports.
#[root@ansibler]

    openstack \
        --os-cloud "${cloudname:?}" \
        port list

--START--
+--------------------------------------+------------------------+-------------------+--------------------------------------------------------------------------------+--------+
| ID                                   | Name                   | MAC Address       | Fixed IP Addresses                                                             | Status |
+--------------------------------------+------------------------+-------------------+--------------------------------------------------------------------------------+--------+
| 017ff9bb-3faa-4df8-b003-d94f55d7540c |                        | fa:16:3e:29:8e:e7 | ip_address='10.10.0.2', subnet_id='522976a8-3bf4-4cb4-bb24-75ddc69dc102'       | ACTIVE |
| 09f668c4-5960-417e-b2c5-d44955920927 |                        | fa:16:3e:e4:06:e7 | ip_address='10.10.0.3', subnet_id='522976a8-3bf4-4cb4-bb24-75ddc69dc102'       | ACTIVE |
| 0e220735-beae-4c09-a07b-e93759f36c86 |                        | fa:16:3e:1e:18:85 | ip_address='128.232.222.163', subnet_id='3fcaa5a5-ba8e-49a9-bf94-d87fbb0afc42' | N/A    |
| 1fcf37de-0326-4d43-96c0-71123ac17018 |                        | fa:16:3e:8f:ba:06 | ip_address='10.11.0.42', subnet_id='f6727fb5-7797-48b2-8aff-8c63d2bdc1fb'      | ACTIVE |
| 2631aaa3-0890-4150-bcd9-eca6b19d4e00 |                        | fa:16:3e:9a:a6:bc | ip_address='10.0.0.1', subnet_id='ca54eb70-d6fd-4550-bdc1-149f80da8efd'        | ACTIVE |
| 48ff7284-b3bb-4690-b1ed-cde02792124e |                        | fa:16:3e:af:35:d7 | ip_address='10.11.0.3', subnet_id='f6727fb5-7797-48b2-8aff-8c63d2bdc1fb'       | ACTIVE |
| 52c87236-40fc-4adf-b878-b9ef703373e9 |                        | fa:16:3e:1f:71:0e | ip_address='10.10.0.1', subnet_id='522976a8-3bf4-4cb4-bb24-75ddc69dc102'       | ACTIVE |
| 619c78c3-b684-4533-8e8d-04bce1ed7b77 |                        | fa:16:3e:5e:a1:ba | ip_address='128.232.222.74', subnet_id='3fcaa5a5-ba8e-49a9-bf94-d87fbb0afc42'  | N/A    |
| 69d70ff4-5748-4872-8bc8-7b10dd22600b |                        | fa:16:3e:a7:7b:40 | ip_address='128.232.222.218', subnet_id='3fcaa5a5-ba8e-49a9-bf94-d87fbb0afc42' | N/A    |
| 76edc4a5-cbc5-4dfe-a157-ea0eddde8c51 |                        | fa:16:3e:6c:2a:4f | ip_address='10.0.0.140', subnet_id='ca54eb70-d6fd-4550-bdc1-149f80da8efd'      | ACTIVE |
| 78ea7403-651d-4f33-ad92-1d24166000b3 |                        | fa:16:3e:c8:9c:c3 | ip_address='10.10.0.250', subnet_id='522976a8-3bf4-4cb4-bb24-75ddc69dc102'     | ACTIVE |
| 8221c0fd-c5fd-4267-9da7-6a13d40d052f |                        | fa:16:3e:35:da:dc | ip_address='10.0.0.2', subnet_id='ca54eb70-d6fd-4550-bdc1-149f80da8efd'        | ACTIVE |
| 9c4faa37-51e6-4ab7-90e5-4ffa3497c28f |                        | fa:16:3e:f8:a4:49 | ip_address='10.10.0.198', subnet_id='522976a8-3bf4-4cb4-bb24-75ddc69dc102'     | ACTIVE |
| ac0182fd-052f-4fc2-b17b-34e2dca68d6b |                        | fa:16:3e:73:27:d4 | ip_address='10.0.0.3', subnet_id='ca54eb70-d6fd-4550-bdc1-149f80da8efd'        | ACTIVE |
| b51a6a95-f13d-4a91-8efb-f575cf58cc7c |                        | fa:16:3e:57:98:a2 | ip_address='128.232.222.237', subnet_id='3fcaa5a5-ba8e-49a9-bf94-d87fbb0afc42' | N/A    |
| d0ab5810-d5e6-4489-920b-670150f18182 |                        | fa:16:3e:26:00:df | ip_address='10.11.0.1', subnet_id='f6727fb5-7797-48b2-8aff-8c63d2bdc1fb'       | ACTIVE |
| f5ae9c86-4e79-41ed-bb8f-4943536eb449 |                        | fa:16:3e:8d:a8:da | ip_address='128.232.222.142', subnet_id='3fcaa5a5-ba8e-49a9-bf94-d87fbb0afc42' | N/A    |
| f8de437c-245f-4f4f-b5fa-8680a62c16e4 | pfb29-ceph-subnet-port | fa:16:3e:31:c3:c9 | ip_address='10.0.0.103', subnet_id='ca54eb70-d6fd-4550-bdc1-149f80da8efd'      | ACTIVE |
| f932afc2-d9b3-49db-a464-d1b47cf79c89 |                        | fa:16:3e:7e:20:27 | ip_address='10.11.0.2', subnet_id='f6727fb5-7797-48b2-8aff-8c63d2bdc1fb'       | ACTIVE |
+--------------------------------------+------------------------+-------------------+--------------------------------------------------------------------------------+--------+
--END--

    routername=aglais-infra-20220202-router

    portid=$(
        jq -r \
            '.interfaces_info[0].port_id' \
            /tmp/${routername:?}.json
        )

    openstack \
        --os-cloud "${cloudname:?}" \
        port show \
            --format json \
            "${portid:?}" \
    | tee /tmp/${routername:?}-port.json

--START--
{
  "admin_state_up": true,
  "allowed_address_pairs": [],
  "binding_host_id": null,
  "binding_profile": {},
  "binding_vif_details": {},
  "binding_vif_type": null,
  "binding_vnic_type": "normal",
  "created_at": "2022-02-02T04:04:25Z",
  "data_plane_status": null,
  "description": "",
  "device_id": "c5855df3-31c3-4dc9-83a5-9f1ee6f2ebe2",
  "device_owner": "network:ha_router_replicated_interface",
  "device_profile": null,
  "dns_assignment": [
    {
      "hostname": "host-10-10-0-1",
      "ip_address": "10.10.0.1",
      "fqdn": "host-10-10-0-1"
    }
  ],
  "dns_domain": "",
  "dns_name": "",
  "extra_dhcp_opts": [],
  "fixed_ips": [
    {
      "subnet_id": "522976a8-3bf4-4cb4-bb24-75ddc69dc102",
      "ip_address": "10.10.0.1"
    }
  ],
  "id": "52c87236-40fc-4adf-b878-b9ef703373e9",
  "ip_allocation": null,
  "mac_address": "fa:16:3e:1f:71:0e",
  "name": "",
  "network_id": "a7cbd1e0-d98d-4a33-bca1-e923ddc8605f",
  "numa_affinity_policy": null,
  "port_security_enabled": false,
  "project_id": "e216e6b502134b6185380be6ccd0bf09",
  "propagate_uplink_status": null,
  "qos_network_policy_id": null,
  "qos_policy_id": null,
  "resource_request": null,
  "revision_number": 7,
  "security_group_ids": [],
  "status": "ACTIVE",
  "tags": [],
  "trunk_details": null,
  "updated_at": "2022-02-02T04:04:35Z"
}
--END--


    routername=molph-router

    portid=$(
        jq -r \
            '.interfaces_info[0].port_id' \
            /tmp/${routername:?}.json
        )

    openstack \
        --os-cloud "${cloudname:?}" \
        port show \
            --format json \
            "${portid:?}" \
    | tee /tmp/${routername:?}-port.json


--START--
{
  "admin_state_up": true,
  "allowed_address_pairs": [],
  "binding_host_id": null,
  "binding_profile": {},
  "binding_vif_details": {},
  "binding_vif_type": null,
  "binding_vnic_type": "normal",
  "created_at": "2022-02-02T04:46:02Z",
  "data_plane_status": null,
  "description": "",
  "device_id": "eb7b22d6-7cbd-47c8-88a6-755ed691fddd",
  "device_owner": "network:ha_router_replicated_interface",
  "device_profile": null,
  "dns_assignment": [
    {
      "hostname": "host-10-11-0-1",
      "ip_address": "10.11.0.1",
      "fqdn": "host-10-11-0-1"
    }
  ],
  "dns_domain": "",
  "dns_name": "",
  "extra_dhcp_opts": [],
  "fixed_ips": [
    {
      "subnet_id": "f6727fb5-7797-48b2-8aff-8c63d2bdc1fb",
      "ip_address": "10.11.0.1"
    }
  ],
  "id": "d0ab5810-d5e6-4489-920b-670150f18182",
  "ip_allocation": null,
  "mac_address": "fa:16:3e:26:00:df",
  "name": "",
  "network_id": "9a43c204-ccf3-4df8-bbb3-f3a28530584d",
  "numa_affinity_policy": null,
  "port_security_enabled": false,
  "project_id": "e216e6b502134b6185380be6ccd0bf09",
  "propagate_uplink_status": null,
  "qos_network_policy_id": null,
  "qos_policy_id": null,
  "resource_request": null,
  "revision_number": 7,
  "security_group_ids": [],
  "status": "ACTIVE",
  "tags": [],
  "trunk_details": null,
  "updated_at": "2022-02-02T04:46:12Z"
}
--END--


    diff \
        /tmp/molph-router-port.json \
        /tmp/aglais-infra-20220202-router-port.json

--START--
9c9
<   "created_at": "2022-02-02T04:46:02Z",
---
>   "created_at": "2022-02-02T04:04:25Z",
12c12
<   "device_id": "eb7b22d6-7cbd-47c8-88a6-755ed691fddd",
---
>   "device_id": "c5855df3-31c3-4dc9-83a5-9f1ee6f2ebe2",
17,19c17,19
<       "hostname": "host-10-11-0-1",
<       "ip_address": "10.11.0.1",
<       "fqdn": "host-10-11-0-1"
---
>       "hostname": "host-10-10-0-1",
>       "ip_address": "10.10.0.1",
>       "fqdn": "host-10-10-0-1"
27,28c27,28
<       "subnet_id": "f6727fb5-7797-48b2-8aff-8c63d2bdc1fb",
<       "ip_address": "10.11.0.1"
---
>       "subnet_id": "522976a8-3bf4-4cb4-bb24-75ddc69dc102",
>       "ip_address": "10.10.0.1"
31c31
<   "id": "d0ab5810-d5e6-4489-920b-670150f18182",
---
>   "id": "52c87236-40fc-4adf-b878-b9ef703373e9",
33c33
<   "mac_address": "fa:16:3e:26:00:df",
---
>   "mac_address": "fa:16:3e:1f:71:0e",
35c35
<   "network_id": "9a43c204-ccf3-4df8-bbb3-f3a28530584d",
---
>   "network_id": "a7cbd1e0-d98d-4a33-bca1-e923ddc8605f",
48c48
<   "updated_at": "2022-02-02T04:46:12Z"
---
>   "updated_at": "2022-02-02T04:04:35Z"
--END--



# -----------------------------------------------------
# -----------------------------------------------------
# Can we ping the VMs from outside ?
#[root@ansibler]

    openstack \
        --os-cloud "${cloudname:?}" \
        server list

--START--
+--------------------------------------+-------------------------------+--------+------------------------------------------------------------+---------------+-------------+
| ID                                   | Name                          | Status | Networks                                                   | Image         | Flavor      |
+--------------------------------------+-------------------------------+--------+------------------------------------------------------------+---------------+-------------+
| efcfcea7-811a-4f1a-bd21-d3e13a834e3b | sunter                        | ACTIVE | pallib=10.11.0.42, 128.232.222.163                         | Fedora-34.1.2 | vm.v1.tiny  |
| eefad14b-6024-42a1-9d8a-2f73d1254c86 | fargemp                       | ACTIVE | aglais-infra-20220202-network=10.10.0.250, 128.232.222.237 | Fedora-34.1.2 | vm.v1.tiny  |
| 58dd70e7-c050-4c4b-8832-d05a67441ff4 | aglais-infra-20220202-machine | ACTIVE | aglais-infra-20220202-network=10.10.0.198, 128.232.222.142 | Fedora-34.1.2 | vm.v1.tiny  |
| f7800318-a6cd-46f6-8b58-506354b13b77 | aglais-20211229-working       | ACTIVE | pfb29-test=10.0.0.140, 128.232.222.74                      | Fedora-34.1.2 | vm.v1.small |
+--------------------------------------+-------------------------------+--------+------------------------------------------------------------+---------------+-------------+
--END--


    ping -c 5 128.232.222.163

--START--
PING 128.232.222.163 (128.232.222.163) 56(84) bytes of data.

--- 128.232.222.163 ping statistics ---
5 packets transmitted, 0 received, 100% packet loss, time 4081ms
--END--


    ping -c 5 128.232.222.237

--START--
PING 128.232.222.237 (128.232.222.237) 56(84) bytes of data.

--- 128.232.222.237 ping statistics ---
5 packets transmitted, 0 received, 100% packet loss, time 4077ms
--END--


    ping -c 5 128.232.222.142

--START--
PING 128.232.222.142 (128.232.222.142) 56(84) bytes of data.

--- 128.232.222.142 ping statistics ---
5 packets transmitted, 0 received, 100% packet loss, time 4106ms
--END--


    ping -c 5 128.232.222.74

--START--
PING 128.232.222.74 (128.232.222.74) 56(84) bytes of data.

--- 128.232.222.74 ping statistics ---
5 packets transmitted, 0 received, 100% packet loss, time 4098ms
--END--



# -----------------------------------------------------
# Can we ssh into the VMs from insode ?
#[root@ansibler]

    openstack \
        --os-cloud "${cloudname:?}" \
        server list

--START--
+--------------------------------------+-------------------------------+--------+------------------------------------------------------------+---------------+-------------+
| ID                                   | Name                          | Status | Networks                                                   | Image         | Flavor      |
+--------------------------------------+-------------------------------+--------+------------------------------------------------------------+---------------+-------------+
| efcfcea7-811a-4f1a-bd21-d3e13a834e3b | sunter                        | ACTIVE | pallib=10.11.0.42, 128.232.222.163                         | Fedora-34.1.2 | vm.v1.tiny  |
| eefad14b-6024-42a1-9d8a-2f73d1254c86 | fargemp                       | ACTIVE | aglais-infra-20220202-network=10.10.0.250, 128.232.222.237 | Fedora-34.1.2 | vm.v1.tiny  |
| 58dd70e7-c050-4c4b-8832-d05a67441ff4 | aglais-infra-20220202-machine | ACTIVE | aglais-infra-20220202-network=10.10.0.198, 128.232.222.142 | Fedora-34.1.2 | vm.v1.tiny  |
| f7800318-a6cd-46f6-8b58-506354b13b77 | aglais-20211229-working       | ACTIVE | pfb29-test=10.0.0.140, 128.232.222.74                      | Fedora-34.1.2 | vm.v1.small |
+--------------------------------------+-------------------------------+--------+------------------------------------------------------------+---------------+-------------+
--END--


    ssh -A fedora@128.232.222.163 \
        '
        hostname
        date
        echo "----"
        ssh fedora@128.232.222.237 \
            "
            hostname
            date
            "
        '

--START--
sunter
Wed Feb  2 06:39:41 UTC 2022
----
fargemp
Wed Feb  2 06:39:41 UTC 2022
--END--


    ssh -A fedora@128.232.222.163 \
        '
        hostname
        date
        echo "----"
        ssh fedora@128.232.222.142 \
            "
            hostname
            date
            "
        '

--START--
sunter
Wed Feb  2 06:41:38 UTC 2022
----
aglais-infra-20220202-machine
Wed Feb  2 06:41:38 UTC 2022
--END--

    #
    # OK - so both VMs on the aglais-infra-20220202-network are reachable from inside.
    # Note - both display an error message about 'dnf-makecache.service' when we login manually.
    #


    ssh -A fedora@128.232.222.163

--START--
Last login: Wed Feb  2 06:42:11 2022 from 90.155.51.57
--END--


        ssh fedora@128.232.222.142

--START--
Last login: Wed Feb  2 06:42:20 2022 from 128.232.222.163
[systemd]
Failed Units: 1
  dnf-makecache.service
--END--




    #
    # Check they can see the outside world ...
    #

    ssh -A fedora@128.232.222.163 \
        '
        hostname
        date
        curl --head http://www.metagrid.co.uk/ | head -n 2
        echo "----"
        ssh fedora@128.232.222.142 \
            "
            hostname
            date
            curl --head http://www.metagrid.co.uk/ | head -n 2
            "
        '

--START--
sunter
Wed Feb  2 06:51:24 UTC 2022
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
HTTP/1.1 200 OK
Date: Wed, 02 Feb 2022 00:22:21 GMT
----
aglais-infra-20220202-machine
Wed Feb  2 06:51:25 UTC 2022
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:--  0:00:16 --:--:--     0
curl: (6) Could not resolve host: www.metagrid.co.uk
--END--

    #
    # DNS is still broken for the new VM.
    #





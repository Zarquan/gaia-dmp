#
# <meta:header>
#   <meta:licence>
#     Copyright (c) 2022, ROE (http://www.roe.ac.uk/)
#
#     This information is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This information is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
#   </meta:licence>
# </meta:header>
#
#zrq-notes-time
#zrq-notes-indent
#zrq-notes-crypto
#zrq-notes-ansible
#zrq-notes-osformat
#zrq-notes-zeppelin
#

    Target:

        Clean deploy on red to test everything.

    Result:

        Work in progress ...

# -----------------------------------------------------
# Create a container to work with.
#[user@desktop]

    source "${HOME:?}/aglais.env"

    podman run \
        --rm \
        --tty \
        --interactive \
        --name ansibler \
        --hostname ansibler \
        --publish 3000:3000 \
        --env "SSH_AUTH_SOCK=/mnt/ssh_auth_sock" \
        --volume "${SSH_AUTH_SOCK}:/mnt/ssh_auth_sock:rw,z" \
        --volume "${HOME:?}/clouds.yaml:/etc/openstack/clouds.yaml:ro,z" \
        --volume "${AGLAIS_CODE:?}/deployments:/deployments:ro,z" \
        ghcr.io/wfau/atolmis/ansible-client:2022.03.19 \
        bash


# -----------------------------------------------------
# Set the target configuration.
#[root@ansibler]

    cloudbase=arcus
    cloudname=iris-gaia-red
    configname=zeppelin-26.43-spark-3.26.43


# -----------------------------------------------------
# Deploy everything.
#[root@ansibler]

    time \
        source /deployments/hadoop-yarn/bin/deploy.sh

--START--
real    36m45.882s
user    13m27.599s
sys     2m37.718s
--END--


# -----------------------------------------------------
# Check our deployment config.
#[root@ansibler]

    cat /tmp/aglais-status.yml

--START--
aglais:
  status:
    deployment:
      type: hadoop-yarn
      conf: zeppelin-26.43-spark-3.26.43
      name: iris-gaia-red-20220721
      date: 20220721T031719
      hostname: zeppelin.gaia-dmp.uk
  spec:
    openstack:
      cloud:
        base: arcus
        name: iris-gaia-red
--END--

# -----------------------------------------------------
# Create some test users.
#[root@ansibler]

    cat > /tmp/test-users.yml << EOF
users:
  - name: "Rhaelhall"
    type: "test"
    role: "user"
    linuxuid: "21000"
    password: "simple password"
    passhash: ""
    publickey: ""

  - name: "Fipa"
    type: "test"
    role: "user"
    linuxuid: "21001"
    password: "Oa7aez4i Aes4ongi"
    passhash: ""
    publickey: ""

  - name: "Mythicson"
    type: "test"
    role: "user"
    linuxuid: "21002"
  # password: "spray goldsmith native heftiness"
    passhash: "$shiro1$SHA-256$500000$1ucx+RkCWIMVnJIJCFKL2A==$55SWIC7EJcV5VxcncvJZHBEdla2+3WT9YX45PLbwKFc="
    publickey: ""

  - name: "Balline"
    type: "test"
    role: "user"
    linuxuid: "21003"
    password: "spray goldsmith native heftiness"
  # passhash: "$shiro1$SHA-256$500000$1ucx+RkCWIMVnJIJCFKL2A==$55SWIC7EJcV5VxcncvJZHBEdla2+3WT9YX45PLbwKFc="
    publickey: ""

  - name: "Balline"
    type: "test"
    role: "user"
    linuxuid: "21004"
    password: ""
    passhash: ""
    publickey: ""

  - name: "Hiness"
    homeshare: iris-gaia-data-user-test-001
    usershare: iris-gaia-data-home-test-001

  - name: "Anskelisia"

EOF

    source /deployments/zeppelin/bin/create-user-tools.sh

    createyamlusers \
        /tmp/test-users.yml \
    | tee /tmp/test-users.json


    jq '
        .users[] | {
            username: .username,
            usershare: .usershare.name,
            homeshare: .homeshare.name
            }
        ' /tmp/test-users.json

--START--
--END--


    jq '
        .users[] | {
            username: .username,
            password: .shirouser.password,
            passhash: .shirouser.passhash
            }
        ' /tmp/test-users.json

--START--
--END--



# -----------------------------------------------------
# Convert the list into YAML format.
#[root@ansibler]

    source /deployments/zeppelin/bin/create-user-tools.sh

    json-yaml-users \
        /tmp/test-users.json \
        /tmp/test-users.yaml

--START--
--END--





#
# <meta:header>
#   <meta:licence>
#     Copyright (c) 2022, ROE (http://www.roe.ac.uk/)
#
#     This information is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This information is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
#   </meta:licence>
# </meta:header>
#
#zrq-notes-time
#zrq-notes-indent
#zrq-notes-crypto
#zrq-notes-ansible
#zrq-notes-osformat
#zrq-notes-zeppelin
#

    Target:

        Clean deploy on red to test everything.

    Result:

        Work in progress ...

# -----------------------------------------------------
# Create a container to work with.
#[user@desktop]

    source "${HOME:?}/aglais.env"

    podman run \
        --rm \
        --tty \
        --interactive \
        --name ansibler \
        --hostname ansibler \
        --publish 3000:3000 \
        --env "SSH_AUTH_SOCK=/mnt/ssh_auth_sock" \
        --volume "${SSH_AUTH_SOCK}:/mnt/ssh_auth_sock:rw,z" \
        --volume "${HOME:?}/clouds.yaml:/etc/openstack/clouds.yaml:ro,z" \
        --volume "${AGLAIS_CODE:?}/deployments:/deployments:ro,z" \
        ghcr.io/wfau/atolmis/ansible-client:2022.03.19 \
        bash


# -----------------------------------------------------
# Set the target configuration.
#[root@ansibler]

    cloudbase=arcus
    cloudname=iris-gaia-red
    configname=zeppelin-26.43-spark-3.26.43


# -----------------------------------------------------
# Deploy everything.
#[root@ansibler]

    time \
        source /deployments/hadoop-yarn/bin/deploy.sh

--START--
real	35m53.734s
user	13m51.862s
sys	2m43.375s
--END--


# -----------------------------------------------------
# Check our deployment config.
#[root@ansibler]

    cat /tmp/aglais-status.yml

--START--
aglais:
  status:
    deployment:
      type: hadoop-yarn
      conf: zeppelin-26.43-spark-3.26.43
      name: iris-gaia-red-20220721
      date: 20220721T031719
      hostname: zeppelin.gaia-dmp.uk
  spec:
    openstack:
      cloud:
        base: arcus
        name: iris-gaia-red
--END--

--START--
aglais:
  status:
    deployment:
      type: hadoop-yarn
      conf: zeppelin-26.43-spark-3.26.43
      name: iris-gaia-red-20220721
      date: 20220721T043453
      hostname: zeppelin.gaia-dmp.uk
  spec:
    openstack:
      cloud:
        base: arcus
        name: iris-gaia-red
--END--


# -----------------------------------------------------
# Create some test users with different combinations os password and passhash.
# Check that passhash overrides password.
#[root@ansibler]

    source /deployments/zeppelin/bin/create-user-tools.sh

    cat > /tmp/test-users-001.yml << EOF
users:
  - name: "Rhaelhall"
    type: "test"
    role: "user"
    linuxuid: "21000"
    password: "simple password"
    passhash: ""
    publickey: ""

  - name: "Fipa"
    type: "test"
    role: "user"
    linuxuid: "21001"
    password: ""
    passhash: ""
    publickey: ""

  - name: "Mythicson"
    type: "test"
    role: "user"
    linuxuid: "21002"
  # password: "spray goldsmith native heftiness"
    passhash: "$shiro1$SHA-256$500000$1ucx+RkCWIMVnJIJCFKL2A==$55SWIC7EJcV5VxcncvJZHBEdla2+3WT9YX45PLbwKFc="
    publickey: ""

  - name: "Balline"
    type: "test"
    role: "user"
    linuxuid: "21003"
    password: "spray goldsmith native heftiness"
  # passhash: "$shiro1$SHA-256$500000$1ucx+RkCWIMVnJIJCFKL2A==$55SWIC7EJcV5VxcncvJZHBEdla2+3WT9YX45PLbwKFc="
    publickey: ""

EOF

    createyamlusers \
        /tmp/test-users-001.yml \
    | tee /tmp/test-users-001.json

    jq '
        .users[] | {
            username: .username,
            password: .shirouser.password,
            passhash: .shirouser.passhash
            }
        ' /tmp/test-users-001.json

--START--
--END--


    json-yaml-users \
        /tmp/test-users-001.json \
        /tmp/test-users-001.yaml

--START--
--END--


# -----------------------------------------------------
# Create more than one user with the same name.
# Check we only get one of each.
#[root@ansibler]

    cat > /tmp/test-users-002.yml << EOF
users:
  - name: "Hiness"

  - name: "Anskelisia"
    password: "first clone's password"

  - name: "Anskelisia"
    password: "second clone's password"

  - name: "Hiness"
    password: "third clone's password"
EOF


    createyamlusers \
        /tmp/test-users-002.yml \
    | tee /tmp/test-users-002.json

    jq '
        .users[] | {
            username: .username,
            password: .shirouser.password,
            passhash: .shirouser.passhash
            }
        ' /tmp/test-users-002.json

--START--
....
....
--END--


    json-yaml-users \
        /tmp/test-users-002.json \
        /tmp/test-users-002.yaml

--START--
....
....
--END--


# -----------------------------------------------------
# Create users with existing shares for home and data.
# Check the shares are mounted correctly.
#[root@ansibler]

    cat > /tmp/test-users-003.yml << EOF
users:
  - name: "Iflee"
    homeshare:
      name:  ${cloudname}-home-test-001
      cloud: ${cloudname}
    usershare:
      name:  ${cloudname}-user-test-001
      cloud: ${cloudname}

  - name: "Mischiellis"
    homeshare:
      name:  iris-gaia-data-user-test-001
      cloud: iris-gaia-data
    usershare:
      name:  iris-gaia-data-home-test-001
      cloud: iris-gaia-data

  - name: "Kellaug"
    homeshare:
      name:  iris-gaia-data-user-test-002
      cloud: iris-gaia-data
    usershare:
      name:  iris-gaia-data-home-test-002
      cloud: iris-gaia-data

EOF

    createyamlusers \
        /tmp/test-users-003.yml \
    | tee /tmp/test-users-003.json

    jq '
        .users[] | {
            username: .username,
            usershare: {
                name:  .usershare.name,
                cloud: .usershare.cloud
                }
            homeshare: {
                name:  .homeshare.name
                cloud: .homeshare.cloud
                }
            }
        ' /tmp/test-users.json

--START--
--END--


    json-yaml-users \
        /tmp/test-users-003.json \
        /tmp/test-users-003.yaml

--START--
....
....
--END--


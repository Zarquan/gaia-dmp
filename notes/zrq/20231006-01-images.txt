#
# <meta:header>
#   <meta:licence>
#     Copyright (c) 2023, ROE (http://www.roe.ac.uk/)
#
#     This information is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This information is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
#   </meta:licence>
# </meta:header>
#
#zrq-notes-time
#zrq-notes-indent
#zrq-notes-crypto
#zrq-notes-ansible
#zrq-notes-osformat
#zrq-notes-zeppelin
#
# AIMetrics: []
#

    Target:

        Create kube images for K8s worker nodes.

        Quickstart
        https://image-builder.sigs.k8s.io/capi/quickstart.html

        Remote build on openstack.
        https://image-builder.sigs.k8s.io/capi/providers/openstack-remote
        https://github.com/kubernetes-sigs/image-builder/blob/main/docs/book/src/capi/providers/openstack-remote.md
        https://developer.hashicorp.com/packer/integrations/hashicorp/openstack/latest/components/builder/openstack

    Result:

        We have a new image.
        TODO now to test it works ..

# -----------------------------------------------------
# Run the container with clouds config and SSH socket.
#[user@desktop]

    source "${HOME:?}/aglais.env"

    podman run \
        --rm \
        --tty \
        --interactive \
        --user root \
        --entrypoint bash \
        --env "SSH_AUTH_SOCK=/mnt/ssh_auth_sock" \
        --volume "${SSH_AUTH_SOCK:?}:/mnt/ssh_auth_sock:rw,z" \
        --volume "${HOME:?}/clouds.yaml:/etc/openstack/clouds.yaml:ro,z" \
        --volume "${AGLAIS_CODE:?}/deployments:/deployments:ro,z" \
        gaia-dmp/image-builder:latest


    cloudname=iris-gaia-red

    openstack --version

    >   openstack 5.8.0


    openstack \
        --os-cloud "${cloudname:?}" \
        image list


    >   +--------------------------------------+------------------------------------------------+--------+
    >   | ID                                   | Name                                           | Status |
    >   +--------------------------------------+------------------------------------------------+--------+
    >   | ................                     | ........                                       | ...... |
    >   | ................                     | ........                                       | ...... |
    >   | 8b608db9-a74c-4de2-ac04-8eddb3041f39 | gaia-dmp-fedora-cloud-38-1.6                   | active |
    >   | 686c415b-c5a6-419e-8c46-4732498582e8 | gaia-dmp-ubuntu-2004-kube-v1.25.4              | active |
    >   | 306ca9c7-a274-4bd5-be62-430aed249cd0 | gaia-dmp-ubuntu-2204-cloudimg                  | active |
    >   | ................                     | ........                                       | ...... |
    >   | ................                     | ........                                       | ...... |
    >   +--------------------------------------+------------------------------------------------+--------+


    #
    # List the current resouces.

    /deployments/openstack/bin/list-all.sh \
        "${cloudname:?}"


    >   Nova servers
    >   +--------------------------------------+----------------------------------------------------------+--------+--------------------------------------------------------------------------+-----------------------------------+----------------------+
    >   | ID                                   | Name                                                     | Status | Networks                                                                 | Image                             | Flavor               |
    >   +--------------------------------------+----------------------------------------------------------+--------+--------------------------------------------------------------------------+-----------------------------------+----------------------+
    >   | 41a75505-7ebc-4855-bc9c-2f7145e3486d | iris-gaia-red-20230922-work-control-plane-13bf1d2f-62gnp | ACTIVE | k8s-clusterapi-cluster-default-iris-gaia-red-20230922-work=192.168.3.70  | gaia-dmp-ubuntu-2004-kube-v1.25.4 | gaia.vm.cclake.4vcpu |
    >   | 4cdb2d1f-4543-45d4-869e-f3f84393eaba | iris-gaia-red-20230922-work-control-plane-13bf1d2f-9p5c6 | ACTIVE | k8s-clusterapi-cluster-default-iris-gaia-red-20230922-work=192.168.3.112 | gaia-dmp-ubuntu-2004-kube-v1.25.4 | gaia.vm.cclake.4vcpu |
    >   | 85bf2ec3-cdb2-476f-8480-f52501694298 | iris-gaia-red-20230922-work-md-0-13bf1d2f-svhpk          | ACTIVE | k8s-clusterapi-cluster-default-iris-gaia-red-20230922-work=192.168.3.165 | gaia-dmp-ubuntu-2004-kube-v1.25.4 | gaia.vm.cclake.4vcpu |
    >   | 60db7791-3274-4648-a9cf-3ef0f5dd6d80 | iris-gaia-red-20230922-work-md-0-13bf1d2f-7lrbj          | ACTIVE | k8s-clusterapi-cluster-default-iris-gaia-red-20230922-work=192.168.3.245 | gaia-dmp-ubuntu-2004-kube-v1.25.4 | gaia.vm.cclake.4vcpu |
    >   | 3c8bcbf4-6713-4b04-98ed-ced6359f05e5 | iris-gaia-red-20230922-work-md-0-13bf1d2f-t6nzj          | ACTIVE | k8s-clusterapi-cluster-default-iris-gaia-red-20230922-work=192.168.3.69  | gaia-dmp-ubuntu-2004-kube-v1.25.4 | gaia.vm.cclake.4vcpu |
    >   | f5ff1624-0ade-4b8c-a5c4-ec6d5637c980 | iris-gaia-red-20230922-work-control-plane-13bf1d2f-xk29x | ACTIVE | k8s-clusterapi-cluster-default-iris-gaia-red-20230922-work=192.168.3.215 | gaia-dmp-ubuntu-2004-kube-v1.25.4 | gaia.vm.cclake.4vcpu |
    >   | 759d1f52-e95d-40da-80d9-2821bd80aa64 | iris-gaia-red-20230922-bootstrap-node                    | ACTIVE | iris-gaia-red-20230922-bootstrap-network=10.10.1.11, 128.232.226.9       | gaia-dmp-fedora-cloud-38-1.6      | gaia.vm.cclake.2vcpu |
    >   +--------------------------------------+----------------------------------------------------------+--------+--------------------------------------------------------------------------+-----------------------------------+----------------------+

    >   ....
    >   ....

    >   Networks
    >   +--------------------------------------+------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+
    >   | ID                                   | Name                                                       | Subnets                                                                                                                                                |
    >   +--------------------------------------+------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+
    >   | 410920fb-5714-4447-b26a-e7b06092fc62 | cephfs                                                     | 5699fb5d-8316-4b88-b889-b05c8a1ec975                                                                                                                   |
    >   | 57add367-d205-4030-a929-d75617a7c63e | CUDN-Internet                                              | 1847b14d-b974-4f78-959d-44d18d4485b8, 3fcaa5a5-ba8e-49a9-bf94-d87fbb0afc42, 5f1388b3-a0c7-463e-bb58-5532c38e4b40, a79eb610-eca3-4ee8-aaf1-88f4fef5a4e7 |
    >   | cb4dffb3-906b-4f43-b7ff-23c95ceb181c | k8s-clusterapi-cluster-default-iris-gaia-red-20230922-work | 3bce12be-d33b-4f01-aab8-c857d4575115                                                                                                                   |
    >   | e287ff50-0a07-4001-9a3d-55bd34397ef7 | iris-gaia-red-20230922-bootstrap-network                   | 99e2d1e3-0d4c-473b-aab5-705844960513                                                                                                                   |
    >   +--------------------------------------+------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+

    >   ....
    >   ....

    >   Floating addresses
    >   +--------------------------------------+---------------------+------------------+--------------------------------------+--------------------------------------+----------------------------------+
    >   | ID                                   | Floating IP Address | Fixed IP Address | Port                                 | Floating Network                     | Project                          |
    >   +--------------------------------------+---------------------+------------------+--------------------------------------+--------------------------------------+----------------------------------+
    >   | 340e3e8b-2866-4997-b9e8-8c651204a06f | 128.232.226.216     | 192.168.3.135    | c35b07c6-a007-4a6d-938a-2633f53a9b06 | 57add367-d205-4030-a929-d75617a7c63e | 0dd8cc5ee5a7455c8748cc06d04c93c3 |
    >   | bb4b2e2b-512c-43f7-b184-8d3cbcb64ac1 | 128.232.226.9       | 10.10.1.11       | 260b8fda-3f54-4b1f-beff-4174b58b23e2 | 57add367-d205-4030-a929-d75617a7c63e | 0dd8cc5ee5a7455c8748cc06d04c93c3 |
    >   +--------------------------------------+---------------------+------------------+--------------------------------------+--------------------------------------+----------------------------------+

    >   ....
    >   ....

    >   Security groups
    >   +--------------------------------------+-----------------------------------------------------------------------+---------------------------+----------------------------------+------+
    >   | ID                                   | Name                                                                  | Description               | Project                          | Tags |
    >   +--------------------------------------+-----------------------------------------------------------------------+---------------------------+----------------------------------+------+
    >   | 14078a21-baea-439f-ace1-9345363a9db6 | k8s-cluster-default-iris-gaia-red-20230922-work-secgroup-controlplane | Cluster API managed group | 0dd8cc5ee5a7455c8748cc06d04c93c3 | []   |
    >   | 470418c6-7fb6-420d-869d-f1063eccd6f8 | default                                                               | Default security group    | 0dd8cc5ee5a7455c8748cc06d04c93c3 | []   |
    >   | 4d2f8975-085d-4910-b850-e940b8ff2807 | iris-gaia-red-20230922-bootstrap-security                             |                           | 0dd8cc5ee5a7455c8748cc06d04c93c3 | []   |
    >   | 5e872b31-f5dc-4477-9a27-9027c5228d2f | k8s-cluster-default-iris-gaia-red-20230922-work-secgroup-worker       | Cluster API managed group | 0dd8cc5ee5a7455c8748cc06d04c93c3 | []   |
    >   +--------------------------------------+-----------------------------------------------------------------------+---------------------------+----------------------------------+------+

    >   ....
    >   ....

    >   SSH keys
    >   +----------------------------------+-------------------------------------------------+------+
    >   | Name                             | Fingerprint                                     | Type |
    >   +----------------------------------+-------------------------------------------------+------+
    >   | ........                         | ................                                | ...  |
    >   | iris-gaia-red-20230922-keypair   | 2e:84:98:98:df:70:06:0e:4c:ed:bd:d4:d6:6b:eb:16 | ssh  |
    >   +----------------------------------+-------------------------------------------------+------+


# -----------------------------------------------------
# Create a VM instance to test our image works.
#[root@ansibler]

    vmname=red-tiger
    vmimage=306ca9c7-a274-4bd5-be62-430aed249cd0
    vmflavor=6b56d6e9-5397-4543-87fb-e0c0b6d47961
    vmnetwork=e287ff50-0a07-4001-9a3d-55bd34397ef7
    vmsecurity=4d2f8975-085d-4910-b850-e940b8ff2807
    vmkey=iris-gaia-red-20230922-keypair

    openstack \
        --os-cloud "${cloudname:?}" \
        server create \
        --image "${vmimage}" \
        --flavor "${vmflavor}" \
        --nic "net-id=${vmnetwork}" \
        --security-group "${vmsecurity}" \
        --key-name "${vmkey}" \
        "${vmname}"

    >   +-----------------------------+----------------------------------------------------------------------+
    >   | Field                       | Value                                                                |
    >   +-----------------------------+----------------------------------------------------------------------+
    >   | OS-DCF:diskConfig           | MANUAL                                                               |
    >   | OS-EXT-AZ:availability_zone |                                                                      |
    >   | OS-EXT-STS:power_state      | NOSTATE                                                              |
    >   | OS-EXT-STS:task_state       | scheduling                                                           |
    >   | OS-EXT-STS:vm_state         | building                                                             |
    >   | OS-SRV-USG:launched_at      | None                                                                 |
    >   | OS-SRV-USG:terminated_at    | None                                                                 |
    >   | accessIPv4                  |                                                                      |
    >   | accessIPv6                  |                                                                      |
    >   | addresses                   |                                                                      |
    >   | adminPass                   | 3dGSrGPXV9cA                                                         |
    >   | config_drive                |                                                                      |
    >   | created                     | 2023-10-06T13:03:35Z                                                 |
    >   | flavor                      | vm.v1.small (6b56d6e9-5397-4543-87fb-e0c0b6d47961)                   |
    >   | hostId                      |                                                                      |
    >   | id                          | 623f21e6-a933-426c-8286-0702e62b3fe2                                 |
    >   | image                       | gaia-dmp-ubuntu-2204-cloudimg (306ca9c7-a274-4bd5-be62-430aed249cd0) |
    >   | key_name                    | iris-gaia-red-20230922-keypair                                       |
    >   | name                        | red-tiger                                                            |
    >   | progress                    | 0                                                                    |
    >   | project_id                  | 0dd8cc5ee5a7455c8748cc06d04c93c3                                     |
    >   | properties                  |                                                                      |
    >   | security_groups             | name='4d2f8975-085d-4910-b850-e940b8ff2807'                          |
    >   | status                      | BUILD                                                                |
    >   | updated                     | 2023-10-06T13:03:35Z                                                 |
    >   | user_id                     | 5fa0c97a6dd14e01a3c7d91dad5c6b17                                     |
    >   | volumes_attached            |                                                                      |
    >   +-----------------------------+----------------------------------------------------------------------+

    openstack \
        --os-cloud "${cloudname:?}" \
        server show \
            '623f21e6-a933-426c-8286-0702e62b3fe2'

    >   +-----------------------------+----------------------------------------------------------------------+
    >   | Field                       | Value                                                                |
    >   +-----------------------------+----------------------------------------------------------------------+
    >   | OS-DCF:diskConfig           | MANUAL                                                               |
    >   | OS-EXT-AZ:availability_zone | nova                                                                 |
    >   | OS-EXT-STS:power_state      | Running                                                              |
    >   | OS-EXT-STS:task_state       | None                                                                 |
    >   | OS-EXT-STS:vm_state         | active                                                               |
    >   | OS-SRV-USG:launched_at      | 2023-10-06T13:03:57.000000                                           |
    >   | OS-SRV-USG:terminated_at    | None                                                                 |
    >   | accessIPv4                  |                                                                      |
    >   | accessIPv6                  |                                                                      |
    >   | addresses                   | iris-gaia-red-20230922-bootstrap-network=10.10.0.50                  |
    >   | config_drive                |                                                                      |
    >   | created                     | 2023-10-06T13:03:35Z                                                 |
    >   | flavor                      | vm.v1.small (6b56d6e9-5397-4543-87fb-e0c0b6d47961)                   |
    >   | hostId                      | 88c0c194bcf16a94f41e529bc8beb0a1afdc92eb430f62bac3d97279             |
    >   | id                          | 623f21e6-a933-426c-8286-0702e62b3fe2                                 |
    >   | image                       | gaia-dmp-ubuntu-2204-cloudimg (306ca9c7-a274-4bd5-be62-430aed249cd0) |
    >   | key_name                    | iris-gaia-red-20230922-keypair                                       |
    >   | name                        | red-tiger                                                            |
    >   | progress                    | 0                                                                    |
    >   | project_id                  | 0dd8cc5ee5a7455c8748cc06d04c93c3                                     |
    >   | properties                  |                                                                      |
    >   | security_groups             | name='iris-gaia-red-20230922-bootstrap-security'                     |
    >   | status                      | ACTIVE                                                               |
    >   | updated                     | 2023-10-06T13:03:57Z                                                 |
    >   | user_id                     | 5fa0c97a6dd14e01a3c7d91dad5c6b17                                     |
    >   | volumes_attached            |                                                                      |
    >   +-----------------------------+----------------------------------------------------------------------+


# -----------------------------------------------------
# Try login to our new VM.
#[root@ansibler]

    # Login to our bootstrap node.
    ssh -A root@128.232.226.9

        # Login to our new VM.
        ssh -A root@10.10.0.50

            lsb_release -a

    >   No LSB modules are available.
    >   Distributor ID:	Ubuntu
    >   Description:	Ubuntu 22.04.3 LTS
    >   Release:	22.04
    >   Codename:	jammy

            docker --version

    >   Command 'docker' not found, but can be installed with:
    >   sudo snap install docker         # version 20.10.24, or
    >   sudo snap install docker         # version 20.10.24
    >   sudo apt  install podman-docker  # version 3.4.4+ds1-1ubuntu1.22.04.2
    >   sudo apt  install docker.io      # version 24.0.5-0ubuntu1~22.04.1
    >   See 'snap info <snapname>' for additional versions.


# -----------------------------------------------------
# Try to build a kube image using this as the base.
#[root@ansibler]

    https://image-builder.sigs.k8s.io/capi/providers/openstack-remote
    https://developer.hashicorp.com/packer/integrations/hashicorp/openstack/latest/components/builder/openstack

        make deps

    >   hack/ensure-python.sh
    >   Checking if python is available
    >   Python 3.10.12
    >   hack/ensure-ansible.sh
    >   Traceback (most recent call last):
    >     File "/home/imagebuilder/.local/bin/ansible-galaxy", line 5, in <module>
    >       from ansible.cli.galaxy import main
    >   ModuleNotFoundError: No module named 'ansible'
    >   make: *** [Makefile:60: deps-common] Error 1


        ansible
    >   Traceback (most recent call last):
    >     File "/home/imagebuilder/.local/bin/ansible", line 5, in <module>
    >       from ansible.cli.adhoc import main
    >   ModuleNotFoundError: No module named 'ansible'


    which ansible

    >   /home/imagebuilder/.local/bin/ansible

    less $(which ansible)

    >   #!/usr/bin/python3
    >   # -*- coding: utf-8 -*-
    >   import re
    >   import sys
    >   from ansible.cli.adhoc import main
    >   if __name__ == '__main__':
    >       sys.argv[0] = re.sub(r'(-script\.pyw|\.exe)?$', '', sys.argv[0])
    >       sys.exit(main())


    pip list

    >   Package                Version
    >   ---------------------- ---------
    >   appdirs                1.4.4
    >   attrs                  21.2.0
    >   autopage               0.4.0
    >   Babel                  2.8.0
    >   beautifulsoup4         4.10.0
    >   blinker                1.4
    >   ....
    >   ....

    #
    # I think this is because I'm logged in as 'root' rather than 'imagebuilder'.
    #

# -----------------------------------------------------
# Try again using 'su imagebuilder'.
#[user@desktop]

    source "${HOME:?}/aglais.env"

    podman run \
        --rm \
        --tty \
        --interactive \
        --user root \
        --entrypoint bash \
        --env "SSH_AUTH_SOCK=/mnt/ssh_auth_sock" \
        --volume "${SSH_AUTH_SOCK:?}:/mnt/ssh_auth_sock:rw,z" \
        --volume "${HOME:?}/clouds.yaml:/etc/openstack/clouds.yaml:ro,z" \
        --volume "${AGLAIS_CODE:?}/deployments:/deployments:ro,z" \
        gaia-dmp/image-builder:latest

    su imagebuilder

    make deps

    >   hack/ensure-python.sh
    >   Checking if python is available
    >   Python 3.10.12
    >   hack/ensure-ansible.sh
    >   Starting galaxy collection install process
    >   Nothing to do. All requested collections are already installed. If you want to reinstall them, consider using `--force`.
    >   ....
    >   ....
    >   Right version of binary present
    >   /home/imagebuilder/.local/bin/packer init packer/config.pkr.hcl
    >   /home/imagebuilder/.local/bin/packer init packer/hcloud/config.pkr.hcl


# -----------------------------------------------------
# Try again, default user 'imagebuilder'.
#[user@desktop]

    source "${HOME:?}/aglais.env"

    podman run \
        --rm \
        --tty \
        --interactive \
        --entrypoint bash \
        --env "SSH_AUTH_SOCK=/mnt/ssh_auth_sock" \
        --volume "${SSH_AUTH_SOCK:?}:/mnt/ssh_auth_sock:rw,z" \
        --volume "${HOME:?}/clouds.yaml:/etc/openstack/clouds.yaml:ro,z" \
        --volume "${AGLAIS_CODE:?}/deployments:/deployments:ro,z" \
        gaia-dmp/image-builder:latest

    make deps

    >   hack/ensure-python.sh
    >   Checking if python is available
    >   Python 3.10.12
    >   hack/ensure-ansible.sh
    >   Starting galaxy collection install process
    >   Nothing to do. All requested collections are already installed. If you want to reinstall them, consider using `--force`.
    >   ....
    >   ....
    >   Right version of binary present
    >   /home/imagebuilder/.local/bin/packer init packer/config.pkr.hcl
    >   /home/imagebuilder/.local/bin/packer init packer/hcloud/config.pkr.hcl

    #
    # That works OK, but do we have access to our SSH keys ?
    #

    # Login to our bootstrap node.
    ssh -A -v root@128.232.226.9

    >   ....
    >   debug1: get_agent_identities: ssh_get_authentication_socket: Permission denied
    >   ....
    >   root@128.232.226.9: Permission denied (publickey,gssapi-with-mic).

    #
    # So our agent socket is blocked.
    # Don't know if this will be a problem yet.
    #


# -----------------------------------------------------
# ....
#[user@builder]

    make deps

    >   ....
    >   ....
    >   /home/imagebuilder/.local/bin/packer init packer/config.pkr.hcl
    >   /home/imagebuilder/.local/bin/packer init packer/hcloud/config.pkr.hcl


    make deps-openstack

    >   ....
    >   ....
    >   /home/imagebuilder/.local/bin/packer init packer/config.pkr.hcl
    >   /home/imagebuilder/.local/bin/packer init packer/openstack/config.pkr.hcl


# -----------------------------------------------------
# ....
#[user@builder]

    cloudname=iris-gaia-red

    openstack \
        --os-cloud "${cloudname:?}" \
        image list

+--------------------------------------+------------------------------------------------+--------+
| ID                                   | Name                                           | Status |
+--------------------------------------+------------------------------------------------+--------+
| ................                     | ........                                       | ...... |
| 8b608db9-a74c-4de2-ac04-8eddb3041f39 | gaia-dmp-fedora-cloud-38-1.6                   | active |
| 686c415b-c5a6-419e-8c46-4732498582e8 | gaia-dmp-ubuntu-2004-kube-v1.25.4              | active |
| 306ca9c7-a274-4bd5-be62-430aed249cd0 | gaia-dmp-ubuntu-2204-cloudimg                  | active |
| ................                     | ........                                       | ...... |
+--------------------------------------+------------------------------------------------+--------+


    openstack \
        --os-cloud "${cloudname:?}" \
        flavor list

    >   +--------------------------------------+-----------------------------+--------+------+-----------+-------+-----------+
    >   | ID                                   | Name                        |    RAM | Disk | Ephemeral | VCPUs | Is Public |
    >   +--------------------------------------+-----------------------------+--------+------+-----------+-------+-----------+
    >   | ................                     | ........                    |   .... |  ... |       ... |   ... | ....      |
    >   | 166497c3-a0bb-4276-bee3-e56932e6f3e4 | gaia.vm.cclake.1vcpu        |   1024 |    8 |         0 |     1 | False     |
    >   | df5133ea-1bfb-45fd-ba39-71fc820abcb1 | gaia.vm.cclake.2vcpu        |   3072 |   14 |         0 |     2 | False     |
    >   | 80e0721d-db0f-407f-a2bf-fe6641312204 | gaia.vm.cclake.4vcpu        |   6144 |   22 |         0 |     4 | False     |
    >   | a1b2789c-761a-4843-8ea8-603a9209dec8 | gaia.vm.cclake.6vcpu        |   9216 |   20 |        24 |     6 | False     |
    >   | ................                     | ........                    |   .... |  ... |       ... |   ... | ....      |
    >   +--------------------------------------+-----------------------------+--------+------+-----------+-------+-----------+


    openstack \
        --os-cloud "${cloudname:?}" \
        network list

    >   +--------------------------------------+------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+
    >   | ID                                   | Name                                                       | Subnets                                                                                                                                                |
    >   +--------------------------------------+------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+
    >   | 410920fb-5714-4447-b26a-e7b06092fc62 | cephfs                                                     | 5699fb5d-8316-4b88-b889-b05c8a1ec975                                                                                                                   |
    >   | 57add367-d205-4030-a929-d75617a7c63e | CUDN-Internet                                              | 1847b14d-b974-4f78-959d-44d18d4485b8, 3fcaa5a5-ba8e-49a9-bf94-d87fbb0afc42, 5f1388b3-a0c7-463e-bb58-5532c38e4b40, a79eb610-eca3-4ee8-aaf1-88f4fef5a4e7 |
    >   | e287ff50-0a07-4001-9a3d-55bd34397ef7 | iris-gaia-red-20230922-bootstrap-network                   | 99e2d1e3-0d4c-473b-aab5-705844960513                                                                                                                   |
    >   +--------------------------------------+------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+


    openstack \
        --os-cloud "${cloudname:?}" \
        security group list

    >   +--------------------------------------+-----------------------------------------------------------------------+---------------------------+----------------------------------+------+
    >   | ID                                   | Name                                                                  | Description               | Project                          | Tags |
    >   +--------------------------------------+-----------------------------------------------------------------------+---------------------------+----------------------------------+------+
    >   | 470418c6-7fb6-420d-869d-f1063eccd6f8 | default                                                               | Default security group    | 0dd8cc5ee5a7455c8748cc06d04c93c3 | []   |
    >   | 4d2f8975-085d-4910-b850-e940b8ff2807 | iris-gaia-red-20230922-bootstrap-security                             |                           | 0dd8cc5ee5a7455c8748cc06d04c93c3 | []   |
    >   +--------------------------------------+-----------------------------------------------------------------------+---------------------------+----------------------------------+------+


    # cloud (string) - An entry in a clouds.yaml file. See the OpenStack os-client-config documentation for more information about clouds.yaml files. If omitted, the OS_CLOUD environment variable is used.
    # floating_ip_network (string) - The ID or name of an external network that can be used for creation of a new floating IP.
    # networks ([]string) - A list of networks by UUID to attach to this instance.

    cat > /tmp/image-builder.json << 'EOF'
{
  "cloud": "iris-gaia-red",
  "source_image": "306ca9c7-a274-4bd5-be62-430aed249cd0",
  "networks": "e287ff50-0a07-4001-9a3d-55bd34397ef7",
  "flavor": "df5133ea-1bfb-45fd-ba39-71fc820abcb1",
  "image_name": "KUBE-UBUNTU",
  "image_visibility": "public",
  "image_disk_format": "raw",
  "volume_type": "",
  "ssh_username": "ubuntu"
}
EOF

    PACKER_VAR_FILES=/tmp/image-builder.json

    make build-openstack-ubuntu-2204

    >   ....
    >   ....
    >   /home/imagebuilder/.local/bin/packer init packer/config.pkr.hcl
    >   /home/imagebuilder/.local/bin/packer init packer/openstack/config.pkr.hcl
    >   packer build -var-file="/home/imagebuilder/packer/config/kubernetes.json"  -var-file="/home/imagebuilder/packer/config/cni.json"  -var-file="/home/imagebuilder/packer/config/containerd.json"  -var-file="/home/imagebuilder/packer/config/wasm-shims.json"  -var-file="/home/imagebuilder/packer/config/ansible-args.json"  -var-file="/home/imagebuilder/packer/config/goss-args.json"  -var-file="/home/imagebuilder/packer/config/common.json"  -var-file="/home/imagebuilder/packer/config/additional_components.json"  -color=true -var-file="/home/imagebuilder/packer/openstack/ubuntu-2204.json" -var-file="/tmp/image-builder.json"  packer/openstack/packer.json
    >   Error: Failed to prepare build: "openstack"
    >   
    >   1 error(s) occurred:
    >   
    >   * Missing input for argument [auth_url]


    # identity_endpoint (string) - The URL to the OpenStack Identity service. If not specified, Packer will use the environment variables OS_AUTH_URL, if set. This is not required if using cloud.yaml.

    #
    # Looks like packer isn't using our clouds.yaml file.
    #
    # https://developer.hashicorp.com/packer/integrations/hashicorp/openstack/latest/components/builder/openstack#authorize-using-application-credential
    # To authorize with an application credential, only identity_endpoint, application_credential_id, and application_credential_secret are needed.
    #

    cat /etc/openstack/clouds.yaml

    >   clouds:
    >   
    >     iris-gaia-red:
    >       auth:
    >         auth_url: https://arcus.openstack.hpc.cam.ac.uk:5000
    >         application_credential_id: "........"
    >         application_credential_secret: "........"
    >       region_name: "RegionOne"
    >       interface: "public"
    >       identity_api_version: 3
    >       auth_type: "v3applicationcredential"
    >   ....
    >   ....


    cat > /tmp/image-builder.json << 'EOF'
{
  "cloud": "iris-gaia-red",
  "identity_endpoint": "https://arcus.openstack.hpc.cam.ac.uk:5000",
  "application_credential_id": "a23204cc16744f2da336afb8d745d1f2",
  "application_credential_secret": "ahjooB0L lejueHa9 oo1iWo3g EiCie0ew",
  "source_image": "306ca9c7-a274-4bd5-be62-430aed249cd0",
  "networks": "e287ff50-0a07-4001-9a3d-55bd34397ef7",
  "flavor": "df5133ea-1bfb-45fd-ba39-71fc820abcb1",
  "image_name": "KUBE-UBUNTU",
  "image_visibility": "public",
  "image_disk_format": "raw",
  "volume_type": "",
  "ssh_username": "ubuntu"
}
EOF

    make build-openstack-ubuntu-2204

    >   ....
    >   ....
    >   Error: Failed to prepare build: "openstack"
    >   
    >   1 error(s) occurred:
    >   
    >   * Missing input for argument [auth_url]

    #
    # OK, let's explicitly set 'auth_url'.

    cat > /tmp/image-builder.json << 'EOF'
{
  "cloud": "iris-gaia-red",
  "auth_url": "https://arcus.openstack.hpc.cam.ac.uk:5000",
  "identity_endpoint": "https://arcus.openstack.hpc.cam.ac.uk:5000",
  "application_credential_id": "a23204cc16744f2da336afb8d745d1f2",
  "application_credential_secret": "ahjooB0L lejueHa9 oo1iWo3g EiCie0ew",
  "source_image": "306ca9c7-a274-4bd5-be62-430aed249cd0",
  "networks": "e287ff50-0a07-4001-9a3d-55bd34397ef7",
  "flavor": "df5133ea-1bfb-45fd-ba39-71fc820abcb1",
  "image_name": "KUBE-UBUNTU",
  "image_visibility": "public",
  "image_disk_format": "raw",
  "volume_type": "",
  "ssh_username": "ubuntu"
}
EOF

    make build-openstack-ubuntu-2204

    >   ....
    >   ....
    >   Error: Failed to prepare build: "openstack"
    >   
    >   1 error(s) occurred:
    >   
    >   * Missing input for argument [auth_url]


    #
    # Is it actually reading our config file ?
    #

    cat > /tmp/image-builder.json << 'EOF'
{
  FROG
}
EOF

    make build-openstack-ubuntu-2204

    >   ....
    >   ....
    >   Error reading variables in '/tmp/image-builder.json': invalid character 'F' looking for beginning of object key string


    cat > /tmp/image-builder.json << 'EOF'
{
  "auth_url": "https://arcus.openstack.hpc.cam.ac.uk:5000",
  "identity_endpoint": "https://arcus.openstack.hpc.cam.ac.uk:5000",
  "application_credential_id": "a23204cc16744f2da336afb8d745d1f2",
  "application_credential_secret": "ahjooB0L lejueHa9 oo1iWo3g EiCie0ew",
  "source_image": "306ca9c7-a274-4bd5-be62-430aed249cd0",
  "networks": "e287ff50-0a07-4001-9a3d-55bd34397ef7",
  "flavor": "df5133ea-1bfb-45fd-ba39-71fc820abcb1",
  "image_name": "KUBE-UBUNTU",
  "image_visibility": "public",
  "image_disk_format": "raw",
  "volume_type": "",
  "ssh_username": "ubuntu"
}
EOF


    #
    # Try run the command outside make.

    packer build \
        -var-file="/home/imagebuilder/packer/config/kubernetes.json"  \
        -var-file="/home/imagebuilder/packer/config/cni.json" \
        -var-file="/home/imagebuilder/packer/config/containerd.json" \
        -var-file="/home/imagebuilder/packer/config/wasm-shims.json" \
        -var-file="/home/imagebuilder/packer/config/ansible-args.json" \
        -var-file="/home/imagebuilder/packer/config/goss-args.json" \
        -var-file="/home/imagebuilder/packer/config/common.json" \
        -var-file="/home/imagebuilder/packer/config/additional_components.json" \
        -color=true \
        -var-file="/home/imagebuilder/packer/openstack/ubuntu-2204.json" \
        -var-file="/tmp/image-builder.json" \
        packer/openstack/packer.json

    >   Error: Failed to prepare build: "openstack"
    >   
    >   1 error(s) occurred:
    >   
    >   * Missing input for argument [auth_url]

    #
    # Explicitly set the cloud name using OS_CLOUD.
    # https://lists.aswf.io/g/tac/message/163

    export OS_CLOUD=iris-gaia-red

    packer build \
        -var-file="/home/imagebuilder/packer/config/kubernetes.json"  \
        -var-file="/home/imagebuilder/packer/config/cni.json" \
        -var-file="/home/imagebuilder/packer/config/containerd.json" \
        -var-file="/home/imagebuilder/packer/config/wasm-shims.json" \
        -var-file="/home/imagebuilder/packer/config/ansible-args.json" \
        -var-file="/home/imagebuilder/packer/config/goss-args.json" \
        -var-file="/home/imagebuilder/packer/config/common.json" \
        -var-file="/home/imagebuilder/packer/config/additional_components.json" \
        -color=true \
        -var-file="/home/imagebuilder/packer/openstack/ubuntu-2204.json" \
        -var-file="/tmp/image-builder.json" \
        packer/openstack/packer.json

    >   openstack: output will be in this color.
    >   
    >   ==> openstack: Loading flavor: df5133ea-1bfb-45fd-ba39-71fc820abcb1
    >       openstack: Verified flavor. ID: df5133ea-1bfb-45fd-ba39-71fc820abcb1
    >   ==> openstack: Creating temporary RSA SSH key for instance...
    >   ==> openstack: Creating temporary keypair: packer_6520e4ce-1fc0-90b0-ae45-dcdc19cf288d ...
    >   ==> openstack: Created temporary keypair: packer_6520e4ce-1fc0-90b0-ae45-dcdc19cf288d
    >   ==> openstack: Creating volume...
    >   ==> openstack: Waiting for volume packer_6520e4ce-5e48-db3d-1946-acf57a876159 (volume id: 95bd4e3c-90c2-4d9d-85fb-f727b7f6fdc4) to become available...
    >   ....
    >   ....
    >       openstack: Volume ID: 95bd4e3c-90c2-4d9d-85fb-f727b7f6fdc4
    >   ==> openstack: Launching server...
    >   ==> openstack: Launching server...
    >       openstack: Server ID: 21bb409b-41a8-4349-98c1-211632be0930
    >   ==> openstack: Waiting for server to become ready...
    >   ==> openstack: Error using the provided floating_ip_network: can't find external network public
    >   ==> openstack: Terminating the source server: 21bb409b-41a8-4349-98c1-211632be0930 ...
    >   ==> openstack: Deleting volume: 95bd4e3c-90c2-4d9d-85fb-f727b7f6fdc4 ...
    >   ==> openstack: Deleting temporary keypair: packer_6520e4ce-1fc0-90b0-ae45-dcdc19cf288d ...
    >   Build 'openstack' errored after 48 seconds 928 milliseconds: Error using the provided floating_ip_network: can't find external network public
    >   
    >   ==> Wait completed after 48 seconds 928 milliseconds
    >   
    >   ==> Some builds didn't complete successfully and had errors:
    >   --> openstack: Error using the provided floating_ip_network: can't find external network public
    >   
    >   ==> Builds finished but no artifacts were created.

    #
    # Yay - major progress.
    #

    >   ....
    >   ==> openstack: Error using the provided floating_ip_network: can't find external network public
    >   ....

    #
    # Add "cloud"
    # Add "floating_ip_network"

    cat > /tmp/image-builder.json << 'EOF'
{
  "cloud": "iris-gaia-red",
  "auth_url": "https://arcus.openstack.hpc.cam.ac.uk:5000",
  "identity_endpoint": "https://arcus.openstack.hpc.cam.ac.uk:5000",
  "application_credential_id": "a23204cc16744f2da336afb8d745d1f2",
  "application_credential_secret": "ahjooB0L lejueHa9 oo1iWo3g EiCie0ew",
  "source_image": "306ca9c7-a274-4bd5-be62-430aed249cd0",
  "networks": "e287ff50-0a07-4001-9a3d-55bd34397ef7",
  "floating_ip_network": "57add367-d205-4030-a929-d75617a7c63e",
  "flavor": "df5133ea-1bfb-45fd-ba39-71fc820abcb1",
  "image_name": "KUBE-UBUNTU",
  "image_visibility": "public",
  "image_disk_format": "raw",
  "volume_type": "",
  "ssh_username": "ubuntu"
}
EOF

    packer build \
        -color=true \
        -var-file="/home/imagebuilder/packer/config/kubernetes.json"  \
        -var-file="/home/imagebuilder/packer/config/cni.json" \
        -var-file="/home/imagebuilder/packer/config/containerd.json" \
        -var-file="/home/imagebuilder/packer/config/wasm-shims.json" \
        -var-file="/home/imagebuilder/packer/config/ansible-args.json" \
        -var-file="/home/imagebuilder/packer/config/goss-args.json" \
        -var-file="/home/imagebuilder/packer/config/common.json" \
        -var-file="/home/imagebuilder/packer/config/additional_components.json" \
        -var-file="/home/imagebuilder/packer/openstack/ubuntu-2204.json" \
        -var-file="/tmp/image-builder.json" \
        packer/openstack/packer.json

    >   ....
    >   ....
    >   ==> openstack: Creating floating IP using network 57add367-d205-4030-a929-d75617a7c63e ...
    >       openstack: Created floating IP: 'a4f667d7-6c1a-4f5b-8933-fa8d313db442' (128.232.227.94)
    >   ==> openstack: Associating floating IP 'a4f667d7-6c1a-4f5b-8933-fa8d313db442' (128.232.227.94) with instance port...
    >       openstack: Added floating IP 'a4f667d7-6c1a-4f5b-8933-fa8d313db442' (128.232.227.94) to instance!
    >   ==> openstack: Using SSH communicator to connect: 128.232.227.94
    >   ==> openstack: Waiting for SSH to become available...
    >   ....
    >   ....

    #
    # SSH won't become available because the default security group on Arcus doesn't allow port 22.
    #

    >   ....
    >   ....
    >   ==> openstack: Timeout waiting for SSH.
    >   ==> openstack: Deleted temporary floating IP 'a4f667d7-6c1a-4f5b-8933-fa8d313db442' (128.232.227.94)
    >   ==> openstack: Terminating the source server: 4ec0fcf4-623b-49db-a32d-f4e7ce62be14 ...
    >   ==> openstack: Deleting volume: 299841a6-c573-4830-a7bd-eda29148ae3b ...
    >   ==> openstack: Deleting temporary keypair: packer_6520e5f2-0eed-907a-c9cb-95e5acc7097f ...
    >   Build 'openstack' errored after 2 hours 59 seconds: Timeout waiting for SSH.



    #
    # Add
    # security_groups ([]string) - A list of security groups by name to add to this instance.

    cat > /tmp/image-builder.json << 'EOF'
{
  "cloud": "iris-gaia-red",
  "auth_url": "https://arcus.openstack.hpc.cam.ac.uk:5000",
  "identity_endpoint": "https://arcus.openstack.hpc.cam.ac.uk:5000",
  "application_credential_id": "a23204cc16744f2da336afb8d745d1f2",
  "application_credential_secret": "ahjooB0L lejueHa9 oo1iWo3g EiCie0ew",
  "source_image": "306ca9c7-a274-4bd5-be62-430aed249cd0",
  "networks": "e287ff50-0a07-4001-9a3d-55bd34397ef7",
  "floating_ip_network": "57add367-d205-4030-a929-d75617a7c63e",
  "flavor": "df5133ea-1bfb-45fd-ba39-71fc820abcb1",
  "image_name": "KUBE-UBUNTU",
  "image_visibility": "public",
  "image_disk_format": "raw",
  "volume_type": "",
  "ssh_username": "ubuntu",
  "security_groups": "4d2f8975-085d-4910-b850-e940b8ff2807"
}
EOF

    packer build \
        -color=true \
        -var-file="/home/imagebuilder/packer/config/kubernetes.json"  \
        -var-file="/home/imagebuilder/packer/config/cni.json" \
        -var-file="/home/imagebuilder/packer/config/containerd.json" \
        -var-file="/home/imagebuilder/packer/config/wasm-shims.json" \
        -var-file="/home/imagebuilder/packer/config/ansible-args.json" \
        -var-file="/home/imagebuilder/packer/config/goss-args.json" \
        -var-file="/home/imagebuilder/packer/config/common.json" \
        -var-file="/home/imagebuilder/packer/config/additional_components.json" \
        -var-file="/home/imagebuilder/packer/openstack/ubuntu-2204.json" \
        -var-file="/tmp/image-builder.json" \
        packer/openstack/packer.json

    >   ....
    >   ....
    >   ==> openstack: Terminating the source server: 9209ccab-cfce-43b5-862d-457041da1b59 ...
    >   ==> openstack: Error terminating server, may still be around: Resource not found
    >   ==> openstack: Deleting volume: 5c9874b9-d23c-4b43-a517-2c078afd850d ...
    >   ==> openstack: Deleting temporary keypair: packer_65210824-eba0-a9d5-8f7e-4428f1c52cda ...
    >   Build 'openstack' errored after 12 minutes 59 seconds: Error updating image visibility: Request forbidden: [PATCH https://arcus.openstack.hpc.cam.ac.uk:9292/v2/images/03873543-0227-4248-a4f0-3660502a2298], error message: {"message": "You are not authorized to complete publicize_image action.<br /><br />\n\n\n", "code": "403 Forbidden", "title": "Forbidden"}
    >   
    >   ==> Wait completed after 12 minutes 59 seconds
    >   
    >   ==> Some builds didn't complete successfully and had errors:
    >   --> openstack: Error updating image visibility: Request forbidden: [PATCH https://arcus.openstack.hpc.cam.ac.uk:9292/v2/images/03873543-0227-4248-a4f0-3660502a2298], error message: {"message": "You are not authorized to complete publicize_image action.<br /><br />\n\n\n", "code": "403 Forbidden", "title": "Forbidden"}
    >   
    >   ==> Builds finished but no artifacts were created.




    #
    # Add
    # image_visibility (imageservice.ImageVisibility) - One of "public", "private", "shared", or "community".

    cat > /tmp/image-builder.json << 'EOF'
{
  "cloud": "iris-gaia-red",
  "auth_url": "https://arcus.openstack.hpc.cam.ac.uk:5000",
  "identity_endpoint": "https://arcus.openstack.hpc.cam.ac.uk:5000",
  "application_credential_id": "a23204cc16744f2da336afb8d745d1f2",
  "application_credential_secret": "ahjooB0L lejueHa9 oo1iWo3g EiCie0ew",
  "source_image": "306ca9c7-a274-4bd5-be62-430aed249cd0",
  "networks": "e287ff50-0a07-4001-9a3d-55bd34397ef7",
  "floating_ip_network": "57add367-d205-4030-a929-d75617a7c63e",
  "flavor": "df5133ea-1bfb-45fd-ba39-71fc820abcb1",
  "image_name": "KUBE-UBUNTU",
  "image_visibility": "public",
  "image_disk_format": "raw",
  "volume_type": "",
  "ssh_username": "ubuntu",
  "security_groups": "4d2f8975-085d-4910-b850-e940b8ff2807",
  "image_visibility": "private"
}
EOF

    packer build \
        -color=true \
        -var-file="/home/imagebuilder/packer/config/kubernetes.json"  \
        -var-file="/home/imagebuilder/packer/config/cni.json" \
        -var-file="/home/imagebuilder/packer/config/containerd.json" \
        -var-file="/home/imagebuilder/packer/config/wasm-shims.json" \
        -var-file="/home/imagebuilder/packer/config/ansible-args.json" \
        -var-file="/home/imagebuilder/packer/config/goss-args.json" \
        -var-file="/home/imagebuilder/packer/config/common.json" \
        -var-file="/home/imagebuilder/packer/config/additional_components.json" \
        -var-file="/home/imagebuilder/packer/openstack/ubuntu-2204.json" \
        -var-file="/tmp/image-builder.json" \
        packer/openstack/packer.json


    >   ....
    >   ....
    >   ==> openstack: Goss validate ran successfully
    >   ==> openstack: Running GOSS render command: cd /tmp/goss &&  /tmp/goss-0.3.16-linux-amd64 --gossfile goss/goss.yaml --vars /tmp/goss/goss-vars.yaml --vars-inline '{"ARCH":"amd64","OS":"ubuntu","OS_VERSION":"","PROVIDER":"qemu","containerd_version":"1.6.23","kubernetes_cni_deb_version":"1.2.0-2.1","kubernetes_cni_rpm_version":"1.2.0","kubernetes_cni_source_type":"pkg","kubernetes_cni_version":"1.2.0","kubernetes_deb_version":"1.26.7-1.1","kubernetes_rpm_version":"1.26.7","kubernetes_source_type":"pkg","kubernetes_version":"1.26.7"}' render > /tmp/goss-spec.yaml
    >   ==> openstack: Goss render ran successfully
    >   ==> openstack: Running GOSS render debug command: cd /tmp/goss &&  /tmp/goss-0.3.16-linux-amd64 --gossfile goss/goss.yaml --vars /tmp/goss/goss-vars.yaml --vars-inline '{"ARCH":"amd64","OS":"ubuntu","OS_VERSION":"","PROVIDER":"qemu","containerd_version":"1.6.23","kubernetes_cni_deb_version":"1.2.0-2.1","kubernetes_cni_rpm_version":"1.2.0","kubernetes_cni_source_type":"pkg","kubernetes_cni_version":"1.2.0","kubernetes_deb_version":"1.26.7-1.1","kubernetes_rpm_version":"1.26.7","kubernetes_source_type":"pkg","kubernetes_version":"1.26.7"}' render -d > /tmp/debug-goss-spec.yaml
    >   ==> openstack: Goss render debug ran successfully
    >   ==> openstack:
    >   ==> openstack:
    >   ==> openstack:
    >   ==> openstack: Downloading spec file and debug info
    >       openstack: Downloading Goss specs from, /tmp/goss-spec.yaml and /tmp/debug-goss-spec.yaml to current dir
    >   ==> openstack: Stopping server: 9340cb02-cd1f-4a75-8303-0165ab14e102 ...
    >       openstack: Waiting for server to stop: 9340cb02-cd1f-4a75-8303-0165ab14e102 ...
    >   ==> openstack: Terminating the source server: 9340cb02-cd1f-4a75-8303-0165ab14e102 ...
    >   ==> openstack: Creating the image: KUBE-UBUNTU
    >       openstack: Image: 4d98ca2b-2791-4b49-8517-78cc6dee5248
    >   ==> openstack: Waiting for image KUBE-UBUNTU (image id: 4d98ca2b-2791-4b49-8517-78cc6dee5248) to become ready...
    >   ==> openstack: Updating image tags to k8s, capi
    >   ==> openstack: Updating image visibility to private
    >   ==> openstack: Deleted temporary floating IP '75e3f528-328c-4998-bed3-0ecd9f4d2bf5' (128.232.226.115)
    >   ==> openstack: Terminating the source server: 9340cb02-cd1f-4a75-8303-0165ab14e102 ...
    >   ==> openstack: Error terminating server, may still be around: Resource not found
    >   ==> openstack: Deleting volume: 5d52b31e-f7af-4d19-b2b9-c7ad3f24c2a2 ...
    >   ==> openstack: Deleting temporary keypair: packer_65211330-46d4-02e7-ee4f-c36ecd3f5de7 ...
    >   ==> openstack: Running post-processor: custom-post-processor (type shell-local)
    >   ==> openstack (shell-local): Running local shell script: /tmp/packer-shell2431936991
    >   Build 'openstack' finished after 13 minutes 10 seconds.
    >   
    >   ==> Wait completed after 13 minutes 10 seconds
    >   
    >   ==> Builds finished. The artifacts of successful builds are:
    >   --> openstack: An image was created: 4d98ca2b-2791-4b49-8517-78cc6dee5248
    >   --> openstack: An image was created: 4d98ca2b-2791-4b49-8517-78cc6dee5248


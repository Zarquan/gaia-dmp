#
# <meta:header>
#   <meta:licence>
#     Copyright (c) 2024, ROE (http://www.roe.ac.uk/)
#
#     This information is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This information is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
#   </meta:licence>
# </meta:header>
#
#zrq-notes-time
#zrq-notes-indent
#zrq-notes-crypto
#zrq-notes-ansible
#zrq-notes-osformat
#zrq-notes-zeppelin
#

    Target:

        Success

    Result:

        Work in progress ...

# -----------------------------------------------------
#

    Login to Openstack Horizon at Cambridge (keystone auth)
    https://arcus.openstack.hpc.cam.ac.uk/

    Generate application credentials for each cloud (red, green, blue and data).
    Fill in the appropriate sections in the clouds.yaml file on your desktop/laptop/vm.


# -----------------------------------------------------
#

    Login to DigitalOcean and create a VM to use as the client.
    Add public ssh key to the VM.


# -----------------------------------------------------
# Transfer our **private** ssh key and clouds.yaml to the VM.
#[user@windows]

    scp .ssh/id_rsa root@206.189.18.250:.ssh/id_rsa

    scp clouds.yaml root@206.189.18.250:clouds.yaml


# -----------------------------------------------------
# Login to the VM using ssh.
#[user@windows]

    ssh root@206.189.18.250


# -----------------------------------------------------
# Install client software
#[user@client-vm]

    apt-get install -y podman

    >   ....
    >   ....


    apt-get install -y git

    >   ....
    >   ....


# -----------------------------------------------------
# Create a local env file in your home directory.
# This makes things easier to refer to later on.
#[user@client-vm]

    # This example uses the main wfau repo.
    # You should use your own fork once you have one.

    vi "${HOME}/aglais.env"

        AGLAIS_REPO='https://github.com/wfau/gaia-dmp.git'
        AGLAIS_CODE="${HOME}/gaia-dmp"

        PATH="${PATH}:${AGLAIS_CODE}/bin"
        export PATH


# -----------------------------------------------------
# Clone our main source code.
#[user@client-vm]

    # Use this once you have your ssh keys setup on GitHub.
    git clone 'git@github.com:wfau/gaia-dmp.git'

    # For editing you should use your fork rather than the main repo.
    git clone 'git@github.com:millingw/gaia-dmp.git'

    # Use this form for a simple read-only copy.
    git clone 'https://github.com/wfau/gaia-dmp.git'

--START--
....
....
--END--


# -----------------------------------------------------
# Setup your ssh-agent.
#[user@client-vm]

    # This is not needed if you are using a Linux client.
    # Linux automatically runs a ssh agent that will respond to authentication requests.
    # This doesn't work on Windows, so we need to start an agent on the client VM.

    eval $(ssh-agent)

--START--
....
....
--END--


cat << EOF
SSH_AGENT_PID [${SSH_AGENT_PID}]
SSH_AUTH_SOCK [${SSH_AUTH_SOCK}]
EOF

--START--
....
....
--END--


# -----------------------------------------------------
# Add your ssh key to the agent.
#[user@client-vm]

    # This is not needed if you are using a Linux client.
    # Linux automatically runs a ssh agent that will respond to authentication requests.
    # This doesn't work on Windows, so we need to start an agent on the client VM.

    ssh-add "${HOME}/.ssh/id_rsa"

--START--
....
....
--END--


    ssh-add -l

--START--
....
....
--END--


# -----------------------------------------------------
# Sanity check the current live host.
#[user@client-vm]

    ssh fedora@live.gaia-dmp.uk \
        '
        date
        hostname
        '

--START--
....
....
--END--


# -----------------------------------------------------
# Create a container to work with.
#[user@client-vm]

    source "${HOME:?}/aglais.env"

    ansi-client 'blue'

--START--
....
....
--END--


# -----------------------------------------------------
# Deploy everything.
#[root@ansibler]

    source /deployments/hadoop-yarn/bin/deploy.sh

--START--
....
....
--END--





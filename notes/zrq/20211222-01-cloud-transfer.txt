#
# <meta:header>
#   <meta:licence>
#     Copyright (c) 2021, ROE (http://www.roe.ac.uk/)
#
#     This information is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This information is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
#   </meta:licence>
# </meta:header>
#
#zrq-notes-time
#zrq-notes-indent
#zrq-notes-crypto
#zrq-notes-ansible
#zrq-notes-osformat
#zrq-notes-zeppelin
#


    Notes on transferring to the new cloud.

# -----------------------------------------------------
# Create a new branch.
#[user@desktop]

    branchname=cloud-transfer

    source "${HOME:?}/aglais.env"
    pushd "${AGLAIS_CODE}"

        branchprev=$(git branch --show-current)
        branchnext=$(date '+%Y%m%d')-zrq-${branchname:?}

        git checkout master
        git checkout -b "${branchnext:?}"

        git push --set-upstream 'origin' "$(git branch --show-current)"

    popd

    >   Already on 'master'
    >   Your branch is up to date with 'origin/master'.

    >   Switched to a new branch '20211222-zrq-cloud-transfer'

    >   Total 0 (delta 0), reused 0 (delta 0), pack-reused 0
    >   remote:
    >   remote: Create a pull request for '20211222-zrq-cloud-transfer' on GitHub by visiting:
    >   remote:      https://github.com/Zarquan/aglais/pull/new/20211222-zrq-cloud-transfer
    >   remote:
    >   To github.com:Zarquan/aglais.git
    >    * [new branch]      20211222-zrq-cloud-transfer -> 20211222-zrq-cloud-transfer
    >   Branch '20211222-zrq-cloud-transfer' set up to track remote branch '20211222-zrq-cloud-transfer' from 'origin'.



# -----------------------------------------------------

    Need to create a short test script to validate all the Openstack functionality we need.

    Horizon login
    Create application tokens

    Command line login
    Create ssh keys

    Create VM
    Create Manila share

    Create Manila router
    Mount the Manila share

    Copy some data in
    Checksum the data

    Create a cluster
    CSI mount the share

    Checksum the data


# -----------------------------------------------------

    Need to create copies of all our data from Manila to Echo.

    1) How many directories do we have ?


# -----------------------------------------------------
# Create a container to work with.
#[user@desktop]

    source "${HOME:?}/aglais.env"

    podman run \
        --rm \
        --tty \
        --interactive \
        --name ansibler \
        --hostname ansibler \
        --publish 3000:3000 \
        --publish 8088:8088 \
        --env "SSH_AUTH_SOCK=/mnt/ssh_auth_sock" \
        --volume "${SSH_AUTH_SOCK}:/mnt/ssh_auth_sock:rw,z" \
        --volume "${HOME:?}/clouds.yaml:/etc/openstack/clouds.yaml:ro,z" \
        --volume "${AGLAIS_CODE:?}/deployments:/deployments:ro,z" \
        atolmis/ansible-client:2021.08.25 \
        bash


# -----------------------------------------------------
# Set the target cloud.
#[root@ansibler]

    cloudname=gaia-dev

# -----------------------------------------------------
# Re-create our Ansible vars file.
# TODO This should have been saved somewhere by the deploy process.
#[root@ansibler]

    configyml='/tmp/aglais-config.yml'
    statusyml='/tmp/aglais-status.yml'

    cat > "${statusyml:?}" << EOF
aglais:
  status:
    deployment:
      type: hadoop-yarn
      conf: zeppelin-28.180-spark-6.27.45
      name: gaia-dev-20211214
      date: 20211214T114345
  spec:
    openstack:
      cloud: gaia-dev
EOF

    ln -sf \
        "${statusyml:?}" \
        '/tmp/ansible-vars.yml'


# -----------------------------------------------------
# Read the config settings.
#[root@ansibler]

    # TODO shell script to read these automatically

    deployconf=$(
        yq eval \
            '.aglais.status.deployment.conf' \
            "${statusyml:?}"
        )

    deployname=$(
        yq eval \
            '.aglais.status.deployment.name' \
            "${statusyml:?}"
        )

    deploydate=$(
        yq eval \
            '.aglais.status.deployment.date' \
            "${statusyml:?}"
        )

# -----------------------------------------------------
# Delete any existing known hosts file..
# Temp fix until we get a better solution.
# https://github.com/wfau/aglais/issues/401
#[root@ansibler]

    rm -f "${HOME}/.ssh/known_hosts"


# -----------------------------------------------------
# Run the Ansible ssh playbook.
#[root@ansibler]

    pushd '/deployments/hadoop-yarn/ansible'

        ansible-playbook \
            --inventory "config/${deployconf}.yml" \
            '05-config-ssh.yml'

        ansible-playbook \
            --inventory "config/${deployconf}.yml" \
            "08-ping-test.yml"

    popd







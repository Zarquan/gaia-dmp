#
# <meta:header>
#   <meta:licence>
#     Copyright (c) 2023, ROE (http://www.roe.ac.uk/)
#
#     This information is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This information is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
#   </meta:licence>
# </meta:header>
#
#zrq-notes-time
#zrq-notes-indent
#zrq-notes-crypto
#zrq-notes-ansible
#zrq-notes-osformat
#zrq-notes-zeppelin
#
# AIMetrics: [{"name": "ChatGPT","contribution": {"value": 0,"units": "%"}}]
#


    Target:

        Success

    Result:

        Work in progress ...

# -----------------------------------------------------

    #
    # Delete and create everything up to 'Deploy our target cluster'.
    # notes/zrq/20230722-01-bootstrap.txt
    #

    >   aglais:
    >     deployment:
    >       type: cluster-api
    >       name: iris-gaia-blue-20230724
    >       date: 20230724T161748
    >     openstack:
    >       cloud:
    >         name: iris-gaia-blue
    >       user:
    >         id: 5fa0c97a6dd14e01a3c7d91dad5c6b17
    >         name: dmorris_gaia
    >       project:
    >         id: e918a13fed2648758175a15fac083569
    >         name: iris-gaia-blue


# -----------------------------------------------------
# -----------------------------------------------------
# Launch another client terminal.
#[user@desktop]

    podman exec \
        --tty \
        --interactive \
        ansibler-blue \
            bash

    ssh root@bootstrap

    statusyml=/opt/aglais/aglais-status.yml
    touch "${statusyml:?}"

    kindclustername=$(
        yq '
           .aglais.kubernetes.kind.name
           ' "${statusyml:?}"
        )

    kindclusterconf=$(
        yq '
           .aglais.kubernetes.kind.conf
           ' "${statusyml:?}"
        )

# -----------------------------------------------------
# Follow the addon-provider logs.
#[root@bootstrap]

    kubectl \
        --kubeconfig "${kindclusterconf:?}" \
        get pods

    >   NAME                                          READY   STATUS    RESTARTS   AGE
    >   cluster-api-addon-provider-5cb78d8945-j45fv   1/1     Running   0          90s


    podname=$(
        kubectl \
            --kubeconfig "${kindclusterconf:?}" \
            get pods \
                --output json \
        | jq -r '.items[].metadata.name | select(test("cluster-api-addon-provider")) '
        )

    kubectl \
        --kubeconfig "${kindclusterconf:?}" \
        logs "${podname:?}" \
            --follow

    >   [2023-07-24 16:27:10,343] easykube.rest.client [INFO    ] API request: "GET https://10.96.0.1/apis/apiextensions.k8s.io/v1" 200
    >   [2023-07-24 16:27:10,367] easykube.rest.client [INFO    ] API request: "PATCH https://10.96.0.1/apis/apiextensions.k8s.io/v1/customresourcedefinitions/helmreleases.addons.stackhpc.com?fieldManager=cluster-api-addon-provider" 201
    >   [2023-07-24 16:27:10,406] easykube.rest.client [INFO    ] API request: "PATCH https://10.96.0.1/apis/apiextensions.k8s.io/v1/customresourcedefinitions/manifests.addons.stackhpc.com?fieldManager=cluster-api-addon-provider" 201
    >   [2023-07-24 16:27:10,406] kopf.activities.star [INFO    ] Activity 'apply_settings' succeeded.
    >   [2023-07-24 16:27:10,407] kopf._core.engines.a [INFO    ] Initial authentication has been initiated.
    >   [2023-07-24 16:27:10,428] kopf.activities.auth [INFO    ] Activity 'login_with_service_account' succeeded.
    >   [2023-07-24 16:27:10,428] kopf._core.engines.a [INFO    ] Initial authentication has finished.
    >   ....
    >   ....

    #
    # API request to 10.96.0.1 ..
    #

    ifconfig

    >   br-d09612036443: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
    >       inet 172.18.0.1  netmask 255.255.0.0  broadcast 172.18.255.255
    >       ether 02:42:81:81:ab:8b  txqueuelen 0  (Ethernet)
    >       ....
    >
    >   docker0: flags=4099<UP,BROADCAST,MULTICAST>  mtu 1500
    >       inet 172.17.0.1  netmask 255.255.0.0  broadcast 172.17.255.255
    >       ether 02:42:0b:4d:5d:bf  txqueuelen 0  (Ethernet)
    >       ....
    >
    >   eth0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1450
    >       inet 10.10.3.158  netmask 255.255.0.0  broadcast 10.10.255.255
    >       ....
    >
    >   veth298bd2b: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
    >       ether 16:fb:86:a3:02:24  txqueuelen 0  (Ethernet)
    >       ....


    ip route

    >   default via 10.10.0.1 dev eth0 proto dhcp metric 100
    >   10.10.0.0/16 dev eth0 proto kernel scope link src 10.10.3.158 metric 100
    >   169.254.169.254 via 10.10.0.3 dev eth0 proto dhcp metric 100
    >   172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 linkdown
    >   172.18.0.0/16 dev br-d09612036443 proto kernel scope link src 172.18.0.1

    #
    # Which implies the VM can't see 10.96...
    # So is this _inside_ the Kubernetes cluster ?
    #


# -----------------------------------------------------
# -----------------------------------------------------
# Enable monitoring and dashboard.
#[root@bootstrap]

    yq eval \
        --inplace \
        "
        .addons.monitoring.enabled = true,
        .addons.kubernetesDashboard.enabled = true
        " \
        /opt/aglais/clusterapi-config.yml


# -----------------------------------------------------
# Deploy our target cluster.
#[root@bootstrap]

    workclusterbase=gaia-dmp-one
    workclustername=${workclusterbase:?}-$(date '+%Y%m%d')

    workclusterpath=/opt/aglais/${workclusterbase:?}
    workclusterconf=${workclusterpath:?}/${workclustername:?}-kubeconfig.yml

    yq eval \
        --inplace \
        "
        .aglais.kubernetes.work.name = \"${workclustername}\",
        .aglais.kubernetes.work.conf = \"${workclusterconf}\"
        " \
        "${statusyml:?}"

    helm upgrade \
        --kubeconfig "${kindclusterconf:?}" \
        "${workclustername:?}" \
        capi/openstack-cluster \
            --install \
            --version "0.1.0" \
            --values '/opt/aglais/clusterapi-config.yml' \
            --values '/opt/aglais/openstack-clouds.yaml'

    >   Release "gaia-dmp-one-20230724" does not exist. Installing it now.
    >   NAME: gaia-dmp-one-20230724
    >   LAST DEPLOYED: Mon Jul 24 16:38:52 2023
    >   NAMESPACE: default
    >   STATUS: deployed
    >   REVISION: 1
    >   TEST SUITE: None


# -----------------------------------------------------
# Watch the cluster status.
#[root@bootstrap]

    watch clusterctl \
        --kubeconfig "${kindclusterconf:?}" \
        describe cluster \
            "${workclustername:?}"

    >   ....
    >   ....


    clusterctl \
        --kubeconfig "${kindclusterconf:?}" \
        describe cluster \
            "${workclustername:?}"

    >   NAME                                                                        READY  SEVERITY  REASON  SINCE  MESSAGE
    >   Cluster/gaia-dmp-one-20230724                                               True                     4m11s
    >   ├─ClusterInfrastructure - OpenStackCluster/gaia-dmp-one-20230724
    >   ├─ControlPlane - KubeadmControlPlane/gaia-dmp-one-20230724-control-plane    True                     4m11s
    >   │  └─3 Machines...                                                           True                     8m46s  ....
    >   └─Workers
    >     └─MachineDeployment/gaia-dmp-one-20230724-md-0                             True                     6m26s
    >       └─3 Machines...                                                           True                     7m12s  ....


# -----------------------------------------------------
# -----------------------------------------------------
# Fetch the work cluster config.
#[root@bootstrap]

    mkdir -p $(dirname "${workclusterconf}")

    clusterctl \
        --kubeconfig "${kindclusterconf:?}" \
        get \
            kubeconfig "${workclustername:?}" \
    | tee "${workclusterconf}" \
    | yq '.'

    >   apiVersion: v1
    >   clusters:
    >     - cluster:
    >         certificate-authority-data: LS0tLS1C........tLS0tLQo=
    >         server: https://128.232.227.79:6443
    >       name: gaia-dmp-one-20230724
    >   contexts:
    >     - context:
    >         cluster: gaia-dmp-one-20230724
    >         user: gaia-dmp-one-20230724-admin
    >       name: gaia-dmp-one-20230724-admin@gaia-dmp-one-20230724
    >   current-context: gaia-dmp-one-20230724-admin@gaia-dmp-one-20230724
    >   kind: Config
    >   preferences: {}
    >   users:
    >     - name: gaia-dmp-one-20230724-admin
    >       user:
    >         client-certificate-data: LS0tLS1C........tLS0tLQo=
    >         client-key-data: LS0tLS1C........0tLS0tCg==


# -----------------------------------------------------
# Check what pods are running.
#[root@bootstrap]

    kubectl \
        --kubeconfig "${workclusterconf:?}" \
        get pods \
            --all-namespaces

    >   NAMESPACE                NAME                                                                         READY   STATUS    RESTARTS       AGE
    >   calico-apiserver         calico-apiserver-6b6f9fdb57-29vdx                                            1/1     Running   0              11m
    >   calico-apiserver         calico-apiserver-6b6f9fdb57-nxvz4                                            1/1     Running   0              11m
    >   calico-system            calico-kube-controllers-7994c4b85-7kgkz                                      1/1     Running   0              12m
    >   calico-system            calico-node-2zmmt                                                            1/1     Running   0              12m
    >   calico-system            calico-node-65spf                                                            1/1     Running   0              12m
    >   calico-system            calico-node-b6zlz                                                            1/1     Running   0              12m
    >   calico-system            calico-node-dj7n7                                                            1/1     Running   0              12m
    >   calico-system            calico-node-dqvxs                                                            1/1     Running   0              9m12s
    >   calico-system            calico-node-xt4vx                                                            1/1     Running   0              11m
    >   calico-system            calico-typha-d489fddbf-2jdvz                                                 1/1     Running   0              12m
    >   calico-system            calico-typha-d489fddbf-7htng                                                 1/1     Running   0              10m
    >   calico-system            calico-typha-d489fddbf-k72m4                                                 1/1     Running   0              12m
    >   calico-system            csi-node-driver-2zg4g                                                        2/2     Running   0              9m12s
    >   calico-system            csi-node-driver-4gw89                                                        2/2     Running   0              12m
    >   calico-system            csi-node-driver-9gcq2                                                        2/2     Running   0              11m
    >   calico-system            csi-node-driver-krqsr                                                        2/2     Running   0              12m
    >   calico-system            csi-node-driver-qfprc                                                        2/2     Running   0              12m
    >   calico-system            csi-node-driver-r8fxq                                                        2/2     Running   0              12m
    >   gpu-operator             gpu-operator-56c9cf6799-q2dt7                                                1/1     Running   0              13m
    >   kube-system              coredns-565d847f94-4tmqc                                                     1/1     Running   0              13m
    >   kube-system              coredns-565d847f94-pbh8n                                                     1/1     Running   0              13m
    >   kube-system              etcd-gaia-dmp-one-20230724-control-plane-d1455deb-4qgjk                      1/1     Running   0              9m2s
    >   kube-system              etcd-gaia-dmp-one-20230724-control-plane-d1455deb-pf9f5                      1/1     Running   0              13m
    >   kube-system              etcd-gaia-dmp-one-20230724-control-plane-d1455deb-pvkqc                      1/1     Running   0              11m
    >   kube-system              kube-apiserver-gaia-dmp-one-20230724-control-plane-d1455deb-4qgjk            1/1     Running   0              7m56s
    >   kube-system              kube-apiserver-gaia-dmp-one-20230724-control-plane-d1455deb-pf9f5            1/1     Running   0              13m
    >   kube-system              kube-apiserver-gaia-dmp-one-20230724-control-plane-d1455deb-pvkqc            1/1     Running   0              11m
    >   kube-system              kube-controller-manager-gaia-dmp-one-20230724-control-plane-d1455deb-4qgjk   1/1     Running   0              9m4s
    >   kube-system              kube-controller-manager-gaia-dmp-one-20230724-control-plane-d1455deb-pf9f5   1/1     Running   1 (11m ago)    13m
    >   kube-system              kube-controller-manager-gaia-dmp-one-20230724-control-plane-d1455deb-pvkqc   1/1     Running   0              11m
    >   kube-system              kube-proxy-48ml9                                                             1/1     Running   0              12m
    >   kube-system              kube-proxy-g9ql2                                                             1/1     Running   0              13m
    >   kube-system              kube-proxy-hdmgl                                                             1/1     Running   0              11m
    >   kube-system              kube-proxy-j7v84                                                             1/1     Running   0              12m
    >   kube-system              kube-proxy-kjdv8                                                             1/1     Running   0              9m12s
    >   kube-system              kube-proxy-vnjhn                                                             1/1     Running   0              12m
    >   kube-system              kube-scheduler-gaia-dmp-one-20230724-control-plane-d1455deb-4qgjk            1/1     Running   0              7m55s
    >   kube-system              kube-scheduler-gaia-dmp-one-20230724-control-plane-d1455deb-pf9f5            1/1     Running   1 (11m ago)    13m
    >   kube-system              kube-scheduler-gaia-dmp-one-20230724-control-plane-d1455deb-pvkqc            1/1     Running   0              11m
    >   kube-system              metrics-server-554f79c654-ps7f2                                              1/1     Running   0              12m
    >   kubernetes-dashboard     kubernetes-dashboard-6cf5d75f8d-4jgnz                                        2/2     Running   0              12m
    >   monitoring-system        alertmanager-kube-prometheus-stack-alertmanager-0                            2/2     Running   1 (10m ago)    10m
    >   monitoring-system        kube-prometheus-stack-grafana-7d66d9d884-bt5xc                               3/3     Running   0              11m
    >   monitoring-system        kube-prometheus-stack-kube-state-metrics-9d456cddd-64wlg                     1/1     Running   0              11m
    >   monitoring-system        kube-prometheus-stack-operator-6c5b95f9fd-mpv2x                              1/1     Running   0              11m
    >   monitoring-system        kube-prometheus-stack-prometheus-node-exporter-28lbt                         1/1     Running   0              11m
    >   monitoring-system        kube-prometheus-stack-prometheus-node-exporter-cnl7z                         1/1     Running   0              9m12s
    >   monitoring-system        kube-prometheus-stack-prometheus-node-exporter-d5hfv                         1/1     Running   0              11m
    >   monitoring-system        kube-prometheus-stack-prometheus-node-exporter-p6lnn                         1/1     Running   0              11m
    >   monitoring-system        kube-prometheus-stack-prometheus-node-exporter-svbl4                         1/1     Running   0              11m
    >   monitoring-system        kube-prometheus-stack-prometheus-node-exporter-tnkqc                         1/1     Running   0              11m
    >   monitoring-system        loki-stack-0                                                                 1/1     Running   0              12m
    >   monitoring-system        loki-stack-promtail-57hbg                                                    1/1     Running   0              10m
    >   monitoring-system        loki-stack-promtail-58vl8                                                    1/1     Running   0              11m
    >   monitoring-system        loki-stack-promtail-dvb9d                                                    1/1     Running   0              8m11s
    >   monitoring-system        loki-stack-promtail-sknr7                                                    1/1     Running   0              11m
    >   monitoring-system        loki-stack-promtail-v9vdv                                                    1/1     Running   0              11m
    >   monitoring-system        loki-stack-promtail-xln5r                                                    1/1     Running   0              11m
    >   monitoring-system        prometheus-kube-prometheus-stack-prometheus-0                                2/2     Running   0              10m
    >   network-operator         mellanox-network-operator-778bffd589-2s26p                                   0/1     Error     7 (5m8s ago)   12m
    >   node-feature-discovery   node-feature-discovery-master-6968cdc89f-4wgfq                               1/1     Running   0              12m
    >   node-feature-discovery   node-feature-discovery-worker-fp7lw                                          1/1     Running   1 (11m ago)    12m
    >   node-feature-discovery   node-feature-discovery-worker-jflzm                                          1/1     Running   1 (11m ago)    12m
    >   node-feature-discovery   node-feature-discovery-worker-kzqcp                                          1/1     Running   0              11m
    >   node-feature-discovery   node-feature-discovery-worker-m2pq6                                          1/1     Running   0              9m12s
    >   node-feature-discovery   node-feature-discovery-worker-wglgx                                          1/1     Running   0              12m
    >   node-feature-discovery   node-feature-discovery-worker-xrrqd                                          1/1     Running   0              12m
    >   openstack-system         openstack-cinder-csi-controllerplugin-698b78b68-ltt2h                        6/6     Running   0              12m
    >   openstack-system         openstack-cinder-csi-nodeplugin-5bp6c                                        3/3     Running   0              12m
    >   openstack-system         openstack-cinder-csi-nodeplugin-k5mp8                                        3/3     Running   0              9m12s
    >   openstack-system         openstack-cinder-csi-nodeplugin-krvxs                                        3/3     Running   0              12m
    >   openstack-system         openstack-cinder-csi-nodeplugin-mrxvw                                        3/3     Running   0              12m
    >   openstack-system         openstack-cinder-csi-nodeplugin-s25xf                                        3/3     Running   0              11m
    >   openstack-system         openstack-cinder-csi-nodeplugin-vntm2                                        3/3     Running   0              12m
    >   openstack-system         openstack-cloud-controller-manager-rvmgr                                     1/1     Running   0              10m
    >   openstack-system         openstack-cloud-controller-manager-wxfws                                     1/1     Running   0              8m11s
    >   openstack-system         openstack-cloud-controller-manager-z9k2t                                     1/1     Running   1 (11m ago)    12m
    >   tigera-operator          tigera-operator-7f96bd8bf8-r8nbj                                             1/1     Running   1 (11m ago)    12m


# -----------------------------------------------------
# -----------------------------------------------------
# Launch another client terminal.
#[user@desktop]

    podman exec \
        --tty \
        --interactive \
        ansibler-blue \
            bash


    /deployments/openstack/bin/list-all.sh \
        "${cloudname:?}"


    >   Nova servers
    >   +--------------------------------------+----------------------------------------------------+--------+-----------------------------------------------------------------------+-----------------------------------+----------------------+
    >   | ID                                   | Name                                               | Status | Networks                                                              | Image                             | Flavor               |
    >   +--------------------------------------+----------------------------------------------------+--------+-----------------------------------------------------------------------+-----------------------------------+----------------------+
    >   | b44086a3-c8c0-416e-b5ff-9f4c7663da13 | gaia-dmp-one-20230724-control-plane-d1455deb-4qgjk | ACTIVE | k8s-clusterapi-cluster-default-gaia-dmp-one-20230724=192.168.3.11     | gaia-dmp-ubuntu-2004-kube-v1.25.4 | gaia.vm.cclake.4vcpu |
    >   | fd858796-2421-4a59-b7af-598fe394b788 | gaia-dmp-one-20230724-control-plane-d1455deb-pvkqc | ACTIVE | k8s-clusterapi-cluster-default-gaia-dmp-one-20230724=192.168.3.182    | gaia-dmp-ubuntu-2004-kube-v1.25.4 | gaia.vm.cclake.4vcpu |
    >   | 1e49006c-f8a0-44dc-844a-b1056eb964bc | gaia-dmp-one-20230724-md-0-d1455deb-fdvt5          | ACTIVE | k8s-clusterapi-cluster-default-gaia-dmp-one-20230724=192.168.3.154    | gaia-dmp-ubuntu-2004-kube-v1.25.4 | gaia.vm.cclake.4vcpu |
    >   | 2796b7af-e5eb-4e85-9967-4368f7b75f7a | gaia-dmp-one-20230724-md-0-d1455deb-pmjk6          | ACTIVE | k8s-clusterapi-cluster-default-gaia-dmp-one-20230724=192.168.3.95     | gaia-dmp-ubuntu-2004-kube-v1.25.4 | gaia.vm.cclake.4vcpu |
    >   | 40a7d115-314f-4334-9e71-cf02664a9610 | gaia-dmp-one-20230724-md-0-d1455deb-pmhdb          | ACTIVE | k8s-clusterapi-cluster-default-gaia-dmp-one-20230724=192.168.3.184    | gaia-dmp-ubuntu-2004-kube-v1.25.4 | gaia.vm.cclake.4vcpu |
    >   | c2f94634-2329-4724-8513-b1a6be25b28d | gaia-dmp-one-20230724-control-plane-d1455deb-pf9f5 | ACTIVE | k8s-clusterapi-cluster-default-gaia-dmp-one-20230724=192.168.3.206    | gaia-dmp-ubuntu-2004-kube-v1.25.4 | gaia.vm.cclake.4vcpu |
    >   | 2c6bbe9f-cda2-4a88-afa2-035d89397794 | iris-gaia-blue-20230724-bootstrap                  | ACTIVE | iris-gaia-blue-20230724-internal-network=10.10.3.158, 128.232.226.189 | Fedora-34.1.2                     | gaia.vm.cclake.2vcpu |
    >   +--------------------------------------+----------------------------------------------------+--------+-----------------------------------------------------------------------+-----------------------------------+----------------------+
    >
    >   ---- ----
    >   Cinder volumes
    >
    >
    >   ---- ----
    >   Manila shares
    >   +--------------------------------------+------------------------------+------+-------------+----------------+-----------+-----------------+------+-------------------+
    >   | ID                                   | Name                         | Size | Share Proto | Status         | Is Public | Share Type Name | Host | Availability Zone |
    >   +--------------------------------------+------------------------------+------+-------------+----------------+-----------+-----------------+------+-------------------+
    >   | dcfa8904-6c11-453c-a82d-dafca87380f6 | blue-test                    |   10 | CEPHFS      | available      | False     | ceph01_cephfs   |      | nova              |
    >   | 5b97c1a5-da70-4417-ba63-80ed2c1301bf | iris-gaia-blue-home-Evison   |    1 | CEPHFS      | deleting       | False     | ceph01_cephfs   |      | nova              |
    >   | 02ad6c76-06d8-4a51-a898-8fb3cd1e2f52 | iris-gaia-blue-home-Reyesfan |    1 | CEPHFS      | error_deleting | False     | ceph01_cephfs   |      | nova              |
    >   | bcc5edd9-dabc-4a18-8c70-dd86ae8e404c | iris-gaia-blue-user-Evison   |    1 | CEPHFS      | deleting       | False     | ceph01_cephfs   |      | nova              |
    >   | 8e108df6-746e-4882-9449-cc11740c1dad | iris-gaia-blue-user-Reyesfan |    1 | CEPHFS      | deleting       | False     | ceph01_cephfs   |      | nova              |
    >   +--------------------------------------+------------------------------+------+-------------+----------------+-----------+-----------------+------+-------------------+
    >
    >   ---- ----
    >   Floating addresses
    >   +--------------------------------------+---------------------+------------------+--------------------------------------+--------------------------------------+----------------------------------+
    >   | ID                                   | Floating IP Address | Fixed IP Address | Port                                 | Floating Network                     | Project                          |
    >   +--------------------------------------+---------------------+------------------+--------------------------------------+--------------------------------------+----------------------------------+
    >   | 74e3d944-67aa-43de-ab58-95c9890706c7 | 128.232.226.189     | 10.10.3.158      | 7b434693-f6cc-4b31-acc1-e4d2c0cdeb52 | 57add367-d205-4030-a929-d75617a7c63e | e918a13fed2648758175a15fac083569 |
    >   | 925de5e8-898c-427d-854a-7ab4137be32a | 128.232.227.79      | 192.168.3.173    | 6a2bfe02-7560-4b10-97ba-01130c031af5 | 57add367-d205-4030-a929-d75617a7c63e | e918a13fed2648758175a15fac083569 |
    >   +--------------------------------------+---------------------+------------------+--------------------------------------+--------------------------------------+----------------------------------+
    >
    >   ---- ----
    >   Load balancers
    >   +--------------------------------------+--------------------------------------------------------------+----------------------------------+---------------+---------------------+------------------+----------+
    >   | id                                   | name                                                         | project_id                       | vip_address   | provisioning_status | operating_status | provider |
    >   +--------------------------------------+--------------------------------------------------------------+----------------------------------+---------------+---------------------+------------------+----------+
    >   | 97d6f25f-7abe-42fc-b334-2059f6533812 | k8s-clusterapi-cluster-default-gaia-dmp-one-20230724-kubeapi | e918a13fed2648758175a15fac083569 | 192.168.3.173 | ACTIVE              | ONLINE           | amphora  |
    >   +--------------------------------------+--------------------------------------------------------------+----------------------------------+---------------+---------------------+------------------+----------+
    >
    >   ---- ----
    >   Routers
    >   +--------------------------------------+------------------------------------------------------+--------+-------+----------------------------------+
    >   | ID                                   | Name                                                 | Status | State | Project                          |
    >   +--------------------------------------+------------------------------------------------------+--------+-------+----------------------------------+
    >   | ab22523d-6adc-4317-85a5-f7924f452a12 | k8s-clusterapi-cluster-default-gaia-dmp-one-20230724 | ACTIVE | UP    | e918a13fed2648758175a15fac083569 |
    >   | d807dcd4-7b79-47c3-bf35-7b2f873c0b2e | iris-gaia-blue-20230724-internal-router              | ACTIVE | UP    | e918a13fed2648758175a15fac083569 |
    >   +--------------------------------------+------------------------------------------------------+--------+-------+----------------------------------+
    >
    >   ---- ----
    >   Networks
    >   +--------------------------------------+------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+
    >   | ID                                   | Name                                                 | Subnets                                                                                                                                                |
    >   +--------------------------------------+------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+
    >   | 410920fb-5714-4447-b26a-e7b06092fc62 | cephfs                                               | 5699fb5d-8316-4b88-b889-b05c8a1ec975                                                                                                                   |
    >   | 57add367-d205-4030-a929-d75617a7c63e | CUDN-Internet                                        | 1847b14d-b974-4f78-959d-44d18d4485b8, 3fcaa5a5-ba8e-49a9-bf94-d87fbb0afc42, 5f1388b3-a0c7-463e-bb58-5532c38e4b40, a79eb610-eca3-4ee8-aaf1-88f4fef5a4e7 |
    >   | a28ad5d8-3511-4060-922f-e9ffdc362518 | k8s-clusterapi-cluster-default-gaia-dmp-one-20230724 | 8c5381e2-f57a-4ebb-8da2-eda936f6be50                                                                                                                   |
    >   | b6accbaf-c56e-4002-8889-dc0a7c0a6859 | iris-gaia-blue-20230724-internal-network             | a7b462d1-309e-48a1-80a4-2561db134b8c                                                                                                                   |
    >   +--------------------------------------+------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+
    >
    >   ---- ----
    >   Subnets
    >   +--------------------------------------+------------------------------------------------------+--------------------------------------+----------------+
    >   | ID                                   | Name                                                 | Network                              | Subnet         |
    >   +--------------------------------------+------------------------------------------------------+--------------------------------------+----------------+
    >   | 5699fb5d-8316-4b88-b889-b05c8a1ec975 | cephfs                                               | 410920fb-5714-4447-b26a-e7b06092fc62 | 10.9.0.0/16    |
    >   | 8c5381e2-f57a-4ebb-8da2-eda936f6be50 | k8s-clusterapi-cluster-default-gaia-dmp-one-20230724 | a28ad5d8-3511-4060-922f-e9ffdc362518 | 192.168.3.0/24 |
    >   | a7b462d1-309e-48a1-80a4-2561db134b8c | iris-gaia-blue-20230724-internal-subnet              | b6accbaf-c56e-4002-8889-dc0a7c0a6859 | 10.10.0.0/16   |
    >   +--------------------------------------+------------------------------------------------------+--------------------------------------+----------------+
    >
    >   ---- ----
    >   Security groups
    >   +--------------------------------------+-----------------------------------------------------------------+---------------------------+----------------------------------+------+
    >   | ID                                   | Name                                                            | Description               | Project                          | Tags |
    >   +--------------------------------------+-----------------------------------------------------------------+---------------------------+----------------------------------+------+
    >   | bce836d1-ec7f-4474-a235-46654a79f327 | k8s-cluster-default-gaia-dmp-one-20230724-secgroup-controlplane | Cluster API managed group | e918a13fed2648758175a15fac083569 | []   |
    >   | bff9ede6-ae9a-4109-af20-410d39a533b1 | iris-gaia-blue-20230724-bootstrap-security                      |                           | e918a13fed2648758175a15fac083569 | []   |
    >   | e1c6a1db-3caf-47f5-91e2-51a3e1967dc6 | default                                                         | Default security group    | e918a13fed2648758175a15fac083569 | []   |
    >   | fdadef6a-f166-464c-845a-0a5c7eb136a0 | k8s-cluster-default-gaia-dmp-one-20230724-secgroup-worker       | Cluster API managed group | e918a13fed2648758175a15fac083569 | []   |
    >   +--------------------------------------+-----------------------------------------------------------------+---------------------------+----------------------------------+------+

# -----------------------------------------------------
# -----------------------------------------------------

    Loadbalancer external address 128.232.227.79


# -----------------------------------------------------
# -----------------------------------------------------


    kubectl \
        --kubeconfig "${workclusterconf:?}" \
        --namespace kubernetes-dashboard \
        get secrets

    >   NAME                                         TYPE                 DATA   AGE
    >   kubernetes-dashboard-certs                   Opaque               0      3h18m
    >   kubernetes-dashboard-csrf                    Opaque               1      3h18m
    >   kubernetes-dashboard-key-holder              Opaque               2      3h18m
    >   sh.helm.release.v1.kubernetes-dashboard.v1   helm.sh/release.v1   1      3h18m


    kubectl \
        --kubeconfig "${workclusterconf:?}" \
        --namespace kubernetes-dashboard \
        get ServiceAccount

    >   NAME                   SECRETS   AGE
    >   default                0         3h20m
    >   kubernetes-dashboard   0         3h20m


    kubectl \
        --kubeconfig "${workclusterconf:?}" \
        --namespace kubernetes-dashboard \
        --output json \
        get ServiceAccount \
            kubernetes-dashboard

    >   {
    >       "apiVersion": "v1",
    >       "kind": "ServiceAccount",
    >       "metadata": {
    >           "annotations": {
    >               "meta.helm.sh/release-name": "kubernetes-dashboard",
    >               "meta.helm.sh/release-namespace": "kubernetes-dashboard"
    >           },
    >           "creationTimestamp": "2023-07-24T16:43:55Z",
    >           "labels": {
    >               "app.kubernetes.io/instance": "kubernetes-dashboard",
    >               "app.kubernetes.io/managed-by": "Helm",
    >               "app.kubernetes.io/name": "kubernetes-dashboard",
    >               "app.kubernetes.io/version": "2.6.1",
    >               "helm.sh/chart": "kubernetes-dashboard-5.10.0"
    >           },
    >           "name": "kubernetes-dashboard",
    >           "namespace": "kubernetes-dashboard",
    >           "resourceVersion": "595",
    >           "uid": "de2bc1fc-7432-4b90-a76e-46ab4b4f95a5"
    >       }
    >   }


    kubectl \
        --kubeconfig "${workclusterconf:?}" \
        --namespace kubernetes-dashboard \
        --output json \
        get secret \
            kubernetes-dashboard-key-holder

    >   {
    >       "apiVersion": "v1",
    >       "data": {
    >           "priv": "LS0tLS1C........0tLS0tCg==",
    >           "pub": "LS0tLS1C........LS0tLS0K"
    >       },
    >       "kind": "Secret",
    >       "metadata": {
    >           "creationTimestamp": "2023-07-24T16:43:55Z",
    >           "name": "kubernetes-dashboard-key-holder",
    >           "namespace": "kubernetes-dashboard",
    >           "resourceVersion": "1918",
    >           "uid": "5d2926d1-0df9-45b4-a521-b1ab6eab88d6"
    >       },
    >       "type": "Opaque"
    >   }


    kubectl \
        --kubeconfig "${workclusterconf:?}" \
        --namespace kubernetes-dashboard \
        get pods

    >   NAME                                    READY   STATUS    RESTARTS   AGE
    >   kubernetes-dashboard-6cf5d75f8d-4jgnz   2/2     Running   0          3h18m


    kubectl \
        --kubeconfig "${workclusterconf:?}" \
        --namespace kubernetes-dashboard \
        --output json \
        get pod \
            kubernetes-dashboard-6cf5d75f8d-4jgnz


    >   {
    >       "apiVersion": "v1",
    >       "kind": "Pod",
    >       "metadata": {
    >           "annotations": {
    >               "cni.projectcalico.org/containerID": "148831f19e42e4c8d0313eae7193665202fa22c5d9e32193252d3dc8dbf62f60",
    >               "cni.projectcalico.org/podIP": "172.18.196.130/32",
    >               "cni.projectcalico.org/podIPs": "172.18.196.130/32"
    >           },
    >           "creationTimestamp": "2023-07-24T16:43:55Z",
    >           "generateName": "kubernetes-dashboard-6cf5d75f8d-",
    >           "labels": {
    >               "app.kubernetes.io/component": "kubernetes-dashboard",
    >               "app.kubernetes.io/instance": "kubernetes-dashboard",
    >               "app.kubernetes.io/managed-by": "Helm",
    >               "app.kubernetes.io/name": "kubernetes-dashboard",
    >               "app.kubernetes.io/version": "2.6.1",
    >               "helm.sh/chart": "kubernetes-dashboard-5.10.0",
    >               "pod-template-hash": "6cf5d75f8d"
    >           },
    >           "name": "kubernetes-dashboard-6cf5d75f8d-4jgnz",
    >           "namespace": "kubernetes-dashboard",
    >           "ownerReferences": [
    >               {
    >                   "apiVersion": "apps/v1",
    >                   "blockOwnerDeletion": true,
    >                   "controller": true,
    >                   "kind": "ReplicaSet",
    >                   "name": "kubernetes-dashboard-6cf5d75f8d",
    >                   "uid": "fa5574da-873a-4819-8e2e-64baa13ccff5"
    >               }
    >           ],
    >           "resourceVersion": "2731",
    >           "uid": "d57ec832-ad9c-4a79-af77-2daaeb626192"
    >       },
    >       "spec": {
    >           "containers": [
    >               {
    >                   "args": [
    >                       "--namespace=kubernetes-dashboard",
    >                       "--auto-generate-certificates",
    >                       "--sidecar-host=http://127.0.0.1:8000"
    >                   ],
    >                   "image": "kubernetesui/dashboard:v2.6.1",
    >                   "imagePullPolicy": "IfNotPresent",
    >                   "livenessProbe": {
    >                       "failureThreshold": 3,
    >                       "httpGet": {
    >                           "path": "/",
    >                           "port": 8443,
    >                           "scheme": "HTTPS"
    >                       },
    >                       "initialDelaySeconds": 30,
    >                       "periodSeconds": 10,
    >                       "successThreshold": 1,
    >                       "timeoutSeconds": 30
    >                   },
    >                   "name": "kubernetes-dashboard",
    >                   "ports": [
    >                       {
    >                           "containerPort": 8443,
    >                           "name": "https",
    >                           "protocol": "TCP"
    >                       }
    >                   ],
    >                   "resources": {
    >                       "limits": {
    >                           "cpu": "2",
    >                           "memory": "200Mi"
    >                       },
    >                       "requests": {
    >                           "cpu": "100m",
    >                           "memory": "200Mi"
    >                       }
    >                   },
    >                   "securityContext": {
    >                       "allowPrivilegeEscalation": false,
    >                       "readOnlyRootFilesystem": true,
    >                       "runAsGroup": 2001,
    >                       "runAsUser": 1001
    >                   },
    >                   "terminationMessagePath": "/dev/termination-log",
    >                   "terminationMessagePolicy": "File",
    >                   "volumeMounts": [
    >                       {
    >                           "mountPath": "/certs",
    >                           "name": "kubernetes-dashboard-certs"
    >                       },
    >                       {
    >                           "mountPath": "/tmp",
    >                           "name": "tmp-volume"
    >                       },
    >                       {
    >                           "mountPath": "/var/run/secrets/kubernetes.io/serviceaccount",
    >                           "name": "kube-api-access-blfg8",
    >                           "readOnly": true
    >                       }
    >                   ]
    >               },
    >               {
    >                   "image": "kubernetesui/metrics-scraper:v1.0.8",
    >                   "imagePullPolicy": "IfNotPresent",
    >                   "livenessProbe": {
    >                       "failureThreshold": 3,
    >                       "httpGet": {
    >                           "path": "/",
    >                           "port": 8000,
    >                           "scheme": "HTTP"
    >                       },
    >                       "initialDelaySeconds": 30,
    >                       "periodSeconds": 10,
    >                       "successThreshold": 1,
    >                       "timeoutSeconds": 30
    >                   },
    >                   "name": "dashboard-metrics-scraper",
    >                   "ports": [
    >                       {
    >                           "containerPort": 8000,
    >                           "protocol": "TCP"
    >                       }
    >                   ],
    >                   "resources": {},
    >                   "securityContext": {
    >                       "allowPrivilegeEscalation": false,
    >                       "readOnlyRootFilesystem": true,
    >                       "runAsGroup": 2001,
    >                       "runAsUser": 1001
    >                   },
    >                   "terminationMessagePath": "/dev/termination-log",
    >                   "terminationMessagePolicy": "File",
    >                   "volumeMounts": [
    >                       {
    >                           "mountPath": "/tmp",
    >                           "name": "tmp-volume"
    >                       },
    >                       {
    >                           "mountPath": "/var/run/secrets/kubernetes.io/serviceaccount",
    >                           "name": "kube-api-access-blfg8",
    >                           "readOnly": true
    >                       }
    >                   ]
    >               }
    >           ],
    >           "dnsPolicy": "ClusterFirst",
    >           "enableServiceLinks": true,
    >           "nodeName": "gaia-dmp-one-20230724-md-0-d1455deb-fdvt5",
    >           "preemptionPolicy": "PreemptLowerPriority",
    >           "priority": 0,
    >           "restartPolicy": "Always",
    >           "schedulerName": "default-scheduler",
    >           "securityContext": {
    >               "seccompProfile": {
    >                   "type": "RuntimeDefault"
    >               }
    >           },
    >           "serviceAccount": "kubernetes-dashboard",
    >           "serviceAccountName": "kubernetes-dashboard",
    >           "terminationGracePeriodSeconds": 30,
    >           "tolerations": [
    >               {
    >                   "effect": "NoExecute",
    >                   "key": "node.kubernetes.io/not-ready",
    >                   "operator": "Exists",
    >                   "tolerationSeconds": 300
    >               },
    >               {
    >                   "effect": "NoExecute",
    >                   "key": "node.kubernetes.io/unreachable",
    >                   "operator": "Exists",
    >                   "tolerationSeconds": 300
    >               }
    >           ],
    >           "volumes": [
    >               {
    >                   "name": "kubernetes-dashboard-certs",
    >                   "secret": {
    >                       "defaultMode": 420,
    >                       "secretName": "kubernetes-dashboard-certs"
    >                   }
    >               },
    >               {
    >                   "emptyDir": {},
    >                   "name": "tmp-volume"
    >               },
    >               {
    >                   "name": "kube-api-access-blfg8",
    >                   "projected": {
    >                       "defaultMode": 420,
    >                       "sources": [
    >                           {
    >                               "serviceAccountToken": {
    >                                   "expirationSeconds": 3607,
    >                                   "path": "token"
    >                               }
    >                           },
    >                           {
    >                               "configMap": {
    >                                   "items": [
    >                                       {
    >                                           "key": "ca.crt",
    >                                           "path": "ca.crt"
    >                                       }
    >                                   ],
    >                                   "name": "kube-root-ca.crt"
    >                               }
    >                           },
    >                           {
    >                               "downwardAPI": {
    >                                   "items": [
    >                                       {
    >                                           "fieldRef": {
    >                                               "apiVersion": "v1",
    >                                               "fieldPath": "metadata.namespace"
    >                                           },
    >                                           "path": "namespace"
    >                                       }
    >                                   ]
    >                               }
    >                           }
    >                       ]
    >                   }
    >               }
    >           ]
    >       },
    >       "status": {
    >           "conditions": [
    >               {
    >                   "lastProbeTime": null,
    >                   "lastTransitionTime": "2023-07-24T16:45:01Z",
    >                   "status": "True",
    >                   "type": "Initialized"
    >               },
    >               {
    >                   "lastProbeTime": null,
    >                   "lastTransitionTime": "2023-07-24T16:46:04Z",
    >                   "status": "True",
    >                   "type": "Ready"
    >               },
    >               {
    >                   "lastProbeTime": null,
    >                   "lastTransitionTime": "2023-07-24T16:46:04Z",
    >                   "status": "True",
    >                   "type": "ContainersReady"
    >               },
    >               {
    >                   "lastProbeTime": null,
    >                   "lastTransitionTime": "2023-07-24T16:45:01Z",
    >                   "status": "True",
    >                   "type": "PodScheduled"
    >               }
    >           ],
    >           "containerStatuses": [
    >               {
    >                   "containerID": "containerd://1fa1977c74ea94a2d8b5b23ed2e4819fc0a88277ba614fdd616a5bcfa3780cdf",
    >                   "image": "docker.io/kubernetesui/metrics-scraper:v1.0.8",
    >                   "imageID": "docker.io/kubernetesui/metrics-scraper@sha256:76049887f07a0476dc93efc2d3569b9529bf982b22d29f356092ce206e98765c",
    >                   "lastState": {},
    >                   "name": "dashboard-metrics-scraper",
    >                   "ready": true,
    >                   "restartCount": 0,
    >                   "started": true,
    >                   "state": {
    >                       "running": {
    >                           "startedAt": "2023-07-24T16:46:04Z"
    >                       }
    >                   }
    >               },
    >               {
    >                   "containerID": "containerd://625cc333568f9b52041f0a7e9e456c82505c3d4c268cb553b7a9571b57faeae8",
    >                   "image": "docker.io/kubernetesui/dashboard:v2.6.1",
    >                   "imageID": "docker.io/kubernetesui/dashboard@sha256:290bebc3cd96c22b6f89e7b21f5c2b16ce5c275a0ec2c2de10e0d8b9dd110289",
    >                   "lastState": {},
    >                   "name": "kubernetes-dashboard",
    >                   "ready": true,
    >                   "restartCount": 0,
    >                   "started": true,
    >                   "state": {
    >                       "running": {
    >                           "startedAt": "2023-07-24T16:45:23Z"
    >                       }
    >                   }
    >               }
    >           ],
    >           "hostIP": "192.168.3.154",
    >           "phase": "Running",
    >           "podIP": "172.18.196.130",
    >           "podIPs": [
    >               {
    >                   "ip": "172.18.196.130"
    >               }
    >           ],
    >           "qosClass": "Burstable",
    >           "startTime": "2023-07-24T16:45:01Z"
    >       }
    >   }



#
# <meta:header>
#   <meta:licence>
#     Copyright (c) 2022, ROE (http://www.roe.ac.uk/)
#
#     This information is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This information is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
#   </meta:licence>
# </meta:header>
#
#zrq-notes-time
#zrq-notes-indent
#zrq-notes-crypto
#zrq-notes-ansible
#zrq-notes-osformat
#zrq-notes-zeppelin
#

    Target:

        Deploy everything from clean on a new system with upstream changes.
        https://github.com/wfau/gaia-dmp/issues/1002

    Result:

        Success.
        Lots of debugging and hacking along the way.
        Needs a clen deploy to test.


# -----------------------------------------------------
# Check which cloud is currently live.
#[user@desktop]

    ssh fedora@live.gaia-dmp.uk \
        '
        date
        hostname
        '

    >   Wed 21 Sep 15:19:48 UTC 2022
    >   iris-gaia-green-20220825-zeppelin



# -----------------------------------------------------
# Create a container to work with.
#[user@desktop]

    #
    # Live is green, Stelios is using red, so selecting blue for the deployment.
    #

    # Starting a new pattern for creating the client container.
    # Working towards a launch-script.
    # https://github.com/wfau/aglais/issues/894

    source "${HOME:?}/aglais.env"

    agcolour=blue
    configname=zeppelin-54.86-spark-6.26.43

    agproxymap=3000:3000
    clientname=ansibler-${agcolour}
    cloudname=iris-gaia-${agcolour}

    podman run \
        --rm \
        --tty \
        --interactive \
        --name     "${clientname:?}" \
        --hostname "${clientname:?}" \
        --publish  "${agproxymap:?}" \
        --env "cloudname=${cloudname:?}" \
        --env "configname=${configname:?}" \
        --env "SSH_AUTH_SOCK=/mnt/ssh_auth_sock" \
        --volume "${SSH_AUTH_SOCK:?}:/mnt/ssh_auth_sock:rw,z" \
        --volume "${HOME:?}/clouds.yaml:/etc/openstack/clouds.yaml:ro,z" \
        --volume "${AGLAIS_CODE:?}/deployments:/deployments:ro,z" \
        ghcr.io/wfau/atolmis/ansible-client:2022.07.25 \
        bash

    >   ....
    >   ....


# -----------------------------------------------------
# Deploy everything.
#[root@ansibler]

    time \
        source /deployments/hadoop-yarn/bin/deploy.sh

    >   aglais:
    >     status:
    >       deployment:
    >         type: hadoop-yarn
    >         conf: zeppelin-54.86-spark-6.26.43
    >         name: iris-gaia-blue-20220921
    >         date: 20220921T152435
    >         hostname: zeppelin.gaia-dmp.uk
    >     spec:
    >       openstack:
    >         cloud:
    >           base: arcus
    >           name: iris-gaia-blue

    >   real    81m52.827s
    >   user    20m23.482s
    >   sys     5m4.416s


# -----------------------------------------------------
# Allow port 8080.
#[root@ansibler]

    openstack \
        --os-cloud "${cloudname:?}" \
        security group list

    >   +--------------------------------------+-------------------------------------------+------------------------+----------------------------------+------+
    >   | ID                                   | Name                                      | Description            | Project                          | Tags |
    >   +--------------------------------------+-------------------------------------------+------------------------+----------------------------------+------+
    >   | 149ded1c-60f3-4010-b0a2-7c2a298ab75e | iris-gaia-blue-20220921-monitor-security  |                        | e918a13fed2648758175a15fac083569 | []   |
    >   | 1f94b75b-e4cf-404e-ac02-658dd047d279 | iris-gaia-blue-20220921-worker-security   |                        | e918a13fed2648758175a15fac083569 | []   |
    >   | 30ce01c5-97b5-4493-b3f9-fc27f9a0675c | iris-gaia-blue-20220921-master-security   |                        | e918a13fed2648758175a15fac083569 | []   |
    >   | e1c6a1db-3caf-47f5-91e2-51a3e1967dc6 | default                                   | Default security group | e918a13fed2648758175a15fac083569 | []   |
    >   | f2442464-3a6d-487c-a27e-1ab74c9c2110 | iris-gaia-blue-20220921-zeppelin-security |                        | e918a13fed2648758175a15fac083569 | []   |
    >   +--------------------------------------+-------------------------------------------+------------------------+----------------------------------+------+


    openstack \
        --os-cloud "${cloudname:?}" \
        security group show \
            'f2442464-3a6d-487c-a27e-1ab74c9c2110'

    >   +-----------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    >   | Field           | Value                                                                                                                                                                                                                                                                                                                      |
    >   +-----------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    >   | created_at      | 2022-09-21T15:25:11Z                                                                                                                                                                                                                                                                                                       |
    >   | description     |                                                                                                                                                                                                                                                                                                                            |
    >   | id              | f2442464-3a6d-487c-a27e-1ab74c9c2110                                                                                                                                                                                                                                                                                       |
    >   | name            | iris-gaia-blue-20220921-zeppelin-security                                                                                                                                                                                                                                                                                  |
    >   | project_id      | e918a13fed2648758175a15fac083569                                                                                                                                                                                                                                                                                           |
    >   | revision_number | 13                                                                                                                                                                                                                                                                                                                         |
    >   | rules           | created_at='2022-09-21T16:32:21Z', direction='ingress', ethertype='IPv4', id='02b0d061-ac99-44fe-b64b-36ef4967d217', protocol='tcp', remote_group_id='1f94b75b-e4cf-404e-ac02-658dd047d279', tenant_id='e918a13fed2648758175a15fac083569', updated_at='2022-09-21T16:32:21Z'                                               |
    >   |                 | created_at='2022-09-21T16:32:13Z', direction='ingress', ethertype='IPv4', id='29d29bfe-a126-4d23-ab74-6df292cd3b87', port_range_max='443', port_range_min='443', protocol='tcp', remote_group_id='f2442464-3a6d-487c-a27e-1ab74c9c2110', tenant_id='e918a13fed2648758175a15fac083569', updated_at='2022-09-21T16:32:13Z'   |
    >   |                 | created_at='2022-09-21T15:25:15Z', direction='ingress', ethertype='IPv4', id='541cb99a-89db-4e1e-b91f-90f570360fcb', port_range_max='22', port_range_min='22', protocol='tcp', remote_ip_prefix='0.0.0.0/0', tenant_id='e918a13fed2648758175a15fac083569', updated_at='2022-09-21T15:25:15Z'                               |
    >   |                 | created_at='2022-09-21T16:32:31Z', direction='ingress', ethertype='IPv4', id='5fcc53ac-28c3-47c5-8fd7-753f353ef5b0', port_range_max='9100', port_range_min='9100', protocol='tcp', remote_group_id='149ded1c-60f3-4010-b0a2-7c2a298ab75e', tenant_id='e918a13fed2648758175a15fac083569', updated_at='2022-09-21T16:32:31Z' |
    >   |                 | created_at='2022-09-21T15:25:22Z', direction='ingress', ethertype='IPv4', id='69209971-0305-4c8e-a2d0-08e3baf8d2e9', port_range_max='80', port_range_min='80', protocol='tcp', remote_ip_prefix='0.0.0.0/0', tenant_id='e918a13fed2648758175a15fac083569', updated_at='2022-09-21T15:25:22Z'                               |
    >   |                 | created_at='2022-09-21T16:32:10Z', direction='ingress', ethertype='IPv4', id='77a0adb4-8a96-4167-83ed-92b40a509f42', port_range_max='80', port_range_min='80', protocol='tcp', remote_group_id='f2442464-3a6d-487c-a27e-1ab74c9c2110', tenant_id='e918a13fed2648758175a15fac083569', updated_at='2022-09-21T16:32:10Z'     |
    >   |                 | created_at='2022-09-21T16:32:17Z', direction='ingress', ethertype='IPv4', id='9dbf9ce4-3b1e-465f-9a21-235597e7457a', protocol='tcp', remote_group_id='30ce01c5-97b5-4493-b3f9-fc27f9a0675c', tenant_id='e918a13fed2648758175a15fac083569', updated_at='2022-09-21T16:32:17Z'                                               |
    >   |                 | created_at='2022-09-21T15:25:11Z', direction='egress',  ethertype='IPv6', id='a01c713c-89eb-4cfc-b9bd-86db73a66bb7', tenant_id='e918a13fed2648758175a15fac083569', updated_at='2022-09-21T15:25:11Z'                                                                                                                        |
    >   |                 | created_at='2022-09-21T15:25:11Z', direction='egress',  ethertype='IPv4', id='a6fbf83a-96f2-4546-9a16-cc3a60f80759', tenant_id='e918a13fed2648758175a15fac083569', updated_at='2022-09-21T15:25:11Z'                                                                                                                        |
    >   |                 | created_at='2022-09-21T16:32:06Z', direction='ingress', ethertype='IPv4', id='bb294d0a-aa75-4665-8aae-fb5ddfe34c8b', port_range_max='8080', port_range_min='8080', protocol='tcp', remote_group_id='f2442464-3a6d-487c-a27e-1ab74c9c2110', tenant_id='e918a13fed2648758175a15fac083569', updated_at='2022-09-21T16:32:06Z' |
    >   |                 | created_at='2022-09-21T15:25:33Z', direction='ingress', ethertype='IPv6', id='e6d73c37-7a1b-4324-93b0-d050bfcf9559', port_range_max='443', port_range_min='443', protocol='tcp', remote_ip_prefix='::/0', tenant_id='e918a13fed2648758175a15fac083569', updated_at='2022-09-21T15:25:33Z'                                  |
    >   |                 | created_at='2022-09-21T15:25:29Z', direction='ingress', ethertype='IPv4', id='e9dbbd2c-453e-4db2-bde5-5ab41ba2f3dd', port_range_max='443', port_range_min='443', protocol='tcp', remote_ip_prefix='0.0.0.0/0', tenant_id='e918a13fed2648758175a15fac083569', updated_at='2022-09-21T15:25:29Z'                             |
    >   |                 | created_at='2022-09-21T15:25:19Z', direction='ingress', ethertype='IPv6', id='f19f1414-cefd-4634-8a42-a98195f0be1f', port_range_max='22', port_range_min='22', protocol='tcp', remote_ip_prefix='::/0', tenant_id='e918a13fed2648758175a15fac083569', updated_at='2022-09-21T15:25:19Z'                                    |
    >   |                 | created_at='2022-09-21T15:25:26Z', direction='ingress', ethertype='IPv6', id='fc035452-c913-43fd-9146-7d7677d01bb7', port_range_max='80', port_range_min='80', protocol='tcp', remote_ip_prefix='::/0', tenant_id='e918a13fed2648758175a15fac083569', updated_at='2022-09-21T15:25:26Z'                                    |
    >   | stateful        | None                                                                                                                                                                                                                                                                                                                       |
    >   | tags            | []                                                                                                                                                                                                                                                                                                                         |
    >   | updated_at      | 2022-09-21T16:32:31Z                                                                                                                                                                                                                                                                                                       |
    >   +-----------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+


    openstack \
        --os-cloud "${cloudname:?}" \
        security group rule list \
            'f2442464-3a6d-487c-a27e-1ab74c9c2110'

    >   +--------------------------------------+-------------+-----------+-----------+------------+-----------+--------------------------------------+----------------------+
    >   | ID                                   | IP Protocol | Ethertype | IP Range  | Port Range | Direction | Remote Security Group                | Remote Address Group |
    >   +--------------------------------------+-------------+-----------+-----------+------------+-----------+--------------------------------------+----------------------+
    >   | 02b0d061-ac99-44fe-b64b-36ef4967d217 | tcp         | IPv4      | 0.0.0.0/0 |            | ingress   | 1f94b75b-e4cf-404e-ac02-658dd047d279 | None                 |
    >   | 29d29bfe-a126-4d23-ab74-6df292cd3b87 | tcp         | IPv4      | 0.0.0.0/0 | 443:443    | ingress   | f2442464-3a6d-487c-a27e-1ab74c9c2110 | None                 |
    >   | 541cb99a-89db-4e1e-b91f-90f570360fcb | tcp         | IPv4      | 0.0.0.0/0 | 22:22      | ingress   | None                                 | None                 |
    >   | 5fcc53ac-28c3-47c5-8fd7-753f353ef5b0 | tcp         | IPv4      | 0.0.0.0/0 | 9100:9100  | ingress   | 149ded1c-60f3-4010-b0a2-7c2a298ab75e | None                 |
    >   | 69209971-0305-4c8e-a2d0-08e3baf8d2e9 | tcp         | IPv4      | 0.0.0.0/0 | 80:80      | ingress   | None                                 | None                 |
    >   | 77a0adb4-8a96-4167-83ed-92b40a509f42 | tcp         | IPv4      | 0.0.0.0/0 | 80:80      | ingress   | f2442464-3a6d-487c-a27e-1ab74c9c2110 | None                 |
    >   | 9dbf9ce4-3b1e-465f-9a21-235597e7457a | tcp         | IPv4      | 0.0.0.0/0 |            | ingress   | 30ce01c5-97b5-4493-b3f9-fc27f9a0675c | None                 |
    >   | a01c713c-89eb-4cfc-b9bd-86db73a66bb7 | None        | IPv6      | ::/0      |            | egress    | None                                 | None                 |
    >   | a6fbf83a-96f2-4546-9a16-cc3a60f80759 | None        | IPv4      | 0.0.0.0/0 |            | egress    | None                                 | None                 |
    >   | bb294d0a-aa75-4665-8aae-fb5ddfe34c8b | tcp         | IPv4      | 0.0.0.0/0 | 8080:8080  | ingress   | f2442464-3a6d-487c-a27e-1ab74c9c2110 | None                 |
    >   | e6d73c37-7a1b-4324-93b0-d050bfcf9559 | tcp         | IPv6      | ::/0      | 443:443    | ingress   | None                                 | None                 |
    >   | e9dbbd2c-453e-4db2-bde5-5ab41ba2f3dd | tcp         | IPv4      | 0.0.0.0/0 | 443:443    | ingress   | None                                 | None                 |
    >   | f19f1414-cefd-4634-8a42-a98195f0be1f | tcp         | IPv6      | ::/0      | 22:22      | ingress   | None                                 | None                 |
    >   | fc035452-c913-43fd-9146-7d7677d01bb7 | tcp         | IPv6      | ::/0      | 80:80      | ingress   | None                                 | None                 |
    >   +--------------------------------------+-------------+-----------+-----------+------------+-----------+--------------------------------------+----------------------+


    openstack \
        --os-cloud "${cloudname:?}" \
        security group rule create \
            --ingress \
            --protocol 'tcp' \
            --dst-port '8080:8080' \
            'f2442464-3a6d-487c-a27e-1ab74c9c2110'

    >   +-------------------------+--------------------------------------+
    >   | Field                   | Value                                |
    >   +-------------------------+--------------------------------------+
    >   | created_at              | 2022-09-22T04:23:09Z                 |
    >   | description             |                                      |
    >   | direction               | ingress                              |
    >   | ether_type              | IPv4                                 |
    >   | id                      | 211b9ac9-3407-4dea-8e1e-d6aef603a9ae |
    >   | name                    | None                                 |
    >   | port_range_max          | 8080                                 |
    >   | port_range_min          | 8080                                 |
    >   | project_id              | e918a13fed2648758175a15fac083569     |
    >   | protocol                | tcp                                  |
    >   | remote_address_group_id | None                                 |
    >   | remote_group_id         | None                                 |
    >   | remote_ip_prefix        | 0.0.0.0/0                            |
    >   | revision_number         | 0                                    |
    >   | security_group_id       | f2442464-3a6d-487c-a27e-1ab74c9c2110 |
    >   | tags                    | []                                   |
    >   | tenant_id               | e918a13fed2648758175a15fac083569     |
    >   | updated_at              | 2022-09-22T04:23:09Z                 |
    >   +-------------------------+--------------------------------------+


# -----------------------------------------------------
# Setup a SSH tunnel SOCKS proxy.
# https://unix.stackexchange.com/questions/34004/how-does-tcp-keepalive-work-in-ssh
# https://unix.stackexchange.com/a/34201
#[root@ansibler]

    ssh \
        -n \
        -f \
        -N \
        -D '*:3000' \
        -o ServerAliveInterval=10 \
        -o ServerAliveCountMax=12 \
        zeppelin

    >   ....
    >   ....


# -----------------------------------------------------
# Create a test user.
#[root@ansibler]

    source /deployments/zeppelin/bin/create-user-tools.sh

    username=$(pwgen 16 1)

    createusermain "${username}" \
    | tee "/tmp/${username}.json" \
    | jq '.shirouser | {"username": .name, "password": .password}'

    >   {
    >     "username": "Iesiu8chooFooghi",
    >     "password": "unrivaled carwash shifter badly"
    >   }


# -----------------------------------------------------
# Login and list notebooks the user can see.
#[root@ansibler]

    password=$(
        jq -r '.shirouser.password' "/tmp/${username}.json"
        )

    zeppelinurl=http://zeppelin:8080
    zepcookies=/tmp/${username:?}.cookies

    curl \
        --silent \
        --request 'POST' \
        --cookie-jar "${zepcookies:?}" \
        --data "userName=${username:?}" \
        --data "password=${password:?}" \
        "${zeppelinurl:?}/api/login" \
    | jq '.'

    >   {
    >     "status": "OK",
    >     "message": "",
    >     "body": {
    >       "principal": "Iesiu8chooFooghi",
    >       "ticket": "112ab4aa-7cc3-4004-a367-da28145477c5",
    >       "roles": "[]"
    >     }
    >   }


    curl \
        --silent \
        --cookie "${zepcookies:?}" \
        "${zeppelinurl:?}/api/notebook" \
    | jq '.'

    >   {
    >     "status": "OK",
    >     "message": "",
    >     "body": [
    >       {
    >         "id": "2GRTQZFUM",
    >         "path": "/Public Examples/1. Start here"
    >       },
    >       {
    >         "id": "2GRA39HCN",
    >         "path": "/Public Examples/2. Data holdings"
    >       },
    >       {
    >         "id": "2GQ6WMH9W",
    >         "path": "/Public Examples/3. Source counts over the sky"
    >       },
    >       {
    >         "id": "2GSNYBDWB",
    >         "path": "/Public Examples/4. Mean proper motions over the sky"
    >       },
    >       {
    >         "id": "2H2YRJCKM",
    >         "path": "/Public Examples/5. Working with Gaia XP spectra"
    >       },
    >       {
    >         "id": "2GZME59KY",
    >         "path": "/Public Examples/6. Working with cross-matched surveys"
    >       },
    >       {
    >         "id": "2GQDKZ59J",
    >         "path": "/Public Examples/7. Good astrometric solutions via ML Random Forest classifier"
    >       },
    >       {
    >         "id": "2GVXKC266",
    >         "path": "/Public Examples/8. Tips and tricks"
    >       }
    >     ]
    >   }

    #
    # Just the public examples.
    #


# -----------------------------------------------------
# Try adding the user's own notebooks.
#[root@ansibler]

    source /deployments/zeppelin/bin/create-user-tools.sh

    cloneusernotebooks \
        "${username}" \
        'test' \
        "${password}"

    >   File [*.zpln]
    >   Name []
    >   Path [/Iesiu8chooFooghi/examples/]
    >   jq: error: Could not open file *.zpln: No such file or directory
    >   curl: no URL specified!
    >   curl: try 'curl --help' or 'curl --manual' for more information
    >   {
    >   "user": "Iesiu8chooFooghi",
    >   "debug": {
    >       "script": "clone-notebooks.sh",
    >       "result": "FAIL",
    >       "messages": [
    >           "PASS: Login [Iesiu8chooFooghi] done",
    >           "FAIL: git clone [https://github.com/wfau/aglais-notebooks] failed","fatal: could not create work tree dir 'aglais-notebooks': Permission denied",
    >           "FAIL: pushd [/opt/aglais/aglais-notebooks] failed","/opt/aglais/bin/json-tools.sh: line 140: pushd: /opt/aglais/aglais-notebooks: No such file or directory",
    >           "FAIL: git checkout [v1.0.1] failed","fatal: not a git repository (or any of the parent directories): .git",
    >           "FAIL: pushd [Public Examples] failed","/opt/aglais/bin/json-tools.sh: line 140: pushd: Public Examples: No such file or directory",
    >           "FAIL: Import failed - error code [127]","/opt/aglais/bin/clone-notebooks.sh: line 196: http://localhost:8080/api/notebook/import: No such file or directory",
    >           "FAIL: pushd [] failed","/opt/aglais/bin/json-tools.sh: line 150: popd: directory stack empty",
    >           "FAIL: pushd [] failed","/opt/aglais/bin/json-tools.sh: line 150: popd: directory stack empty"]
    >       }
    >   }

# -----------------------------------------------------
# Local bug fixes and rsync push.
#[root@ansibler]

    sudo dnf install -y rsync

    rsync --rsync-path="sudo rsync" \
        --stats \
        --progress \
        --checksum \
        --recursive \
        --human-readable \
        /deployments/aglais/bin/ \
        zeppelin:/opt/aglais/bin

    >   ....
    >   clone-notebooks.sh
    >             7.48K 100%    6.47MB/s    0:00:00 (xfr#1, to-chk=6/9)
    >   json-tools.sh
    >             3.81K 100%    3.63MB/s    0:00:00 (xfr#2, to-chk=1/9)
    >   ....

    #
    # Lots of iterations fixing fragile code.
    # Spaces in the notebook names complicates everything.
    #


# -----------------------------------------------------
# Create a new test user.
#[root@ansibler]

    source /deployments/zeppelin/bin/create-user-tools.sh

    username=$(pwgen 16 1)

    createusermain "${username}" \
    | tee "/tmp/${username}.json" \
    | jq '.shirouser | {"username": .name, "password": .password}'

    >   {
    >     "username": "fai3Weegh2fo9Yae",
    >     "password": "unsorted coastland pasty backwater"
    >   }


# -----------------------------------------------------
# Login and list notebooks the user can see.
#[root@ansibler]

    password=$(
        jq -r '.shirouser.password' "/tmp/${username}.json"
        )

    zeppelinurl=http://zeppelin:8080
    zepcookies=/tmp/${username:?}.cookies

    curl \
        --silent \
        --request 'POST' \
        --cookie-jar "${zepcookies:?}" \
        --data "userName=${username:?}" \
        --data "password=${password:?}" \
        "${zeppelinurl:?}/api/login" \
    | jq '.'

    >   {
    >     "status": "OK",
    >     "message": "",
    >     "body": {
    >       "principal": "fai3Weegh2fo9Yae",
    >       "ticket": "d766709d-1519-4f64-b432-125c9de10015",
    >       "roles": "[]"
    >     }
    >   }


    curl \
        --silent \
        --cookie "${zepcookies:?}" \
        "${zeppelinurl:?}/api/notebook" \
    | jq '.'

    >   {
    >     "status": "OK",
    >     "message": "",
    >     "body": [
    >       {
    >         "id": "2GRTQZFUM",
    >         "path": "/Public Examples/1. Start here"
    >       },
    >       {
    >         "id": "2GRA39HCN",
    >         "path": "/Public Examples/2. Data holdings"
    >       },
    >       {
    >         "id": "2GQ6WMH9W",
    >         "path": "/Public Examples/3. Source counts over the sky"
    >       },
    >       {
    >         "id": "2GSNYBDWB",
    >         "path": "/Public Examples/4. Mean proper motions over the sky"
    >       },
    >       {
    >         "id": "2H2YRJCKM",
    >         "path": "/Public Examples/5. Working with Gaia XP spectra"
    >       },
    >       {
    >         "id": "2GZME59KY",
    >         "path": "/Public Examples/6. Working with cross-matched surveys"
    >       },
    >       {
    >         "id": "2GQDKZ59J",
    >         "path": "/Public Examples/7. Good astrometric solutions via ML Random Forest classifier"
    >       },
    >       {
    >         "id": "2GVXKC266",
    >         "path": "/Public Examples/8. Tips and tricks"
    >       }
    >     ]
    >   }

    #
    # Just the public examples.
    #

# -----------------------------------------------------
# Try adding the user's own examples.
#[root@ansibler]

    source /deployments/zeppelin/bin/create-user-tools.sh

    cloneusernotebooks \
        "${username}" \
        'test' \
        "${password}" \
    | tee "/tmp/${username}-clone.log" \
    jq '.'

    >   {
    >   "user": "fai3Weegh2fo9Yae",
    >   "debug": {
    >       "script": "clone-notebooks.sh",
    >       "result": "FAIL",
    >       "messages": [
    >           "PASS: Login [fai3Weegh2fo9Yae] done",
    >           "FAIL: git pull [https://github.com/wfau/aglais-notebooks] failed",
    >           "You are not currently on a branch.",
    >           "Please specify which branch you want to merge with.",
    >           "See git-pull(1) for details.",
    >           "",
    >           "    git pull <remote> <branch>",
    >           "",
    >           "PASS: Importing [Public Examples/1. Start here_2GRTQZFUM.zpln] as [/fai3Weegh2fo9Yae/examples/1. Start here]",
    >           "FAIL: Import failed - exception [IOException] ",
    >           "PASS: Importing [Public Examples/2. Data holdings_2GRA39HCN.zpln] as [/fai3Weegh2fo9Yae/examples/2. Data holdings]",
    >           "FAIL: Import failed - exception [IOException] ",
    >           "PASS: Importing [Public Examples/3. Source counts over the sky_2GQ6WMH9W.zpln] as [/fai3Weegh2fo9Yae/examples/3. Source counts over the sky]",
    >           "FAIL: Import failed - exception [IOException] ",
    >           "PASS: Importing [Public Examples/4. Mean proper motions over the sky_2GSNYBDWB.zpln] as [/fai3Weegh2fo9Yae/examples/4. Mean proper motions over the sky]",
    >           "FAIL: Import failed - exception [IOException] ",
    >           "PASS: Importing [Public Examples/5. Working with Gaia XP spectra_2H2YRJCKM.zpln] as [/fai3Weegh2fo9Yae/examples/5. Working with Gaia XP spectra]",
    >           "FAIL: Import failed - exception [IOException] ",
    >           "PASS: Importing [Public Examples/6. Working with cross-matched surveys_2GZME59KY.zpln] as [/fai3Weegh2fo9Yae/examples/6. Working with cross-matched surveys]",
    >           "FAIL: Import failed - exception [IOException] ",
    >           "PASS: Importing [Public Examples/7. Good astrometric solutions via ML Random Forest classifier_2GQDKZ59J.zpln] as [/fai3Weegh2fo9Yae/examples/7. Good astrometric solutions via ML Random Forest classifier]",
    >           "FAIL: Import failed - exception [IOException] ",
    >           "PASS: Importing [Public Examples/8. Tips and tricks_2GVXKC266.zpln] as [/fai3Weegh2fo9Yae/examples/8. Tips and tricks]",
    >           "FAIL: Import failed - exception [IOException] "
    >           ]
    >       }
    >   }

    #
    # FAIL message deosn't really help much.
    #   "FAIL: Import failed - exception [IOException] "
    #
    # Check the server side logs ..
    #

# -----------------------------------------------------
# Check the server side logs.
#[user@zeppelin]

    pushd /home/fedora/zeppelin/logs

        tail -f zeppelin-fedora-iris-gaia-blue-20220921-zeppelin.log

    >   ....
    >   WARN [2022-09-22 13:30:11,223] ({qtp686466458-6915} SimpleServiceCallback.java[onFailure]:50) - Fail to import note: Note '/1. Start here' existed, cause: Note '/1. Start here' existed
    >   ....

    #
    # Looking at the top level notebook directory, we do indeed see the same notebooks.
    # Probably from a previous import.
    # ** users are able to import notebooks to the top level !!
    #

    #
    # Confirmation:
    # This user can't see any notebooks in the GUI.
    # Logut and login as the previous user, and they can see the examples
    # imported at the top level.
    #

    #
    # OMG - the REST API import method doesn't have a 'path' parameter.
    # It dumps the new notebook at the top level regardless.
    # Seems to be getting the 'name' from the notebook, but not the path ?
    #

    #
    # So we need to make a copy of the notebook, replacing the name with the full path
    # before we pass it to curl to upload ...
    #

    #
    # We are wasting so much time on this ..
    #


# -----------------------------------------------------
# Local edit to add jq filtering and rsync push.
#[root@ansibler]

    #
    # Add jq filter to set notebook name
    # ....
    #

    rsync --rsync-path="sudo rsync" \
        --stats \
        --progress \
        --checksum \
        --recursive \
        --human-readable \
        /deployments/aglais/bin/ \
        zeppelin:/opt/aglais/bin

    >   ....
    >   clone-notebooks.sh
    >             8.28K 100%    7.23MB/s    0:00:00 (xfr#1, to-chk=6/9)
    >   ....


# -----------------------------------------------------
# Create a new test user.
#[root@ansibler]

    source /deployments/zeppelin/bin/create-user-tools.sh

    username=$(pwgen 16 1)

    createusermain "${username}" \
    | tee "/tmp/${username}.json" \
    | jq '.shirouser | {"username": .name, "password": .password}'

    >   {
    >     "username": "Eidai3eiG9ohng7i",
    >     "password": "subsiding emphases rimmed scuff"
    >   }


# -----------------------------------------------------
# Login and list notebooks the user can see.
#[root@ansibler]

    password=$(
        jq -r '.shirouser.password' "/tmp/${username}.json"
        )

    zeppelinurl=http://zeppelin:8080
    zepcookies=/tmp/${username:?}.cookies

    curl \
        --silent \
        --request 'POST' \
        --cookie-jar "${zepcookies:?}" \
        --data "userName=${username:?}" \
        --data "password=${password:?}" \
        "${zeppelinurl:?}/api/login" \
    | jq '.'

    >   {
    >     "status": "OK",
    >     "message": "",
    >     "body": {
    >       "principal": "Eidai3eiG9ohng7i",
    >       "ticket": "cd87b90b-6eb6-40f0-8600-d245abeaf31a",
    >       "roles": "[]"
    >     }
    >   }


    curl \
        --silent \
        --cookie "${zepcookies:?}" \
        "${zeppelinurl:?}/api/notebook" \
    | jq '.'

    >   {
    >     "status": "OK",
    >     "message": "",
    >     "body": [
    >       {
    >         "id": "2GRTQZFUM",
    >         "path": "/Public Examples/1. Start here"
    >       },
    >       {
    >         "id": "2GRA39HCN",
    >         "path": "/Public Examples/2. Data holdings"
    >       },
    >       {
    >         "id": "2GQ6WMH9W",
    >         "path": "/Public Examples/3. Source counts over the sky"
    >       },
    >       {
    >         "id": "2GSNYBDWB",
    >         "path": "/Public Examples/4. Mean proper motions over the sky"
    >       },
    >       {
    >         "id": "2H2YRJCKM",
    >         "path": "/Public Examples/5. Working with Gaia XP spectra"
    >       },
    >       {
    >         "id": "2GZME59KY",
    >         "path": "/Public Examples/6. Working with cross-matched surveys"
    >       },
    >       {
    >         "id": "2GQDKZ59J",
    >         "path": "/Public Examples/7. Good astrometric solutions via ML Random Forest classifier"
    >       },
    >       {
    >         "id": "2GVXKC266",
    >         "path": "/Public Examples/8. Tips and tricks"
    >       }
    >     ]
    >   }

    #
    # Just the public examples.
    #

# -----------------------------------------------------
# Try adding the user's own examples.
#[root@ansibler]

    source /deployments/zeppelin/bin/create-user-tools.sh

    cloneusernotebooks \
        "${username}" \
        'test' \
        "${password}" \
    | tee "/tmp/${username}-clone.log" \
    jq '.'


    >   tee: .: Is a directory
    >   {
    >   "user": "Eidai3eiG9ohng7i",
    >   "debug": {
    >       "script": "clone-notebooks.sh",
    >       "result": "FAIL",
    >       "messages": ["PASS: Login [Eidai3eiG9ohng7i] done",
    >   "FAIL: git pull [https://github.com/wfau/aglais-notebooks] failed",
    >       "You are not currently on a branch.",
    >       "Please specify which branch you want to merge with.",
    >       "See git-pull(1) for details.",
    >       "",
    >       "    git pull <remote> <branch>",
    >       "",
    >   "PASS: jq filter [Public Examples/1. Start here_2GRTQZFUM.zpln] to [/tmp/tmp.doDAxkoqCJ.zpln]",
    >   "FAIL: jq filter [Public Examples/1. Start here_2GRTQZFUM.zpln] to [/tmp/tmp.doDAxkoqCJ.zpln] failed",
    >       "jq: error: syntax error, unexpected $end, expecting QQSTRING_TEXT or QQSTRING_INTERP_START or QQSTRING_END (Unix shell quoting issues?) at <top-level>, line 2:",
    >       "                                .name=\"//Eidai3eiG9ohng7i/examples/examples/1.                                       ",
    >       "jq: 1 compile error",
    >   "PASS: Importing [/tmp/tmp.doDAxkoqCJ.zpln] as [//Eidai3eiG9ohng7i/examples/examples/1. Start here]",
    >   "FAIL: Import failed - exception [IOException] ",
    >   ....
    >   ....


# -----------------------------------------------------
# Local edit to fix jq filtering and rsync push.
#[root@ansibler]

    #
    # Fix jq filter ....
    #

    rsync --rsync-path="sudo rsync" \
        --stats \
        --progress \
        --checksum \
        --recursive \
        --human-readable \
        /deployments/aglais/bin/ \
        zeppelin:/opt/aglais/bin

    >   ....
    >   clone-notebooks.sh
    >             8.28K 100%    7.23MB/s    0:00:00 (xfr#1, to-chk=6/9)
    >   ....


# -----------------------------------------------------
# Create a new test user.
#[root@ansibler]

    source /deployments/zeppelin/bin/create-user-tools.sh

    username=$(pwgen 16 1)

    createusermain "${username}" \
    | tee "/tmp/${username}.json" \
    | jq '.shirouser | {"username": .name, "password": .password}'

    >   {
    >     "username": "Aemomiquai2caegh",
    >     "password": "unruly celibacy easel altitude"
    >   }


# -----------------------------------------------------
# Login as the new user.
#[root@ansibler]

    password=$(
        jq -r '.shirouser.password' "/tmp/${username}.json"
        )

    zeppelinurl=http://zeppelin:8080
    zepcookies=/tmp/${username:?}.cookies

    curl \
        --silent \
        --request 'POST' \
        --cookie-jar "${zepcookies:?}" \
        --data "userName=${username:?}" \
        --data "password=${password:?}" \
        "${zeppelinurl:?}/api/login" \
    | jq '.'

    >   {
    >     "status": "OK",
    >     "message": "",
    >     "body": {
    >       "principal": "Aemomiquai2caegh",
    >       "ticket": "344ff6fb-753f-4c78-bcc2-9c9306eb29b3",
    >       "roles": "[]"
    >     }
    >   }


# -----------------------------------------------------
# Try adding the user's examples.
#[root@ansibler]

    source /deployments/zeppelin/bin/create-user-tools.sh

    cloneusernotebooks \
        "${username}" \
        'test' \
        "${password}" \
    | tee "/tmp/${username}-clone.log" \
    | jq '.'

    >   {
    >     "user": "Aemomiquai2caegh",
    >     "debug": {
    >       "script": "clone-notebooks.sh",
    >       "result": "FAIL",
    >       "messages": [
    >         "PASS: Login [Aemomiquai2caegh] done",
    >         "FAIL: git pull [https://github.com/wfau/aglais-notebooks] failed",
    >         "You are not currently on a branch.",
    >         "Please specify which branch you want to merge with.",
    >         "See git-pull(1) for details.",
    >         "",
    >         "    git pull <remote> <branch>",
    >         "",
    >         "PASS: jq filter [Public Examples/1. Start here_2GRTQZFUM.zpln] to [/tmp/tmp.uG8Q1W5UWZ.zpln]",
    >         "PASS: Importing [/tmp/tmp.uG8Q1W5UWZ.zpln] as [/Aemomiquai2caegh/examples/1. Start here]",
    >         "PASS: Imported [Public Examples/1. Start here_2GRTQZFUM.zpln] as [/Aemomiquai2caegh/examples/1. Start here]",
    >         "PASS: jq filter [Public Examples/2. Data holdings_2GRA39HCN.zpln] to [/tmp/tmp.PmoT9tbWEW.zpln]",
    >         "PASS: Importing [/tmp/tmp.PmoT9tbWEW.zpln] as [/Aemomiquai2caegh/examples/2. Data holdings]",
    >         "FAIL: Import failed - exception [IOException] ",
    >         "PASS: jq filter [Public Examples/3. Source counts over the sky_2GQ6WMH9W.zpln] to [/tmp/tmp.9Pgz9eiEwP.zpln]",
    >         "PASS: Importing [/tmp/tmp.9Pgz9eiEwP.zpln] as [/Aemomiquai2caegh/examples/3. Source counts over the sky]",
    >         "FAIL: Import failed - exception [IOException] ",
    >         "PASS: jq filter [Public Examples/4. Mean proper motions over the sky_2GSNYBDWB.zpln] to [/tmp/tmp.mVyz0OH7kr.zpln]",
    >         "PASS: Importing [/tmp/tmp.mVyz0OH7kr.zpln] as [/Aemomiquai2caegh/examples/4. Mean proper motions over the sky]",
    >         "FAIL: Import failed - exception [IOException] ",
    >         "PASS: jq filter [Public Examples/5. Working with Gaia XP spectra_2H2YRJCKM.zpln] to [/tmp/tmp.EvYjSu058d.zpln]",
    >         "PASS: Importing [/tmp/tmp.EvYjSu058d.zpln] as [/Aemomiquai2caegh/examples/5. Working with Gaia XP spectra]",
    >         "FAIL: Import failed - exception [IOException] ",
    >         "PASS: jq filter [Public Examples/6. Working with cross-matched surveys_2GZME59KY.zpln] to [/tmp/tmp.IFxPqYMe3J.zpln]",
    >         "PASS: Importing [/tmp/tmp.IFxPqYMe3J.zpln] as [/Aemomiquai2caegh/examples/6. Working with cross-matched surveys]",
    >         "FAIL: Import failed - exception [IOException] ",
    >         "PASS: jq filter [Public Examples/7. Good astrometric solutions via ML Random Forest classifier_2GQDKZ59J.zpln] to [/tmp/tmp.ul0qe9LMvz.zpln]",
    >         "PASS: Importing [/tmp/tmp.ul0qe9LMvz.zpln] as [/Aemomiquai2caegh/examples/7. Good astrometric solutions via ML Random Forest classifier]",
    >         "FAIL: Import failed - exception [IOException] ",
    >         "PASS: jq filter [Public Examples/8. Tips and tricks_2GVXKC266.zpln] to [/tmp/tmp.RJ99CaiZCu.zpln]",
    >         "PASS: Importing [/tmp/tmp.RJ99CaiZCu.zpln] as [/Aemomiquai2caegh/examples/8. Tips and tricks]",
    >         "FAIL: Import failed - exception [IOException] "
    >       ]
    >     }
    >   }

    #
    # Fixed the problem with git pull.
    # The release tag results in detached head, where pull doesn't work.
    # Need to step back to main to do the pull.
    #

    #
    # Check the server side logs, lokks like jq isn't replacing the argument correctly.
    #

    >   ....
    >   Caused by: java.io.IOException: Fail to import note: Note '/$path' existed
    >   ....

    #
    # Fixed the jq arg replacement (quotes).
    #

# -----------------------------------------------------
# Upload the changes.
#[root@ansibler]

    rsync --rsync-path="sudo rsync" \
        --stats \
        --progress \
        --checksum \
        --recursive \
        --human-readable \
        /deployments/aglais/bin/ \
        zeppelin:/opt/aglais/bin

    >   ....
    >   ....

# -----------------------------------------------------
# Create a new test user.
#[root@ansibler]

    source /deployments/zeppelin/bin/create-user-tools.sh

    username=$(pwgen 16 1)

    createusermain "${username}" \
    | tee "/tmp/${username}.json" \
    | jq '.shirouser | {"username": .name, "password": .password}'

    >   {
    >     "username": "phaihaB0eiF9fee4",
    >     "password": "marvelous flavoring immobile paver"
    >   }


# -----------------------------------------------------
# Login as the new user.
#[root@ansibler]

    password=$(
        jq -r '.shirouser.password' "/tmp/${username}.json"
        )

    zeppelinurl=http://zeppelin:8080
    zepcookies=/tmp/${username:?}.cookies

    curl \
        --silent \
        --request 'POST' \
        --cookie-jar "${zepcookies:?}" \
        --data "userName=${username:?}" \
        --data "password=${password:?}" \
        "${zeppelinurl:?}/api/login" \
    | jq '.'

    >   {
    >     "status": "OK",
    >     "message": "",
    >     "body": {
    >       "principal": "phaihaB0eiF9fee4",
    >       "ticket": "73766988-02a0-4290-b5a7-2a48ac73fdff",
    >       "roles": "[]"
    >     }
    >   }


# -----------------------------------------------------
# Try adding the user's examples.
#[root@ansibler]

    source /deployments/zeppelin/bin/create-user-tools.sh

    cloneusernotebooks \
        "${username}" \
        'test' \
        "${password}" \
    | tee "/tmp/${username}-clone.log" \
    | jq '.'

    >   {
    >     "user": "phaihaB0eiF9fee4",
    >     "debug": {
    >       "script": "clone-notebooks.sh",
    >       "result": "PASS",
    >       "messages": [
    >         "PASS: Login [phaihaB0eiF9fee4] done",
    >         "PASS: jq filter [Public Examples/1. Start here_2GRTQZFUM.zpln] to [/tmp/tmp.hkwkqjsXZL.zpln]",
    >         "PASS: Importing [/tmp/tmp.hkwkqjsXZL.zpln] as [/phaihaB0eiF9fee4/examples/1. Start here]",
    >         "PASS: Imported [Public Examples/1. Start here_2GRTQZFUM.zpln] as [/phaihaB0eiF9fee4/examples/1. Start here]",
    >         "PASS: jq filter [Public Examples/2. Data holdings_2GRA39HCN.zpln] to [/tmp/tmp.TjrzaSMSgT.zpln]",
    >         "PASS: Importing [/tmp/tmp.TjrzaSMSgT.zpln] as [/phaihaB0eiF9fee4/examples/2. Data holdings]",
    >         "PASS: Imported [Public Examples/2. Data holdings_2GRA39HCN.zpln] as [/phaihaB0eiF9fee4/examples/2. Data holdings]",
    >         "PASS: jq filter [Public Examples/3. Source counts over the sky_2GQ6WMH9W.zpln] to [/tmp/tmp.nsk4jIa3HZ.zpln]",
    >         "PASS: Importing [/tmp/tmp.nsk4jIa3HZ.zpln] as [/phaihaB0eiF9fee4/examples/3. Source counts over the sky]",
    >         "PASS: Imported [Public Examples/3. Source counts over the sky_2GQ6WMH9W.zpln] as [/phaihaB0eiF9fee4/examples/3. Source counts over the sky]",
    >         "PASS: jq filter [Public Examples/4. Mean proper motions over the sky_2GSNYBDWB.zpln] to [/tmp/tmp.RL3poUwOR0.zpln]",
    >         "PASS: Importing [/tmp/tmp.RL3poUwOR0.zpln] as [/phaihaB0eiF9fee4/examples/4. Mean proper motions over the sky]",
    >         "PASS: Imported [Public Examples/4. Mean proper motions over the sky_2GSNYBDWB.zpln] as [/phaihaB0eiF9fee4/examples/4. Mean proper motions over the sky]",
    >         "PASS: jq filter [Public Examples/5. Working with Gaia XP spectra_2H2YRJCKM.zpln] to [/tmp/tmp.Ofu2sQg33l.zpln]",
    >         "PASS: Importing [/tmp/tmp.Ofu2sQg33l.zpln] as [/phaihaB0eiF9fee4/examples/5. Working with Gaia XP spectra]",
    >         "PASS: Imported [Public Examples/5. Working with Gaia XP spectra_2H2YRJCKM.zpln] as [/phaihaB0eiF9fee4/examples/5. Working with Gaia XP spectra]",
    >         "PASS: jq filter [Public Examples/6. Working with cross-matched surveys_2GZME59KY.zpln] to [/tmp/tmp.hiVJ8Zp6Pg.zpln]",
    >         "PASS: Importing [/tmp/tmp.hiVJ8Zp6Pg.zpln] as [/phaihaB0eiF9fee4/examples/6. Working with cross-matched surveys]",
    >         "PASS: Imported [Public Examples/6. Working with cross-matched surveys_2GZME59KY.zpln] as [/phaihaB0eiF9fee4/examples/6. Working with cross-matched surveys]",
    >         "PASS: jq filter [Public Examples/7. Good astrometric solutions via ML Random Forest classifier_2GQDKZ59J.zpln] to [/tmp/tmp.agt1VCdpa7.zpln]",
    >         "PASS: Importing [/tmp/tmp.agt1VCdpa7.zpln] as [/phaihaB0eiF9fee4/examples/7. Good astrometric solutions via ML Random Forest classifier]",
    >         "PASS: Imported [Public Examples/7. Good astrometric solutions via ML Random Forest classifier_2GQDKZ59J.zpln] as [/phaihaB0eiF9fee4/examples/7. Good astrometric solutions via ML Random Forest classifier]",
    >         "PASS: jq filter [Public Examples/8. Tips and tricks_2GVXKC266.zpln] to [/tmp/tmp.wKrsadOm9Y.zpln]",
    >         "PASS: Importing [/tmp/tmp.wKrsadOm9Y.zpln] as [/phaihaB0eiF9fee4/examples/8. Tips and tricks]",
    >         "PASS: Imported [Public Examples/8. Tips and tricks_2GVXKC266.zpln] as [/phaihaB0eiF9fee4/examples/8. Tips and tricks]"
    >       ]
    >     }
    >   }

    #
    # Yay - first time run :-)
    #



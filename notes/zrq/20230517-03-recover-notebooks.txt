#
# <meta:header>
#   <meta:licence>
#     Copyright (c) 2023, ROE (http://www.roe.ac.uk/)
#
#     This information is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This information is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
#   </meta:licence>
# </meta:header>
#
#zrq-notes-time
#zrq-notes-indent
#zrq-notes-crypto
#zrq-notes-ansible
#zrq-notes-osformat
#zrq-notes-zeppelin
#
# AIMetrics: [{"name": "ChatGPT","contribution": {"value": 0,"units": "%"}}]
#


    Target:

        Test notebook recovery on a test system.

    Result:

        Work in progress ...

# -----------------------------------------------------

    My guess is we can fix this by re-installing the examples for each user using the create-user-tools script.
    https://github.com/wfau/gaia-dmp/blob/15ef8549aaa0a9064cfa399aa719b9772c46f8e1/deployments/zeppelin/bin/create-user-tools.sh#L163-L175

        username='AKrause'
        linuxuid=10012

        username='NWalton'
        linuxuid=10013

        username='HHeinl'
        linuxuid=10014

        username='ZWay'
        linuxuid=10015

        username='SSagear'
        linuxuid=10016

        username='MNizovkina'
        linuxuid=10017

        username='MLucey'
        linuxuid=10018

        username='CWorley'
        linuxuid=10019

        username='MFouesneau'
        linuxuid=10020

        username='SHodgkin'
        linuxuid=10021

        username='MVioque'
        linuxuid=10022


# -----------------------------------------------------
# Check which cloud is currently live.
#[user@desktop]

    ssh fedora@live.gaia-dmp.uk \
        '
        date
        hostname
        '

--START--
Thu 18 May 05:17:27 UTC 2023
iris-gaia-green-20230308-zeppelin
--END--


# -----------------------------------------------------
# Create a container to work with.
#[user@desktop]

    #
    # Live is green, selecting red for the deployment.
    #

    source "${HOME:?}/aglais.env"

    agcolour=red
    configname=zeppelin-54.86-spark-6.26.43

    agproxymap=3000:3000
    clientname=ansibler-${agcolour}
    cloudname=iris-gaia-${agcolour}

    podman run \
        --rm \
        --tty \
        --interactive \
        --name     "${clientname:?}" \
        --hostname "${clientname:?}" \
        --publish  "${agproxymap:?}" \
        --env "cloudname=${cloudname:?}" \
        --env "configname=${configname:?}" \
        --env "SSH_AUTH_SOCK=/mnt/ssh_auth_sock" \
        --volume "${SSH_AUTH_SOCK:?}:/mnt/ssh_auth_sock:rw,z" \
        --volume "${HOME:?}/clouds.yaml:/etc/openstack/clouds.yaml:ro,z" \
        --volume "${AGLAIS_CODE:?}/deployments:/deployments:ro,z" \
        ghcr.io/wfau/atolmis/ansible-client:2022.07.25 \
        bash

    >   ....
    >   ....


# -----------------------------------------------------
# Deploy everything.
#[root@ansibler]

    time \
        source /deployments/hadoop-yarn/bin/deploy.sh

--START--
....
....
--END--

--START--
....
....
--END--


# -----------------------------------------------------
# Create a test user.
#[root@ansibler]

    source /deployments/zeppelin/bin/create-user-tools.sh

    username=$(pwgen 16 1)

    createusermain "${username}" \
    | tee "/tmp/${username}.json" \
    | jq '.shirouser | {"username": .name, "password": .password}'

    password=$(
        jq -r '.shirouser.password' "/tmp/${username}.json"
        )

--START--
....
....
--END--


# -----------------------------------------------------
# Setup a SSH tunnel.
# https://linux.die.net/man/1/ssh
#[root@ansibler]

    ssh \
        -n \
        -f \
        -N \
        -L 8080:zeppelin:8080 \
        zeppelin

    zeppelinurl='http://localhost:8080'


# -----------------------------------------------------
# Run all the test user's examples.
#[root@ansibler]

    source /deployments/zeppelin/bin/zeppelin-rest-tools.sh

    testall \
        "${username:?}" \
        "${password:?}" \
    | tee "/tmp/${username}-testall.json" \
    | jq '.'

--START--
....
....
--END--

    #
    # No clue as to what causes the parse errors, logged it as an issue.
    # https://github.com/wfau/gaia-dmp/issues/1120
    #

    #
    # Check the execution times.
    #

    jq '
        .notebooks[].execute | {name, duration}
        ' "/tmp/${username}-testall.json"

--START--
....
....
--END--




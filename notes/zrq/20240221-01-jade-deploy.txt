#
# <meta:header>
#   <meta:licence>
#     Copyright (c) 2024, ROE (http://www.roe.ac.uk/)
#
#     This information is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This information is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
#   </meta:licence>
# </meta:header>
#
#zrq-notes-time
#zrq-notes-indent
#zrq-notes-crypto
#zrq-notes-ansible
#zrq-notes-osformat
#zrq-notes-zeppelin
#
# AIMetrics: []
#

    Target:

        Try a new deployment, keeping track of how long it takes to become healthy.

    Result:

        Deploy failed.
        Left it for 30hrs and still not resolved.


# -----------------------------------------------------
# Run our local client.
#[user@desktop]

    source "${HOME:?}/aglais.env"
    export PATH=${PATH}:${AGLAIS_CODE}/bin

    kube-client jade

    >   ....
    >   ....


# -----------------------------------------------------
# Delete and create everything.
#[root@ansibler]

    export cloudsite=somerville-jade

    /deployments/openstack/bin/delete-all.sh \
        "${cloudname:?}"

    ansible-playbook \
        --inventory 'bootstrap,' \
        '/deployments/cluster-api/ansible/00-create-all.yml'

    >   ....
    >   ....


# -----------------------------------------------------
# Check the deployment configuration.
#[root@ansibler]

    cat /opt/aglais/aglais-status.yml

    >   ....
    >   ....


# -----------------------------------------------------
# Check the cluster status.
#[root@ansibler]

    ssh bootstrap -t \
        '
        source loadconfig
        clusterctl \
            --kubeconfig "${kindclusterconf:?}" \
            describe cluster \
                --grouping=false \
                --show-conditions all \
                "${workclustername:?}"
        '

    >   NAME                                                                              READY  SEVERITY  REASON                                                                   SINCE  MESSAGE
    >   Cluster/somerville-jade-20240221-work                                             False  Warning   ScalingUp                                                                12m    Scaling up control plane to 3 replicas (actual 1)
    >   │           ├─ControlPlaneInitialized                                             True                                                                                      10m
    >   │           ├─ControlPlaneReady                                                   False  Warning   ScalingUp                                                                12m    Scaling up control plane to 3 replicas (actual 1)
    >   │           └─InfrastructureReady                                                 True                                                                                      13m
    >   ├─ClusterInfrastructure - OpenStackCluster/somerville-jade-20240221-work
    >   ├─ControlPlane - KubeadmControlPlane/somerville-jade-20240221-work-control-plane  False  Warning   ScalingUp                                                                12m    Scaling up control plane to 3 replicas (actual 1)
    >   │ │           ├─Available                                                         True                                                                                      10m
    >   │ │           ├─CertificatesAvailable                                             True                                                                                      13m
    >   │ │           ├─MachinesReady                                                     False  Warning   NodeStartupTimeout @ /somerville-jade-20240221-work-control-plane-bdfrr  52s    Node failed to report startup in 10m0s
    >   │ │           └─Resized                                                           False  Warning   ScalingUp                                                                12m    Scaling up control plane to 3 replicas (actual 1)
    >   │ └─Machine/somerville-jade-20240221-work-control-plane-bdfrr                     False  Warning   NodeStartupTimeout                                                       55s    Node failed to report startup in 10m0s
    >   │               ├─BootstrapReady                                                  True                                                                                      13m
    >   │               ├─HealthCheckSucceeded                                            False  Warning   NodeStartupTimeout                                                       55s    Node failed to report startup in 10m0s
    >   │               ├─InfrastructureReady                                             True                                                                                      12m
    >   │               ├─NodeHealthy                                                     False  Warning   NodeProvisioning                                                         10m
    >   │               └─OwnerRemediated                                                 False  Warning   WaitingForRemediation                                                    53s    KCP can't remediate if current replicas are less or equal to 1
    >   └─Workers
    >     └─MachineDeployment/somerville-jade-20240221-work-md-0                          False  Warning   WaitingForAvailableMachines                                              14m    Minimum availability requires 5 replicas, current 0 available
    >       │           └─Available                                                       False  Warning   WaitingForAvailableMachines                                              14m    Minimum availability requires 5 replicas, current 0 available
    >       ├─Machine/somerville-jade-20240221-work-md-0-bc4ps-jqcjp                      True                                                                                      14s
    >       │             ├─BootstrapReady                                                True                                                                                      27s
    >       │             ├─InfrastructureReady                                           True                                                                                      14s
    >       │             └─NodeHealthy                                                   False  Warning   NodeProvisioning                                                         13s
    >       ├─Machine/somerville-jade-20240221-work-md-0-bc4ps-sc5pc                      True                                                                                      17s
    >       │             ├─BootstrapReady                                                True                                                                                      29s
    >       │             ├─InfrastructureReady                                           True                                                                                      17s
    >       │             └─NodeHealthy                                                   False  Warning   NodeProvisioning                                                         16s
    >       ├─Machine/somerville-jade-20240221-work-md-0-bc4ps-sc5xt                      True                                                                                      14s
    >       │             ├─BootstrapReady                                                True                                                                                      26s
    >       │             ├─InfrastructureReady                                           True                                                                                      14s
    >       │             └─NodeHealthy                                                   False  Warning   NodeProvisioning                                                         14s
    >       ├─Machine/somerville-jade-20240221-work-md-0-bc4ps-spnmh                      True                                                                                      23s
    >       │             ├─BootstrapReady                                                True                                                                                      35s
    >       │             ├─InfrastructureReady                                           True                                                                                      23s
    >       │             └─NodeHealthy                                                   False  Warning   NodeProvisioning                                                         22s
    >       ├─Machine/somerville-jade-20240221-work-md-0-bc4ps-xccp4                      True                                                                                      11s
    >       │             ├─BootstrapReady                                                True                                                                                      24s
    >       │             ├─InfrastructureReady                                           True                                                                                      11s
    >       │             └─NodeHealthy                                                   False  Warning   NodeProvisioning                                                         10s
    >       └─Machine/somerville-jade-20240221-work-md-0-bc4ps-xmx67                      True                                                                                      18s
    >                     ├─BootstrapReady                                                True                                                                                      32s
    >                     ├─InfrastructureReady                                           True                                                                                      18s
    >                     └─NodeHealthy                                                   False  Warning   NodeProvisioning                                                         18s


# -----------------------------------------------------
# List our machines in Openstack.
#[root@ansibler]

    openstack \
        --os-cloud "${cloudname:?}" \
        server list

    >   +--------------------------------------+------------------------------------------------------------+--------+----------------------------------------------------------------------------+-----------------------------------+----------------+
    >   | ID                                   | Name                                                       | Status | Networks                                                                   | Image                             | Flavor         |
    >   +--------------------------------------+------------------------------------------------------------+--------+----------------------------------------------------------------------------+-----------------------------------+----------------+
    >   | 9930656b-57eb-4455-b697-5e135a55679a | somerville-jade-20240221-work-md-0-f538b732-x9gr9          | ACTIVE | k8s-clusterapi-cluster-default-somerville-jade-20240221-work=192.168.3.115 | gaia-dmp-ubuntu-2204-kube-v1.26.7 | gaia.vm.26vcpu |
    >   | b21a5408-3ceb-45de-89ff-ed50d2bdf2e3 | somerville-jade-20240221-work-md-0-f538b732-9cflr          | ACTIVE | k8s-clusterapi-cluster-default-somerville-jade-20240221-work=192.168.3.96  | gaia-dmp-ubuntu-2204-kube-v1.26.7 | gaia.vm.26vcpu |
    >   | eb4702e1-29d8-43f4-bfb5-b8da42edcc54 | somerville-jade-20240221-work-md-0-f538b732-s46n8          | ACTIVE | k8s-clusterapi-cluster-default-somerville-jade-20240221-work=192.168.3.39  | gaia-dmp-ubuntu-2204-kube-v1.26.7 | gaia.vm.26vcpu |
    >   | 0babc155-fc63-483b-8df2-e027cd751110 | somerville-jade-20240221-work-md-0-f538b732-6xkbt          | ACTIVE | k8s-clusterapi-cluster-default-somerville-jade-20240221-work=192.168.3.119 | gaia-dmp-ubuntu-2204-kube-v1.26.7 | gaia.vm.26vcpu |
    >   | d5d50923-dcbe-4d9f-958e-6991fb595d42 | somerville-jade-20240221-work-md-0-f538b732-ptksh          | ACTIVE | k8s-clusterapi-cluster-default-somerville-jade-20240221-work=192.168.3.31  | gaia-dmp-ubuntu-2204-kube-v1.26.7 | gaia.vm.26vcpu |
    >   | bd6abaff-27ad-4010-bba2-e78d29c94f6b | somerville-jade-20240221-work-md-0-f538b732-9x7bk          | ACTIVE | k8s-clusterapi-cluster-default-somerville-jade-20240221-work=192.168.3.191 | gaia-dmp-ubuntu-2204-kube-v1.26.7 | gaia.vm.26vcpu |
    >   | 073c0051-8805-4719-a589-3769c66339b1 | somerville-jade-20240221-work-control-plane-c6b6f2d1-f5k5w | ACTIVE | k8s-clusterapi-cluster-default-somerville-jade-20240221-work=192.168.3.176 | gaia-dmp-ubuntu-2204-kube-v1.26.7 | gaia.vm.2vcpu  |
    >   | 086da559-fea9-4875-aa79-53cc0dbe7011 | somerville-jade-20240221-bootstrap-node                    | ACTIVE | somerville-jade-20240221-bootstrap-network=10.10.2.166, 192.41.122.71      | gaia-dmp-fedora-cloud-38-1.6      | gaia.vm.2vcpu  |
    >   +--------------------------------------+------------------------------------------------------------+--------+----------------------------------------------------------------------------+-----------------------------------+----------------+


# -----------------------------------------------------
# List our machines in the KinD cluster.
#[root@ansibler]

    ssh bootstrap -t \
        '
        source loadconfig
        kubectl \
            --kubeconfig "${kindclusterconf:?}" \
            get machines \
                --all-namespaces
        '

    >   NAMESPACE   NAME                                                CLUSTER                         NODENAME   PROVIDERID                                          PHASE         AGE     VERSION
    >   default     somerville-jade-20240221-work-control-plane-bdfrr   somerville-jade-20240221-work              openstack:///073c0051-8805-4719-a589-3769c66339b1   Provisioned   19m     v1.26.7
    >   default     somerville-jade-20240221-work-md-0-bc4ps-jqcjp      somerville-jade-20240221-work              openstack:///eb4702e1-29d8-43f4-bfb5-b8da42edcc54   Provisioned   6m32s   v1.26.7
    >   default     somerville-jade-20240221-work-md-0-bc4ps-sc5pc      somerville-jade-20240221-work              openstack:///0babc155-fc63-483b-8df2-e027cd751110   Provisioned   6m34s   v1.26.7
    >   default     somerville-jade-20240221-work-md-0-bc4ps-sc5xt      somerville-jade-20240221-work              openstack:///b21a5408-3ceb-45de-89ff-ed50d2bdf2e3   Provisioned   6m31s   v1.26.7
    >   default     somerville-jade-20240221-work-md-0-bc4ps-spnmh      somerville-jade-20240221-work              openstack:///bd6abaff-27ad-4010-bba2-e78d29c94f6b   Provisioned   6m39s   v1.26.7
    >   default     somerville-jade-20240221-work-md-0-bc4ps-xccp4      somerville-jade-20240221-work              openstack:///9930656b-57eb-4455-b697-5e135a55679a   Provisioned   6m29s   v1.26.7
    >   default     somerville-jade-20240221-work-md-0-bc4ps-xmx67      somerville-jade-20240221-work              openstack:///d5d50923-dcbe-4d9f-958e-6991fb595d42   Provisioned   6m36s   v1.26.7


# -----------------------------------------------------
# List our nodes in the work cluster.
#[root@ansibler]

    ssh bootstrap -t \
        '
        source loadconfig
        kubectl \
            --kubeconfig "${workclusterconf:?}" \
            get nodes \
                --all-namespaces
        '

    >   E0221 07:03:35.168872   15478 memcache.go:287] couldn't get resource list for metrics.k8s.io/v1beta1: the server is currently unable to handle the request
    >   E0221 07:03:35.210309   15478 memcache.go:121] couldn't get resource list for metrics.k8s.io/v1beta1: the server is currently unable to handle the request
    >   E0221 07:03:35.220496   15478 memcache.go:121] couldn't get resource list for metrics.k8s.io/v1beta1: the server is currently unable to handle the request
    >   E0221 07:03:35.227506   15478 memcache.go:121] couldn't get resource list for metrics.k8s.io/v1beta1: the server is currently unable to handle the request
    >   NAME                                                         STATUS     ROLES           AGE     VERSION
    >   somerville-jade-20240221-work-control-plane-c6b6f2d1-f5k5w   Ready      control-plane   17m     v1.26.7
    >   somerville-jade-20240221-work-md-0-f538b732-474d8            NotReady   <none>          15m     v1.26.7
    >   somerville-jade-20240221-work-md-0-f538b732-5tgnn            NotReady   <none>          15m     v1.26.7
    >   somerville-jade-20240221-work-md-0-f538b732-6xkbt            Ready      <none>          6m5s    v1.26.7
    >   somerville-jade-20240221-work-md-0-f538b732-8d8n2            NotReady   <none>          16m     v1.26.7
    >   somerville-jade-20240221-work-md-0-f538b732-9cflr            Ready      <none>          5m34s   v1.26.7
    >   somerville-jade-20240221-work-md-0-f538b732-9x7bk            Ready      <none>          5m50s   v1.26.7
    >   somerville-jade-20240221-work-md-0-f538b732-fbpln            NotReady   <none>          15m     v1.26.7
    >   somerville-jade-20240221-work-md-0-f538b732-phgtl            NotReady   <none>          16m     v1.26.7
    >   somerville-jade-20240221-work-md-0-f538b732-ptksh            Ready      <none>          6m30s   v1.26.7
    >   somerville-jade-20240221-work-md-0-f538b732-s46n8            Ready      <none>          5m4s    v1.26.7
    >   somerville-jade-20240221-work-md-0-f538b732-vfckp            NotReady   <none>          16m     v1.26.7
    >   somerville-jade-20240221-work-md-0-f538b732-x9gr9            Ready      <none>          6m18s   v1.26.7




# -----------------------------------------------------
# Get the Kubernetes service status
# https://kubernetes.io/docs/tasks/debug/debug-application/debug-service/
#[root@ansibler]

    ssh bootstrap -t \
        '
        source loadconfig
        kubectl \
            --kubeconfig "${workclusterconf:?}" \
            describe service \
                --namespace default \
                kubernetes
        '

    >   E0221 07:13:43.703538   15770 memcache.go:287] couldn't get resource list for metrics.k8s.io/v1beta1: the server is currently unable to handle the request
    >   E0221 07:13:43.732918   15770 memcache.go:121] couldn't get resource list for metrics.k8s.io/v1beta1: the server is currently unable to handle the request
    >   E0221 07:13:43.737366   15770 memcache.go:121] couldn't get resource list for metrics.k8s.io/v1beta1: the server is currently unable to handle the request
    >   E0221 07:13:43.741154   15770 memcache.go:121] couldn't get resource list for metrics.k8s.io/v1beta1: the server is currently unable to handle the request
    >   Name:              kubernetes
    >   Namespace:         default
    >   Labels:            component=apiserver
    >                      provider=kubernetes
    >   Annotations:       <none>
    >   Selector:          <none>
    >   Type:              ClusterIP
    >   IP Family Policy:  SingleStack
    >   IP Families:       IPv4
    >   IP:                172.24.0.1
    >   IPs:               172.24.0.1
    >   Port:              https  443/TCP
    >   TargetPort:        6443/TCP
    >   Endpoints:         192.168.3.176:6443
    >   Session Affinity:  None
    >   Events:            <none>


    ssh bootstrap -t \
        '
        source loadconfig
        kubectl \
            --kubeconfig "${workclusterconf:?}" \
            get service \
                --namespace default \
                kubernetes \
                    --output json
        '
    >   {
    >       "apiVersion": "v1",
    >       "kind": "Service",
    >       "metadata": {
    >           "creationTimestamp": "2024-02-21T06:45:23Z",
    >           "labels": {
    >               "component": "apiserver",
    >               "provider": "kubernetes"
    >           },
    >           "name": "kubernetes",
    >           "namespace": "default",
    >           "resourceVersion": "195",
    >           "uid": "12c7b70c-cff8-4cf3-9f37-2a01ddf50193"
    >       },
    >       "spec": {
    >           "clusterIP": "172.24.0.1",
    >           "clusterIPs": [
    >               "172.24.0.1"
    >           ],
    >           "internalTrafficPolicy": "Cluster",
    >           "ipFamilies": [
    >               "IPv4"
    >           ],
    >           "ipFamilyPolicy": "SingleStack",
    >           "ports": [
    >               {
    >                   "name": "https",
    >                   "port": 443,
    >                   "protocol": "TCP",
    >                   "targetPort": 6443
    >               }
    >           ],
    >           "sessionAffinity": "None",
    >           "type": "ClusterIP"
    >       },
    >       "status": {
    >           "loadBalancer": {}
    >       }
    >   }


# -----------------------------------------------------
# List stuff in the KinD cluster.
#[root@ansibler]

    ssh bootstrap -t \
        '
        source loadconfig
        kubectl \
            --kubeconfig "${kindclusterconf:?}" \
            api-resources
        '

    >   NAME                              SHORTNAMES   APIVERSION                                 NAMESPACED   KIND
    >   bindings                                       v1                                         true         Binding
    >   componentstatuses                 cs           v1                                         false        ComponentStatus
    >   configmaps                        cm           v1                                         true         ConfigMap
    >   endpoints                         ep           v1                                         true         Endpoints
    >   events                            ev           v1                                         true         Event
    >   limitranges                       limits       v1                                         true         LimitRange
    >   namespaces                        ns           v1                                         false        Namespace
    >   nodes                             no           v1                                         false        Node
    >   persistentvolumeclaims            pvc          v1                                         true         PersistentVolumeClaim
    >   persistentvolumes                 pv           v1                                         false        PersistentVolume
    >   pods                              po           v1                                         true         Pod
    >   podtemplates                                   v1                                         true         PodTemplate
    >   replicationcontrollers            rc           v1                                         true         ReplicationController
    >   resourcequotas                    quota        v1                                         true         ResourceQuota
    >   secrets                                        v1                                         true         Secret
    >   serviceaccounts                   sa           v1                                         true         ServiceAccount
    >   services                          svc          v1                                         true         Service
    >   challenges                                     acme.cert-manager.io/v1                    true         Challenge
    >   orders                                         acme.cert-manager.io/v1                    true         Order
    >   clusterresourcesetbindings                     addons.cluster.x-k8s.io/v1beta1            true         ClusterResourceSetBinding
    >   clusterresourcesets                            addons.cluster.x-k8s.io/v1beta1            true         ClusterResourceSet
    >   helmreleases                                   addons.stackhpc.com/v1alpha1               true         HelmRelease
    >   manifests                                      addons.stackhpc.com/v1alpha1               true         Manifests
    >   mutatingwebhookconfigurations                  admissionregistration.k8s.io/v1            false        MutatingWebhookConfiguration
    >   validatingwebhookconfigurations                admissionregistration.k8s.io/v1            false        ValidatingWebhookConfiguration
    >   customresourcedefinitions         crd,crds     apiextensions.k8s.io/v1                    false        CustomResourceDefinition
    >   apiservices                                    apiregistration.k8s.io/v1                  false        APIService
    >   controllerrevisions                            apps/v1                                    true         ControllerRevision
    >   daemonsets                        ds           apps/v1                                    true         DaemonSet
    >   deployments                       deploy       apps/v1                                    true         Deployment
    >   replicasets                       rs           apps/v1                                    true         ReplicaSet
    >   statefulsets                      sts          apps/v1                                    true         StatefulSet
    >   tokenreviews                                   authentication.k8s.io/v1                   false        TokenReview
    >   localsubjectaccessreviews                      authorization.k8s.io/v1                    true         LocalSubjectAccessReview
    >   selfsubjectaccessreviews                       authorization.k8s.io/v1                    false        SelfSubjectAccessReview
    >   selfsubjectrulesreviews                        authorization.k8s.io/v1                    false        SelfSubjectRulesReview
    >   subjectaccessreviews                           authorization.k8s.io/v1                    false        SubjectAccessReview
    >   horizontalpodautoscalers          hpa          autoscaling/v2                             true         HorizontalPodAutoscaler
    >   cronjobs                          cj           batch/v1                                   true         CronJob
    >   jobs                                           batch/v1                                   true         Job
    >   kubeadmconfigs                                 bootstrap.cluster.x-k8s.io/v1beta1         true         KubeadmConfig
    >   kubeadmconfigtemplates                         bootstrap.cluster.x-k8s.io/v1beta1         true         KubeadmConfigTemplate
    >   certificaterequests               cr,crs       cert-manager.io/v1                         true         CertificateRequest
    >   certificates                      cert,certs   cert-manager.io/v1                         true         Certificate
    >   clusterissuers                                 cert-manager.io/v1                         false        ClusterIssuer
    >   issuers                                        cert-manager.io/v1                         true         Issuer
    >   certificatesigningrequests        csr          certificates.k8s.io/v1                     false        CertificateSigningRequest
    >   clusterclasses                    cc           cluster.x-k8s.io/v1beta1                   true         ClusterClass
    >   clusters                          cl           cluster.x-k8s.io/v1beta1                   true         Cluster
    >   machinedeployments                md           cluster.x-k8s.io/v1beta1                   true         MachineDeployment
    >   machinehealthchecks               mhc,mhcs     cluster.x-k8s.io/v1beta1                   true         MachineHealthCheck
    >   machinepools                      mp           cluster.x-k8s.io/v1beta1                   true         MachinePool
    >   machines                          ma           cluster.x-k8s.io/v1beta1                   true         Machine
    >   machinesets                       ms           cluster.x-k8s.io/v1beta1                   true         MachineSet
    >   providers                                      clusterctl.cluster.x-k8s.io/v1alpha3       true         Provider
    >   kubeadmcontrolplanes              kcp          controlplane.cluster.x-k8s.io/v1beta1      true         KubeadmControlPlane
    >   kubeadmcontrolplanetemplates                   controlplane.cluster.x-k8s.io/v1beta1      true         KubeadmControlPlaneTemplate
    >   leases                                         coordination.k8s.io/v1                     true         Lease
    >   endpointslices                                 discovery.k8s.io/v1                        true         EndpointSlice
    >   events                            ev           events.k8s.io/v1                           true         Event
    >   flowschemas                                    flowcontrol.apiserver.k8s.io/v1beta3       false        FlowSchema
    >   prioritylevelconfigurations                    flowcontrol.apiserver.k8s.io/v1beta3       false        PriorityLevelConfiguration
    >   openstackclusters                 osc          infrastructure.cluster.x-k8s.io/v1alpha7   true         OpenStackCluster
    >   openstackclustertemplates         osct         infrastructure.cluster.x-k8s.io/v1alpha7   true         OpenStackClusterTemplate
    >   openstackmachines                 osm          infrastructure.cluster.x-k8s.io/v1alpha7   true         OpenStackMachine
    >   openstackmachinetemplates         osmt         infrastructure.cluster.x-k8s.io/v1alpha7   true         OpenStackMachineTemplate
    >   ipaddressclaims                                ipam.cluster.x-k8s.io/v1beta1              true         IPAddressClaim
    >   ipaddresses                                    ipam.cluster.x-k8s.io/v1beta1              true         IPAddress
    >   ingressclasses                                 networking.k8s.io/v1                       false        IngressClass
    >   ingresses                         ing          networking.k8s.io/v1                       true         Ingress
    >   networkpolicies                   netpol       networking.k8s.io/v1                       true         NetworkPolicy
    >   runtimeclasses                                 node.k8s.io/v1                             false        RuntimeClass
    >   poddisruptionbudgets              pdb          policy/v1                                  true         PodDisruptionBudget
    >   clusterrolebindings                            rbac.authorization.k8s.io/v1               false        ClusterRoleBinding
    >   clusterroles                                   rbac.authorization.k8s.io/v1               false        ClusterRole
    >   rolebindings                                   rbac.authorization.k8s.io/v1               true         RoleBinding
    >   roles                                          rbac.authorization.k8s.io/v1               true         Role
    >   extensionconfigs                  ext          runtime.cluster.x-k8s.io/v1alpha1          false        ExtensionConfig
    >   priorityclasses                   pc           scheduling.k8s.io/v1                       false        PriorityClass
    >   csidrivers                                     storage.k8s.io/v1                          false        CSIDriver
    >   csinodes                                       storage.k8s.io/v1                          false        CSINode
    >   csistoragecapacities                           storage.k8s.io/v1                          true         CSIStorageCapacity
    >   storageclasses                    sc           storage.k8s.io/v1                          false        StorageClass
    >   volumeattachments                              storage.k8s.io/v1                          false        VolumeAttachment


    ssh bootstrap -t \
        '
        source loadconfig
        kubectl \
            --kubeconfig "${kindclusterconf:?}" \
            get clusters \
                --all-namespaces
        '

    >   NAMESPACE   NAME                            CLUSTERCLASS   PHASE         AGE   VERSION
    >   default     somerville-jade-20240221-work                  Provisioned   38m


    ssh bootstrap -t \
        '
        source loadconfig
        kubectl \
            --kubeconfig "${kindclusterconf:?}" \
            get cluster \
                --namespace default \
                'somerville-jade-20240221-work'
        '

    >   NAME                            CLUSTERCLASS   PHASE         AGE   VERSION
    >   somerville-jade-20240221-work                  Provisioned   39m


    ssh bootstrap -t \
        '
        source loadconfig
        kubectl \
            --kubeconfig "${kindclusterconf:?}" \
            get cluster \
                --namespace default \
                --output json \
                'somerville-jade-20240221-work'
        '

    >   {
    >       "apiVersion": "cluster.x-k8s.io/v1beta1",
    >       "kind": "Cluster",
    >       "metadata": {
    >           "annotations": {
    >               "meta.helm.sh/release-name": "somerville-jade-20240221-work",
    >               "meta.helm.sh/release-namespace": "default"
    >           },
    >           "creationTimestamp": "2024-02-21T06:42:08Z",
    >           "finalizers": [
    >               "cluster.cluster.x-k8s.io"
    >           ],
    >           "generation": 3,
    >           "labels": {
    >               "app.kubernetes.io/managed-by": "Helm",
    >               "capi.stackhpc.com/cluster": "somerville-jade-20240221-work",
    >               "capi.stackhpc.com/infrastructure-provider": "openstack",
    >               "capi.stackhpc.com/managed-by": "Helm",
    >               "helm.sh/chart": "openstack-cluster-0.1.0"
    >           },
    >           "name": "somerville-jade-20240221-work",
    >           "namespace": "default",
    >           "resourceVersion": "4059",
    >           "uid": "5d43f46b-4b5f-4a88-a27c-f2b446434a89"
    >       },
    >       "spec": {
    >           "clusterNetwork": {
    >               "pods": {
    >                   "cidrBlocks": [
    >                       "172.16.0.0/13"
    >                   ]
    >               },
    >               "serviceDomain": "cluster.local",
    >               "services": {
    >                   "cidrBlocks": [
    >                       "172.24.0.0/13"
    >                   ]
    >               }
    >           },
    >           "controlPlaneEndpoint": {
    >               "host": "192.41.122.207",
    >               "port": 6443
    >           },
    >           "controlPlaneRef": {
    >               "apiVersion": "controlplane.cluster.x-k8s.io/v1beta1",
    >               "kind": "KubeadmControlPlane",
    >               "name": "somerville-jade-20240221-work-control-plane",
    >               "namespace": "default"
    >           },
    >           "infrastructureRef": {
    >               "apiVersion": "infrastructure.cluster.x-k8s.io/v1alpha7",
    >               "kind": "OpenStackCluster",
    >               "name": "somerville-jade-20240221-work",
    >               "namespace": "default"
    >           }
    >       },
    >       "status": {
    >           "conditions": [
    >               {
    >                   "lastTransitionTime": "2024-02-21T06:44:13Z",
    >                   "message": "Scaling up control plane to 3 replicas (actual 1)",
    >                   "reason": "ScalingUp",
    >                   "severity": "Warning",
    >                   "status": "False",
    >                   "type": "Ready"
    >               },
    >               {
    >                   "lastTransitionTime": "2024-02-21T06:45:58Z",
    >                   "status": "True",
    >                   "type": "ControlPlaneInitialized"
    >               },
    >               {
    >                   "lastTransitionTime": "2024-02-21T06:44:13Z",
    >                   "message": "Scaling up control plane to 3 replicas (actual 1)",
    >                   "reason": "ScalingUp",
    >                   "severity": "Warning",
    >                   "status": "False",
    >                   "type": "ControlPlaneReady"
    >               },
    >               {
    >                   "lastTransitionTime": "2024-02-21T06:43:49Z",
    >                   "status": "True",
    >                   "type": "InfrastructureReady"
    >               }
    >           ],
    >           "controlPlaneReady": true,
    >           "failureDomains": {
    >               "nova": {},
    >               "testbed": {}
    >           },
    >           "infrastructureReady": true,
    >           "observedGeneration": 3,
    >           "phase": "Provisioned"
    >       }
    >   }


    ssh bootstrap -t \
        '
        source loadconfig
        kubectl \
            --kubeconfig "${kindclusterconf:?}" \
            get openstackcluster \
                --namespace default \
                --output json \
                'somerville-jade-20240221-work'
        '

    >   {
    >       "apiVersion": "infrastructure.cluster.x-k8s.io/v1alpha7",
    >       "kind": "OpenStackCluster",
    >       "metadata": {
    >           "annotations": {
    >               "helm.sh/resource-policy": "keep",
    >               "meta.helm.sh/release-name": "somerville-jade-20240221-work",
    >               "meta.helm.sh/release-namespace": "default"
    >           },
    >           "creationTimestamp": "2024-02-21T06:42:10Z",
    >           "finalizers": [
    >               "openstackcluster.infrastructure.cluster.x-k8s.io"
    >           ],
    >           "generation": 3,
    >           "labels": {
    >               "app.kubernetes.io/managed-by": "Helm",
    >               "capi.stackhpc.com/cluster": "somerville-jade-20240221-work",
    >               "capi.stackhpc.com/infrastructure-provider": "openstack",
    >               "capi.stackhpc.com/managed-by": "Helm",
    >               "cluster.x-k8s.io/cluster-name": "somerville-jade-20240221-work",
    >               "helm.sh/chart": "openstack-cluster-0.1.0"
    >           },
    >           "name": "somerville-jade-20240221-work",
    >           "namespace": "default",
    >           "ownerReferences": [
    >               {
    >                   "apiVersion": "cluster.x-k8s.io/v1beta1",
    >                   "blockOwnerDeletion": true,
    >                   "controller": true,
    >                   "kind": "Cluster",
    >                   "name": "somerville-jade-20240221-work",
    >                   "uid": "5d43f46b-4b5f-4a88-a27c-f2b446434a89"
    >               }
    >           ],
    >           "resourceVersion": "3818",
    >           "uid": "13e936cc-625b-40f5-8cac-1773818a067f"
    >       },
    >       "spec": {
    >           "allowAllInClusterTraffic": true,
    >           "apiServerLoadBalancer": {
    >               "allowedCidrs": [
    >                   "192.41.122.71/32",
    >                   "90.155.51.57/32"
    >               ],
    >               "enabled": true
    >           },
    >           "apiServerPort": 6443,
    >           "cloudName": "openstack",
    >           "controlPlaneEndpoint": {
    >               "host": "192.41.122.207",
    >               "port": 6443
    >           },
    >           "controlPlaneOmitAvailabilityZone": true,
    >           "disableAPIServerFloatingIP": false,
    >           "externalNetworkId": "1875828a-ccc3-419b-87fd-856aaa781492",
    >           "identityRef": {
    >               "kind": "Secret",
    >               "name": "somerville-jade-20240221-work-cloud-credentials"
    >           },
    >           "managedSecurityGroups": true,
    >           "network": {},
    >           "nodeCidr": "192.168.3.0/24",
    >           "subnet": {}
    >       },
    >       "status": {
    >           "apiServerLoadBalancer": {
    >               "allowedCIDRs": [
    >                   "192.168.3.0/24",
    >                   "192.41.122.71/32",
    >                   "192.41.122.98/32",
    >                   "90.155.51.57/32"
    >               ],
    >               "id": "71b5524d-a508-496b-9f49-06edbf8ed358",
    >               "internalIP": "192.168.3.46",
    >               "ip": "192.41.122.207",
    >               "name": "k8s-clusterapi-cluster-default-somerville-jade-20240221-work-kubeapi"
    >           },
    >           "controlPlaneSecurityGroup": {
    >               "id": "02053952-b7da-4e4a-a659-31c0ead42ef9",
    >               "name": "k8s-cluster-default-somerville-jade-20240221-work-secgroup-controlplane",
    >               "rules": [
    >                   {
    >                       "description": "Full open",
    >                       "direction": "egress",
    >                       "etherType": "IPv4",
    >                       "name": "93649003-4943-4480-8218-0ea309640a49",
    >                       "portRangeMax": 0,
    >                       "portRangeMin": 0,
    >                       "protocol": "",
    >                       "remoteGroupID": "",
    >                       "remoteIPPrefix": "",
    >                       "securityGroupID": "02053952-b7da-4e4a-a659-31c0ead42ef9"
    >                   },
    >                   {
    >                       "description": "Full open",
    >                       "direction": "egress",
    >                       "etherType": "IPv6",
    >                       "name": "5285f124-624f-420e-9a80-2035b0351715",
    >                       "portRangeMax": 0,
    >                       "portRangeMin": 0,
    >                       "protocol": "",
    >                       "remoteGroupID": "",
    >                       "remoteIPPrefix": "",
    >                       "securityGroupID": "02053952-b7da-4e4a-a659-31c0ead42ef9"
    >                   },
    >                   {
    >                       "description": "Kubernetes API",
    >                       "direction": "ingress",
    >                       "etherType": "IPv4",
    >                       "name": "7bcfc55e-4a0b-4be0-b89f-663444420860",
    >                       "portRangeMax": 6443,
    >                       "portRangeMin": 6443,
    >                       "protocol": "tcp",
    >                       "remoteGroupID": "",
    >                       "remoteIPPrefix": "",
    >                       "securityGroupID": "02053952-b7da-4e4a-a659-31c0ead42ef9"
    >                   },
    >                   {
    >                       "description": "In-cluster Ingress",
    >                       "direction": "ingress",
    >                       "etherType": "IPv4",
    >                       "name": "3c813479-0661-4ae2-bc69-02338ef64c12",
    >                       "portRangeMax": 0,
    >                       "portRangeMin": 0,
    >                       "protocol": "",
    >                       "remoteGroupID": "02053952-b7da-4e4a-a659-31c0ead42ef9",
    >                       "remoteIPPrefix": "",
    >                       "securityGroupID": "02053952-b7da-4e4a-a659-31c0ead42ef9"
    >                   },
    >                   {
    >                       "description": "In-cluster Ingress",
    >                       "direction": "ingress",
    >                       "etherType": "IPv4",
    >                       "name": "e3b737e6-4928-4b05-900c-320ce89f664a",
    >                       "portRangeMax": 0,
    >                       "portRangeMin": 0,
    >                       "protocol": "",
    >                       "remoteGroupID": "416d64bf-8b76-4602-a497-6773b48dc3df",
    >                       "remoteIPPrefix": "",
    >                       "securityGroupID": "02053952-b7da-4e4a-a659-31c0ead42ef9"
    >                   }
    >               ]
    >           },
    >           "externalNetwork": {
    >               "id": "1875828a-ccc3-419b-87fd-856aaa781492",
    >               "name": "external"
    >           },
    >           "failureDomains": {
    >               "nova": {},
    >               "testbed": {}
    >           },
    >           "network": {
    >               "id": "401237d6-1385-4b2b-9167-c0abd0d0fe48",
    >               "name": "k8s-clusterapi-cluster-default-somerville-jade-20240221-work",
    >               "subnets": [
    >                   {
    >                       "cidr": "192.168.3.0/24",
    >                       "id": "94f4ece7-4439-4de9-a863-903c6428b6e5",
    >                       "name": "k8s-clusterapi-cluster-default-somerville-jade-20240221-work"
    >                   }
    >               ]
    >           },
    >           "ready": true,
    >           "router": {
    >               "id": "a242ea47-3d3d-4215-9350-453da310614b",
    >               "ips": [
    >                   "192.41.122.98"
    >               ],
    >               "name": "k8s-clusterapi-cluster-default-somerville-jade-20240221-work"
    >           },
    >           "workerSecurityGroup": {
    >               "id": "416d64bf-8b76-4602-a497-6773b48dc3df",
    >               "name": "k8s-cluster-default-somerville-jade-20240221-work-secgroup-worker",
    >               "rules": [
    >                   {
    >                       "description": "Full open",
    >                       "direction": "egress",
    >                       "etherType": "IPv4",
    >                       "name": "59056e61-a9d7-4797-b2ba-210740d3ab0d",
    >                       "portRangeMax": 0,
    >                       "portRangeMin": 0,
    >                       "protocol": "",
    >                       "remoteGroupID": "",
    >                       "remoteIPPrefix": "",
    >                       "securityGroupID": "416d64bf-8b76-4602-a497-6773b48dc3df"
    >                   },
    >                   {
    >                       "description": "Full open",
    >                       "direction": "egress",
    >                       "etherType": "IPv6",
    >                       "name": "8f1feb2b-6514-4b53-8c00-dd5b1176fca5",
    >                       "portRangeMax": 0,
    >                       "portRangeMin": 0,
    >                       "protocol": "",
    >                       "remoteGroupID": "",
    >                       "remoteIPPrefix": "",
    >                       "securityGroupID": "416d64bf-8b76-4602-a497-6773b48dc3df"
    >                   },
    >                   {
    >                       "description": "Node Port Services",
    >                       "direction": "ingress",
    >                       "etherType": "IPv4",
    >                       "name": "272f1fce-ec60-43e1-a885-3ec119006a0c",
    >                       "portRangeMax": 32767,
    >                       "portRangeMin": 30000,
    >                       "protocol": "tcp",
    >                       "remoteGroupID": "",
    >                       "remoteIPPrefix": "",
    >                       "securityGroupID": "416d64bf-8b76-4602-a497-6773b48dc3df"
    >                   },
    >                   {
    >                       "description": "Node Port Services",
    >                       "direction": "ingress",
    >                       "etherType": "IPv4",
    >                       "name": "848147ab-df94-4b59-aecc-55bc61e4ca6a",
    >                       "portRangeMax": 32767,
    >                       "portRangeMin": 30000,
    >                       "protocol": "udp",
    >                       "remoteGroupID": "",
    >                       "remoteIPPrefix": "",
    >                       "securityGroupID": "416d64bf-8b76-4602-a497-6773b48dc3df"
    >                   },
    >                   {
    >                       "description": "In-cluster Ingress",
    >                       "direction": "ingress",
    >                       "etherType": "IPv4",
    >                       "name": "93075903-fbcd-4819-b348-f0a086cd093e",
    >                       "portRangeMax": 0,
    >                       "portRangeMin": 0,
    >                       "protocol": "",
    >                       "remoteGroupID": "416d64bf-8b76-4602-a497-6773b48dc3df",
    >                       "remoteIPPrefix": "",
    >                       "securityGroupID": "416d64bf-8b76-4602-a497-6773b48dc3df"
    >                   },
    >                   {
    >                       "description": "In-cluster Ingress",
    >                       "direction": "ingress",
    >                       "etherType": "IPv4",
    >                       "name": "145a6db0-18f6-4ed4-b274-39f215790616",
    >                       "portRangeMax": 0,
    >                       "portRangeMin": 0,
    >                       "protocol": "",
    >                       "remoteGroupID": "02053952-b7da-4e4a-a659-31c0ead42ef9",
    >                       "remoteIPPrefix": "",
    >                       "securityGroupID": "416d64bf-8b76-4602-a497-6773b48dc3df"
    >                   }
    >               ]
    >           }
    >       }
    >   }



    ssh bootstrap -t \
        '
        source loadconfig
        kubectl \
            --kubeconfig "${kindclusterconf:?}" \
            get machinehealthchecks \
                --namespace default \
                --output json
        '

    >   {
    >       "apiVersion": "v1",
    >       "items": [
    >           {
    >               "apiVersion": "cluster.x-k8s.io/v1beta1",
    >               "kind": "MachineHealthCheck",
    >               "metadata": {
    >                   "annotations": {
    >                       "meta.helm.sh/release-name": "somerville-jade-20240221-work",
    >                       "meta.helm.sh/release-namespace": "default"
    >                   },
    >                   "creationTimestamp": "2024-02-21T06:42:10Z",
    >                   "generation": 1,
    >                   "labels": {
    >                       "app.kubernetes.io/managed-by": "Helm",
    >                       "capi.stackhpc.com/cluster": "somerville-jade-20240221-work",
    >                       "capi.stackhpc.com/component": "control-plane",
    >                       "capi.stackhpc.com/infrastructure-provider": "openstack",
    >                       "capi.stackhpc.com/managed-by": "Helm",
    >                       "cluster.x-k8s.io/cluster-name": "somerville-jade-20240221-work",
    >                       "helm.sh/chart": "openstack-cluster-0.1.0"
    >                   },
    >                   "name": "somerville-jade-20240221-work-control-plane",
    >                   "namespace": "default",
    >                   "ownerReferences": [
    >                       {
    >                           "apiVersion": "cluster.x-k8s.io/v1beta1",
    >                           "kind": "Cluster",
    >                           "name": "somerville-jade-20240221-work",
    >                           "uid": "5d43f46b-4b5f-4a88-a27c-f2b446434a89"
    >                       }
    >                   ],
    >                   "resourceVersion": "2273",
    >                   "uid": "c8992d33-517e-4d9b-b54d-6d2546640d3e"
    >               },
    >               "spec": {
    >                   "clusterName": "somerville-jade-20240221-work",
    >                   "maxUnhealthy": "100%",
    >                   "nodeStartupTimeout": "10m0s",
    >                   "selector": {
    >                       "matchLabels": {
    >                           "capi.stackhpc.com/cluster": "somerville-jade-20240221-work",
    >                           "capi.stackhpc.com/component": "control-plane"
    >                       }
    >                   },
    >                   "unhealthyConditions": [
    >                       {
    >                           "status": "Unknown",
    >                           "timeout": "5m0s",
    >                           "type": "Ready"
    >                       },
    >                       {
    >                           "status": "False",
    >                           "timeout": "5m0s",
    >                           "type": "Ready"
    >                       }
    >                   ]
    >               },
    >               "status": {
    >                   "conditions": [
    >                       {
    >                           "lastTransitionTime": "2024-02-21T06:42:10Z",
    >                           "status": "True",
    >                           "type": "RemediationAllowed"
    >                       }
    >                   ],
    >                   "expectedMachines": 1,
    >                   "observedGeneration": 1,
    >                   "targets": [
    >                       "somerville-jade-20240221-work-control-plane-bdfrr"
    >                   ]
    >               }
    >           },
    >           {
    >               "apiVersion": "cluster.x-k8s.io/v1beta1",
    >               "kind": "MachineHealthCheck",
    >               "metadata": {
    >                   "annotations": {
    >                       "meta.helm.sh/release-name": "somerville-jade-20240221-work",
    >                       "meta.helm.sh/release-namespace": "default"
    >                   },
    >                   "creationTimestamp": "2024-02-21T06:42:10Z",
    >                   "generation": 1,
    >                   "labels": {
    >                       "app.kubernetes.io/managed-by": "Helm",
    >                       "capi.stackhpc.com/cluster": "somerville-jade-20240221-work",
    >                       "capi.stackhpc.com/component": "worker",
    >                       "capi.stackhpc.com/infrastructure-provider": "openstack",
    >                       "capi.stackhpc.com/managed-by": "Helm",
    >                       "capi.stackhpc.com/node-group": "md-0",
    >                       "cluster.x-k8s.io/cluster-name": "somerville-jade-20240221-work",
    >                       "helm.sh/chart": "openstack-cluster-0.1.0"
    >                   },
    >                   "name": "somerville-jade-20240221-work-md-0",
    >                   "namespace": "default",
    >                   "ownerReferences": [
    >                       {
    >                           "apiVersion": "cluster.x-k8s.io/v1beta1",
    >                           "kind": "Cluster",
    >                           "name": "somerville-jade-20240221-work",
    >                           "uid": "5d43f46b-4b5f-4a88-a27c-f2b446434a89"
    >                       }
    >                   ],
    >                   "resourceVersion": "11655",
    >                   "uid": "de48c1ad-7401-4027-bc7a-6f5b385c8b63"
    >               },
    >               "spec": {
    >                   "clusterName": "somerville-jade-20240221-work",
    >                   "maxUnhealthy": "100%",
    >                   "nodeStartupTimeout": "10m0s",
    >                   "selector": {
    >                       "matchLabels": {
    >                           "capi.stackhpc.com/cluster": "somerville-jade-20240221-work",
    >                           "capi.stackhpc.com/component": "worker",
    >                           "capi.stackhpc.com/node-group": "md-0"
    >                       }
    >                   },
    >                   "unhealthyConditions": [
    >                       {
    >                           "status": "Unknown",
    >                           "timeout": "5m0s",
    >                           "type": "Ready"
    >                       },
    >                       {
    >                           "status": "False",
    >                           "timeout": "5m0s",
    >                           "type": "Ready"
    >                       }
    >                   ]
    >               },
    >               "status": {
    >                   "conditions": [
    >                       {
    >                           "lastTransitionTime": "2024-02-21T06:42:10Z",
    >                           "status": "True",
    >                           "type": "RemediationAllowed"
    >                       }
    >                   ],
    >                   "expectedMachines": 6,
    >                   "observedGeneration": 1,
    >                   "targets": [
    >                       "somerville-jade-20240221-work-md-0-bc4ps-2vwsp",
    >                       "somerville-jade-20240221-work-md-0-bc4ps-64l4h",
    >                       "somerville-jade-20240221-work-md-0-bc4ps-bn992",
    >                       "somerville-jade-20240221-work-md-0-bc4ps-dqbpb",
    >                       "somerville-jade-20240221-work-md-0-bc4ps-jxnvk",
    >                       "somerville-jade-20240221-work-md-0-bc4ps-zvgb7"
    >                   ]
    >               }
    >           }
    >       ],
    >       "kind": "List",
    >       "metadata": {
    >           "resourceVersion": ""
    >       }
    >   }


    ssh bootstrap -t \
        '
        source loadconfig
        kubectl \
            --kubeconfig "${kindclusterconf:?}" \
            get machinedeployments \
                --namespace default \
                --output json
        '

    >   {
    >       "apiVersion": "v1",
    >       "items": [
    >           {
    >               "apiVersion": "cluster.x-k8s.io/v1beta1",
    >               "kind": "MachineDeployment",
    >               "metadata": {
    >                   "annotations": {
    >                       "machinedeployment.clusters.x-k8s.io/revision": "1",
    >                       "meta.helm.sh/release-name": "somerville-jade-20240221-work",
    >                       "meta.helm.sh/release-namespace": "default"
    >                   },
    >                   "creationTimestamp": "2024-02-21T06:42:09Z",
    >                   "generation": 2,
    >                   "labels": {
    >                       "app.kubernetes.io/managed-by": "Helm",
    >                       "capi.stackhpc.com/cluster": "somerville-jade-20240221-work",
    >                       "capi.stackhpc.com/component": "worker",
    >                       "capi.stackhpc.com/infrastructure-provider": "openstack",
    >                       "capi.stackhpc.com/managed-by": "Helm",
    >                       "capi.stackhpc.com/node-group": "md-0",
    >                       "cluster.x-k8s.io/cluster-name": "somerville-jade-20240221-work",
    >                       "helm.sh/chart": "openstack-cluster-0.1.0"
    >                   },
    >                   "name": "somerville-jade-20240221-work-md-0",
    >                   "namespace": "default",
    >                   "ownerReferences": [
    >                       {
    >                           "apiVersion": "cluster.x-k8s.io/v1beta1",
    >                           "kind": "Cluster",
    >                           "name": "somerville-jade-20240221-work",
    >                           "uid": "5d43f46b-4b5f-4a88-a27c-f2b446434a89"
    >                       }
    >                   ],
    >                   "resourceVersion": "11702",
    >                   "uid": "e9d2ee01-aded-4f47-af74-f4d93aca4cdc"
    >               },
    >               "spec": {
    >                   "clusterName": "somerville-jade-20240221-work",
    >                   "minReadySeconds": 0,
    >                   "progressDeadlineSeconds": 600,
    >                   "replicas": 6,
    >                   "revisionHistoryLimit": 1,
    >                   "selector": {
    >                       "matchLabels": {
    >                           "capi.stackhpc.com/cluster": "somerville-jade-20240221-work",
    >                           "capi.stackhpc.com/component": "worker",
    >                           "capi.stackhpc.com/node-group": "md-0",
    >                           "cluster.x-k8s.io/cluster-name": "somerville-jade-20240221-work"
    >                       }
    >                   },
    >                   "strategy": {
    >                       "rollingUpdate": {
    >                           "deletePolicy": "Random",
    >                           "maxSurge": 0,
    >                           "maxUnavailable": 1
    >                       },
    >                       "type": "RollingUpdate"
    >                   },
    >                   "template": {
    >                       "metadata": {
    >                           "labels": {
    >                               "capi.stackhpc.com/cluster": "somerville-jade-20240221-work",
    >                               "capi.stackhpc.com/component": "worker",
    >                               "capi.stackhpc.com/node-group": "md-0",
    >                               "cluster.x-k8s.io/cluster-name": "somerville-jade-20240221-work"
    >                           }
    >                       },
    >                       "spec": {
    >                           "bootstrap": {
    >                               "configRef": {
    >                                   "apiVersion": "bootstrap.cluster.x-k8s.io/v1beta1",
    >                                   "kind": "KubeadmConfigTemplate",
    >                                   "name": "somerville-jade-20240221-work-md-0-99910806"
    >                               }
    >                           },
    >                           "clusterName": "somerville-jade-20240221-work",
    >                           "infrastructureRef": {
    >                               "apiVersion": "infrastructure.cluster.x-k8s.io/v1alpha7",
    >                               "kind": "OpenStackMachineTemplate",
    >                               "name": "somerville-jade-20240221-work-md-0-f538b732"
    >                           },
    >                           "nodeDrainTimeout": "5m0s",
    >                           "version": "v1.26.7"
    >                       }
    >                   }
    >               },
    >               "status": {
    >                   "conditions": [
    >                       {
    >                           "lastTransitionTime": "2024-02-21T06:42:12Z",
    >                           "message": "Minimum availability requires 5 replicas, current 0 available",
    >                           "reason": "WaitingForAvailableMachines",
    >                           "severity": "Warning",
    >                           "status": "False",
    >                           "type": "Ready"
    >                       },
    >                       {
    >                           "lastTransitionTime": "2024-02-21T06:42:12Z",
    >                           "message": "Minimum availability requires 5 replicas, current 0 available",
    >                           "reason": "WaitingForAvailableMachines",
    >                           "severity": "Warning",
    >                           "status": "False",
    >                           "type": "Available"
    >                       }
    >                   ],
    >                   "observedGeneration": 2,
    >                   "phase": "ScalingUp",
    >                   "replicas": 6,
    >                   "selector": "capi.stackhpc.com/cluster=somerville-jade-20240221-work,capi.stackhpc.com/component=worker,capi.stackhpc.com/node-group=md-0,cluster.x-k8s.io/cluster-name=somerville-jade-20240221-work",
    >                   "unavailableReplicas": 6,
    >                   "updatedReplicas": 6
    >               }
    >           }
    >       ],
    >       "kind": "List",
    >       "metadata": {
    >           "resourceVersion": ""
    >       }
    >   }


    ssh bootstrap -t \
        '
        source loadconfig
        kubectl \
            --kubeconfig "${kindclusterconf:?}" \
            get machinedeployment \
                --namespace default \
                --output json \
                "somerville-jade-20240221-work-md-0" \
        | jq ".status"
        '

    >   {
    >     "conditions": [
    >       {
    >         "lastTransitionTime": "2024-02-21T06:42:12Z",
    >         "message": "Minimum availability requires 5 replicas, current 0 available",
    >         "reason": "WaitingForAvailableMachines",
    >         "severity": "Warning",
    >         "status": "False",
    >         "type": "Ready"
    >       },
    >       {
    >         "lastTransitionTime": "2024-02-21T06:42:12Z",
    >         "message": "Minimum availability requires 5 replicas, current 0 available",
    >         "reason": "WaitingForAvailableMachines",
    >         "severity": "Warning",
    >         "status": "False",
    >         "type": "Available"
    >       }
    >     ],
    >     "observedGeneration": 2,
    >     "phase": "ScalingUp",
    >     "replicas": 6,
    >     "selector": "capi.stackhpc.com/cluster=somerville-jade-20240221-work,capi.stackhpc.com/component=worker,capi.stackhpc.com/node-group=md-0,cluster.x-k8s.io/cluster-name=somerville-jade-20240221-work",
    >     "unavailableReplicas": 6,
    >     "updatedReplicas": 6
    >   }



    ssh bootstrap -t \
        '
        source loadconfig
        kubectl \
            --kubeconfig "${kindclusterconf:?}" \
            get KubeadmControlPlanes \
                --namespace default \
                --output json
        '

    >   {
    >       "apiVersion": "v1",
    >       "items": [
    >           {
    >               "apiVersion": "controlplane.cluster.x-k8s.io/v1beta1",
    >               "kind": "KubeadmControlPlane",
    >               "metadata": {
    >                   "annotations": {
    >                       "helm.sh/resource-policy": "keep",
    >                       "meta.helm.sh/release-name": "somerville-jade-20240221-work",
    >                       "meta.helm.sh/release-namespace": "default"
    >                   },
    >                   "creationTimestamp": "2024-02-21T06:42:09Z",
    >                   "finalizers": [
    >                       "kubeadm.controlplane.cluster.x-k8s.io"
    >                   ],
    >                   "generation": 2,
    >                   "labels": {
    >                       "app.kubernetes.io/managed-by": "Helm",
    >                       "capi.stackhpc.com/cluster": "somerville-jade-20240221-work",
    >                       "capi.stackhpc.com/component": "control-plane",
    >                       "capi.stackhpc.com/infrastructure-provider": "openstack",
    >                       "capi.stackhpc.com/managed-by": "Helm",
    >                       "cluster.x-k8s.io/cluster-name": "somerville-jade-20240221-work",
    >                       "helm.sh/chart": "openstack-cluster-0.1.0"
    >                   },
    >                   "name": "somerville-jade-20240221-work-control-plane",
    >                   "namespace": "default",
    >                   "ownerReferences": [
    >                       {
    >                           "apiVersion": "cluster.x-k8s.io/v1beta1",
    >                           "blockOwnerDeletion": true,
    >                           "controller": true,
    >                           "kind": "Cluster",
    >                           "name": "somerville-jade-20240221-work",
    >                           "uid": "5d43f46b-4b5f-4a88-a27c-f2b446434a89"
    >                       }
    >                   ],
    >                   "resourceVersion": "4570",
    >                   "uid": "2cf20dae-b637-41d6-9097-5d004aff1206"
    >               },
    >               "spec": {
    >                   "kubeadmConfigSpec": {
    >                       "clusterConfiguration": {
    >                           "apiServer": {
    >                               "extraArgs": {
    >                                   "cloud-provider": "external"
    >                               }
    >                           },
    >                           "controllerManager": {
    >                               "extraArgs": {
    >                                   "bind-address": "0.0.0.0",
    >                                   "cloud-provider": "external"
    >                               }
    >                           },
    >                           "dns": {},
    >                           "etcd": {
    >                               "local": {
    >                                   "extraArgs": {
    >                                       "listen-metrics-urls": "http://0.0.0.0:2381"
    >                                   }
    >                               }
    >                           },
    >                           "networking": {},
    >                           "scheduler": {
    >                               "extraArgs": {
    >                                   "bind-address": "0.0.0.0"
    >                               }
    >                           }
    >                       },
    >                       "files": [
    >                           {
    >                               "content": "# This file is created by the capi-helm-chart to\n# ensure that its parent directory exists. *.toml\n# files in this directory are included in containerd\n# config when /etc/containerd/config.toml is parsed.\n",
    >                               "owner": "root:root",
    >                               "path": "/etc/containerd/conf.d/.keepdir",
    >                               "permissions": "0644"
    >                           },
    >                           {
    >                               "content": "---\napiVersion: kubeproxy.config.k8s.io/v1alpha1\nkind: KubeProxyConfiguration\nmetricsBindAddress: 0.0.0.0:10249\n",
    >                               "owner": "root:root",
    >                               "path": "/run/kubeadm/kube-proxy-configuration.yaml",
    >                               "permissions": "0644"
    >                           }
    >                       ],
    >                       "format": "cloud-config",
    >                       "initConfiguration": {
    >                           "localAPIEndpoint": {},
    >                           "nodeRegistration": {
    >                               "imagePullPolicy": "IfNotPresent",
    >                               "kubeletExtraArgs": {
    >                                   "cloud-provider": "external"
    >                               },
    >                               "name": "{{ local_hostname }}"
    >                           }
    >                       },
    >                       "joinConfiguration": {
    >                           "discovery": {},
    >                           "nodeRegistration": {
    >                               "imagePullPolicy": "IfNotPresent",
    >                               "kubeletExtraArgs": {
    >                                   "cloud-provider": "external"
    >                               },
    >                               "name": "{{ local_hostname }}"
    >                           }
    >                       },
    >                       "preKubeadmCommands": [
    >                           "cat /run/kubeadm/kube-proxy-configuration.yaml \u003e\u003e /run/kubeadm/kubeadm.yaml"
    >                       ]
    >                   },
    >                   "machineTemplate": {
    >                       "infrastructureRef": {
    >                           "apiVersion": "infrastructure.cluster.x-k8s.io/v1alpha7",
    >                           "kind": "OpenStackMachineTemplate",
    >                           "name": "somerville-jade-20240221-work-control-plane-c6b6f2d1",
    >                           "namespace": "default"
    >                       },
    >                       "metadata": {
    >                           "labels": {
    >                               "capi.stackhpc.com/cluster": "somerville-jade-20240221-work",
    >                               "capi.stackhpc.com/component": "control-plane"
    >                           }
    >                       },
    >                       "nodeDrainTimeout": "5m0s"
    >                   },
    >                   "replicas": 3,
    >                   "rolloutStrategy": {
    >                       "rollingUpdate": {
    >                           "maxSurge": 1
    >                       },
    >                       "type": "RollingUpdate"
    >                   },
    >                   "version": "v1.26.7"
    >               },
    >               "status": {
    >                   "conditions": [
    >                       {
    >                           "lastTransitionTime": "2024-02-21T06:44:12Z",
    >                           "message": "Scaling up control plane to 3 replicas (actual 1)",
    >                           "reason": "ScalingUp",
    >                           "severity": "Warning",
    >                           "status": "False",
    >                           "type": "Ready"
    >                       },
    >                       {
    >                           "lastTransitionTime": "2024-02-21T06:45:58Z",
    >                           "status": "True",
    >                           "type": "Available"
    >                       },
    >                       {
    >                           "lastTransitionTime": "2024-02-21T06:43:51Z",
    >                           "status": "True",
    >                           "type": "CertificatesAvailable"
    >                       },
    >                       {
    >                           "lastTransitionTime": "2024-02-21T06:56:02Z",
    >                           "message": "Node failed to report startup in 10m0s",
    >                           "reason": "NodeStartupTimeout @ /somerville-jade-20240221-work-control-plane-bdfrr",
    >                           "severity": "Warning",
    >                           "status": "False",
    >                           "type": "MachinesReady"
    >                       },
    >                       {
    >                           "lastTransitionTime": "2024-02-21T06:44:12Z",
    >                           "message": "Scaling up control plane to 3 replicas (actual 1)",
    >                           "reason": "ScalingUp",
    >                           "severity": "Warning",
    >                           "status": "False",
    >                           "type": "Resized"
    >                       }
    >                   ],
    >                   "initialized": true,
    >                   "observedGeneration": 2,
    >                   "ready": true,
    >                   "readyReplicas": 1,
    >                   "replicas": 1,
    >                   "selector": "cluster.x-k8s.io/cluster-name=somerville-jade-20240221-work,cluster.x-k8s.io/control-plane",
    >                   "unavailableReplicas": 0,
    >                   "updatedReplicas": 1
    >               }
    >           }
    >       ],
    >       "kind": "List",
    >       "metadata": {
    >           "resourceVersion": ""
    >       }
    >   }


    ssh bootstrap -t \
        '
        source loadconfig
        kubectl \
            --kubeconfig "${kindclusterconf:?}" \
            get KubeadmControlPlane \
                --namespace default \
                --output json \
                "somerville-jade-20240221-work-control-plane" \
        | jq ".status"
        '

    >   {
    >     "conditions": [
    >       {
    >         "lastTransitionTime": "2024-02-21T06:44:12Z",
    >         "message": "Scaling up control plane to 3 replicas (actual 1)",
    >         "reason": "ScalingUp",
    >         "severity": "Warning",
    >         "status": "False",
    >         "type": "Ready"
    >       },
    >       {
    >         "lastTransitionTime": "2024-02-21T06:45:58Z",
    >         "status": "True",
    >         "type": "Available"
    >       },
    >       {
    >         "lastTransitionTime": "2024-02-21T06:43:51Z",
    >         "status": "True",
    >         "type": "CertificatesAvailable"
    >       },
    >       {
    >         "lastTransitionTime": "2024-02-21T06:56:02Z",
    >         "message": "Node failed to report startup in 10m0s",
    >         "reason": "NodeStartupTimeout @ /somerville-jade-20240221-work-control-plane-bdfrr",
    >         "severity": "Warning",
    >         "status": "False",
    >         "type": "MachinesReady"
    >       },
    >       {
    >         "lastTransitionTime": "2024-02-21T06:44:12Z",
    >         "message": "Scaling up control plane to 3 replicas (actual 1)",
    >         "reason": "ScalingUp",
    >         "severity": "Warning",
    >         "status": "False",
    >         "type": "Resized"
    >       }
    >     ],
    >     "initialized": true,
    >     "observedGeneration": 2,
    >     "ready": true,
    >     "readyReplicas": 1,
    >     "replicas": 1,
    >     "selector": "cluster.x-k8s.io/cluster-name=somerville-jade-20240221-work,cluster.x-k8s.io/control-plane",
    >     "unavailableReplicas": 0,
    >     "updatedReplicas": 1
    >   }


# -----------------------------------------------------
# List stuff in the work cluster ....
#[root@ansibler]



# -----------------------------------------------------
# Try connect to the metrics endpoint.
# https://github.com/stackhpc/capi-helm-charts/tree/main/charts/cluster-addons#monitoring-and-logging
#[root@ansibler]

    source /deployments/cluster-api/ansible/files/aglais/bin/loadconfig

    kubectl \
        --kubeconfig "${workclusterconf:?}" \
        --namespace monitoring-system \
        port-forward \
            svc/kube-prometheus-stack-grafana \
            3000:80

    #
    # Need to use ssh port forwarding as well.
    # podman -> client
    #   ssh socks desktop -> bootstrap
    #     kubectl bootstrap -> work
    #       ....
    #
    # Added port 3001 to the podman command
    #

# -----------------------------------------------------
# Watch the cluster status ...
#[root@bootstrap]

    clusterctl \
        --kubeconfig "${kindclusterconf:?}" \
        describe cluster \
            "${workclustername:?}"

    >   NAME                                                                              READY  SEVERITY  REASON                       SINCE  MESSAGE
    >   Cluster/somerville-jade-20240221-work                                             False  Warning   ScalingUp                    3h33m  Scaling up control plane to 3 replicas (actual 1)
    >   ├─ClusterInfrastructure - OpenStackCluster/somerville-jade-20240221-work
    >   ├─ControlPlane - KubeadmControlPlane/somerville-jade-20240221-work-control-plane  False  Warning   ScalingUp                    3h33m  Scaling up control plane to 3 replicas (actual 1)
    >   │ └─Machine/somerville-jade-20240221-work-control-plane-bdfrr                     False  Warning   NodeStartupTimeout           3h22m  Node failed to report startup in 10m0s
    >   └─Workers
    >     └─MachineDeployment/somerville-jade-20240221-work-md-0                          False  Warning   WaitingForAvailableMachines  3h35m  Minimum availability requires 5 replicas, current 0 available
    >       └─6 Machines...                                                               True                                          6m21s  See somerville-jade-20240221-work-md-0-bc4ps-5bvnv, somerville-jade-20240221-work-md-0-bc4ps-dd6rs, ...

    #
    # 5hrs and counting ...
    # 6hrs and counting ...
    # 30hrs ....
    #

    clusterctl \
        --kubeconfig "${kindclusterconf:?}" \
        describe cluster \
            "${workclustername:?}"

    >   NAME                                                                              READY  SEVERITY  REASON                       SINCE  MESSAGE
    >   Cluster/somerville-jade-20240221-work                                             False  Warning   ScalingUp                    30h    Scaling up control plane to 3 replicas (actual 1)
    >   ├─ClusterInfrastructure - OpenStackCluster/somerville-jade-20240221-work
    >   ├─ControlPlane - KubeadmControlPlane/somerville-jade-20240221-work-control-plane  False  Warning   ScalingUp                    30h    Scaling up control plane to 3 replicas (actual 1)
    >   │ └─Machine/somerville-jade-20240221-work-control-plane-bdfrr                     False  Warning   NodeStartupTimeout           30h    Node failed to report startup in 10m0s
    >   └─Workers
    >     └─MachineDeployment/somerville-jade-20240221-work-md-0                          False  Warning   WaitingForAvailableMachines  30h    Minimum availability requires 5 replicas, current 0 available
    >       └─6 Machines...                                                               True                                          5m50s  See somerville-jade-20240221-work-md-0-bc4ps-6x8lk, somerville-jade-20240221-work-md-0-bc4ps-nlwb7, ...




#
# <meta:header>
#   <meta:licence>
#     Copyright (c) 2024, ROE (http://www.roe.ac.uk/)
#
#     This information is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This information is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
#   </meta:licence>
# </meta:header>
#
#zrq-notes-time
#zrq-notes-indent
#zrq-notes-crypto
#zrq-notes-ansible
#zrq-notes-osformat
#zrq-notes-zeppelin
#
# AIMetrics: []
#

    Target:

        Test out the new flavors and quota on Somerville.
        First deploy with no changes, just to check.
        Then deploy with new flavors and quota.

        The first deployment with no changes failed,
        turning this into an epic debugging session.

        Many thanks to Alex Welsh and Scott Davidson from StackHPC
        for talking me through the debugging process.

    Result:

        Work in progress ...


# -----------------------------------------------------
# Start a new branch.
#[user@desktop]

    branchname=new-flavors

    source "${HOME:?}/aglais.env"
    pushd "${AGLAIS_CODE}"

        newbranch=$(date '+%Y%m%d')-zrq-${branchname:?}

        git checkout master

        git checkout -b "${newbranch:?}"

    popd


# -----------------------------------------------------
# Run our local client.
#[user@desktop]

    source "${HOME:?}/aglais.env"
    export PATH=${PATH}:${AGLAIS_CODE}/bin

    agclient jade

    >   ....
    >   ....


# -----------------------------------------------------
# Delete and create everything.
#[root@ansibler]

    export cloudsite=somerville-jade

    /deployments/openstack/bin/delete-all.sh \
        "${cloudname:?}"

    ansible-playbook \
        --inventory 'bootstrap,' \
        '/deployments/cluster-api/ansible/00-create-all.yml'

    >   ....
    >   ....
    >   PLAY RECAP **********************************************************************************************************************
    >   bootstrap                  : ok=58   changed=45   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
    >   localhost                  : ok=35   changed=26   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0


# -----------------------------------------------------
# Check the cluster status.
#[root@ansibler]

    ssh bootstrap -t \
        '
        source loadconfig
        watch \
            clusterctl \
                --kubeconfig "${kindclusterconf:?}" \
                describe cluster \
                    "${workclustername:?}"
        '

    >   NAME                                                                              READY  SEVERITY  REASON                       SINCE  MESSAGE
    >   Cluster/somerville-jade-20240123-work                                             True                                          5m
    >   ├─ClusterInfrastructure - OpenStackCluster/somerville-jade-20240123-work
    >   ├─ControlPlane - KubeadmControlPlane/somerville-jade-20240123-work-control-plane  True                                          5m
    >   │ └─Machine/somerville-jade-20240123-work-control-plane-hql8j                     True                                          6m38s
    >   └─Workers
    >     └─MachineDeployment/somerville-jade-20240123-work-md-0                          False  Warning   WaitingForAvailableMachines  8m37s  Minimum availability requires 2 replicas, current 0 available
    >       └─3 Machines...                                                               True                                          4m44s  See somerville-jade-20240123-work-md-0-d6nk8-295vn, somerville-jade-20240123-work-md-0-d6nk8-xbbxc, ...

    #
    # Back to not working :-(
    #


# -----------------------------------------------------
# -----------------------------------------------------
# List the Helm releases.
#[root@bootstrap]

    source loadconfig
    kubectl \
        --kubeconfig "${kindclusterconf:?}" \
        get helmrelease -A

    >   NAMESPACE   NAME                                                      CLUSTER                         BOOTSTRAP   TARGET NAMESPACE         RELEASE NAME                PHASE        REVISION   CHART NAME                           CHART VERSION   AGE
    >   default     somerville-jade-20240123-work-ccm-openstack               somerville-jade-20240123-work   true        openstack-system         ccm-openstack               Deployed     1          openstack-cloud-controller-manager   1.3.0           16m
    >   default     somerville-jade-20240123-work-cni-calico                  somerville-jade-20240123-work   true        tigera-operator          cni-calico                  Deployed     1          tigera-operator                      v3.26.0         16m
    >   default     somerville-jade-20240123-work-csi-cinder                  somerville-jade-20240123-work   true        openstack-system         csi-cinder                  Installing              openstack-cinder-csi                 2.2.0           16m
    >   default     somerville-jade-20240123-work-kubernetes-dashboard        somerville-jade-20240123-work   true        kubernetes-dashboard     kubernetes-dashboard        Deployed     1          kubernetes-dashboard                 5.10.0          16m
    >   default     somerville-jade-20240123-work-mellanox-network-operator   somerville-jade-20240123-work   true        network-operator         mellanox-network-operator   Installing              network-operator                     1.3.0           16m
    >   default     somerville-jade-20240123-work-metrics-server              somerville-jade-20240123-work   true        kube-system              metrics-server              Installing              metrics-server                       3.8.2           16m
    >   default     somerville-jade-20240123-work-node-feature-discovery      somerville-jade-20240123-work   true        node-feature-discovery   node-feature-discovery      Installing              node-feature-discovery               0.11.2          16m
    >   default     somerville-jade-20240123-work-nvidia-gpu-operator         somerville-jade-20240123-work   true        gpu-operator             nvidia-gpu-operator         Installing              gpu-operator                         v1.11.1         16m


    ssh bootstrap -t \
        '
        source loadconfig
        kubectl \
            --kubeconfig "${workclusterconf:?}" \
            get helmrelease -A
        '

    >   E0123 11:54:11.824302   13707 memcache.go:287] couldn't get resource list for metrics.k8s.io/v1beta1: the server is currently unable to handle the request
    >   E0123 11:54:11.832176   13707 memcache.go:121] couldn't get resource list for metrics.k8s.io/v1beta1: the server is currently unable to handle the request
    >   E0123 11:54:11.843122   13707 memcache.go:121] couldn't get resource list for metrics.k8s.io/v1beta1: the server is currently unable to handle the request
    >   E0123 11:54:11.846845   13707 memcache.go:121] couldn't get resource list for metrics.k8s.io/v1beta1: the server is currently unable to handle the request
    >   E0123 11:54:11.854335   13707 memcache.go:121] couldn't get resource list for metrics.k8s.io/v1beta1: the server is currently unable to handle the request
    >   error: the server doesn't have a resource type "helmrelease"


    kubectl \
        --kubeconfig "${kindclusterconf:?}" \
        get helmrelease \
            --all-namespaces

    >   NAMESPACE   NAME                                                      CLUSTER                         BOOTSTRAP   TARGET NAMESPACE         RELEASE NAME                PHASE        REVISION   CHART NAME                           CHART VERSION   AGE
    >   default     somerville-jade-20240123-work-ccm-openstack               somerville-jade-20240123-work   true        openstack-system         ccm-openstack               Deployed     1          openstack-cloud-controller-manager   1.3.0           16m
    >   default     somerville-jade-20240123-work-cni-calico                  somerville-jade-20240123-work   true        tigera-operator          cni-calico                  Deployed     1          tigera-operator                      v3.26.0         16m
    >   default     somerville-jade-20240123-work-csi-cinder                  somerville-jade-20240123-work   true        openstack-system         csi-cinder                  Installing              openstack-cinder-csi                 2.2.0           16m
    >   default     somerville-jade-20240123-work-kubernetes-dashboard        somerville-jade-20240123-work   true        kubernetes-dashboard     kubernetes-dashboard        Deployed     1          kubernetes-dashboard                 5.10.0          16m
    >   default     somerville-jade-20240123-work-mellanox-network-operator   somerville-jade-20240123-work   true        network-operator         mellanox-network-operator   Installing              network-operator                     1.3.0           16m
    >   default     somerville-jade-20240123-work-metrics-server              somerville-jade-20240123-work   true        kube-system              metrics-server              Installing              metrics-server                       3.8.2           16m
    >   default     somerville-jade-20240123-work-node-feature-discovery      somerville-jade-20240123-work   true        node-feature-discovery   node-feature-discovery      Installing              node-feature-discovery               0.11.2          16m
    >   default     somerville-jade-20240123-work-nvidia-gpu-operator         somerville-jade-20240123-work   true        gpu-operator             nvidia-gpu-operator         Installing              gpu-operator                         v1.11.1         16m


    kubectl \
        --kubeconfig "${kindclusterconf:?}" \
        get pods \
            --all-namespaces

    >   NAMESPACE                           NAME                                                                  READY   STATUS             RESTARTS        AGE
    >   capi-kubeadm-bootstrap-system       capi-kubeadm-bootstrap-controller-manager-7db568c844-kmbmt            1/1     Running            0               29m
    >   capi-kubeadm-control-plane-system   capi-kubeadm-control-plane-controller-manager-7f9b558f5c-5r2mm        1/1     Running            0               29m
    >   capi-system                         capi-controller-manager-76955c46b9-drqph                              1/1     Running            0               29m
    >   capo-system                         capo-controller-manager-544cb69b9d-njccn                              1/1     Running            0               29m
    >   cert-manager                        cert-manager-66d9545484-5mf9c                                         1/1     Running            0               31m
    >   cert-manager                        cert-manager-cainjector-7d8b6bd6fb-p89lw                              1/1     Running            0               31m
    >   cert-manager                        cert-manager-webhook-669b96dcfd-wq5zt                                 1/1     Running            0               31m
    >   default                             cluster-api-addon-provider-66cc76bbbf-jmlq2                           1/1     Running            0               29m
    >   default                             somerville-jade-20240123-work-autoscaler-59658d94b6-jxx6d             0/1     CrashLoopBackOff   9 (2m15s ago)   27m
    >   kube-system                         coredns-5d78c9869d-hrp6n                                              1/1     Running            0               31m
    >   kube-system                         coredns-5d78c9869d-nt956                                              1/1     Running            0               31m
    >   kube-system                         etcd-somerville-jade-20240123-kind-control-plane                      1/1     Running            0               32m
    >   kube-system                         kindnet-s2f52                                                         1/1     Running            0               31m
    >   kube-system                         kube-apiserver-somerville-jade-20240123-kind-control-plane            1/1     Running            0               31m
    >   kube-system                         kube-controller-manager-somerville-jade-20240123-kind-control-plane   1/1     Running            0               32m
    >   kube-system                         kube-proxy-nz7xd                                                      1/1     Running            0               31m
    >   kube-system                         kube-scheduler-somerville-jade-20240123-kind-control-plane            1/1     Running            0               32m
    >   local-path-storage                  local-path-provisioner-6bc4bddd6b-58fs2                               1/1     Running            0               31m


    kubectl \
        --kubeconfig "${workclusterconf:?}" \
        get pods \
            --all-namespaces

    >   E0123 12:04:43.708937   14021 memcache.go:287] couldn't get resource list for metrics.k8s.io/v1beta1: the server is currently unable to handle the request
    >   E0123 12:04:43.744442   14021 memcache.go:121] couldn't get resource list for metrics.k8s.io/v1beta1: the server is currently unable to handle the request
    >   E0123 12:04:43.749007   14021 memcache.go:121] couldn't get resource list for metrics.k8s.io/v1beta1: the server is currently unable to handle the request
    >   E0123 12:04:43.753613   14021 memcache.go:121] couldn't get resource list for metrics.k8s.io/v1beta1: the server is currently unable to handle the request
    >   NAMESPACE                NAME                                                                                 READY   STATUS              RESTARTS        AGE
    >   calico-system            calico-kube-controllers-6f994d9b59-z7fhs                                             0/1     Pending             0               23m
    >   calico-system            calico-node-5jdwc                                                                    1/1     Running             0               3m14s
    >   calico-system            calico-node-h7gcn                                                                    1/1     Running             0               2m59s
    >   calico-system            calico-node-mqgjj                                                                    1/1     Running             0               22m
    >   calico-system            calico-node-mvtbk                                                                    0/1     CrashLoopBackOff    6 (6m2s ago)    13m
    >   calico-system            calico-node-nkmtb                                                                    1/1     Running             0               3m15s
    >   calico-system            calico-node-p5vc8                                                                    1/1     Running             0               11m
    >   calico-system            calico-node-pzbgq                                                                    1/1     Running             0               23m
    >   calico-system            calico-node-qkdjb                                                                    1/1     Running             0               22m
    >   calico-system            calico-node-rj7jk                                                                    1/1     Running             0               11m
    >   calico-system            calico-node-z8fvd                                                                    1/1     Running             0               22m
    >   calico-system            calico-typha-588d9ffd8c-6dfw8                                                        1/1     Running             0               22m
    >   calico-system            calico-typha-588d9ffd8c-b5mmg                                                        1/1     Running             0               13m
    >   calico-system            calico-typha-588d9ffd8c-btgbm                                                        1/1     Running             0               23m
    >   calico-system            csi-node-driver-8kxmh                                                                2/2     Running             0               22m
    >   calico-system            csi-node-driver-8xmbj                                                                2/2     Running             0               3m14s
    >   calico-system            csi-node-driver-9dmxv                                                                0/2     ContainerCreating   0               13m
    >   calico-system            csi-node-driver-cztgj                                                                2/2     Running             0               3m15s
    >   calico-system            csi-node-driver-ktngs                                                                2/2     Running             0               22m
    >   calico-system            csi-node-driver-pg72j                                                                2/2     Running             0               22m
    >   calico-system            csi-node-driver-rhx88                                                                2/2     Running             0               11m
    >   calico-system            csi-node-driver-rp8l6                                                                2/2     Running             0               11m
    >   calico-system            csi-node-driver-vs6nf                                                                2/2     Running             0               2m59s
    >   calico-system            csi-node-driver-zchr5                                                                2/2     Running             0               23m
    >   gpu-operator             gpu-operator-6c8649c88c-x4pxp                                                        0/1     Pending             0               22m
    >   kube-system              coredns-787d4945fb-fvbzn                                                             0/1     Pending             0               24m
    >   kube-system              coredns-787d4945fb-lcvkz                                                             0/1     Pending             0               24m
    >   kube-system              etcd-somerville-jade-20240123-work-control-plane-aa1b69e0-s5ncb                      1/1     Running             0               24m
    >   kube-system              kube-apiserver-somerville-jade-20240123-work-control-plane-aa1b69e0-s5ncb            1/1     Running             0               24m
    >   kube-system              kube-controller-manager-somerville-jade-20240123-work-control-plane-aa1b69e0-s5ncb   1/1     Running             0               24m
    >   kube-system              kube-proxy-2gv9n                                                                     1/1     Running             0               3m14s
    >   kube-system              kube-proxy-8g2kg                                                                     1/1     Running             0               22m
    >   kube-system              kube-proxy-dvcnv                                                                     1/1     Running             0               3m14s
    >   kube-system              kube-proxy-gsklp                                                                     1/1     Running             0               11m
    >   kube-system              kube-proxy-jmmf5                                                                     1/1     Running             0               22m
    >   kube-system              kube-proxy-mzb58                                                                     1/1     Running             0               13m
    >   kube-system              kube-proxy-pcnfv                                                                     1/1     Running             0               2m59s
    >   kube-system              kube-proxy-sm294                                                                     1/1     Running             0               11m
    >   kube-system              kube-proxy-wr85g                                                                     1/1     Running             0               24m
    >   kube-system              kube-proxy-xvb9n                                                                     1/1     Running             0               22m
    >   kube-system              kube-scheduler-somerville-jade-20240123-work-control-plane-aa1b69e0-s5ncb            1/1     Running             0               24m
    >   kube-system              metrics-server-65cccfc7bb-lxcx6                                                      0/1     Pending             0               24m
    >   kubernetes-dashboard     kubernetes-dashboard-85d67585b8-hfdk7                                                0/2     Pending             0               24m
    >   network-operator         mellanox-network-operator-5f7b6b766c-4cxnj                                           0/1     Pending             0               22m
    >   node-feature-discovery   node-feature-discovery-master-75c9d78d5f-f97c8                                       0/1     Pending             0               24m
    >   node-feature-discovery   node-feature-discovery-worker-25wcz                                                  0/1     CrashLoopBackOff    7 (30s ago)     24m
    >   node-feature-discovery   node-feature-discovery-worker-48nzw                                                  1/1     Running             1 (60s ago)     3m14s
    >   node-feature-discovery   node-feature-discovery-worker-48zgq                                                  0/1     ContainerCreating   0               13m
    >   node-feature-discovery   node-feature-discovery-worker-8qdt7                                                  1/1     Running             4 (15m ago)     22m
    >   node-feature-discovery   node-feature-discovery-worker-cgww4                                                  1/1     Running             3 (15m ago)     22m
    >   node-feature-discovery   node-feature-discovery-worker-gml9h                                                  1/1     Running             3 (15m ago)     22m
    >   node-feature-discovery   node-feature-discovery-worker-nh9fd                                                  1/1     Running             4 (5m14s ago)   11m
    >   node-feature-discovery   node-feature-discovery-worker-s6lbz                                                  1/1     Running             2 (31s ago)     3m14s
    >   node-feature-discovery   node-feature-discovery-worker-svhbl                                                  1/1     Running             1 (25s ago)     2m59s
    >   node-feature-discovery   node-feature-discovery-worker-wfd77                                                  0/1     Error               4 (5m53s ago)   11m
    >   openstack-system         openstack-cinder-csi-controllerplugin-b5bb59498-6hnp8                                0/6     Pending             0               24m
    >   openstack-system         openstack-cinder-csi-nodeplugin-7t5mk                                                0/3     ContainerCreating   0               22m
    >   openstack-system         openstack-cinder-csi-nodeplugin-bj7c7                                                0/3     ContainerCreating   0               11m
    >   openstack-system         openstack-cinder-csi-nodeplugin-cnlrv                                                0/3     ContainerCreating   0               3m14s
    >   openstack-system         openstack-cinder-csi-nodeplugin-hwft8                                                0/3     ContainerCreating   0               3m14s
    >   openstack-system         openstack-cinder-csi-nodeplugin-j6czn                                                0/3     ContainerCreating   0               2m59s
    >   openstack-system         openstack-cinder-csi-nodeplugin-lpqd8                                                0/3     ContainerCreating   0               13m
    >   openstack-system         openstack-cinder-csi-nodeplugin-n46lq                                                0/3     ContainerCreating   0               11m
    >   openstack-system         openstack-cinder-csi-nodeplugin-rdqgl                                                0/3     ContainerCreating   0               22m
    >   openstack-system         openstack-cinder-csi-nodeplugin-rj9k8                                                0/3     ContainerCreating   0               22m
    >   openstack-system         openstack-cinder-csi-nodeplugin-tq5jc                                                0/3     ContainerCreating   0               24m
    >   openstack-system         openstack-cloud-controller-manager-wmhqr                                             0/1     ContainerCreating   0               21m
    >   tigera-operator          tigera-operator-7d4cfffc6-bv7gq                                                      1/1     Running             0               23m


# -----------------------------------------------------
# -----------------------------------------------------
# List our Openstack resources.
#[root@ansibler]

    /deployments/openstack/bin/list-all.sh \
        "${cloudname:?}"

    >   ---- ---- ----
    >   File [list-all.sh]
    >   Path [/deployments/openstack/bin]
    >   Tree [/deployments]
    >   ---- ---- ----
    >   Cloud name [somerville-jade]
    >   ---- ---- ----
    >   
    >   ---- ----
    >   Magnum clusters
    >   
    >   ---- ----
    >   Nova servers
    >   +--------------------------------------+------------------------------------------------------------+--------+----------------------------------------------------------------------------+-----------------------------------+-----------------+
    >   | ID                                   | Name                                                       | Status | Networks                                                                   | Image                             | Flavor          |
    >   +--------------------------------------+------------------------------------------------------------+--------+----------------------------------------------------------------------------+-----------------------------------+-----------------+
    >   | ada6371d-b618-41c6-b188-11f0383cefe5 | somerville-jade-20240123-work-md-0-d078a3a6-cb672          | BUILD  |                                                                            | gaia-dmp-ubuntu-2204-kube-v1.26.7 | qserv-worker-v2 |
    >   | 0f1078e4-05bf-4a5d-b3b8-bdbe8f4541b0 | somerville-jade-20240123-work-md-0-d078a3a6-4nn6t          | ACTIVE | k8s-clusterapi-cluster-default-somerville-jade-20240123-work=192.168.3.44  | gaia-dmp-ubuntu-2204-kube-v1.26.7 | qserv-worker-v2 |
    >   | 1525b338-4bc0-4b7d-84f9-b899f671d055 | somerville-jade-20240123-work-md-0-d078a3a6-rnx6j          | ACTIVE | k8s-clusterapi-cluster-default-somerville-jade-20240123-work=192.168.3.207 | gaia-dmp-ubuntu-2204-kube-v1.26.7 | qserv-worker-v2 |
    >   | 37798e83-9b7c-40ef-b320-23906f6c2999 | somerville-jade-20240123-work-control-plane-aa1b69e0-s5ncb | ACTIVE | k8s-clusterapi-cluster-default-somerville-jade-20240123-work=192.168.3.225 | gaia-dmp-ubuntu-2204-kube-v1.26.7 | qserv-jump-v2   |
    >   | 43005b66-703e-4458-b8da-baf25bc10886 | somerville-jade-20240123-bootstrap-node                    | ACTIVE | somerville-jade-20240123-bootstrap-network=10.10.0.183, 192.41.122.36      | gaia-dmp-fedora-cloud-38-1.6      | qserv-jump-v2   |
    >   +--------------------------------------+------------------------------------------------------------+--------+----------------------------------------------------------------------------+-----------------------------------+-----------------+
    >   
    >   ---- ----
    >   Cinder volumes
    >   
    >   
    >   ---- ----
    >   Manila shares
    >   
    >   
    >   ---- ----
    >   Floating addresses
    >   +--------------------------------------+---------------------+------------------+--------------------------------------+--------------------------------------+----------------------------------+
    >   | ID                                   | Floating IP Address | Fixed IP Address | Port                                 | Floating Network                     | Project                          |
    >   +--------------------------------------+---------------------+------------------+--------------------------------------+--------------------------------------+----------------------------------+
    >   | 1e2e4757-0650-4785-a78a-8a918e24f3b2 | 192.41.122.36       | 10.10.0.183      | 6371588f-7c2e-42d6-abe5-f0994cb8f261 | 1875828a-ccc3-419b-87fd-856aaa781492 | be227fe0300b4ce5b03f44264df615df |
    >   | 4ee1ebf0-f221-4074-9caa-9d0df994d81d | 192.41.122.154      | 192.168.3.84     | 939c9f88-8e11-4d5f-889f-7a8f91013412 | 1875828a-ccc3-419b-87fd-856aaa781492 | be227fe0300b4ce5b03f44264df615df |
    >   +--------------------------------------+---------------------+------------------+--------------------------------------+--------------------------------------+----------------------------------+
    >   
    >   ---- ----
    >   Load balancers
    >   +--------------------------------------+----------------------------------------------------------------------+----------------------------------+--------------+---------------------+------------------+----------+
    >   | id                                   | name                                                                 | project_id                       | vip_address  | provisioning_status | operating_status | provider |
    >   +--------------------------------------+----------------------------------------------------------------------+----------------------------------+--------------+---------------------+------------------+----------+
    >   | febc0ed1-7aaf-4cc8-9bbf-9b48d16730e3 | k8s-clusterapi-cluster-default-somerville-jade-20240123-work-kubeapi | be227fe0300b4ce5b03f44264df615df | 192.168.3.84 | ACTIVE              | ONLINE           | amphora  |
    >   +--------------------------------------+----------------------------------------------------------------------+----------------------------------+--------------+---------------------+------------------+----------+
    >   
    >   ---- ----
    >   Routers
    >   +--------------------------------------+--------------------------------------------------------------+--------+-------+----------------------------------+
    >   | ID                                   | Name                                                         | Status | State | Project                          |
    >   +--------------------------------------+--------------------------------------------------------------+--------+-------+----------------------------------+
    >   | 0debe918-8758-44eb-b5ed-897d31d343bd | k8s-clusterapi-cluster-default-somerville-jade-20240123-work | ACTIVE | UP    | be227fe0300b4ce5b03f44264df615df |
    >   | 44ad4fe0-f87e-4475-af4f-ff8979c38e5e | somerville-jade-20240123-bootstrap-network-router            | ACTIVE | UP    | be227fe0300b4ce5b03f44264df615df |
    >   +--------------------------------------+--------------------------------------------------------------+--------+-------+----------------------------------+
    >   
    >   ---- ----
    >   Networks
    >   +--------------------------------------+--------------------------------------------------------------+--------------------------------------+
    >   | ID                                   | Name                                                         | Subnets                              |
    >   +--------------------------------------+--------------------------------------------------------------+--------------------------------------+
    >   | 12a61257-7a3d-49c4-b379-540b9e61b83e | cephfs                                                       | d94f3b30-c4c4-431b-8e85-d6304df5c843 |
    >   | 1875828a-ccc3-419b-87fd-856aaa781492 | external                                                     | 04e4d1f2-8884-4071-aab6-e31c5ae375a4 |
    >   | 31d00f46-e1cb-41a8-a935-52f33be309ce | test                                                         | 6ed03fc2-b47f-4d88-a2b7-b9efe467d122 |
    >   | 3d028d5b-c14d-4104-91dc-42c8701f0340 | rally_verify_efb37a30_lhNtSXSE                               | cf672531-d22e-49ab-ada0-80cde1e0eb1a |
    >   | 4acdf774-0688-4c7c-8698-bdf76b5d2847 | somerville-jade-20240123-bootstrap-network                   | 092bc9ce-6a35-4784-b908-05398b64efb2 |
    >   | c77c3002-388d-401a-af69-923149978dea | k8s-clusterapi-cluster-default-somerville-jade-20240123-work | 86f09703-3916-4a29-af29-7fc0116a7991 |
    >   +--------------------------------------+--------------------------------------------------------------+--------------------------------------+
    >   
    >   ---- ----
    >   Subnets
    >   +--------------------------------------+--------------------------------------------------------------+--------------------------------------+----------------+
    >   | ID                                   | Name                                                         | Network                              | Subnet         |
    >   +--------------------------------------+--------------------------------------------------------------+--------------------------------------+----------------+
    >   | 092bc9ce-6a35-4784-b908-05398b64efb2 | somerville-jade-20240123-bootstrap-network-subnet            | 4acdf774-0688-4c7c-8698-bdf76b5d2847 | 10.10.0.0/16   |
    >   | 6ed03fc2-b47f-4d88-a2b7-b9efe467d122 | test-subnet                                                  | 31d00f46-e1cb-41a8-a935-52f33be309ce | 10.65.0.0/24   |
    >   | 86f09703-3916-4a29-af29-7fc0116a7991 | k8s-clusterapi-cluster-default-somerville-jade-20240123-work | c77c3002-388d-401a-af69-923149978dea | 192.168.3.0/24 |
    >   | cf672531-d22e-49ab-ada0-80cde1e0eb1a | rally_verify_efb37a30_s4najSGz                               | 3d028d5b-c14d-4104-91dc-42c8701f0340 | 10.2.0.0/24    |
    >   | d94f3b30-c4c4-431b-8e85-d6304df5c843 | cephfs-subnet                                                | 12a61257-7a3d-49c4-b379-540b9e61b83e | 10.21.0.0/16   |
    >   +--------------------------------------+--------------------------------------------------------------+--------------------------------------+----------------+
    >   
    >   ---- ----
    >   Security groups
    >   +--------------------------------------+-------------------------------------------------------------------------+---------------------------+----------------------------------+------+
    >   | ID                                   | Name                                                                    | Description               | Project                          | Tags |
    >   +--------------------------------------+-------------------------------------------------------------------------+---------------------------+----------------------------------+------+
    >   | 59625c4d-2800-4d87-b293-8061eca42d53 | k8s-cluster-default-somerville-jade-20240123-work-secgroup-controlplane | Cluster API managed group | be227fe0300b4ce5b03f44264df615df | []   |
    >   | 652235ec-b5ed-428a-a83a-e1c281f79001 | default                                                                 | Default security group    | be227fe0300b4ce5b03f44264df615df | []   |
    >   | 85aa01af-7204-48fc-9f18-6c9490d464a7 | k8s-cluster-default-somerville-jade-20240123-work-secgroup-worker       | Cluster API managed group | be227fe0300b4ce5b03f44264df615df | []   |
    >   | c98cfc9e-38b8-46aa-a81e-d78c649b87bb | somerville-jade-20240123-bootstrap-security                             |                           | be227fe0300b4ce5b03f44264df615df | []   |
    >   +--------------------------------------+-------------------------------------------------------------------------+---------------------------+----------------------------------+------+
    >   
    >   ---- ----
    >   SSH keys
    >   +---------------------------------------+-------------------------------------------------+------+
    >   | Name                                  | Fingerprint                                     | Type |
    >   +---------------------------------------+-------------------------------------------------+------+
    >   | somerville-gaia-jade-20240110-keypair | 2e:84:98:98:df:70:06:0e:4c:ed:bd:d4:d6:6b:eb:16 | ssh  |
    >   | somerville-jade-20240123-keypair      | 2e:84:98:98:df:70:06:0e:4c:ed:bd:d4:d6:6b:eb:16 | ssh  |
    >   | test-20240110-keypair                 | 2e:84:98:98:df:70:06:0e:4c:ed:bd:d4:d6:6b:eb:16 | ssh  |
    >   +---------------------------------------+-------------------------------------------------+------+


# -----------------------------------------------------
# List the active servers.
#[root@ansibler]

    openstack \
        --os-cloud "${cloudname:?}" \
        server list

    >   +--------------------------------------+------------------------------------------------------------+--------+----------------------------------------------------------------------------+-----------------------------------+-----------------+
    >   | ID                                   | Name                                                       | Status | Networks                                                                   | Image                             | Flavor          |
    >   +--------------------------------------+------------------------------------------------------------+--------+----------------------------------------------------------------------------+-----------------------------------+-----------------+
    >   | 97d2f19d-872b-4078-a93a-e4022f546da0 | somerville-jade-20240123-work-md-0-d078a3a6-8pz8r          | ACTIVE | k8s-clusterapi-cluster-default-somerville-jade-20240123-work=192.168.3.52  | gaia-dmp-ubuntu-2204-kube-v1.26.7 | qserv-worker-v2 |
    >   | 7f0fdc7c-4013-46e2-967d-7c79213cfd6b | somerville-jade-20240123-work-md-0-d078a3a6-nr2mv          | ACTIVE | k8s-clusterapi-cluster-default-somerville-jade-20240123-work=192.168.3.66  | gaia-dmp-ubuntu-2204-kube-v1.26.7 | qserv-worker-v2 |
    >   | 9578a773-af30-4179-87ed-6dc5f8659921 | somerville-jade-20240123-work-md-0-d078a3a6-9jm5r          | ACTIVE | k8s-clusterapi-cluster-default-somerville-jade-20240123-work=192.168.3.63  | gaia-dmp-ubuntu-2204-kube-v1.26.7 | qserv-worker-v2 |
    >   | 37798e83-9b7c-40ef-b320-23906f6c2999 | somerville-jade-20240123-work-control-plane-aa1b69e0-s5ncb | ACTIVE | k8s-clusterapi-cluster-default-somerville-jade-20240123-work=192.168.3.225 | gaia-dmp-ubuntu-2204-kube-v1.26.7 | qserv-jump-v2   |
    >   | 43005b66-703e-4458-b8da-baf25bc10886 | somerville-jade-20240123-bootstrap-node                    | ACTIVE | somerville-jade-20240123-bootstrap-network=10.10.0.183, 192.41.122.36      | gaia-dmp-fedora-cloud-38-1.6      | qserv-jump-v2   |
    >   +--------------------------------------+------------------------------------------------------------+--------+----------------------------------------------------------------------------+-----------------------------------+-----------------+


# -----------------------------------------------------
# -----------------------------------------------------
# Back on bootstrap.
#[root@bootstrap]

    #
    # KinD (managment) cluster has 3 worker machines.
    #

    kubectl \
        --kubeconfig "${kindclusterconf:?}" \
        get machines \
            --all-namespaces

    >   NAMESPACE   NAME                                                CLUSTER                         NODENAME   PROVIDERID                                          PHASE         AGE    VERSION
    >   default     somerville-jade-20240123-work-control-plane-hql8j   somerville-jade-20240123-work              openstack:///37798e83-9b7c-40ef-b320-23906f6c2999   Provisioned   106m   v1.26.7
    >   default     somerville-jade-20240123-work-md-0-d6nk8-f5znq      somerville-jade-20240123-work              openstack:///7f0fdc7c-4013-46e2-967d-7c79213cfd6b   Provisioned   2m     v1.26.7
    >   default     somerville-jade-20240123-work-md-0-d6nk8-mdx8f      somerville-jade-20240123-work              openstack:///97d2f19d-872b-4078-a93a-e4022f546da0   Provisioned   119s   v1.26.7
    >   default     somerville-jade-20240123-work-md-0-d6nk8-qd5qs      somerville-jade-20240123-work              openstack:///9578a773-af30-4179-87ed-6dc5f8659921   Provisioned   2m3s   v1.26.7


    #
    # Work (tenet) cluster has lots of NotReady nodes.
    #

    kubectl \
        --kubeconfig "${workclusterconf:?}" \
        get nodes

    >   E0123 13:25:32.442205   15034 memcache.go:287] couldn't get resource list for metrics.k8s.io/v1beta1: the server is currently unable to handle the request
    >   E0123 13:25:32.482340   15034 memcache.go:121] couldn't get resource list for metrics.k8s.io/v1beta1: the server is currently unable to handle the request
    >   E0123 13:25:32.485672   15034 memcache.go:121] couldn't get resource list for metrics.k8s.io/v1beta1: the server is currently unable to handle the request
    >   E0123 13:25:32.489080   15034 memcache.go:121] couldn't get resource list for metrics.k8s.io/v1beta1: the server is currently unable to handle the request
    >   NAME                                                         STATUS     ROLES           AGE     VERSION
    >   somerville-jade-20240123-work-control-plane-aa1b69e0-s5ncb   Ready      control-plane   105m    v1.26.7
    >   somerville-jade-20240123-work-md-0-d078a3a6-2b7j7            NotReady   <none>          63m     v1.26.7
    >   somerville-jade-20240123-work-md-0-d078a3a6-4n78z            NotReady   <none>          32m     v1.26.7
    >   somerville-jade-20240123-work-md-0-d078a3a6-4nn6t            NotReady   <none>          53m     v1.26.7
    >   somerville-jade-20240123-work-md-0-d078a3a6-4phxn            NotReady   <none>          32m     v1.26.7
    >   somerville-jade-20240123-work-md-0-d078a3a6-4qmmt            NotReady   <none>          103m    v1.26.7
    >   somerville-jade-20240123-work-md-0-d078a3a6-694t9            NotReady   <none>          43m     v1.26.7
    >   somerville-jade-20240123-work-md-0-d078a3a6-6fbzk            NotReady   <none>          42m     v1.26.7
    >   somerville-jade-20240123-work-md-0-d078a3a6-6rz8q            NotReady   <none>          92m     v1.26.7
    >   somerville-jade-20240123-work-md-0-d078a3a6-8p8jf            NotReady   <none>          12m     v1.26.7
    >   somerville-jade-20240123-work-md-0-d078a3a6-8pz8r            NotReady   <none>          2m12s   v1.26.7
    >   somerville-jade-20240123-work-md-0-d078a3a6-9jm5r            NotReady   <none>          114s    v1.26.7
    >   somerville-jade-20240123-work-md-0-d078a3a6-9q476            NotReady   <none>          63m     v1.26.7
    >   somerville-jade-20240123-work-md-0-d078a3a6-b6fr7            NotReady   <none>          94m     v1.26.7
    >   somerville-jade-20240123-work-md-0-d078a3a6-cb672            NotReady   <none>          50m     v1.26.7
    >   somerville-jade-20240123-work-md-0-d078a3a6-dqvww            NotReady   <none>          12m     v1.26.7
    >   somerville-jade-20240123-work-md-0-d078a3a6-fn27d            NotReady   <none>          92m     v1.26.7
    >   somerville-jade-20240123-work-md-0-d078a3a6-fs2lk            NotReady   <none>          63m     v1.26.7
    >   somerville-jade-20240123-work-md-0-d078a3a6-gznmt            NotReady   <none>          103m    v1.26.7
    >   somerville-jade-20240123-work-md-0-d078a3a6-kbs8w            NotReady   <none>          84m     v1.26.7
    >   somerville-jade-20240123-work-md-0-d078a3a6-kdlk7            NotReady   <none>          73m     v1.26.7
    >   somerville-jade-20240123-work-md-0-d078a3a6-kn6fn            NotReady   <none>          73m     v1.26.7
    >   somerville-jade-20240123-work-md-0-d078a3a6-ktd5t            NotReady   <none>          103m    v1.26.7
    >   somerville-jade-20240123-work-md-0-d078a3a6-kz9hg            NotReady   <none>          32m     v1.26.7
    >   somerville-jade-20240123-work-md-0-d078a3a6-m7tgr            NotReady   <none>          22m     v1.26.7
    >   somerville-jade-20240123-work-md-0-d078a3a6-nr2mv            NotReady   <none>          2m13s   v1.26.7
    >   somerville-jade-20240123-work-md-0-d078a3a6-nzdqc            NotReady   <none>          83m     v1.26.7
    >   somerville-jade-20240123-work-md-0-d078a3a6-pslz5            NotReady   <none>          84m     v1.26.7
    >   somerville-jade-20240123-work-md-0-d078a3a6-r8dlt            NotReady   <none>          42m     v1.26.7
    >   somerville-jade-20240123-work-md-0-d078a3a6-rnx6j            NotReady   <none>          53m     v1.26.7
    >   somerville-jade-20240123-work-md-0-d078a3a6-sp2vl            NotReady   <none>          73m     v1.26.7
    >   somerville-jade-20240123-work-md-0-d078a3a6-wnqf2            NotReady   <none>          22m     v1.26.7
    >   somerville-jade-20240123-work-md-0-d078a3a6-wz4gs            NotReady   <none>          12m     v1.26.7
    >   somerville-jade-20240123-work-md-0-d078a3a6-xt4mr            NotReady   <none>          22m     v1.26.7


    #
    # KinD (managment) cluster has openstackmachines for 3 workers.
    #

    kubectl \
        --kubeconfig "${kindclusterconf:?}" \
        get openstackmachine

    >   NAME                                                         CLUSTER                         INSTANCESTATE   READY   PROVIDERID                                          MACHINE                                             AGE
    >   somerville-jade-20240123-work-control-plane-aa1b69e0-s5ncb   somerville-jade-20240123-work   ACTIVE          true    openstack:///37798e83-9b7c-40ef-b320-23906f6c2999   somerville-jade-20240123-work-control-plane-hql8j   112m
    >   somerville-jade-20240123-work-md-0-d078a3a6-8pz8r            somerville-jade-20240123-work   ACTIVE          true    openstack:///97d2f19d-872b-4078-a93a-e4022f546da0   somerville-jade-20240123-work-md-0-d6nk8-mdx8f      8m19s
    >   somerville-jade-20240123-work-md-0-d078a3a6-9jm5r            somerville-jade-20240123-work   ACTIVE          true    openstack:///9578a773-af30-4179-87ed-6dc5f8659921   somerville-jade-20240123-work-md-0-d6nk8-qd5qs      8m23s
    >   somerville-jade-20240123-work-md-0-d078a3a6-nr2mv            somerville-jade-20240123-work   ACTIVE          true    openstack:///7f0fdc7c-4013-46e2-967d-7c79213cfd6b   somerville-jade-20240123-work-md-0-d6nk8-f5znq      8m21s


    #
    # capi-system/capi-controller-manager lists lots of unhealthy nodes.
    #

    kubectl \
        --kubeconfig "${kindclusterconf:?}" \
        logs \
            --namespace capi-system \
            capi-controller-manager-76955c46b9-drqph

    >   ....
    >   ....
    >   I0123 13:33:05.623894       1 recorder.go:104] "events: Machine default/somerville-jade-20240123-work-md-0/somerville-jade-20240123-work-md-0-d6nk8-6j4qt/ has unhealthy node " type="Normal" object={"kind":"Machine","namespace":"default","name":"somerville-jade-20240123-work-md-0-d6nk8-6j4qt","uid":"8ce227dc-7848-41bc-a77d-5df3702d0364","apiVersion":"cluster.x-k8s.io/v1beta1","resourceVersion":"26449"} reason="DetectedUnhealthy"
    >   I0123 13:33:05.623951       1 recorder.go:104] "events: Machine default/somerville-jade-20240123-work-md-0/somerville-jade-20240123-work-md-0-d6nk8-bgcc6/ has unhealthy node " type="Normal" object={"kind":"Machine","namespace":"default","name":"somerville-jade-20240123-work-md-0-d6nk8-bgcc6","uid":"978be68c-0994-4d43-a4fe-7a166d4aed10","apiVersion":"cluster.x-k8s.io/v1beta1","resourceVersion":"26471"} reason="DetectedUnhealthy"
    >   ....
    >   ....


    #
    # Specifically looking for errors we get a mixture of TLS errors and reconciler errors.
    #

    kubectl \
        --kubeconfig "${kindclusterconf:?}" \
        logs \
            --namespace capi-system \
            capi-controller-manager-76955c46b9-drqph \
    | grep 'error'

    >   ....
    >   ....
    >   2024/01/23 13:02:20 http: TLS handshake error from 10.244.0.1:24405: EOF
    >   ....
    >   E0123 13:12:19.933465       1 controller.go:329] "Reconciler error" err="machines.cluster.x-k8s.io \"somerville-jade-20240123-work-md-0-d6nk8-m9ss9\" not found" controller="machine" controllerGroup="cluster.x-k8s.io" controllerKind="Machine" Machine="default/somerville-jade-20240123-work-md-0-d6nk8-m9ss9" namespace="default" name="somerville-jade-20240123-work-md-0-d6nk8-m9ss9" reconcileID="211c8b54-3e7d-4f3e-a827-e14c9d01b6e6"
    >   ....
    >   2024/01/23 13:22:36 http: TLS handshake error from 10.244.0.1:56066: EOF
    >   ....
    >   E0123 13:32:50.282542       1 controller.go:329] "Reconciler error" err="machines.cluster.x-k8s.io \"somerville-jade-20240123-work-md-0-d6nk8-f5znq\" not found" controller="machine" controllerGroup="cluster.x-k8s.io" controllerKind="Machine" Machine="default/somerville-jade-20240123-work-md-0-d6nk8-f5znq" namespace="default" name="somerville-jade-20240123-work-md-0-d6nk8-f5znq" reconcileID="840f52bd-1b15-4fca-a798-57dbb7126d49"
    >   ....
    >   ....


    kubectl \
        --kubeconfig "${workclusterconf:?}" \
        describe node \
            somerville-jade-20240123-work-md-0-d078a3a6-2b7j7

    >   E0123 13:43:27.260860   15355 memcache.go:287] couldn't get resource list for metrics.k8s.io/v1beta1: the server is currently unable to handle the request
    >   E0123 13:43:27.266429   15355 memcache.go:121] couldn't get resource list for metrics.k8s.io/v1beta1: the server is currently unable to handle the request
    >   E0123 13:43:27.269523   15355 memcache.go:121] couldn't get resource list for metrics.k8s.io/v1beta1: the server is currently unable to handle the request
    >   E0123 13:43:27.273432   15355 memcache.go:121] couldn't get resource list for metrics.k8s.io/v1beta1: the server is currently unable to handle the request
    >   Name:               somerville-jade-20240123-work-md-0-d078a3a6-2b7j7
    >   Roles:              <none>
    >   Labels:             beta.kubernetes.io/arch=amd64
    >                       beta.kubernetes.io/os=linux
    >                       kubernetes.io/arch=amd64
    >                       kubernetes.io/hostname=somerville-jade-20240123-work-md-0-d078a3a6-2b7j7
    >                       kubernetes.io/os=linux
    >   Annotations:        csi.volume.kubernetes.io/nodeid: {"csi.tigera.io":"somerville-jade-20240123-work-md-0-d078a3a6-2b7j7"}
    >                       kubeadm.alpha.kubernetes.io/cri-socket: unix:///var/run/containerd/containerd.sock
    >                       node.alpha.kubernetes.io/ttl: 0
    >                       projectcalico.org/IPv4Address: 192.168.3.188/24
    >                       projectcalico.org/IPv4VXLANTunnelAddr: 172.18.224.64
    >                       volumes.kubernetes.io/controller-managed-attach-detach: true
    >   CreationTimestamp:  Tue, 23 Jan 2024 12:21:54 +0000
    >   Taints:             node.cloudprovider.kubernetes.io/uninitialized=true:NoSchedule
    >                       node.cluster.x-k8s.io/uninitialized:NoSchedule
    >                       node.kubernetes.io/unreachable:NoSchedule
    >   Unschedulable:      false
    >   Lease:
    >     HolderIdentity:  somerville-jade-20240123-work-md-0-d078a3a6-2b7j7
    >     AcquireTime:     <unset>
    >     RenewTime:       Tue, 23 Jan 2024 12:31:07 +0000
    >   Conditions:
    >     Type                 Status    LastHeartbeatTime                 LastTransitionTime                Reason              Message
    >     ----                 ------    -----------------                 ------------------                ------              -------
    >     NetworkUnavailable   False     Tue, 23 Jan 2024 12:22:23 +0000   Tue, 23 Jan 2024 12:22:23 +0000   CalicoIsUp          Calico is running on this node
    >     MemoryPressure       Unknown   Tue, 23 Jan 2024 12:28:22 +0000   Tue, 23 Jan 2024 12:31:50 +0000   NodeStatusUnknown   Kubelet stopped posting node status.
    >     DiskPressure         Unknown   Tue, 23 Jan 2024 12:28:22 +0000   Tue, 23 Jan 2024 12:31:50 +0000   NodeStatusUnknown   Kubelet stopped posting node status.
    >     PIDPressure          Unknown   Tue, 23 Jan 2024 12:28:22 +0000   Tue, 23 Jan 2024 12:31:50 +0000   NodeStatusUnknown   Kubelet stopped posting node status.
    >     Ready                Unknown   Tue, 23 Jan 2024 12:28:22 +0000   Tue, 23 Jan 2024 12:31:50 +0000   NodeStatusUnknown   Kubelet stopped posting node status.
    >   Addresses:
    >     InternalIP:  192.168.3.188
    >     Hostname:    somerville-jade-20240123-work-md-0-d078a3a6-2b7j7
    >   Capacity:
    >     cpu:                8
    >     ephemeral-storage:  50620216Ki
    >     hugepages-1Gi:      0
    >     hugepages-2Mi:      0
    >     memory:             65843720Ki
    >     pods:               110
    >   Allocatable:
    >     cpu:                8
    >     ephemeral-storage:  46651590989
    >     hugepages-1Gi:      0
    >     hugepages-2Mi:      0
    >     memory:             65741320Ki
    >     pods:               110
    >   System Info:
    >     Machine ID:                 db6c6da36e4e4220b22f08c589dbebb9
    >     System UUID:                db6c6da3-6e4e-4220-b22f-08c589dbebb9
    >     Boot ID:                    ce055a93-9578-4897-9b1c-5b693888b49e
    >     Kernel Version:             5.15.0-88-generic
    >     OS Image:                   Ubuntu 22.04.3 LTS
    >     Operating System:           linux
    >     Architecture:               amd64
    >     Container Runtime Version:  containerd://1.6.23
    >     Kubelet Version:            v1.26.7
    >     Kube-Proxy Version:         v1.26.7
    >   PodCIDR:                      172.16.14.0/24
    >   PodCIDRs:                     172.16.14.0/24
    >   Non-terminated Pods:          (5 in total)
    >     Namespace                   Name                                     CPU Requests  CPU Limits  Memory Requests  Memory Limits  Age
    >     ---------                   ----                                     ------------  ----------  ---------------  -------------  ---
    >     calico-system               calico-node-gnc4p                        0 (0%)        0 (0%)      0 (0%)           0 (0%)         81m
    >     calico-system               csi-node-driver-sghjv                    0 (0%)        0 (0%)      0 (0%)           0 (0%)         81m
    >     kube-system                 kube-proxy-dch9j                         0 (0%)        0 (0%)      0 (0%)           0 (0%)         81m
    >     node-feature-discovery      node-feature-discovery-worker-b2dmm      0 (0%)        0 (0%)      0 (0%)           0 (0%)         81m
    >     openstack-system            openstack-cinder-csi-nodeplugin-gtfhw    0 (0%)        0 (0%)      0 (0%)           0 (0%)         81m
    >   Allocated resources:
    >     (Total limits may be over 100 percent, i.e., overcommitted.)
    >     Resource           Requests  Limits
    >     --------           --------  ------
    >     cpu                0 (0%)    0 (0%)
    >     memory             0 (0%)    0 (0%)
    >     ephemeral-storage  0 (0%)    0 (0%)
    >     hugepages-1Gi      0 (0%)    0 (0%)
    >     hugepages-2Mi      0 (0%)    0 (0%)
    >   Events:              <none>



# -----------------------------------------------------
# -----------------------------------------------------
# Add SSH access to our cluster security groups.
#[root@ansibler]

    openstack \
        --os-cloud "${cloudname:?}" \
        security group \
            list

    >   +--------------------------------------+-------------------------------------------------------------------------+---------------------------+----------------------------------+------+
    >   | ID                                   | Name                                                                    | Description               | Project                          | Tags |
    >   +--------------------------------------+-------------------------------------------------------------------------+---------------------------+----------------------------------+------+
    >   | 59625c4d-2800-4d87-b293-8061eca42d53 | k8s-cluster-default-somerville-jade-20240123-work-secgroup-controlplane | Cluster API managed group | be227fe0300b4ce5b03f44264df615df | []   |
    >   | 652235ec-b5ed-428a-a83a-e1c281f79001 | default                                                                 | Default security group    | be227fe0300b4ce5b03f44264df615df | []   |
    >   | 85aa01af-7204-48fc-9f18-6c9490d464a7 | k8s-cluster-default-somerville-jade-20240123-work-secgroup-worker       | Cluster API managed group | be227fe0300b4ce5b03f44264df615df | []   |
    >   | c98cfc9e-38b8-46aa-a81e-d78c649b87bb | somerville-jade-20240123-bootstrap-security                             |                           | be227fe0300b4ce5b03f44264df615df | []   |
    >   +--------------------------------------+-------------------------------------------------------------------------+---------------------------+----------------------------------+------+


    openstack \
        --os-cloud "${cloudname:?}" \
        security group \
            rule create \
                --ingress \
                --dst-port 22 \
                --protocol 'tcp' \
                --remote-ip '0.0.0.0' \
                'k8s-cluster-default-somerville-jade-20240123-work-secgroup-controlplane'

    >   +-------------------------+--------------------------------------+
    >   | Field                   | Value                                |
    >   +-------------------------+--------------------------------------+
    >   | created_at              | 2024-01-23T16:59:32Z                 |
    >   | description             |                                      |
    >   | direction               | ingress                              |
    >   | ether_type              | IPv4                                 |
    >   | id                      | fd6fdb17-59c3-4234-933c-0733c6136d4e |
    >   | name                    | None                                 |
    >   | port_range_max          | 22                                   |
    >   | port_range_min          | 22                                   |
    >   | project_id              | be227fe0300b4ce5b03f44264df615df     |
    >   | protocol                | tcp                                  |
    >   | remote_address_group_id | None                                 |
    >   | remote_group_id         | None                                 |
    >   | remote_ip_prefix        | 0.0.0.0/32                           |
    >   | revision_number         | 0                                    |
    >   | security_group_id       | 59625c4d-2800-4d87-b293-8061eca42d53 |
    >   | tags                    | []                                   |
    >   | tenant_id               | be227fe0300b4ce5b03f44264df615df     |
    >   | updated_at              | 2024-01-23T16:59:32Z                 |
    >   +-------------------------+--------------------------------------+


    openstack \
        --os-cloud "${cloudname:?}" \
        security group \
            rule create \
                --ingress \
                --dst-port 22 \
                --protocol 'tcp' \
                --remote-ip '0.0.0.0' \
                'k8s-cluster-default-somerville-jade-20240123-work-secgroup-worker'

    >   +-------------------------+--------------------------------------+
    >   | Field                   | Value                                |
    >   +-------------------------+--------------------------------------+
    >   | created_at              | 2024-01-23T17:00:17Z                 |
    >   | description             |                                      |
    >   | direction               | ingress                              |
    >   | ether_type              | IPv4                                 |
    >   | id                      | 76e0fdcf-73fd-4975-b7b7-51b269600a27 |
    >   | name                    | None                                 |
    >   | port_range_max          | 22                                   |
    >   | port_range_min          | 22                                   |
    >   | project_id              | be227fe0300b4ce5b03f44264df615df     |
    >   | protocol                | tcp                                  |
    >   | remote_address_group_id | None                                 |
    >   | remote_group_id         | None                                 |
    >   | remote_ip_prefix        | 0.0.0.0/32                           |
    >   | revision_number         | 0                                    |
    >   | security_group_id       | 85aa01af-7204-48fc-9f18-6c9490d464a7 |
    >   | tags                    | []                                   |
    >   | tenant_id               | be227fe0300b4ce5b03f44264df615df     |
    >   | updated_at              | 2024-01-23T17:00:17Z                 |
    >   +-------------------------+--------------------------------------+


# -----------------------------------------------------
# Create a debug gateway inside our cluster network.
#[root@ansibler]

    openstack \
        --os-cloud "${cloudname:?}" \
        server create \
            --image 'gaia-dmp-fedora-cloud-38-1.6' \
            --flavor 'qserv-jump-v2' \
            --security-group 'k8s-cluster-default-somerville-jade-20240123-work-secgroup-controlplane' \
            --key-name 'somerville-jade-20240123-keypair' \
            --network 'k8s-clusterapi-cluster-default-somerville-jade-20240123-work' \
            'debug-gateway'

    >   +-----------------------------+---------------------------------------------------------------------+
    >   | Field                       | Value                                                               |
    >   +-----------------------------+---------------------------------------------------------------------+
    >   | OS-DCF:diskConfig           | MANUAL                                                              |
    >   | OS-EXT-AZ:availability_zone |                                                                     |
    >   | OS-EXT-STS:power_state      | NOSTATE                                                             |
    >   | OS-EXT-STS:task_state       | scheduling                                                          |
    >   | OS-EXT-STS:vm_state         | building                                                            |
    >   | OS-SRV-USG:launched_at      | None                                                                |
    >   | OS-SRV-USG:terminated_at    | None                                                                |
    >   | accessIPv4                  |                                                                     |
    >   | accessIPv6                  |                                                                     |
    >   | addresses                   |                                                                     |
    >   | adminPass                   | rexkAummgN72                                                        |
    >   | config_drive                |                                                                     |
    >   | created                     | 2024-01-23T17:06:08Z                                                |
    >   | flavor                      | qserv-jump-v2 (d3ef8930-b9da-4a03-993a-3d8a5a3ed65a)                |
    >   | hostId                      |                                                                     |
    >   | id                          | d7a63a2f-23de-4bb7-9e00-0b50519f97ea                                |
    >   | image                       | gaia-dmp-fedora-cloud-38-1.6 (ce533fcf-75a6-4267-a622-d0227e6940b0) |
    >   | key_name                    | somerville-jade-20240123-keypair                                    |
    >   | name                        | debug-gateway                                                       |
    >   | progress                    | 0                                                                   |
    >   | project_id                  | be227fe0300b4ce5b03f44264df615df                                    |
    >   | properties                  |                                                                     |
    >   | security_groups             | name='59625c4d-2800-4d87-b293-8061eca42d53'                         |
    >   | status                      | BUILD                                                               |
    >   | updated                     | 2024-01-23T17:06:09Z                                                |
    >   | user_id                     | c4aad146ab7acaf44819e90e3e67a4d0490c164fbb02d388823c1ac9f0ae2e13    |
    >   | volumes_attached            |                                                                     |
    >   +-----------------------------+---------------------------------------------------------------------+


    openstack \
        --os-cloud "${cloudname:?}" \
        floating ip create \
            'external'

    >   +---------------------+--------------------------------------+
    >   | Field               | Value                                |
    >   +---------------------+--------------------------------------+
    >   | created_at          | 2024-01-23T17:13:17Z                 |
    >   | description         |                                      |
    >   | dns_domain          |                                      |
    >   | dns_name            |                                      |
    >   | fixed_ip_address    | None                                 |
    >   | floating_ip_address | 192.41.122.181                       |
    >   | floating_network_id | 1875828a-ccc3-419b-87fd-856aaa781492 |
    >   | id                  | d4dfcac0-6bba-44d6-b023-9a17ede72445 |
    >   | name                | 192.41.122.181                       |
    >   | port_details        | None                                 |
    >   | port_id             | None                                 |
    >   | project_id          | be227fe0300b4ce5b03f44264df615df     |
    >   | qos_policy_id       | None                                 |
    >   | revision_number     | 0                                    |
    >   | router_id           | None                                 |
    >   | status              | DOWN                                 |
    >   | subnet_id           | None                                 |
    >   | tags                | []                                   |
    >   | updated_at          | 2024-01-23T17:13:17Z                 |
    >   +---------------------+--------------------------------------+

    openstack \
        --os-cloud "${cloudname:?}" \
        server add floating ip \
            'debug-gateway' \
            '192.41.122.181'


# -----------------------------------------------------
# List our current servers.
#[root@ansibler]

    openstack \
        --os-cloud "${cloudname:?}" \
        server list

    >   +--------------------------------------+------------------------------------------------------------+--------+--------------------------------------------------------------------------------------------+-----------------------------------+-----------------+
    >   | ID                                   | Name                                                       | Status | Networks                                                                                   | Image                             | Flavor          |
    >   +--------------------------------------+------------------------------------------------------------+--------+--------------------------------------------------------------------------------------------+-----------------------------------+-----------------+
    >   | 7bb80f05-8eb3-48c5-ab72-185989e16224 | somerville-jade-20240123-work-md-0-d078a3a6-wtpc5          | ACTIVE | k8s-clusterapi-cluster-default-somerville-jade-20240123-work=192.168.3.25                  | gaia-dmp-ubuntu-2204-kube-v1.26.7 | qserv-worker-v2 |
    >   | 7a08f0ef-2594-48fc-b194-d0549aa3e47c | somerville-jade-20240123-work-md-0-d078a3a6-ds4rx          | ACTIVE | k8s-clusterapi-cluster-default-somerville-jade-20240123-work=192.168.3.120                 | gaia-dmp-ubuntu-2204-kube-v1.26.7 | qserv-worker-v2 |
    >   | ebbfb8d7-71a6-4af8-aa60-6e6547a7966e | somerville-jade-20240123-work-md-0-d078a3a6-krncd          | ACTIVE | k8s-clusterapi-cluster-default-somerville-jade-20240123-work=192.168.3.168                 | gaia-dmp-ubuntu-2204-kube-v1.26.7 | qserv-worker-v2 |
    >   | d7a63a2f-23de-4bb7-9e00-0b50519f97ea | debug-gateway                                              | ACTIVE | k8s-clusterapi-cluster-default-somerville-jade-20240123-work=192.168.3.117, 192.41.122.181 | gaia-dmp-fedora-cloud-38-1.6      | qserv-jump-v2   |
    >   | 37798e83-9b7c-40ef-b320-23906f6c2999 | somerville-jade-20240123-work-control-plane-aa1b69e0-s5ncb | ACTIVE | k8s-clusterapi-cluster-default-somerville-jade-20240123-work=192.168.3.225                 | gaia-dmp-ubuntu-2204-kube-v1.26.7 | qserv-jump-v2   |
    >   | 43005b66-703e-4458-b8da-baf25bc10886 | somerville-jade-20240123-bootstrap-node                    | ACTIVE | somerville-jade-20240123-bootstrap-network=10.10.0.183, 192.41.122.36                      | gaia-dmp-fedora-cloud-38-1.6      | qserv-jump-v2   |
    >   +--------------------------------------+------------------------------------------------------------+--------+--------------------------------------------------------------------------------------------+-----------------------------------+-----------------+


    openstack \
        --os-cloud "${cloudname:?}" \
        server list \
            --format json \
    | jq -r '
        .[]
        | select(.Name | contains("work-control-plane"))
        | .Networks
        | ."k8s-clusterapi-cluster-default-somerville-jade-20240123-work"
        | .[0]
        '

    >   192.168.3.225


    openstack \
        --os-cloud "${cloudname:?}" \
        server list \
            --format json \
    | jq -r '
        .[]
        | select(.Name | contains("work-md-0"))
        | .Networks
        | ."k8s-clusterapi-cluster-default-somerville-jade-20240123-work"
        | .[0]
        '

    >   192.168.3.25
    >   192.168.3.120
    >   192.168.3.168


# -----------------------------------------------------
# Login to our debug gateway and then poll our worker nodes.
#[root@ansibler]

    ssh -A 'fedora@192.41.122.181'

        ssh -A 'ubuntu@192.168.3.225' \
            '
            date
            hostname
            '

    >   Tue Jan 23 17:23:14 UTC 2024
    >   somerville-jade-20240123-work-control-plane-aa1b69e0-s5ncb

        #
        # Update our list of workers - they change every 10 min.
        workers=(
            '192.168.3.25'
            '192.168.3.120'
            '192.168.3.168'
            )

        #
        # ssh from our debug node into our worker nodes.
        for worker in "${workers[@]}"
            do
                echo "---- ----"
                echo "Worker [${worker}]"
                ssh -A \
                    -o 'LogLevel=ERROR' \
                    -o 'StrictHostKeychecking=no' \
                    "ubuntu@${worker}" \
                        '
                        date
                        hostname
                        '
            done

    >   ---- ----
    >   Worker [192.168.3.25]
    >   Tue Jan 23 17:52:11 UTC 2024
    >   somerville-jade-20240123-work-md-0-d078a3a6-wtpc5
    >   ---- ----
    >   Worker [192.168.3.120]
    >   Tue Jan 23 17:52:12 UTC 2024
    >   somerville-jade-20240123-work-md-0-d078a3a6-ds4rx
    >   ---- ----
    >   Worker [192.168.3.168]
    >   Tue Jan 23 17:52:15 UTC 2024
    >   somerville-jade-20240123-work-md-0-d078a3a6-krncd

        #
        # Update our list of workers - they change every 10 min.
        workers=(
            '192.168.3.25'
            '192.168.3.120'
            '192.168.3.168'
            )

        #
        # ssh from each worker node back into our control node.
        for worker in "${workers[@]}"
            do
                echo ""
                echo "---- ----"
                echo "Worker [${worker}]"
                ssh -A \
                    -o 'LogLevel=ERROR' \
                    -o 'StrictHostKeychecking=no' \
                    "ubuntu@${worker}" \
                        "
                        date
                        hostname
                        ssh -A \
                            -o 'LogLevel=ERROR' \
                            -o 'StrictHostKeychecking=no' \
                            'ubuntu@192.168.3.225' \
                                '
                                date
                                hostname
                                '
                        "
            done


    >   ---- ----
    >   Worker [192.168.3.25]
    >   Tue Jan 23 17:52:41 UTC 2024
    >   somerville-jade-20240123-work-md-0-d078a3a6-wtpc5
    >   Tue Jan 23 17:52:42 UTC 2024
    >   somerville-jade-20240123-work-control-plane-aa1b69e0-s5ncb
    >   
    >   ---- ----
    >   Worker [192.168.3.120]
    >   Tue Jan 23 17:52:42 UTC 2024
    >   somerville-jade-20240123-work-md-0-d078a3a6-ds4rx
    >   Tue Jan 23 17:52:43 UTC 2024
    >   somerville-jade-20240123-work-control-plane-aa1b69e0-s5ncb
    >   
    >   ---- ----
    >   Worker [192.168.3.168]
    >   Tue Jan 23 17:52:43 UTC 2024
    >   somerville-jade-20240123-work-md-0-d078a3a6-krncd
    >   Tue Jan 23 17:52:43 UTC 2024
    >   somerville-jade-20240123-work-control-plane-aa1b69e0-s5ncb

    #
    # OK, so that tells us that we can ssh from the dubug node into all the other nodes,
    # and that all the worker nodes can ssh back into our control node.
    #
    # So networking is working ...
    #


# -----------------------------------------------------
# List our current server names.
#[root@ansibler]

    openstack \
        --os-cloud "${cloudname:?}" \
        server list \
            --format json \
    | jq -r '
        .[]
        | select(.Name | contains("work-control-plane"))
        | .Name
        '

    >   somerville-jade-20240123-work-control-plane-aa1b69e0-s5ncb

    openstack \
        --os-cloud "${cloudname:?}" \
        server list \
            --format json \
    | jq -r '
        .[]
        | select(.Name | contains("work-control-plane"))
        | .Name
        '

    >   somerville-jade-20240123-work-control-plane-aa1b69e0-s5ncb--END--
    >   
    >   
    >       openstack \
    >           --os-cloud "${cloudname:?}" \
    >           server list \
    >               --format json \
    >       | jq -r '
    >           .[]
    >           | select(.Name | contains("work-md-0"))
    >           | .Name
    >           '
    >   
    >   somerville-jade-20240123-work-md-0-d078a3a6-lkqfw
    >   somerville-jade-20240123-work-md-0-d078a3a6-d288v
    >   somerville-jade-20240123-work-md-0-d078a3a6-w42wh


# -----------------------------------------------------
# Login to our debug gateway and then poll our worker nodes.
#[root@ansibler]

    ssh -A 'fedora@192.41.122.181'

        #
        # Update our list of workers - they change every 10 min.
        workers=(
            'somerville-jade-20240123-work-md-0-d078a3a6-lkqfw'
            'somerville-jade-20240123-work-md-0-d078a3a6-d288v'
            'somerville-jade-20240123-work-md-0-d078a3a6-w42wh'
            )

        #
        # ssh from our debug node into our worker nodes.
        for worker in "${workers[@]}"
            do
                echo "---- ----"
                echo "Worker [${worker}]"
                ssh -A \
                    -o 'LogLevel=ERROR' \
                    -o 'StrictHostKeychecking=no' \
                    "ubuntu@${worker}" \
                        '
                        date
                        hostname
                        '
            done

    >   ---- ----
    >   Worker [somerville-jade-20240123-work-md-0-d078a3a6-lkqfw]
    >   ssh: Could not resolve hostname somerville-jade-20240123-work-md-0-d078a3a6-lkqfw: Name or service not known
    >   ---- ----
    >   Worker [somerville-jade-20240123-work-md-0-d078a3a6-d288v]
    >   ssh: Could not resolve hostname somerville-jade-20240123-work-md-0-d078a3a6-d288v: Name or service not known
    >   ---- ----
    >   Worker [somerville-jade-20240123-work-md-0-d078a3a6-w42wh]
    >   ssh: Could not resolve hostname somerville-jade-20240123-work-md-0-d078a3a6-w42wh: Name or service not known

        #
        # Update our list of workers - they change every 10 min.
        workers=(
            '192.168.3.231'
            '192.168.3.96'
            '192.168.3.242'
            )

        #
        # ssh from our debug node into our worker nodes.
        for worker in "${workers[@]}"
            do
                echo "---- ----"
                echo "Worker [${worker}]"
                ssh -A \
                    -o 'LogLevel=ERROR' \
                    -o 'StrictHostKeychecking=no' \
                    "ubuntu@${worker}" \
                        '
                        date
                        hostname
                        '
            done

    >   ---- ----
    >   Worker [192.168.3.231]
    >   Tue Jan 23 18:02:24 UTC 2024
    >   somerville-jade-20240123-work-md-0-d078a3a6-lkqfw
    >   ---- ----
    >   Worker [192.168.3.96]
    >   Tue Jan 23 18:02:25 UTC 2024
    >   somerville-jade-20240123-work-md-0-d078a3a6-d288v
    >   ---- ----
    >   Worker [192.168.3.242]
    >   Tue Jan 23 18:02:27 UTC 2024
    >   somerville-jade-20240123-work-md-0-d078a3a6-w42wh

        #
        # ssh from each worker node back into our control node IP address.
        for worker in "${workers[@]}"
            do
                echo ""
                echo "---- ----"
                echo "Worker [${worker}]"
                ssh -A \
                    -o 'LogLevel=ERROR' \
                    -o 'StrictHostKeychecking=no' \
                    "ubuntu@${worker}" \
                        "
                        date
                        hostname
                        ssh -A \
                            -o 'LogLevel=ERROR' \
                            -o 'StrictHostKeychecking=no' \
                            'ubuntu@192.168.3.225' \
                                '
                                date
                                hostname
                                '
                        "
            done

    >   ---- ----
    >   Worker [192.168.3.231]
    >   Tue Jan 23 18:04:35 UTC 2024
    >   somerville-jade-20240123-work-md-0-d078a3a6-lkqfw
    >   Tue Jan 23 18:04:37 UTC 2024
    >   somerville-jade-20240123-work-control-plane-aa1b69e0-s5ncb
    >   
    >   ---- ----
    >   Worker [192.168.3.96]
    >   Tue Jan 23 18:04:37 UTC 2024
    >   somerville-jade-20240123-work-md-0-d078a3a6-d288v
    >   Tue Jan 23 18:04:38 UTC 2024
    >   somerville-jade-20240123-work-control-plane-aa1b69e0-s5ncb
    >   
    >   ---- ----
    >   Worker [192.168.3.242]
    >   Tue Jan 23 18:04:39 UTC 2024
    >   somerville-jade-20240123-work-md-0-d078a3a6-w42wh
    >   Tue Jan 23 18:04:39 UTC 2024
    >   somerville-jade-20240123-work-control-plane-aa1b69e0-s5ncb


        #
        # ssh from each worker node back into our control node by name.
        for worker in "${workers[@]}"
            do
                echo ""
                echo "---- ----"
                echo "Worker [${worker}]"
                ssh -A \
                    -o 'LogLevel=ERROR' \
                    -o 'StrictHostKeychecking=no' \
                    "ubuntu@${worker}" \
                        "
                        date
                        hostname
                        ssh -A \
                            -o 'LogLevel=ERROR' \
                            -o 'StrictHostKeychecking=no' \
                            'ubuntu@somerville-jade-20240123-work-control-plane-aa1b69e0-s5ncb' \
                                '
                                date
                                hostname
                                '
                        "
            done

    >   ---- ----
    >   Worker [192.168.3.231]
    >   Tue Jan 23 18:05:37 UTC 2024
    >   somerville-jade-20240123-work-md-0-d078a3a6-lkqfw
    >   ssh: Could not resolve hostname somerville-jade-20240123-work-control-plane-aa1b69e0-s5ncb: Temporary failure in name resolution
    >   
    >   ---- ----
    >   Worker [192.168.3.96]
    >   Tue Jan 23 18:05:38 UTC 2024
    >   somerville-jade-20240123-work-md-0-d078a3a6-d288v
    >   ssh: Could not resolve hostname somerville-jade-20240123-work-control-plane-aa1b69e0-s5ncb: Temporary failure in name resolution
    >   
    >   ---- ----
    >   Worker [192.168.3.242]
    >   Tue Jan 23 18:05:38 UTC 2024
    >   somerville-jade-20240123-work-md-0-d078a3a6-w42wh
    >   ssh: Could not resolve hostname somerville-jade-20240123-work-control-plane-aa1b69e0-s5ncb: Temporary failure in name resolution

    #
    # So IP addresses work but name resolving doesn't.
    # We would have to test it out on the working Cluster at Cambridge to see if it should work.
    #




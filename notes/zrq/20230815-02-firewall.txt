#
# <meta:header>
#   <meta:licence>
#     Copyright (c) 2023, ROE (http://www.roe.ac.uk/)
#
#     This information is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This information is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
#   </meta:licence>
# </meta:header>
#
#zrq-notes-time
#zrq-notes-indent
#zrq-notes-crypto
#zrq-notes-ansible
#zrq-notes-osformat
#zrq-notes-zeppelin
#
# AIMetrics: []
#


    Target:

        Try again.
        Add firewall rules to limit access to the kubectl endpoint.

    Result:

        Partial success.
        The patch seems to work.
        The patch seems to allow/block access from external addresses.
        The Openstack loadbalancer listener has the right list of allowed_cidrs.

        The spec of the Kubernetes loadbalancer has the right list of allowedCidrs.
        .. but it doesn't always show up in the list of allowedCIDRs in the Kubernetes loadbalancer status.

        Applying the patch manually seems to have more deterministic results.
        .. but it isn't clear why.

        Caveat - not clear whether we were logged in a root@bootstrap or user@bootstrap.
        Scripts had a mixture of logins and not 100% sure we kept track in the notes.


# -----------------------------------------------------
# -----------------------------------------------------
# Check which platform is live.
#[user@desktop]

    ssh fedora@live.gaia-dmp.uk \
        '
        date
        hostname
        '

    >   Tue 15 Aug 18:09:42 UTC 2023
    >   iris-gaia-green-20230308-zeppelin


# -----------------------------------------------------
# Create our client container.
#[user@desktop]

    agclient blue

    >   ....
    >   ....


# -----------------------------------------------------
# Delete and deploy everything.
#[root@ansibler]

    /deployments/openstack/bin/delete-all.sh \
        "${cloudname:?}"

    ansible-playbook \
        --inventory 'bootstrap,' \
        '/deployments/cluster-api/bootstrap/ansible/00-create-all.yml'

    >   ....
    >   ....
    >   fatal: [bootstrap]: FAILED! => {
    >       "changed": false,
    >       "command": "
    >           /usr/local/bin/helm \
    >               --version=0.1.0
    >               upgrade
    >               -i
    >               --reset-values
    >               --wait
    >               --values=/opt/aglais/clusterapi-config.yml
    >               --values=/opt/aglais/openstack-clouds.yml
    >               iris-gaia-blue-20230815-work
    >               capi/openstack-cluster
    >           ",
    >       "msg": "
    >           Failure when executing Helm command.
    >               Exited 1.
    >                   stdout: Release \"iris-gaia-blue-20230815-work\" does not exist. Installing it now.
    >                   stderr: Error: context deadline exceeded
    >           ",
    >       "stderr": "Error: context deadline exceeded",
    >       "stderr_lines": [
    >           "Error: context deadline exceeded"
    >           ],
    >       "stdout": "Release \"iris-gaia-blue-20230815-work\" does not exist. Installing it now.",
    >       "stdout_lines": [
    >           "Release \"iris-gaia-blue-20230815-work\" does not exist. Installing it now."
    >           ]
    >       }

    #
    # That looks familiar ...
    #

# -----------------------------------------------------
# Skip what I was going to do and check the Loadbalancer status.
#[root@ansibler]

    openstack \
        --os-cloud "${cloudname:?}" \
        loadbalancer list

    >   +--------------------------------------+---------------------------------------------------------------------+----------------------------------+--------------+---------------------+------------------+----------+
    >   | id                                   | name                                                                | project_id                       | vip_address  | provisioning_status | operating_status | provider |
    >   +--------------------------------------+---------------------------------------------------------------------+----------------------------------+--------------+---------------------+------------------+----------+
    >   | e8a87c9c-bb37-43d4-abff-96c1685a9c3a | k8s-clusterapi-cluster-default-iris-gaia-blue-20230815-work-kubeapi | e918a13fed2648758175a15fac083569 | 192.168.3.64 | ACTIVE              | ONLINE           | amphora  |
    >   +--------------------------------------+---------------------------------------------------------------------+----------------------------------+--------------+---------------------+------------------+----------+

    openstack \
        --os-cloud "${cloudname:?}" \
        loadbalancer show \
            'e8a87c9c-bb37-43d4-abff-96c1685a9c3a'

    >   +---------------------+----------------------------------------------------------------------------------------+
    >   | Field               | Value                                                                                  |
    >   +---------------------+----------------------------------------------------------------------------------------+
    >   | admin_state_up      | True                                                                                   |
    >   | availability_zone   | None                                                                                   |
    >   | created_at          | 2023-08-15T14:19:15                                                                    |
    >   | description         | Created by cluster-api-provider-openstack cluster default-iris-gaia-blue-20230815-work |
    >   | flavor_id           | None                                                                                   |
    >   | id                  | e8a87c9c-bb37-43d4-abff-96c1685a9c3a                                                   |
    >   | listeners           |                                                                                        |
    >   | name                | k8s-clusterapi-cluster-default-iris-gaia-blue-20230815-work-kubeapi                    |
    >   | operating_status    | ONLINE                                                                                 |
    >   | pools               | a4026368-67a6-423e-8097-aa52b29bd3e5                                                   |
    >   | project_id          | e918a13fed2648758175a15fac083569                                                       |
    >   | provider            | amphora                                                                                |
    >   | provisioning_status | ACTIVE                                                                                 |
    >   | updated_at          | 2023-08-15T17:59:44                                                                    |
    >   | vip_address         | 192.168.3.64                                                                           |
    >   | vip_network_id      | 14c09291-4f30-4366-96f7-7dd09ce1a453                                                   |
    >   | vip_port_id         | f5adba05-0734-4cb5-8f54-af7c7c584755                                                   |
    >   | vip_qos_policy_id   | None                                                                                   |
    >   | vip_subnet_id       | 50acadc1-1501-4533-b637-6824f6a23ce6                                                   |
    >   | tags                |                                                                                        |
    >   +---------------------+----------------------------------------------------------------------------------------+

    #
    # Hmmm, so not that hen.
    #

# -----------------------------------------------------
# Check what components we have.
#[root@ansibler]

    /deployments/openstack/bin/list-all.sh \
        "${cloudname:?}"

    >   ---- ----
    >   Nova servers
    >   +--------------------------------------+----------------------------------------+--------+-----------------------------------------------------------------------+---------------+----------------------+
    >   | ID                                   | Name                                   | Status | Networks                                                              | Image         | Flavor               |
    >   +--------------------------------------+----------------------------------------+--------+-----------------------------------------------------------------------+---------------+----------------------+
    >   | 63d40e91-08d8-4650-98ab-f47df5bc223c | iris-gaia-blue-20230815-bootstrap-node | ACTIVE | iris-gaia-blue-20230815-bootstrap-network=10.10.2.170, 128.232.226.73 | Fedora-34.1.2 | gaia.vm.cclake.2vcpu |
    >   +--------------------------------------+----------------------------------------+--------+-----------------------------------------------------------------------+---------------+----------------------+

    >   ---- ----
    >   Floating addresses
    >   +--------------------------------------+---------------------+------------------+--------------------------------------+--------------------------------------+----------------------------------+
    >   | ID                                   | Floating IP Address | Fixed IP Address | Port                                 | Floating Network                     | Project                          |
    >   +--------------------------------------+---------------------+------------------+--------------------------------------+--------------------------------------+----------------------------------+
    >   | 2a0353f1-babb-4a99-9254-f3928a0ac2a6 | 128.232.226.73      | 10.10.2.170      | 96cbd8d3-3eaa-4f81-b66d-7cf83b97d785 | 57add367-d205-4030-a929-d75617a7c63e | e918a13fed2648758175a15fac083569 |
    >   | 63563f2d-067f-442b-8b2f-129d12ae180d | 128.232.226.7       | None             | None                                 | 57add367-d205-4030-a929-d75617a7c63e | e918a13fed2648758175a15fac083569 |
    >   | 9d9237c7-14e4-41cf-8da5-2b649d457b58 | 128.232.226.229     | None             | None                                 | 57add367-d205-4030-a929-d75617a7c63e | e918a13fed2648758175a15fac083569 |
    >   | b3a25a33-684f-400d-a4a9-a9fead092f9c | 128.232.227.70      | None             | None                                 | 57add367-d205-4030-a929-d75617a7c63e | e918a13fed2648758175a15fac083569 |
    >   | c1c9392e-888b-464c-afee-ecf62024e67d | 128.232.227.67      | None             | None                                 | 57add367-d205-4030-a929-d75617a7c63e | e918a13fed2648758175a15fac083569 |
    >   | dc7bcf83-00ea-4f28-a7d0-a82d71b7ae20 | 128.232.226.22      | None             | None                                 | 57add367-d205-4030-a929-d75617a7c63e | e918a13fed2648758175a15fac083569 |
    >   +--------------------------------------+---------------------+------------------+--------------------------------------+--------------------------------------+----------------------------------+

    >   ---- ----
    >   Load balancers
    >   +--------------------------------------+---------------------------------------------------------------------+----------------------------------+--------------+---------------------+------------------+----------+
    >   | id                                   | name                                                                | project_id                       | vip_address  | provisioning_status | operating_status | provider |
    >   +--------------------------------------+---------------------------------------------------------------------+----------------------------------+--------------+---------------------+------------------+----------+
    >   | e8a87c9c-bb37-43d4-abff-96c1685a9c3a | k8s-clusterapi-cluster-default-iris-gaia-blue-20230815-work-kubeapi | e918a13fed2648758175a15fac083569 | 192.168.3.64 | ACTIVE              | ONLINE           | amphora  |
    >   +--------------------------------------+---------------------------------------------------------------------+----------------------------------+--------------+---------------------+------------------+----------+

    >   ---- ----
    >   Routers
    >   +--------------------------------------+-------------------------------------------------------------+--------+-------+----------------------------------+
    >   | ID                                   | Name                                                        | Status | State | Project                          |
    >   +--------------------------------------+-------------------------------------------------------------+--------+-------+----------------------------------+
    >   | 1bfbbedc-be70-4213-9540-d56fa7bfe7b1 | iris-gaia-blue-20230815-bootstrap-network-router            | ACTIVE | UP    | e918a13fed2648758175a15fac083569 |
    >   | 3333cbe7-cefc-4b32-a545-c2a0d2ffda98 | k8s-clusterapi-cluster-default-iris-gaia-blue-20230815-work | ACTIVE | UP    | e918a13fed2648758175a15fac083569 |
    >   +--------------------------------------+-------------------------------------------------------------+--------+-------+----------------------------------+

    >   ---- ----
    >   Networks
    >   +--------------------------------------+-------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+
    >   | ID                                   | Name                                                        | Subnets                                                                                                                                                |
    >   +--------------------------------------+-------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+
    >   | 2fade8b5-dfa2-420e-a585-7a4ea71a8ea6 | iris-gaia-blue-20230815-bootstrap-network                   | f8467fef-4785-4027-b60b-006a6134569c                                                                                                                   |
    >   | 410920fb-5714-4447-b26a-e7b06092fc62 | cephfs                                                      | 5699fb5d-8316-4b88-b889-b05c8a1ec975                                                                                                                   |
    >   | 57add367-d205-4030-a929-d75617a7c63e | CUDN-Internet                                               | 1847b14d-b974-4f78-959d-44d18d4485b8, 3fcaa5a5-ba8e-49a9-bf94-d87fbb0afc42, 5f1388b3-a0c7-463e-bb58-5532c38e4b40, a79eb610-eca3-4ee8-aaf1-88f4fef5a4e7 |
    >   | dd5ab3f2-09c0-44bf-8212-d0154a42da4e | k8s-clusterapi-cluster-default-iris-gaia-blue-20230815-work | aaad4562-f5ed-4e9c-8fd9-4b444f22b560                                                                                                                   |
    >   +--------------------------------------+-------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+

    >   ---- ----
    >   Subnets
    >   +--------------------------------------+-------------------------------------------------------------+--------------------------------------+----------------+
    >   | ID                                   | Name                                                        | Network                              | Subnet         |
    >   +--------------------------------------+-------------------------------------------------------------+--------------------------------------+----------------+
    >   | 5699fb5d-8316-4b88-b889-b05c8a1ec975 | cephfs                                                      | 410920fb-5714-4447-b26a-e7b06092fc62 | 10.9.0.0/16    |
    >   | aaad4562-f5ed-4e9c-8fd9-4b444f22b560 | k8s-clusterapi-cluster-default-iris-gaia-blue-20230815-work | dd5ab3f2-09c0-44bf-8212-d0154a42da4e | 192.168.3.0/24 |
    >   | f8467fef-4785-4027-b60b-006a6134569c | iris-gaia-blue-20230815-bootstrap-network-subnet            | 2fade8b5-dfa2-420e-a585-7a4ea71a8ea6 | 10.10.0.0/16   |
    >   +--------------------------------------+-------------------------------------------------------------+--------------------------------------+----------------+

    >   ---- ----
    >   Security groups
    >   +--------------------------------------+------------------------------------------------------------------------+---------------------------+----------------------------------+------+
    >   | ID                                   | Name                                                                   | Description               | Project                          | Tags |
    >   +--------------------------------------+------------------------------------------------------------------------+---------------------------+----------------------------------+------+
    >   | 02f76ecb-2f0a-428d-86b6-7b17c5a9a83f | iris-gaia-blue-20230815-bootstrap-security                             |                           | e918a13fed2648758175a15fac083569 | []   |
    >   | 1702788b-1d73-466a-b03d-2240f1750ed8 | k8s-cluster-default-iris-gaia-blue-20230815-work-secgroup-controlplane | Cluster API managed group | e918a13fed2648758175a15fac083569 | []   |
    >   | e1c6a1db-3caf-47f5-91e2-51a3e1967dc6 | default                                                                | Default security group    | e918a13fed2648758175a15fac083569 | []   |
    >   | e5c71a32-cc4f-4f98-8708-8fa07af98f5f | k8s-cluster-default-iris-gaia-blue-20230815-work-secgroup-worker       | Cluster API managed group | e918a13fed2648758175a15fac083569 | []   |
    >   +--------------------------------------+------------------------------------------------------------------------+---------------------------+----------------------------------+------+

    #
    # No cluster nodes, but a lot of orhpanned flotaing IP addresses.
    # Is this caused by a Kubernetes Operator flailing around,
    # creating and deleting things until it gets them right.
    #


# -----------------------------------------------------
# Delete everything.
#[root@ansibler]

    /deployments/openstack/bin/delete-all.sh \
        "${cloudname:?}"

    >   ....
    >   ---- ----
    >   Releasing addresses
    >   - Releasing address [2a0353f1-babb-4a99-9254-f3928a0ac2a6]
    >   - Releasing address [63563f2d-067f-442b-8b2f-129d12ae180d]
    >   - Releasing address [9d9237c7-14e4-41cf-8da5-2b649d457b58]
    >   - Releasing address [b3a25a33-684f-400d-a4a9-a9fead092f9c]
    >   - Releasing address [c1c9392e-888b-464c-afee-ecf62024e67d]
    >   - Releasing address [dc7bcf83-00ea-4f28-a7d0-a82d71b7ae20]
    >   ....


# -----------------------------------------------------
# Try again.
#[root@ansibler]

    ansible-playbook \
        --inventory 'bootstrap,' \
        '/deployments/cluster-api/bootstrap/ansible/00-create-all.yml'

    >   ....
    >   ....

# -----------------------------------------------------
# -----------------------------------------------------
# Login to our bootstrap node as root.
#[root@ansibler]

    ssh root@bootstrap

    source loadconfig

cat << EOF
kindclustername [${kindclustername}]
kindclusterconf [${kindclusterconf}]
workclustername [${workclustername}]
workclusterconf [${workclusterconf}]
EOF

    >   kindclustername [iris-gaia-blue-20230815-kind]
    >   kindclusterconf [/opt/aglais/iris-gaia-blue-20230815-kind.yml]
    >   workclustername [iris-gaia-blue-20230815-work]
    >   workclusterconf [/opt/aglais/iris-gaia-blue-20230815-work.yml]


# -----------------------------------------------------
# Check the cluster status.
#[root@bootstrap]

    kubectl \
        --kubeconfig "${kindclusterconf:?}" \
        get OpenStackClusters

    >   NAME                           CLUSTER                        READY   NETWORK                                SUBNET                                 BASTION IP   AGE
    >   iris-gaia-blue-20230815-work   iris-gaia-blue-20230815-work   true    f7637460-95f6-459a-bad7-96810f54fdda   516349a1-1394-44b6-b56a-7ce5ae2f9fcb                6m33s


    clusterctl \
        --kubeconfig "${kindclusterconf:?}" \
        describe cluster \
            "${workclustername:?}"

    >   NAME                                                                             READY  SEVERITY  REASON  SINCE  MESSAGE
    >   Cluster/iris-gaia-blue-20230815-work                                             True                     79s
    >   ├─ClusterInfrastructure - OpenStackCluster/iris-gaia-blue-20230815-work
    >   ├─ControlPlane - KubeadmControlPlane/iris-gaia-blue-20230815-work-control-plane  True                     79s
    >   │  └─3 Machines...                                                                True                     4m46s  See iris-gaia-blue-20230815-work-control-plane-4wccf, iris-gaia-blue-20230815-work-control-plane-fj47s, ...
    >   └─Workers
    >     └─MachineDeployment/iris-gaia-blue-20230815-work-md-0                          True                     2m26s
    >       └─3 Machines...                                                              True                     3m13s  See iris-gaia-blue-20230815-work-md-0-646cfd65f8xcbzdh-4g9cg, iris-gaia-blue-20230815-work-md-0-646cfd65f8xcbzdh-6rdkk, ...


# -----------------------------------------------------
# Check the load balancer spec.
#[user@bootstrap]

    kubectl \
        --kubeconfig "${kindclusterconf:?}" \
        get OpenStackCluster \
            --output json \
            "${workclustername:?}" \
    | jq '.spec.apiServerLoadBalancer'

    >   {
    >     "enabled": true
    >   }


# -----------------------------------------------------
# Check the load balancer status.
#[user@bootstrap]

    kubectl \
        --kubeconfig "${kindclusterconf:?}" \
        get OpenStackCluster \
            --output json \
            "${workclustername:?}" \
    | jq '.status.network.apiServerLoadBalancer'

    >   {
    >     "id": "f2c97f08-4f7b-4b82-ab04-b3f514e98aa5",
    >     "internalIP": "192.168.3.161",
    >     "ip": "128.232.227.94",
    >     "name": "k8s-clusterapi-cluster-default-iris-gaia-blue-20230815-work-kubeapi"
    >   }


# -----------------------------------------------------
# -----------------------------------------------------
# Follow the capo-controller-manager logs.
#[user@desktop]

    podman exec \
        --tty \
        --interactive \
        'ansibler-blue' \
        'bash'

        ssh 'bootstrap'

            source /opt/aglais/bin/loadconfig

            namespace=capo-system
            podnamepart=capo-controller-manager

            podname=$(
                kubectl \
                    --kubeconfig "${kindclusterconf:?}" \
                    get pods \
                        --output json \
                        --namespace "${namespace:?}" \
                | jq -r ".items[].metadata.name | select(test(\"${podnamepart:?}\"))"
                )

            kubectl \
                --kubeconfig "${kindclusterconf:?}" \
                logs \
                    --follow \
                    --namespace "${namespace:?}"  \
                    "${podname:?}" \
            | tee "/tmp/${podname:?}.log"

    >   ....
    >   ....


# -----------------------------------------------------
# -----------------------------------------------------
# Extract the kubectl endpoint.
#[root@ansibler]

    source /deployments/cluster-api/bootstrap/ansible/files/aglais/bin/loadconfig

    endpoint=$(
        yq '.clusters[0].cluster.server' \
            "${workclusterconf}"
        )

    echo "Endpoint [${endpoint}]"

    >   Endpoint [https://128.232.227.94:6443]

# -----------------------------------------------------
# Try to access the API from our client container.
#[root@ansibler]

    curl \
        --head \
        --insecure \
        --no-progress-meter \
        "${endpoint:?}"

    >   HTTP/2 403
    >   audit-id: e2976bc5-f235-4ece-9102-848a074c5a0d
    >   cache-control: no-cache, private
    >   content-type: application/json
    >   ....
    >   ....


# -----------------------------------------------------
# Try to access the API from our bootstrap node.
#[root@ansibler]

    ssh bootstrap \
        "
        curl \
            --head \
            --insecure \
            --no-progress-meter \
            '${endpoint:?}'
        "

    >   HTTP/2 403
    >   audit-id: aa10742f-b547-41ba-b0b6-99e994dd19d5
    >   cache-control: no-cache, private
    >   content-type: application/json
    >   ....
    >   ....


# -----------------------------------------------------
# Try to access the API from our DigitalOcean node.
#[root@ansibler]

    ssh "root@164.92.185.112" \
        "
        curl \
            --head \
            --insecure \
            --no-progress-meter \
            '${endpoint:?}'
        "

    >   HTTP/2 403
    >   audit-id: 3b9b786a-0d29-471c-832b-b915febbf24c
    >   cache-control: no-cache, private
    >   content-type: application/json
    >   ....
    >   ....


# -----------------------------------------------------
# Apply the patch with Ansible.
#[root@ansibler]

    ansible-playbook \
        -vvv \
        --inventory 'bootstrap,' \
        '/deployments/cluster-api/bootstrap/ansible/26-secure-work-cluster.yml'

    >   ....
    >       "stdout": "openstackcluster.infrastructure.cluster.x-k8s.io/iris-gaia-blue-20230815-work patched",
    >   ....


# -----------------------------------------------------
# -----------------------------------------------------
# Follow the capo-controller-manager logs.
#[user@bootstrap]

    >   ....
    >   I0815 19:20:42.188976       1 recorder.go:103] "events: Updated allowed_cidrs [128.232.226.11/32 128.232.227.14/32 192.168.3.0/24 90.155.51.57/32] for listener k8s-clusterapi-cluster-default-iris-gaia-blue-20230815-work-kubeapi-6443 with id 03495dda-e642-44e3-acf7-3df885975e5e" type="Normal" object={Kind:OpenStackCluster Namespace:default Name:iris-gaia-blue-20230815-work UID:dbdf032c-07fa-4458-8077-5dbe05dfcfb6 APIVersion:infrastructure.cluster.x-k8s.io/v1alpha6 ResourceVersion:6035 FieldPath:} reason="Successfulupdatelistener"
    >   I0815 19:20:42.528470       1 openstackcluster_controller.go:301] "Reconciled Cluster create successfully" controller="openstackcluster" controllerGroup="infrastructure.cluster.x-k8s.io" controllerKind="OpenStackCluster" OpenStackCluster="default/iris-gaia-blue-20230815-work" namespace="default" name="iris-gaia-blue-20230815-work" reconcileID=6c0ae5a1-d7dd-40c3-94f0-e22e375428f8 cluster="iris-gaia-blue-20230815-work"
    >   ....


# -----------------------------------------------------
# -----------------------------------------------------
# Check the load balancer spec.
#[user@bootstrap]

    kubectl \
        --kubeconfig "${kindclusterconf:?}" \
        get OpenStackCluster \
            --output json \
            "${workclustername:?}" \
    | jq '.spec.apiServerLoadBalancer'

    >   {
    >     "allowedCidrs": [
    >       "128.232.227.14/32",
    >       "90.155.51.57/32"
    >     ],
    >     "enabled": true
    >   }


# -----------------------------------------------------
# Check the load balancer status.
#[user@bootstrap]

    kubectl \
        --kubeconfig "${kindclusterconf:?}" \
        get OpenStackCluster \
            --output json \
            "${workclustername:?}" \
    | jq '.status.network.apiServerLoadBalancer'

    >   {
    >     "id": "f2c97f08-4f7b-4b82-ab04-b3f514e98aa5",
    >     "internalIP": "192.168.3.161",
    >     "ip": "128.232.227.94",
    >     "name": "k8s-clusterapi-cluster-default-iris-gaia-blue-20230815-work-kubeapi"
    >   }


# -----------------------------------------------------
# Try to access the API from our client container.
#[root@ansibler]

    curl \
        --head \
        --insecure \
        --no-progress-meter \
        "${endpoint:?}"

    >   HTTP/2 403
    >   audit-id: 2200d0a9-2af5-4fa7-afae-e7bcf27523fc
    >   cache-control: no-cache, private
    >   content-type: application/json
    >   ....
    >   ....


# -----------------------------------------------------
# Try to access the API from our bootstrap node.
#[root@ansibler]

    ssh bootstrap \
        "
        curl \
            --head \
            --insecure \
            --no-progress-meter \
            '${endpoint:?}'
        "

    >   HTTP/2 403
    >   audit-id: 563f755f-d27e-4b76-997c-b9d4d99060fa
    >   cache-control: no-cache, private
    >   content-type: application/json
    >   ....
    >   ....


# -----------------------------------------------------
# Try to access the API from our DigitalOcean node.
#[root@ansibler]

    ssh "root@164.92.185.112" \
        "
        curl \
            --head \
            --insecure \
            --no-progress-meter \
            '${endpoint:?}'
        "

    >   curl: (28) Failed to connect to 128.232.227.94 port 6443 after 130337 ms: Couldn't connect to server


# -----------------------------------------------------
# -----------------------------------------------------
# Check the load balancer status.
#[user@bootstrap]

    kubectl \
        --kubeconfig "${kindclusterconf:?}" \
        get OpenStackCluster \
            --output json \
            "${workclustername:?}" \
    | jq '.status.network.apiServerLoadBalancer'

    >   {
    >     "id": "f2c97f08-4f7b-4b82-ab04-b3f514e98aa5",
    >     "internalIP": "192.168.3.161",
    >     "ip": "128.232.227.94",
    >     "name": "k8s-clusterapi-cluster-default-iris-gaia-blue-20230815-work-kubeapi"
    >   }


# -----------------------------------------------------
# -----------------------------------------------------
# Check the actual load balancer.
#[root@ansibler]

    openstack \
        --os-cloud "${cloudname:?}" \
        loadbalancer list

    >   +--------------------------------------+---------------------------------------------------------------------+----------------------------------+---------------+---------------------+------------------+----------+
    >   | id                                   | name                                                                | project_id                       | vip_address   | provisioning_status | operating_status | provider |
    >   +--------------------------------------+---------------------------------------------------------------------+----------------------------------+---------------+---------------------+------------------+----------+
    >   | f2c97f08-4f7b-4b82-ab04-b3f514e98aa5 | k8s-clusterapi-cluster-default-iris-gaia-blue-20230815-work-kubeapi | e918a13fed2648758175a15fac083569 | 192.168.3.161 | ACTIVE              | ONLINE           | amphora  |
    >   +--------------------------------------+---------------------------------------------------------------------+----------------------------------+---------------+---------------------+------------------+----------+


    openstack \
        --os-cloud "${cloudname:?}" \
        loadbalancer show \
            'f2c97f08-4f7b-4b82-ab04-b3f514e98aa5'

    >   +---------------------+----------------------------------------------------------------------------------------+
    >   | Field               | Value                                                                                  |
    >   +---------------------+----------------------------------------------------------------------------------------+
    >   | admin_state_up      | True                                                                                   |
    >   | availability_zone   | None                                                                                   |
    >   | created_at          | 2023-08-15T19:01:17                                                                    |
    >   | description         | Created by cluster-api-provider-openstack cluster default-iris-gaia-blue-20230815-work |
    >   | flavor_id           | None                                                                                   |
    >   | id                  | f2c97f08-4f7b-4b82-ab04-b3f514e98aa5                                                   |
    >   | listeners           | 03495dda-e642-44e3-acf7-3df885975e5e                                                   |
    >   | name                | k8s-clusterapi-cluster-default-iris-gaia-blue-20230815-work-kubeapi                    |
    >   | operating_status    | ONLINE                                                                                 |
    >   | pools               | 04089268-2aae-49f6-8e70-d346afd4dfc3                                                   |
    >   | project_id          | e918a13fed2648758175a15fac083569                                                       |
    >   | provider            | amphora                                                                                |
    >   | provisioning_status | ACTIVE                                                                                 |
    >   | updated_at          | 2023-08-15T19:20:45                                                                    |
    >   | vip_address         | 192.168.3.161                                                                          |
    >   | vip_network_id      | f7637460-95f6-459a-bad7-96810f54fdda                                                   |
    >   | vip_port_id         | 2142b1e9-96bd-4449-84d6-2bb51b89c03a                                                   |
    >   | vip_qos_policy_id   | None                                                                                   |
    >   | vip_subnet_id       | 516349a1-1394-44b6-b56a-7ce5ae2f9fcb                                                   |
    >   | tags                |                                                                                        |
    >   +---------------------+----------------------------------------------------------------------------------------+


    openstack \
        --os-cloud "${cloudname:?}" \
        loadbalancer listener list \
            --loadbalancer 'f2c97f08-4f7b-4b82-ab04-b3f514e98aa5'

    >   +--------------------------------------+--------------------------------------+--------------------------------------------------------------------------+----------------------------------+----------+---------------+----------------+
    >   | id                                   | default_pool_id                      | name                                                                     | project_id                       | protocol | protocol_port | admin_state_up |
    >   +--------------------------------------+--------------------------------------+--------------------------------------------------------------------------+----------------------------------+----------+---------------+----------------+
    >   | 03495dda-e642-44e3-acf7-3df885975e5e | 04089268-2aae-49f6-8e70-d346afd4dfc3 | k8s-clusterapi-cluster-default-iris-gaia-blue-20230815-work-kubeapi-6443 | e918a13fed2648758175a15fac083569 | TCP      |          6443 | True           |
    >   +--------------------------------------+--------------------------------------+--------------------------------------------------------------------------+----------------------------------+----------+---------------+----------------+


    openstack \
        --os-cloud "${cloudname:?}" \
        loadbalancer listener show \
            '03495dda-e642-44e3-acf7-3df885975e5e'

    >   +-----------------------------+--------------------------------------------------------------------------+
    >   | Field                       | Value                                                                    |
    >   +-----------------------------+--------------------------------------------------------------------------+
    >   | admin_state_up              | True                                                                     |
    >   | connection_limit            | -1                                                                       |
    >   | created_at                  | 2023-08-15T19:02:23                                                      |
    >   | default_pool_id             | 04089268-2aae-49f6-8e70-d346afd4dfc3                                     |
    >   | default_tls_container_ref   | None                                                                     |
    >   | description                 |                                                                          |
    >   | id                          | 03495dda-e642-44e3-acf7-3df885975e5e                                     |
    >   | insert_headers              | None                                                                     |
    >   | l7policies                  |                                                                          |
    >   | loadbalancers               | f2c97f08-4f7b-4b82-ab04-b3f514e98aa5                                     |
    >   | name                        | k8s-clusterapi-cluster-default-iris-gaia-blue-20230815-work-kubeapi-6443 |
    >   | operating_status            | ONLINE                                                                   |
    >   | project_id                  | e918a13fed2648758175a15fac083569                                         |
    >   | protocol                    | TCP                                                                      |
    >   | protocol_port               | 6443                                                                     |
    >   | provisioning_status         | ACTIVE                                                                   |
    >   | sni_container_refs          | []                                                                       |
    >   | timeout_client_data         | 50000                                                                    |
    >   | timeout_member_connect      | 5000                                                                     |
    >   | timeout_member_data         | 50000                                                                    |
    >   | timeout_tcp_inspect         | 0                                                                        |
    >   | updated_at                  | 2023-08-15T19:20:45                                                      |
    >   | client_ca_tls_container_ref | None                                                                     |
    >   | client_authentication       | NONE                                                                     |
    >   | client_crl_container_ref    | None                                                                     |
    >   | allowed_cidrs               | 128.232.226.11/32                                                        |
    >   |                             | 128.232.227.14/32                                                        |
    >   |                             | 192.168.3.0/24                                                           |
    >   |                             | 90.155.51.57/32                                                          |
    >   | tls_ciphers                 | None                                                                     |
    >   | tls_versions                | None                                                                     |
    >   | alpn_protocols              | None                                                                     |
    >   | tags                        |                                                                          |
    >   +-----------------------------+--------------------------------------------------------------------------+

    #
    # The Openstack loadbalancer listener has the right list of allowed_cidrs.
    #

    >   +-----------------------------+--------------------------------------------------------------------------+
    >   | Field                       | Value                                                                    |
    >   +-----------------------------+--------------------------------------------------------------------------+
    >   | ........                    | ........                                                                 |
    >   | allowed_cidrs               | 128.232.226.11/32                                                        |
    >   |                             | 128.232.227.14/32                                                        |
    >   |                             | 192.168.3.0/24                                                           |
    >   |                             | 90.155.51.57/32                                                          |
    >   | ........                    | ........                                                                 |
    >   +-----------------------------+--------------------------------------------------------------------------+


    openstack \
        --os-cloud "${cloudname:?}" \
        loadbalancer listener show \
            --format json \
            '03495dda-e642-44e3-acf7-3df885975e5e' \
    | jq '.allowed_cidrs'

    >   "128.232.226.11/32\n128.232.227.14/32\n192.168.3.0/24\n90.155.51.57/32"


    openstack \
        --os-cloud "${cloudname:?}" \
        loadbalancer listener show \
            --format json \
            '03495dda-e642-44e3-acf7-3df885975e5e' \
    | jq -r '.allowed_cidrs' \
    | sed 's/\\n/\n/'

    >   128.232.226.11/32
    >   128.232.227.14/32
    >   192.168.3.0/24
    >   90.155.51.57/32


# -----------------------------------------------------
# -----------------------------------------------------
# Check the load balancer spec.
#[user@bootstrap]

    #
    # The spec of the Kubernetes loadbalancer has the right list of allowedCidrs.
    #

    kubectl \
        --kubeconfig "${kindclusterconf:?}" \
        get OpenStackCluster \
            --output json \
            "${workclustername:?}" \
    | jq '.spec.apiServerLoadBalancer'

    >   {
    >     "allowedCidrs": [
    >       "128.232.227.14/32",
    >       "90.155.51.57/32"
    >     ],
    >     "enabled": true
    >   }


# -----------------------------------------------------
# Check the load balancer status.
#[user@bootstrap]

    #
    # It doesn't always show up in the loadbalancer status.
    #

    kubectl \
        --kubeconfig "${kindclusterconf:?}" \
        get OpenStackCluster \
            --output json \
            "${workclustername:?}" \
    | jq '.status.network.apiServerLoadBalancer'

    >   {
    >     "id": "f2c97f08-4f7b-4b82-ab04-b3f514e98aa5",
    >     "internalIP": "192.168.3.161",
    >     "ip": "128.232.227.94",
    >     "name": "k8s-clusterapi-cluster-default-iris-gaia-blue-20230815-work-kubeapi"
    >   }


#
# <meta:header>
#   <meta:licence>
#     Copyright (c) 2022, ROE (http://www.roe.ac.uk/)
#
#     This information is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This information is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
#   </meta:licence>
# </meta:header>
#
#zrq-notes-time
#zrq-notes-indent
#zrq-notes-crypto
#zrq-notes-ansible
#zrq-notes-osformat
#zrq-notes-zeppelin
#

    Target:

        Clean deploy on red to test everything.

    Result:

        Work in progress ...


# -----------------------------------------------------
# Create a container to work with.
#[user@desktop]

    source "${HOME:?}/aglais.env"

    podman run \
        --rm \
        --tty \
        --interactive \
        --name ansibler \
        --hostname ansibler \
        --publish 3000:3000 \
        --env "SSH_AUTH_SOCK=/mnt/ssh_auth_sock" \
        --volume "${SSH_AUTH_SOCK}:/mnt/ssh_auth_sock:rw,z" \
        --volume "${HOME:?}/clouds.yaml:/etc/openstack/clouds.yaml:ro,z" \
        --volume "${AGLAIS_CODE:?}/deployments:/deployments:ro,z" \
        ghcr.io/wfau/atolmis/ansible-client:2022.03.19 \
        bash


# -----------------------------------------------------
# Set the target configuration.
#[root@ansibler]

    cloudbase=arcus
    cloudname=iris-gaia-red
    configname=zeppelin-26.43-spark-3.26.43


# -----------------------------------------------------
# Deploy everything.
#[root@ansibler]

    time \
        source /deployments/hadoop-yarn/bin/deploy.sh

    >   real    35m36.900s
    >   user    12m45.609s
    >   sys     2m24.199s


# -----------------------------------------------------
# Check the data shares are in place.
#[root@ansibler]

    nodes=(
        zeppelin
        master01
        worker01
        worker02
        worker03
        )

    for node in "${nodes[@]}"
    do
        echo
        echo "Node [${node}]"
        ssh "${node}" \
            '
            hostname
            date
            df -h /data/gaia/GEDR3_2048/
            '
    done

    >   Node [zeppelin]
    >   iris-gaia-red-20220714-zeppelin
    >   Thu Jul 14 14:34:37 UTC 2022
    >   Filesystem                                                                                                Size  Used Avail Use% Mounted on
    >   10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/5e74d2f7-dba9-40aa-ab90-526c8d0d58e5  409T  115T  295T  28% /data/gaia/GEDR3_2048
    >   
    >   Node [master01]
    >   iris-gaia-red-20220714-master01
    >   Thu Jul 14 14:34:37 UTC 2022
    >   Filesystem                                                                                                Size  Used Avail Use% Mounted on
    >   10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/5e74d2f7-dba9-40aa-ab90-526c8d0d58e5  409T  115T  295T  28% /data/gaia/GEDR3_2048
    >   
    >   Node [worker01]
    >   iris-gaia-red-20220714-worker01
    >   Thu Jul 14 14:34:37 UTC 2022
    >   Filesystem                                                                                                Size  Used Avail Use% Mounted on
    >   10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/5e74d2f7-dba9-40aa-ab90-526c8d0d58e5  409T  115T  295T  28% /data/gaia/GEDR3_2048
    >   
    >   Node [worker02]
    >   iris-gaia-red-20220714-worker02
    >   Thu Jul 14 14:34:37 UTC 2022
    >   Filesystem                                                                                                Size  Used Avail Use% Mounted on
    >   10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/5e74d2f7-dba9-40aa-ab90-526c8d0d58e5  409T  115T  295T  28% /data/gaia/GEDR3_2048
    >   
    >   Node [worker03]
    >   iris-gaia-red-20220714-worker03
    >   Thu Jul 14 14:34:37 UTC 2022
    >   Filesystem                                                                                                Size  Used Avail Use% Mounted on
    >   10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/5e74d2f7-dba9-40aa-ab90-526c8d0d58e5  409T  115T  295T  28% /data/gaia/GEDR3_2048


# -----------------------------------------------------
# Create some test users.
#[root@ansibler]

    source /deployments/zeppelin/bin/create-user-tools.sh

    testnames=(
        Halda
        Jaden
        )

    createarrayusers \
        "${testnames[@]}" \
    | tee /tmp/testusers.json \
    | jq '.'


    >   {
    >     "users": [
    >       {
    >         "linuxuser": {
    >           "name": "Halda",
    >           "type": "test",
    >           "linuxuid": "20001",
    >           "debug": {
    >             "script": "create-linux-user.sh",
    >             "result": "PASS",
    >             "messages": [
    >               "PASS: adduser [Halda] done",
    >               "PASS: mkdir [/home/Halda/.ssh] done",
    >               "PASS: adding public key for [zepelin] done",
    >               "SKIP: adding public key for [Halda] skipped (no key)"
    >             ]
    >           }
    >         },
    >         "hdfsspace": {
    >           "path": "/albert/Halda",
    >           "owner": "Halda",
    >           "group": "supergroup",
    >           "debug": {
    >             "script": "create-hdfs-space.sh",
    >             "result": "PASS",
    >             "messages": [
    >               "PASS: hdfs mkdir [/albert/Halda] done",
    >               "PASS: hdfs chown [/albert/Halda] done"
    >             ]
    >           }
    >         },
    >         "shirouser": {
    >           "name": "Halda",
    >           "type": "test",
    >           "role": "user",
    >           "password": "Eech7uD6yeekahsha2Uf",
    >           "passhash": "$shiro1$SHA-256$500000$ywCzcwA6Ed2+cJZY/OlUFA==$0SHAIGyccQlIGdL0a3BRDDY/qTGVpZIR5872bnxdiU4=",
    >           "debug": {
    >             "script": "create-shiro-user.sh",
    >             "result": "PASS",
    >             "messages": [
    >               "PASS: passgen done",
    >               "PASS: hashpass done",
    >               "PASS: database INSERT done"
    >             ]
    >           }
    >         },
    >         "notebooks": {
    >           "user": "Halda",
    >           "debug": {
    >             "script": "clone-notebooks.sh",
    >             "result": "PASS",
    >             "messages": [
    >               "PASS: Login [Halda] done",
    >               "PASS: Clone done [2GRTQZFUM][/Users/Halda/examples/1. Start here]",
    >               "PASS: Clone done [2GRA39HCN][/Users/Halda/examples/2. Data holdings]",
    >               "PASS: Clone done [2GQ6WMH9W][/Users/Halda/examples/3. Source counts over the sky]",
    >               "PASS: Clone done [2GSNYBDWB][/Users/Halda/examples/4. Mean proper motions over the sky]",
    >               "PASS: Clone done [2H2YRJCKM][/Users/Halda/examples/5. Working with Gaia XP spectra]",
    >               "PASS: Clone done [2GZME59KY][/Users/Halda/examples/6. Working with cross-matched surveys]",
    >               "PASS: Clone done [2GQDKZ59J][/Users/Halda/examples/7. Good astrometric solutions via ML Random Forrest classifier]",
    >               "PASS: Clone done [2GVXKC266][/Users/Halda/examples/8. Tips and tricks]"
    >             ]
    >           }
    >         }
    >       },
    >       {
    >         "linuxuser": {
    >           "name": "Jaden",
    >           "type": "test",
    >           "linuxuid": "20002",
    >           "debug": {
    >             "script": "create-linux-user.sh",
    >             "result": "PASS",
    >             "messages": [
    >               "PASS: adduser [Jaden] done",
    >               "PASS: mkdir [/home/Jaden/.ssh] done",
    >               "PASS: adding public key for [zepelin] done",
    >               "SKIP: adding public key for [Jaden] skipped (no key)"
    >             ]
    >           }
    >         },
    >         "hdfsspace": {
    >           "path": "/albert/Jaden",
    >           "owner": "Jaden",
    >           "group": "supergroup",
    >           "debug": {
    >             "script": "create-hdfs-space.sh",
    >             "result": "PASS",
    >             "messages": [
    >               "PASS: hdfs mkdir [/albert/Jaden] done",
    >               "PASS: hdfs chown [/albert/Jaden] done"
    >             ]
    >           }
    >         },
    >         "shirouser": {
    >           "name": "Jaden",
    >           "type": "test",
    >           "role": "user",
    >           "password": "chaimoowoo5aebeiShah",
    >           "passhash": "$shiro1$SHA-256$500000$q3pGCH0WvPVxxO3n/uV8Ig==$PtEEh5A+j1v79AbxV38q6qF0YwFTqxcfNNmh6nwcJyQ=",
    >           "debug": {
    >             "script": "create-shiro-user.sh",
    >             "result": "PASS",
    >             "messages": [
    >               "PASS: passgen done",
    >               "PASS: hashpass done",
    >               "PASS: database INSERT done"
    >             ]
    >           }
    >         },
    >         "notebooks": {
    >           "user": "Jaden",
    >           "debug": {
    >             "script": "clone-notebooks.sh",
    >             "result": "PASS",
    >             "messages": [
    >               "PASS: Login [Jaden] done",
    >               "PASS: Clone done [2GRTQZFUM][/Users/Jaden/examples/1. Start here]",
    >               "PASS: Clone done [2GRA39HCN][/Users/Jaden/examples/2. Data holdings]",
    >               "PASS: Clone done [2GQ6WMH9W][/Users/Jaden/examples/3. Source counts over the sky]",
    >               "PASS: Clone done [2GSNYBDWB][/Users/Jaden/examples/4. Mean proper motions over the sky]",
    >               "PASS: Clone done [2H2YRJCKM][/Users/Jaden/examples/5. Working with Gaia XP spectra]",
    >               "PASS: Clone done [2GZME59KY][/Users/Jaden/examples/6. Working with cross-matched surveys]",
    >               "PASS: Clone done [2GQDKZ59J][/Users/Jaden/examples/7. Good astrometric solutions via ML Random Forrest classifier]",
    >               "PASS: Clone done [2GVXKC266][/Users/Jaden/examples/8. Tips and tricks]"
    >             ]
    >           }
    >         }
    >       }
    >     ]
    >   }


    jq '.users[].shirouser | {name, password}' /tmp/testusers.json

    >   {
    >     "name": "Halda",
    >     "password": "Eech7uD6yeekahsha2Uf"
    >   }
    >   {
    >     "name": "Jaden",
    >     "password": "chaimoowoo5aebeiShah"
    >   }


# -----------------------------------------------------
# Try creating a new share
#[root@ansibler]

    /deployments/zeppelin/bin/create-ceph-share.sh \
        "${cloudname:?}" \
        "Halda-user-share-006" \
        10 \
        "/user/Halda/006" \
        "Halda" \
        "users"  \
    | tee /tmp/create-test.json \
    | jq '.'

    >   {
    >     "name": "Halda-user-share-006",
    >     "uuid": "cf12b273-3b84-4cc5-bcd0-9373bbc30ce9",
    >     "status": "available",
    >     "ceph": {
    >       "nodes": "10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789",
    >       "path": "/volumes/_nogroup/02bcf000-18b8-43bf-b336-4faf26e1ad68",
    >       "name": "Halda-user-share-006-rw",
    >       "key": "AQAvOtBiQgUNAhAA4bsy5JXZPRL5eQYKWohbxQ=="
    >     },
    >     "mount": {
    >       "path": "/user/Halda/006",
    >       "mode": "rw",
    >       "owner": "Halda",
    >       "group": "users"
    >     },
    >     "openstack": {
    >       "access_rules_status": "active",
    >       "availability_zone": "nova",
    >       "create_share_from_snapshot_support": false,
    >       "created_at": "2022-07-14T15:45:38.000000",
    >       "description": null,
    >       "export_locations": "\npath = 10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/02bcf000-18b8-43bf-b336-4faf26e1ad68\nid = a184f786-6ad8-48d2-849e-5cadb8dacc83\npreferred = False",
    >       "has_replicas": false,
    >       "id": "cf12b273-3b84-4cc5-bcd0-9373bbc30ce9",
    >       "is_public": true,
    >       "mount_snapshot_support": false,
    >       "name": "Halda-user-share-006",
    >       "project_id": "0dd8cc5ee5a7455c8748cc06d04c93c3",
    >       "properties": {},
    >       "replication_type": null,
    >       "revert_to_snapshot_support": false,
    >       "share_group_id": null,
    >       "share_network_id": null,
    >       "share_proto": "CEPHFS",
    >       "share_type": "12668f5c-44e4-4b63-abf1-c56002ccc424",
    >       "share_type_name": "ceph01_cephfs",
    >       "size": 10,
    >       "snapshot_id": null,
    >       "snapshot_support": false,
    >       "source_share_group_snapshot_member_id": null,
    >       "status": "available",
    >       "task_state": null,
    >       "user_id": "5fa0c97a6dd14e01a3c7d91dad5c6b17",
    >       "volume_type": "ceph01_cephfs"
    >     },
    >     "ansible": {
    >       "custom_stats": {},
    >       "global_custom_stats": {},
    >       "plays": [
    >         {
    >           "play": {
    >             "duration": {
    >               "end": "2022-07-14T15:46:08.007673Z",
    >               "start": "2022-07-14T15:45:59.431837Z"
    >             },
    >             "id": "aa52aaa5-c50c-64fc-695e-00000000000b",
    >             "name": "Install and mount a CephFS share"
    >           },
    >           "tasks": [
    >             {
    >               "hosts": {
    >                 "master01": {
    >                   "_ansible_no_log": false,
    >                   "action": "blockinfile",
    >                   "ansible_facts": {
    >                     "discovered_interpreter_python": "/usr/bin/python3"
    >                   },
    >                   "changed": false,
    >                   "diff": [
    >                     {
    >                       "after": "",
    >                       "after_header": "/etc/ceph/ceph.conf (content)",
    >                       "before": "",
    >                       "before_header": "/etc/ceph/ceph.conf (content)"
    >                     },
    >                     {
    >                       "after_header": "/etc/ceph/ceph.conf (file attributes)",
    >                       "before_header": "/etc/ceph/ceph.conf (file attributes)"
    >                     }
    >                   ],
    >                   "invocation": {
    >                     "module_args": {
    >                       "attributes": null,
    >                       "backup": false,
    >                       "block": "[client]\n    client quota = true\n    mon host = 10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789\n",
    >                       "create": true,
    >                       "group": null,
    >                       "insertafter": null,
    >                       "insertbefore": null,
    >                       "marker": "# {mark} ANSIBLE MANAGED BLOCK",
    >                       "marker_begin": "BEGIN",
    >                       "marker_end": "END",
    >                       "mode": null,
    >                       "owner": null,
    >                       "path": "/etc/ceph/ceph.conf",
    >                       "selevel": null,
    >                       "serole": null,
    >                       "setype": null,
    >                       "seuser": null,
    >                       "state": "present",
    >                       "unsafe_writes": false,
    >                       "validate": null
    >                     }
    >                   },
    >                   "msg": ""
    >                 },
    >                 "worker01": {
    >                   "_ansible_no_log": false,
    >                   "action": "blockinfile",
    >                   "ansible_facts": {
    >                     "discovered_interpreter_python": "/usr/bin/python3"
    >                   },
    >                   "changed": false,
    >                   "diff": [
    >                     {
    >                       "after": "",
    >                       "after_header": "/etc/ceph/ceph.conf (content)",
    >                       "before": "",
    >                       "before_header": "/etc/ceph/ceph.conf (content)"
    >                     },
    >                     {
    >                       "after_header": "/etc/ceph/ceph.conf (file attributes)",
    >                       "before_header": "/etc/ceph/ceph.conf (file attributes)"
    >                     }
    >                   ],
    >                   "invocation": {
    >                     "module_args": {
    >                       "attributes": null,
    >                       "backup": false,
    >                       "block": "[client]\n    client quota = true\n    mon host = 10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789\n",
    >                       "create": true,
    >                       "group": null,
    >                       "insertafter": null,
    >                       "insertbefore": null,
    >                       "marker": "# {mark} ANSIBLE MANAGED BLOCK",
    >                       "marker_begin": "BEGIN",
    >                       "marker_end": "END",
    >                       "mode": null,
    >                       "owner": null,
    >                       "path": "/etc/ceph/ceph.conf",
    >                       "selevel": null,
    >                       "serole": null,
    >                       "setype": null,
    >                       "seuser": null,
    >                       "state": "present",
    >                       "unsafe_writes": false,
    >                       "validate": null
    >                     }
    >                   },
    >                   "msg": ""
    >                 },
    >                 "worker02": {
    >                   "_ansible_no_log": false,
    >                   "action": "blockinfile",
    >                   "ansible_facts": {
    >                     "discovered_interpreter_python": "/usr/bin/python3"
    >                   },
    >                   "changed": false,
    >                   "diff": [
    >                     {
    >                       "after": "",
    >                       "after_header": "/etc/ceph/ceph.conf (content)",
    >                       "before": "",
    >                       "before_header": "/etc/ceph/ceph.conf (content)"
    >                     },
    >                     {
    >                       "after_header": "/etc/ceph/ceph.conf (file attributes)",
    >                       "before_header": "/etc/ceph/ceph.conf (file attributes)"
    >                     }
    >                   ],
    >                   "invocation": {
    >                     "module_args": {
    >                       "attributes": null,
    >                       "backup": false,
    >                       "block": "[client]\n    client quota = true\n    mon host = 10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789\n",
    >                       "create": true,
    >                       "group": null,
    >                       "insertafter": null,
    >                       "insertbefore": null,
    >                       "marker": "# {mark} ANSIBLE MANAGED BLOCK",
    >                       "marker_begin": "BEGIN",
    >                       "marker_end": "END",
    >                       "mode": null,
    >                       "owner": null,
    >                       "path": "/etc/ceph/ceph.conf",
    >                       "selevel": null,
    >                       "serole": null,
    >                       "setype": null,
    >                       "seuser": null,
    >                       "state": "present",
    >                       "unsafe_writes": false,
    >                       "validate": null
    >                     }
    >                   },
    >                   "msg": ""
    >                 },
    >                 "worker03": {
    >                   "_ansible_no_log": false,
    >                   "action": "blockinfile",
    >                   "ansible_facts": {
    >                     "discovered_interpreter_python": "/usr/bin/python3"
    >                   },
    >                   "changed": false,
    >                   "diff": [
    >                     {
    >                       "after": "",
    >                       "after_header": "/etc/ceph/ceph.conf (content)",
    >                       "before": "",
    >                       "before_header": "/etc/ceph/ceph.conf (content)"
    >                     },
    >                     {
    >                       "after_header": "/etc/ceph/ceph.conf (file attributes)",
    >                       "before_header": "/etc/ceph/ceph.conf (file attributes)"
    >                     }
    >                   ],
    >                   "invocation": {
    >                     "module_args": {
    >                       "attributes": null,
    >                       "backup": false,
    >                       "block": "[client]\n    client quota = true\n    mon host = 10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789\n",
    >                       "create": true,
    >                       "group": null,
    >                       "insertafter": null,
    >                       "insertbefore": null,
    >                       "marker": "# {mark} ANSIBLE MANAGED BLOCK",
    >                       "marker_begin": "BEGIN",
    >                       "marker_end": "END",
    >                       "mode": null,
    >                       "owner": null,
    >                       "path": "/etc/ceph/ceph.conf",
    >                       "selevel": null,
    >                       "serole": null,
    >                       "setype": null,
    >                       "seuser": null,
    >                       "state": "present",
    >                       "unsafe_writes": false,
    >                       "validate": null
    >                     }
    >                   },
    >                   "msg": ""
    >                 },
    >                 "zeppelin": {
    >                   "_ansible_no_log": false,
    >                   "action": "blockinfile",
    >                   "ansible_facts": {
    >                     "discovered_interpreter_python": "/usr/bin/python3"
    >                   },
    >                   "changed": false,
    >                   "diff": [
    >                     {
    >                       "after": "",
    >                       "after_header": "/etc/ceph/ceph.conf (content)",
    >                       "before": "",
    >                       "before_header": "/etc/ceph/ceph.conf (content)"
    >                     },
    >                     {
    >                       "after_header": "/etc/ceph/ceph.conf (file attributes)",
    >                       "before_header": "/etc/ceph/ceph.conf (file attributes)"
    >                     }
    >                   ],
    >                   "invocation": {
    >                     "module_args": {
    >                       "attributes": null,
    >                       "backup": false,
    >                       "block": "[client]\n    client quota = true\n    mon host = 10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789\n",
    >                       "create": true,
    >                       "group": null,
    >                       "insertafter": null,
    >                       "insertbefore": null,
    >                       "marker": "# {mark} ANSIBLE MANAGED BLOCK",
    >                       "marker_begin": "BEGIN",
    >                       "marker_end": "END",
    >                       "mode": null,
    >                       "owner": null,
    >                       "path": "/etc/ceph/ceph.conf",
    >                       "selevel": null,
    >                       "serole": null,
    >                       "setype": null,
    >                       "seuser": null,
    >                       "state": "present",
    >                       "unsafe_writes": false,
    >                       "validate": null
    >                     }
    >                   },
    >                   "msg": ""
    >                 }
    >               },
    >               "task": {
    >                 "duration": {
    >                   "end": "2022-07-14T15:46:01.284349Z",
    >                   "start": "2022-07-14T15:45:59.463602Z"
    >                 },
    >                 "id": "aa52aaa5-c50c-64fc-695e-00000000000d",
    >                 "name": "Creating CephFS cfg file [/etc/ceph/ceph.conf]"
    >               }
    >             },
    >             {
    >               "hosts": {
    >                 "master01": {
    >                   "_ansible_no_log": false,
    >                   "action": "blockinfile",
    >                   "changed": true,
    >                   "diff": [
    >                     {
    >                       "after": "",
    >                       "after_header": "/etc/ceph/ceph.client.Halda-user-share-006-rw.keyring (content)",
    >                       "before": "",
    >                       "before_header": "/etc/ceph/ceph.client.Halda-user-share-006-rw.keyring (content)"
    >                     },
    >                     {
    >                       "after_header": "/etc/ceph/ceph.client.Halda-user-share-006-rw.keyring (file attributes)",
    >                       "before_header": "/etc/ceph/ceph.client.Halda-user-share-006-rw.keyring (file attributes)"
    >                     }
    >                   ],
    >                   "invocation": {
    >                     "module_args": {
    >                       "attributes": null,
    >                       "backup": false,
    >                       "block": "[client.Halda-user-share-006-rw]\n    key = AQAvOtBiQgUNAhAA4bsy5JXZPRL5eQYKWohbxQ==\n",
    >                       "create": true,
    >                       "group": null,
    >                       "insertafter": null,
    >                       "insertbefore": null,
    >                       "marker": "# {mark} ANSIBLE MANAGED BLOCK",
    >                       "marker_begin": "BEGIN",
    >                       "marker_end": "END",
    >                       "mode": null,
    >                       "owner": null,
    >                       "path": "/etc/ceph/ceph.client.Halda-user-share-006-rw.keyring",
    >                       "selevel": null,
    >                       "serole": null,
    >                       "setype": null,
    >                       "seuser": null,
    >                       "state": "present",
    >                       "unsafe_writes": false,
    >                       "validate": null
    >                     }
    >                   },
    >                   "msg": "File created"
    >                 },
    >                 "worker01": {
    >                   "_ansible_no_log": false,
    >                   "action": "blockinfile",
    >                   "changed": true,
    >                   "diff": [
    >                     {
    >                       "after": "",
    >                       "after_header": "/etc/ceph/ceph.client.Halda-user-share-006-rw.keyring (content)",
    >                       "before": "",
    >                       "before_header": "/etc/ceph/ceph.client.Halda-user-share-006-rw.keyring (content)"
    >                     },
    >                     {
    >                       "after_header": "/etc/ceph/ceph.client.Halda-user-share-006-rw.keyring (file attributes)",
    >                       "before_header": "/etc/ceph/ceph.client.Halda-user-share-006-rw.keyring (file attributes)"
    >                     }
    >                   ],
    >                   "invocation": {
    >                     "module_args": {
    >                       "attributes": null,
    >                       "backup": false,
    >                       "block": "[client.Halda-user-share-006-rw]\n    key = AQAvOtBiQgUNAhAA4bsy5JXZPRL5eQYKWohbxQ==\n",
    >                       "create": true,
    >                       "group": null,
    >                       "insertafter": null,
    >                       "insertbefore": null,
    >                       "marker": "# {mark} ANSIBLE MANAGED BLOCK",
    >                       "marker_begin": "BEGIN",
    >                       "marker_end": "END",
    >                       "mode": null,
    >                       "owner": null,
    >                       "path": "/etc/ceph/ceph.client.Halda-user-share-006-rw.keyring",
    >                       "selevel": null,
    >                       "serole": null,
    >                       "setype": null,
    >                       "seuser": null,
    >                       "state": "present",
    >                       "unsafe_writes": false,
    >                       "validate": null
    >                     }
    >                   },
    >                   "msg": "File created"
    >                 },
    >                 "worker02": {
    >                   "_ansible_no_log": false,
    >                   "action": "blockinfile",
    >                   "changed": true,
    >                   "diff": [
    >                     {
    >                       "after": "",
    >                       "after_header": "/etc/ceph/ceph.client.Halda-user-share-006-rw.keyring (content)",
    >                       "before": "",
    >                       "before_header": "/etc/ceph/ceph.client.Halda-user-share-006-rw.keyring (content)"
    >                     },
    >                     {
    >                       "after_header": "/etc/ceph/ceph.client.Halda-user-share-006-rw.keyring (file attributes)",
    >                       "before_header": "/etc/ceph/ceph.client.Halda-user-share-006-rw.keyring (file attributes)"
    >                     }
    >                   ],
    >                   "invocation": {
    >                     "module_args": {
    >                       "attributes": null,
    >                       "backup": false,
    >                       "block": "[client.Halda-user-share-006-rw]\n    key = AQAvOtBiQgUNAhAA4bsy5JXZPRL5eQYKWohbxQ==\n",
    >                       "create": true,
    >                       "group": null,
    >                       "insertafter": null,
    >                       "insertbefore": null,
    >                       "marker": "# {mark} ANSIBLE MANAGED BLOCK",
    >                       "marker_begin": "BEGIN",
    >                       "marker_end": "END",
    >                       "mode": null,
    >                       "owner": null,
    >                       "path": "/etc/ceph/ceph.client.Halda-user-share-006-rw.keyring",
    >                       "selevel": null,
    >                       "serole": null,
    >                       "setype": null,
    >                       "seuser": null,
    >                       "state": "present",
    >                       "unsafe_writes": false,
    >                       "validate": null
    >                     }
    >                   },
    >                   "msg": "File created"
    >                 },
    >                 "worker03": {
    >                   "_ansible_no_log": false,
    >                   "action": "blockinfile",
    >                   "changed": true,
    >                   "diff": [
    >                     {
    >                       "after": "",
    >                       "after_header": "/etc/ceph/ceph.client.Halda-user-share-006-rw.keyring (content)",
    >                       "before": "",
    >                       "before_header": "/etc/ceph/ceph.client.Halda-user-share-006-rw.keyring (content)"
    >                     },
    >                     {
    >                       "after_header": "/etc/ceph/ceph.client.Halda-user-share-006-rw.keyring (file attributes)",
    >                       "before_header": "/etc/ceph/ceph.client.Halda-user-share-006-rw.keyring (file attributes)"
    >                     }
    >                   ],
    >                   "invocation": {
    >                     "module_args": {
    >                       "attributes": null,
    >                       "backup": false,
    >                       "block": "[client.Halda-user-share-006-rw]\n    key = AQAvOtBiQgUNAhAA4bsy5JXZPRL5eQYKWohbxQ==\n",
    >                       "create": true,
    >                       "group": null,
    >                       "insertafter": null,
    >                       "insertbefore": null,
    >                       "marker": "# {mark} ANSIBLE MANAGED BLOCK",
    >                       "marker_begin": "BEGIN",
    >                       "marker_end": "END",
    >                       "mode": null,
    >                       "owner": null,
    >                       "path": "/etc/ceph/ceph.client.Halda-user-share-006-rw.keyring",
    >                       "selevel": null,
    >                       "serole": null,
    >                       "setype": null,
    >                       "seuser": null,
    >                       "state": "present",
    >                       "unsafe_writes": false,
    >                       "validate": null
    >                     }
    >                   },
    >                   "msg": "File created"
    >                 },
    >                 "zeppelin": {
    >                   "_ansible_no_log": false,
    >                   "action": "blockinfile",
    >                   "changed": true,
    >                   "diff": [
    >                     {
    >                       "after": "",
    >                       "after_header": "/etc/ceph/ceph.client.Halda-user-share-006-rw.keyring (content)",
    >                       "before": "",
    >                       "before_header": "/etc/ceph/ceph.client.Halda-user-share-006-rw.keyring (content)"
    >                     },
    >                     {
    >                       "after_header": "/etc/ceph/ceph.client.Halda-user-share-006-rw.keyring (file attributes)",
    >                       "before_header": "/etc/ceph/ceph.client.Halda-user-share-006-rw.keyring (file attributes)"
    >                     }
    >                   ],
    >                   "invocation": {
    >                     "module_args": {
    >                       "attributes": null,
    >                       "backup": false,
    >                       "block": "[client.Halda-user-share-006-rw]\n    key = AQAvOtBiQgUNAhAA4bsy5JXZPRL5eQYKWohbxQ==\n",
    >                       "create": true,
    >                       "group": null,
    >                       "insertafter": null,
    >                       "insertbefore": null,
    >                       "marker": "# {mark} ANSIBLE MANAGED BLOCK",
    >                       "marker_begin": "BEGIN",
    >                       "marker_end": "END",
    >                       "mode": null,
    >                       "owner": null,
    >                       "path": "/etc/ceph/ceph.client.Halda-user-share-006-rw.keyring",
    >                       "selevel": null,
    >                       "serole": null,
    >                       "setype": null,
    >                       "seuser": null,
    >                       "state": "present",
    >                       "unsafe_writes": false,
    >                       "validate": null
    >                     }
    >                   },
    >                   "msg": "File created"
    >                 }
    >               },
    >               "task": {
    >                 "duration": {
    >                   "end": "2022-07-14T15:46:02.266000Z",
    >                   "start": "2022-07-14T15:46:01.298740Z"
    >                 },
    >                 "id": "aa52aaa5-c50c-64fc-695e-00000000000e",
    >                 "name": "Creating CephFS key file [/etc/ceph/ceph.client.Halda-user-share-006-rw.keyring]"
    >               }
    >             },
    >             {
    >               "hosts": {
    >                 "master01": {
    >                   "_ansible_no_log": false,
    >                   "action": "mount",
    >                   "backup_file": "",
    >                   "boot": "yes",
    >                   "changed": true,
    >                   "dump": "0",
    >                   "fstab": "/etc/fstab",
    >                   "fstype": "ceph",
    >                   "invocation": {
    >                     "module_args": {
    >                       "backup": false,
    >                       "boot": true,
    >                       "dump": null,
    >                       "fstab": null,
    >                       "fstype": "ceph",
    >                       "opts": "name=Halda-user-share-006-rw,async,auto,nodev,noexec,nosuid,_netdev,rw",
    >                       "passno": null,
    >                       "path": "/user/Halda/006",
    >                       "src": "10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/02bcf000-18b8-43bf-b336-4faf26e1ad68",
    >                       "state": "mounted"
    >                     }
    >                   },
    >                   "name": "/user/Halda/006",
    >                   "opts": "name=Halda-user-share-006-rw,async,auto,nodev,noexec,nosuid,_netdev,rw",
    >                   "passno": "0",
    >                   "src": "10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/02bcf000-18b8-43bf-b336-4faf26e1ad68"
    >                 },
    >                 "worker01": {
    >                   "_ansible_no_log": false,
    >                   "action": "mount",
    >                   "backup_file": "",
    >                   "boot": "yes",
    >                   "changed": true,
    >                   "dump": "0",
    >                   "fstab": "/etc/fstab",
    >                   "fstype": "ceph",
    >                   "invocation": {
    >                     "module_args": {
    >                       "backup": false,
    >                       "boot": true,
    >                       "dump": null,
    >                       "fstab": null,
    >                       "fstype": "ceph",
    >                       "opts": "name=Halda-user-share-006-rw,async,auto,nodev,noexec,nosuid,_netdev,rw",
    >                       "passno": null,
    >                       "path": "/user/Halda/006",
    >                       "src": "10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/02bcf000-18b8-43bf-b336-4faf26e1ad68",
    >                       "state": "mounted"
    >                     }
    >                   },
    >                   "name": "/user/Halda/006",
    >                   "opts": "name=Halda-user-share-006-rw,async,auto,nodev,noexec,nosuid,_netdev,rw",
    >                   "passno": "0",
    >                   "src": "10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/02bcf000-18b8-43bf-b336-4faf26e1ad68"
    >                 },
    >                 "worker02": {
    >                   "_ansible_no_log": false,
    >                   "action": "mount",
    >                   "backup_file": "",
    >                   "boot": "yes",
    >                   "changed": true,
    >                   "dump": "0",
    >                   "fstab": "/etc/fstab",
    >                   "fstype": "ceph",
    >                   "invocation": {
    >                     "module_args": {
    >                       "backup": false,
    >                       "boot": true,
    >                       "dump": null,
    >                       "fstab": null,
    >                       "fstype": "ceph",
    >                       "opts": "name=Halda-user-share-006-rw,async,auto,nodev,noexec,nosuid,_netdev,rw",
    >                       "passno": null,
    >                       "path": "/user/Halda/006",
    >                       "src": "10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/02bcf000-18b8-43bf-b336-4faf26e1ad68",
    >                       "state": "mounted"
    >                     }
    >                   },
    >                   "name": "/user/Halda/006",
    >                   "opts": "name=Halda-user-share-006-rw,async,auto,nodev,noexec,nosuid,_netdev,rw",
    >                   "passno": "0",
    >                   "src": "10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/02bcf000-18b8-43bf-b336-4faf26e1ad68"
    >                 },
    >                 "worker03": {
    >                   "_ansible_no_log": false,
    >                   "action": "mount",
    >                   "backup_file": "",
    >                   "boot": "yes",
    >                   "changed": true,
    >                   "dump": "0",
    >                   "fstab": "/etc/fstab",
    >                   "fstype": "ceph",
    >                   "invocation": {
    >                     "module_args": {
    >                       "backup": false,
    >                       "boot": true,
    >                       "dump": null,
    >                       "fstab": null,
    >                       "fstype": "ceph",
    >                       "opts": "name=Halda-user-share-006-rw,async,auto,nodev,noexec,nosuid,_netdev,rw",
    >                       "passno": null,
    >                       "path": "/user/Halda/006",
    >                       "src": "10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/02bcf000-18b8-43bf-b336-4faf26e1ad68",
    >                       "state": "mounted"
    >                     }
    >                   },
    >                   "name": "/user/Halda/006",
    >                   "opts": "name=Halda-user-share-006-rw,async,auto,nodev,noexec,nosuid,_netdev,rw",
    >                   "passno": "0",
    >                   "src": "10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/02bcf000-18b8-43bf-b336-4faf26e1ad68"
    >                 },
    >                 "zeppelin": {
    >                   "_ansible_no_log": false,
    >                   "action": "mount",
    >                   "backup_file": "",
    >                   "boot": "yes",
    >                   "changed": true,
    >                   "dump": "0",
    >                   "fstab": "/etc/fstab",
    >                   "fstype": "ceph",
    >                   "invocation": {
    >                     "module_args": {
    >                       "backup": false,
    >                       "boot": true,
    >                       "dump": null,
    >                       "fstab": null,
    >                       "fstype": "ceph",
    >                       "opts": "name=Halda-user-share-006-rw,async,auto,nodev,noexec,nosuid,_netdev,rw",
    >                       "passno": null,
    >                       "path": "/user/Halda/006",
    >                       "src": "10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/02bcf000-18b8-43bf-b336-4faf26e1ad68",
    >                       "state": "mounted"
    >                     }
    >                   },
    >                   "name": "/user/Halda/006",
    >                   "opts": "name=Halda-user-share-006-rw,async,auto,nodev,noexec,nosuid,_netdev,rw",
    >                   "passno": "0",
    >                   "src": "10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/02bcf000-18b8-43bf-b336-4faf26e1ad68"
    >                 }
    >               },
    >               "task": {
    >                 "duration": {
    >                   "end": "2022-07-14T15:46:06.721608Z",
    >                   "start": "2022-07-14T15:46:02.275077Z"
    >                 },
    >                 "id": "aa52aaa5-c50c-64fc-695e-00000000000f",
    >                 "name": "Creating CephFS fstab entry [/user/Halda/006]"
    >               }
    >             },
    >             {
    >               "hosts": {
    >                 "zeppelin": {
    >                   "_ansible_delegated_vars": {
    >                     "ansible_host": "zeppelin",
    >                     "ansible_port": null,
    >                     "ansible_user": null
    >                   },
    >                   "_ansible_no_log": false,
    >                   "action": "file",
    >                   "changed": true,
    >                   "diff": {
    >                     "after": {
    >                       "group": 100,
    >                       "mode": "02755",
    >                       "owner": 20001,
    >                       "path": "/user/Halda/006"
    >                     },
    >                     "before": {
    >                       "group": 0,
    >                       "mode": "0777",
    >                       "owner": 0,
    >                       "path": "/user/Halda/006"
    >                     }
    >                   },
    >                   "gid": 100,
    >                   "group": "users",
    >                   "invocation": {
    >                     "module_args": {
    >                       "_diff_peek": null,
    >                       "_original_basename": null,
    >                       "access_time": null,
    >                       "access_time_format": "%Y%m%d%H%M.%S",
    >                       "attributes": null,
    >                       "follow": true,
    >                       "force": false,
    >                       "group": "users",
    >                       "mode": "u=rwX,g=rXs,o=rX",
    >                       "modification_time": null,
    >                       "modification_time_format": "%Y%m%d%H%M.%S",
    >                       "owner": "Halda",
    >                       "path": "/user/Halda/006",
    >                       "recurse": false,
    >                       "selevel": null,
    >                       "serole": null,
    >                       "setype": null,
    >                       "seuser": null,
    >                       "src": null,
    >                       "state": "directory",
    >                       "unsafe_writes": false
    >                     }
    >                   },
    >                   "mode": "02755",
    >                   "owner": "Halda",
    >                   "path": "/user/Halda/006",
    >                   "secontext": "system_u:object_r:cephfs_t:s0",
    >                   "size": 0,
    >                   "state": "directory",
    >                   "uid": 20001
    >                 }
    >               },
    >               "task": {
    >                 "duration": {
    >                   "end": "2022-07-14T15:46:08.007673Z",
    >                   "start": "2022-07-14T15:46:06.748379Z"
    >                 },
    >                 "id": "aa52aaa5-c50c-64fc-695e-000000000010",
    >                 "name": "Setting permissions for [/user/Halda/006]"
    >               }
    >             }
    >           ]
    >         }
    >       ],
    >       "stats": {
    >         "master01": {
    >           "changed": 2,
    >           "failures": 0,
    >           "ignored": 0,
    >           "ok": 3,
    >           "rescued": 0,
    >           "skipped": 0,
    >           "unreachable": 0
    >         },
    >         "worker01": {
    >           "changed": 2,
    >           "failures": 0,
    >           "ignored": 0,
    >           "ok": 3,
    >           "rescued": 0,
    >           "skipped": 0,
    >           "unreachable": 0
    >         },
    >         "worker02": {
    >           "changed": 2,
    >           "failures": 0,
    >           "ignored": 0,
    >           "ok": 3,
    >           "rescued": 0,
    >           "skipped": 0,
    >           "unreachable": 0
    >         },
    >         "worker03": {
    >           "changed": 2,
    >           "failures": 0,
    >           "ignored": 0,
    >           "ok": 3,
    >           "rescued": 0,
    >           "skipped": 0,
    >           "unreachable": 0
    >         },
    >         "zeppelin": {
    >           "changed": 3,
    >           "failures": 0,
    >           "ignored": 0,
    >           "ok": 4,
    >           "rescued": 0,
    >           "skipped": 0,
    >           "unreachable": 0
    >         }
    >       }
    >     },
    >     "debug": {
    >       "script": "create-ceph-share.sh",
    >       "result": "PASS",
    >       "messages": [
    >         "PASS: Share [Halda-user-share-006] created [cf12b273-3b84-4cc5-bcd0-9373bbc30ce9][creating]",
    >         "PASS: Share [Halda-user-share-006][cf12b273-3b84-4cc5-bcd0-9373bbc30ce9] status [available]",
    >         "PASS: Share [Halda-user-share-006][cf12b273-3b84-4cc5-bcd0-9373bbc30ce9] [ro] access created",
    >         "PASS: Share [Halda-user-share-006][cf12b273-3b84-4cc5-bcd0-9373bbc30ce9] [rw] access created",
    >         "PASS: Ansible mount playbook succeded"
    >       ]
    >     }
    >   }


    jq 'del(.openstack, .ansible)' /tmp/create-test.json

    >   {
    >     "name": "Halda-user-share-006",
    >     "uuid": "cf12b273-3b84-4cc5-bcd0-9373bbc30ce9",
    >     "status": "available",
    >     "ceph": {
    >       "nodes": "10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789",
    >       "path": "/volumes/_nogroup/02bcf000-18b8-43bf-b336-4faf26e1ad68",
    >       "name": "Halda-user-share-006-rw",
    >       "key": "AQAvOtBiQgUNAhAA4bsy5JXZPRL5eQYKWohbxQ=="
    >     },
    >     "mount": {
    >       "path": "/user/Halda/006",
    >       "mode": "rw",
    >       "owner": "Halda",
    >       "group": "users"
    >     },
    >     "debug": {
    >       "script": "create-ceph-share.sh",
    >       "result": "PASS",
    >       "messages": [
    >         "PASS: Share [Halda-user-share-006] created [cf12b273-3b84-4cc5-bcd0-9373bbc30ce9][creating]",
    >         "PASS: Share [Halda-user-share-006][cf12b273-3b84-4cc5-bcd0-9373bbc30ce9] status [available]",
    >         "PASS: Share [Halda-user-share-006][cf12b273-3b84-4cc5-bcd0-9373bbc30ce9] [ro] access created",
    >         "PASS: Share [Halda-user-share-006][cf12b273-3b84-4cc5-bcd0-9373bbc30ce9] [rw] access created",
    >         "PASS: Ansible mount playbook succeded"
    >       ]
    >     }
    >   }



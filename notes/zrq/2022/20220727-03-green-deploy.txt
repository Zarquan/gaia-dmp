#
# <meta:header>
#   <meta:licence>
#     Copyright (c) 2022, ROE (http://www.roe.ac.uk/)
#
#     This information is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This information is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
#   </meta:licence>
# </meta:header>
#
#zrq-notes-time
#zrq-notes-indent
#zrq-notes-crypto
#zrq-notes-ansible
#zrq-notes-osformat
#zrq-notes-zeppelin
#

    Target:

        Clean deploy on green to test everything.
        Clean 'empty' set of notebooks on data node.
        Clean set of live users.

    Result:

        Work in progress ....


# -----------------------------------------------------
# Create a container to work with.
#[user@desktop]

    #
    # Starting a new pattern for creating the client container.
    # Working towards a launch-script.
    # https://github.com/wfau/aglais/issues/894

    source "${HOME:?}/aglais.env"

    agcolour=green
    agproxymap=3000:3000

    clientname=ansibler-${agcolour}
    cloudname=iris-gaia-${agcolour}
    configname=zeppelin-26.43-spark-3.26.43

    podman run \
        --rm \
        --tty \
        --interactive \
        --name     "${clientname:?}" \
        --hostname "${clientname:?}" \
        --publish  "${agproxymap:?}" \
        --env "cloudname=${cloudname:?}" \
        --env "configname=${configname:?}" \
        --env "SSH_AUTH_SOCK=/mnt/ssh_auth_sock" \
        --volume "${SSH_AUTH_SOCK:?}:/mnt/ssh_auth_sock:rw,z" \
        --volume "${HOME:?}/clouds.yaml:/etc/openstack/clouds.yaml:ro,z" \
        --volume "${AGLAIS_CODE:?}/deployments:/deployments:ro,z" \
        ghcr.io/wfau/atolmis/ansible-client:2022.07.25 \
        bash


# -----------------------------------------------------
# Deploy everything.
#[root@ansibler]

    time \
        source /deployments/hadoop-yarn/bin/deploy.sh

    >   aglais:
    >     status:
    >       deployment:
    >         type: hadoop-yarn
    >         conf: zeppelin-26.43-spark-3.26.43
    >         name: iris-gaia-green-20220727
    >         date: 20220727T140701
    >         hostname: zeppelin.gaia-dmp.uk
    >     spec:
    >       openstack:
    >         cloud:
    >           base: arcus
    >           name: iris-gaia-green

    >   real    42m56.844s
    >   user    13m26.744s
    >   sys     2m47.610s


# -----------------------------------------------------
# Import our live users.
#[root@ansibler]

    source /deployments/zeppelin/bin/create-user-tools.sh

    import-live-users

    >   ....
    >   ....


    list-linux-info \
        /tmp/live-users.json

    >   [
    >     {
    >       "username": "DCrake",
    >       "homedir": "/home/DCrake",
    >       "linuxuid": "10001",
    >       "pkeyhash": "3a2afa4552c09330033182326a1e6fe5"
    >     },
    >     {
    >       "username": "NHambly",
    >       "homedir": "/home/NHambly",
    >       "linuxuid": "10002",
    >       "pkeyhash": "f83ced7b4be2bc239a537c92fdb531ce"
    >     },
    >     {
    >       "username": "SVoutsinas",
    >       "homedir": "/home/SVoutsinas",
    >       "linuxuid": "10003",
    >       "pkeyhash": "2b8cf5d662453b38de9c345cb5faef8f"
    >     },
    >     {
    >       "username": "DMorris",
    >       "homedir": "/home/DMorris",
    >       "linuxuid": "10004",
    >       "pkeyhash": "7763ae76c0d07f278465ad0a2162a492"
    >     },
    >     {
    >       "username": "MSemczuk",
    >       "homedir": "/home/MSemczuk",
    >       "linuxuid": "10005",
    >       "pkeyhash": "68b329da9893e34099c7d8ad5cb9c940"
    >     },
    >     {
    >       "username": "SGoughKelly",
    >       "homedir": "/home/SGoughKelly",
    >       "linuxuid": "10006",
    >       "pkeyhash": "68b329da9893e34099c7d8ad5cb9c940"
    >     }
    >   ]


    list-shiro-info \
        /tmp/live-users.json

    >   [
    >     {
    >       "username": "DCrake",
    >       "password": "quotable ragweed motto maturing",
    >       "hashhash": "b6c983b72f40f84d2724cfd479f0d667"
    >     },
    >     {
    >       "username": "NHambly",
    >       "password": "sanction backhand democrat backyard",
    >       "hashhash": "7211571860c377e3fbe64f444f5aeb06"
    >     },
    >     {
    >       "username": "SVoutsinas",
    >       "password": "",
    >       "hashhash": "71e07a92016b3cee2fc56b38efaf2ab6"
    >     },
    >     {
    >       "username": "DMorris",
    >       "password": "",
    >       "hashhash": "99106f7237588b98e844d7de497956f4"
    >     },
    >     {
    >       "username": "MSemczuk",
    >       "password": "",
    >       "hashhash": "e192adcffc8436bf403bc79b8e48723e"
    >     },
    >     {
    >       "username": "SGoughKelly",
    >       "password": "",
    >       "hashhash": "0031d1bfe25fb2262eaf0c4f82499101"
    >     }
    >   ]


    list-ceph-info \
        /tmp/live-users.json

    >   [
    >     {
    >       "username": "DCrake",
    >       "usershare": {
    >         "name": "aglais-user-dcr",
    >         "size": 1024,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       },
    >       "homeshare": {
    >         "name": "iris-gaia-data-home-DCrake",
    >         "size": 1,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       }
    >     },
    >     {
    >       "username": "NHambly",
    >       "usershare": {
    >         "name": "aglais-user-nch",
    >         "size": 50000,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       },
    >       "homeshare": {
    >         "name": "iris-gaia-data-home-NHambly",
    >         "size": 1,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       }
    >     },
    >     {
    >       "username": "SVoutsinas",
    >       "usershare": {
    >         "name": "aglais-user-stv",
    >         "size": 1024,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       },
    >       "homeshare": {
    >         "name": "iris-gaia-data-home-SVoutsinas",
    >         "size": 1,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       }
    >     },
    >     {
    >       "username": "DMorris",
    >       "usershare": {
    >         "name": "aglais-user-zrq",
    >         "size": 1025,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       },
    >       "homeshare": {
    >         "name": "iris-gaia-data-home-DMorris",
    >         "size": 1,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       }
    >     },
    >     {
    >       "username": "MSemczuk",
    >       "usershare": {
    >         "name": "iris-gaia-data-user-MSemczuk",
    >         "size": 10,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       },
    >       "homeshare": {
    >         "name": "iris-gaia-data-home-MSemczuk",
    >         "size": 1,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       }
    >     },
    >     {
    >       "username": "SGoughKelly",
    >       "usershare": {
    >         "name": "iris-gaia-data-user-SGoughKelly",
    >         "size": 10,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       },
    >       "homeshare": {
    >         "name": "iris-gaia-data-home-SGoughKelly",
    >         "size": 1,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       }
    >     }
    >   ]


# -----------------------------------------------------
# Check our local deployment status is saved in the right location.
# https://github.com/wfau/aglais/issues/857
#[root@ansibler]

    cat /opt/aglais/aglais-status.yml

    >   aglais:
    >     status:
    >       deployment:
    >         type: hadoop-yarn
    >         conf: zeppelin-26.43-spark-3.26.43
    >         name: iris-gaia-green-20220727
    >         date: 20220727T140701
    >         hostname: zeppelin.gaia-dmp.uk
    >     spec:
    >       openstack:
    >         cloud:
    >           base: arcus
    >           name: iris-gaia-green


# -----------------------------------------------------
# Check the deployment status is saved on the zeppelin node.
# https://github.com/wfau/aglais/issues/478
#[root@ansibler]

    ssh zeppelin \
        '
        date
        hostname
        echo
        cat /opt/aglais/aglais-status.yml
        '

    >   Wed Jul 27 15:56:27 UTC 2022
    >   iris-gaia-green-20220727-zeppelin

    >   aglais:
    >     status:
    >       deployment:
    >         type: hadoop-yarn
    >         conf: zeppelin-26.43-spark-3.26.43
    >         name: iris-gaia-green-20220727
    >         date: 20220727T140701
    >         hostname: zeppelin.gaia-dmp.uk
    >     spec:
    >       openstack:
    >         cloud:
    >           base: arcus
    >           name: iris-gaia-green


# -----------------------------------------------------
# Check we can ssh into our live account.
# This checks that the ssh key has been loaded correctly.
# https://github.com/wfau/aglais/issues/871
#[root@ansibler]

    ssh DMorris@zeppelin \
            '
            date
            hostname
            id
            '

    >   Wed Jul 27 15:56:55 UTC 2022
    >   iris-gaia-green-20220727-zeppelin
    >   uid=10004(DMorris) gid=10004(DMorris) groups=10004(DMorris),100(users),1001(zeppelinusers) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023


# -----------------------------------------------------
# Check the size of our live user's Ceph shares.
#[root@ansibler]

    source /deployments/zeppelin/bin/create-user-tools.sh

    list-ceph-info \
        /tmp/live-users.json \
    | jq '[
        .[] | {name: .username, size: .usershare.size}
        ]'

    >   [
    >     {
    >       "name": "DCrake",
    >       "size": 1024
    >     },
    >     {
    >       "name": "NHambly",
    >       "size": 50000
    >     },
    >     {
    >       "name": "SVoutsinas",
    >       "size": 1024
    >     },
    >     {
    >       "name": "DMorris",
    >       "size": 1025
    >     },
    >     {
    >       "name": "MSemczuk",
    >       "size": 10
    >     },
    >     {
    >       "name": "SGoughKelly",
    >       "size": 10
    >     }
    >   ]


# -----------------------------------------------------
# Check the contents of our home directory.
#[root@ansibler]

    for username in $(
        jq -r '.users[] | .username' /tmp/live-users.json
        )
    do
        echo
        echo "User [${username}]"
        ssh zeppelin \
            "
            sudo ls -al '/home/${username}'
            "
    done

    >   User [DCrake]
    >   total 4
    >   drwxr-x---. 3 DCrake DCrake    1 Jul 27 13:25 .
    >   drwxr-xr-x. 9 root   root   4096 Jul 27 14:55 ..
    >   drwx------. 2 DCrake DCrake    1 Jul 27 14:52 .ssh

    >   User [NHambly]
    >   total 4
    >   drwxr-x---. 3 NHambly NHambly    1 Jul 27 13:26 .
    >   drwxr-xr-x. 9 root    root    4096 Jul 27 14:55 ..
    >   drwx------. 2 NHambly NHambly    1 Jul 27 14:53 .ssh

    >   User [SVoutsinas]
    >   total 4
    >   drwxr-x---. 3 SVoutsinas SVoutsinas    1 Jul 22 15:40 .
    >   drwxr-xr-x. 9 root       root       4096 Jul 27 14:55 ..
    >   drwx------. 2 SVoutsinas SVoutsinas    1 Jul 27 14:53 .ssh

    >   User [DMorris]
    >   total 5
    >   drwxr-x---. 6 DMorris DMorris    6 Jul 26 15:38 .
    >   drwxr-xr-x. 9 root    root    4096 Jul 27 14:55 ..
    >   -rw-------. 1 DMorris DMorris    2 Jul 26 15:38 .bash_history
    >   drwxr-x---. 3 DMorris DMorris    1 Jul 25 01:29 .cache
    >   drwxr-x---. 3 DMorris DMorris    1 Jul 25 01:29 .config
    >   drwxr-x---. 5 DMorris DMorris    3 Jul 25 01:29 .ipython
    >   drwx------. 2 DMorris DMorris    1 Jul 27 14:54 .ssh
    >   -rwxr-x---. 1 DMorris DMorris   32 Jul 25 01:30 mydate.txt

    >   User [MSemczuk]
    >   total 4
    >   drwxr-x---. 3 MSemczuk MSemczuk    1 Jul 21 14:06 .
    >   drwxr-xr-x. 9 root     root     4096 Jul 27 14:55 ..
    >   drwx------. 2 MSemczuk MSemczuk    1 Jul 27 14:55 .ssh

    >   User [SGoughKelly]
    >   total 4
    >   drwxr-x---. 3 SGoughKelly SGoughKelly    1 Jul 26 12:07 .
    >   drwxr-xr-x. 9 root        root        4096 Jul 27 14:55 ..
    >   drwx------. 2 SGoughKelly SGoughKelly    1 Jul 27 14:56 .ssh

    #
    # Need to add the skeleton files for everyone apart from me.
    #

    for username in $(
        jq -r '.users[] | .username' /tmp/live-users.json
        )
    do
        echo
        echo "User [${username}]"
        ssh zeppelin \
            "
            sudo cp \
               --recursive   \
               --no-clobber  \
               --preserve    \
                 /etc/skel/. \
                 /home/${username}

            sudo chown -R '${username}:${username}' '/home/${username}'
            sudo ls -al '/home/${username}'
            "
    done

    >   User [DCrake]
    >   total 6
    >   drwxr-xr-x. 3 DCrake DCrake    4 Oct 23  2019 .
    >   drwxr-xr-x. 9 root   root   4096 Jul 27 14:55 ..
    >   -rw-r--r--. 1 DCrake DCrake   18 Aug  5  2019 .bash_logout
    >   -rw-r--r--. 1 DCrake DCrake  141 Aug  5  2019 .bash_profile
    >   -rw-r--r--. 1 DCrake DCrake  376 Aug  5  2019 .bashrc
    >   drwx------. 2 DCrake DCrake    1 Jul 27 14:52 .ssh

    >   User [NHambly]
    >   total 6
    >   drwxr-xr-x. 3 NHambly NHambly    4 Oct 23  2019 .
    >   drwxr-xr-x. 9 root    root    4096 Jul 27 14:55 ..
    >   -rw-r--r--. 1 NHambly NHambly   18 Aug  5  2019 .bash_logout
    >   -rw-r--r--. 1 NHambly NHambly  141 Aug  5  2019 .bash_profile
    >   -rw-r--r--. 1 NHambly NHambly  376 Aug  5  2019 .bashrc
    >   drwx------. 2 NHambly NHambly    1 Jul 27 14:53 .ssh

    >   User [SVoutsinas]
    >   total 6
    >   drwxr-xr-x. 3 SVoutsinas SVoutsinas    4 Oct 23  2019 .
    >   drwxr-xr-x. 9 root       root       4096 Jul 27 14:55 ..
    >   -rw-r--r--. 1 SVoutsinas SVoutsinas   18 Aug  5  2019 .bash_logout
    >   -rw-r--r--. 1 SVoutsinas SVoutsinas  141 Aug  5  2019 .bash_profile
    >   -rw-r--r--. 1 SVoutsinas SVoutsinas  376 Aug  5  2019 .bashrc
    >   drwx------. 2 SVoutsinas SVoutsinas    1 Jul 27 14:53 .ssh

    >   User [DMorris]
    >   total 7
    >   drwxr-xr-x. 6 DMorris DMorris    9 Oct 23  2019 .
    >   drwxr-xr-x. 9 root    root    4096 Jul 27 14:55 ..
    >   -rw-------. 1 DMorris DMorris    2 Jul 26 15:38 .bash_history
    >   -rw-r--r--. 1 DMorris DMorris   18 Aug  5  2019 .bash_logout
    >   -rw-r--r--. 1 DMorris DMorris  141 Aug  5  2019 .bash_profile
    >   -rw-r--r--. 1 DMorris DMorris  376 Aug  5  2019 .bashrc
    >   drwxr-x---. 3 DMorris DMorris    1 Jul 25 01:29 .cache
    >   drwxr-x---. 3 DMorris DMorris    1 Jul 25 01:29 .config
    >   drwxr-x---. 5 DMorris DMorris    3 Jul 25 01:29 .ipython
    >   drwx------. 2 DMorris DMorris    1 Jul 27 14:54 .ssh
    >   -rwxr-x---. 1 DMorris DMorris   32 Jul 25 01:30 mydate.txt

    >   User [MSemczuk]
    >   total 6
    >   drwxr-xr-x. 3 MSemczuk MSemczuk    4 Oct 23  2019 .
    >   drwxr-xr-x. 9 root     root     4096 Jul 27 14:55 ..
    >   -rw-r--r--. 1 MSemczuk MSemczuk   18 Aug  5  2019 .bash_logout
    >   -rw-r--r--. 1 MSemczuk MSemczuk  141 Aug  5  2019 .bash_profile
    >   -rw-r--r--. 1 MSemczuk MSemczuk  376 Aug  5  2019 .bashrc
    >   drwx------. 2 MSemczuk MSemczuk    1 Jul 27 14:55 .ssh

    >   User [SGoughKelly]
    >   total 6
    >   drwxr-xr-x. 3 SGoughKelly SGoughKelly    4 Oct 23  2019 .
    >   drwxr-xr-x. 9 root        root        4096 Jul 27 14:55 ..
    >   -rw-r--r--. 1 SGoughKelly SGoughKelly   18 Aug  5  2019 .bash_logout
    >   -rw-r--r--. 1 SGoughKelly SGoughKelly  141 Aug  5  2019 .bash_profile
    >   -rw-r--r--. 1 SGoughKelly SGoughKelly  376 Aug  5  2019 .bashrc
    >   drwx------. 2 SGoughKelly SGoughKelly    1 Jul 27 14:56 .ssh


# -----------------------------------------------------
# Check the installed notebooks
#[root@ansibler]

    ssh zeppelin \
            "
            date
            hostname

            echo
            ls -al '/home/fedora/zeppelin/notebook'
            "

    >   Wed Jul 27 16:14:29 UTC 2022
    >   iris-gaia-green-20220727-zeppelin

    >   total 64
    >   drwxrwxr-x.  5 fedora fedora         4096 Jul 27 14:46 .
    >   drwxr-x---. 14 fedora zeppelinusers  4096 Jul 27 14:46 ..
    >   drwxrwxr-x.  7 fedora fedora         4096 Jul 27 14:46 .git
    >   -rw-rw-r--.  1 fedora fedora            6 Jul 27 10:51 .gitignore
    >   -rw-rw-r--.  1 fedora fedora        35149 Jul 27 10:51 LICENSE
    >   drwxrwxr-x.  2 fedora fedora         4096 Jul 27 10:51 Public Examples
    >   -rw-rw-r--.  1 fedora fedora          145 Jul 27 10:51 README.md
    >   drwxrwxr-x.  4 fedora fedora         4096 Jul 27 14:53 Users
--END--


    ssh zeppelin \
            "
            date
            hostname

            pushd /home/fedora/zeppelin/notebook
                rm -rf .git
                rm .gitignore
                rm README.md
                rm -rf Users
                mv LICENSE 'Public Examples'
            popd
            "

    ssh zeppelin \
            "
            date
            hostname

            echo
            ls -al '/home/fedora/zeppelin/notebook'

            echo
            ls -al '/home/fedora/zeppelin/notebook/Public Examples'
            "

    >   Wed Jul 27 16:43:48 UTC 2022
    >   iris-gaia-green-20220727-zeppelin

    >   total 12
    >   drwxrwxr-x.  3 fedora fedora        4096 Jul 27 16:42 .
    >   drwxr-x---. 14 fedora zeppelinusers 4096 Jul 27 16:41 ..
    >   drwxrwxr-x.  2 fedora fedora        4096 Jul 27 16:42 Public Examples

    >   total 3344
    >   drwxrwxr-x. 2 fedora fedora   4096 Jul 27 16:42 .
    >   drwxrwxr-x. 3 fedora fedora   4096 Jul 27 16:42 ..
    >   -rw-rw-r--. 1 fedora fedora  75164 Jul 27 10:51 1. Start here_2GRTQZFUM.zpln
    >   -rw-rw-r--. 1 fedora fedora 107397 Jul 27 10:51 2. Data holdings_2GRA39HCN.zpln
    >   -rw-rw-r--. 1 fedora fedora 496194 Jul 27 10:51 3. Source counts over the sky_2GQ6WMH9W.zpln
    >   -rw-rw-r--. 1 fedora fedora 987763 Jul 27 10:51 4. Mean proper motions over the sky_2GSNYBDWB.zpln
    >   -rw-rw-r--. 1 fedora fedora 113652 Jul 27 10:51 5. Working with Gaia XP spectra_2H2YRJCKM.zpln
    >   -rw-rw-r--. 1 fedora fedora 436925 Jul 27 10:51 6. Working with cross-matched surveys_2GZME59KY.zpln
    >   -rw-rw-r--. 1 fedora fedora 827966 Jul 27 10:51 7. Good astrometric solutions via ML Random Forrest classifier_2GQDKZ59J.zpln
    >   -rw-rw-r--. 1 fedora fedora 315092 Jul 27 10:51 8. Tips and tricks_2GVXKC266.zpln
    >   -rw-rw-r--. 1 fedora fedora  35149 Jul 27 10:51 LICENSE


# -----------------------------------------------------
# Setup a SSH tunnel SOCKS proxy.
# https://unix.stackexchange.com/questions/34004/how-does-tcp-keepalive-work-in-ssh
# https://unix.stackexchange.com/a/34201
#[root@ansibler]

    ssh \
        -n \
        -f \
        -N \
        -D '*:3000' \
        -o ServerAliveInterval=10 \
        -o ServerAliveCountMax=12 \
        zeppelin


# -----------------------------------------------------
# -----------------------------------------------------
# Login and check the notebooks.
#[user@desktop]

    firefox 'http://zeppelin:8080/' &


    Fixes done:
    https://github.com/wfau/aglais/issues/914#issuecomment-1197064452

    Example 1. Start here
    * Fixed URLs to notebooks and markdown.

    Example 2. Data holdings
    * Updated the links to DR3 documentation - done
    * Left the SQL queries pointing to eDR3 because the neighbour tables are not in DR3 yet (#909 ).

    Example 3. Source counts over the sky
    * Added gaiadr3 prefix to the query
    * Changed the plot title to 'Gaia DR3 source counts ..'

    Example 4. Mean proper motions over the sky
    * Added gaiadr3 prefix to the query

    Example 5. Working with Gaia XP spectra
    * Added gaiadr3 prefix to the query
    * Changed save_path to output_path

    Example 6. Working with cross-matched surveys
    * no changes
    * no errors

    Example 7. Good astrometric solutions via ML Random Forrest classifier
    * Added gaiadr3 prefix to the query

    * Original from blue contained an Arrow conversion error.
    * Ran the notebook on new deploy and it cleared.
    ```
    /opt/spark/python/pyspark/sql/pandas/conversion.py:87: UserWarning: toPandas attempted Arrow optimization because 'spark.sql.execution.arrow.pyspark.enabled' is set to true; however, failed by the reason below:
      Unsupported type in conversion to Arrow: VectorUDT
    Attempting non-optimization as 'spark.sql.execution.arrow.pyspark.fallback.enabled' is set to true.
    ```

    Example 8. Tips and tricks
    * All good.


# -----------------------------------------------------
# -----------------------------------------------------
# Backup the notebooks from our deployment on green.
#[user@data]

    colour=green

    sshuser=fedora
    sshhost=${colour:?}.aglais.uk

    pushd /var/local/backups
        pushd notebooks

            datetime=$(date '+%Y%m%d-%H%M%S')
            backname="${datetime:?}-${colour:?}-notebooks"

            rsync \
                --perms \
                --times \
                --group \
                --owner \
                --stats \
                --progress \
                --human-readable \
                --checksum \
                --recursive \
                --rsync-path 'sudo rsync' \
                "${sshuser:?}@${sshhost:?}:/home/fedora/zeppelin/notebook/" \
                "${backname:?}"

            if [ -L latest ]
            then
                rm latest
            fi
            ln -s "${backname:?}" latest

            ls -al

        popd
    popd

    >   ....
    >   ....
    >   drwxrwxr-x.  3 fedora fedora 4096 Jul 27 16:42 20220727-181710-green-notebooks
    >   drwxrwxr-x.  4 fedora fedora 4096 Jul 27 11:14 20220727-new-start
    >   drwxrwxr-x.  6 fedora fedora 4096 Jul 27 10:43 attic
    >   lrwxrwxrwx.  1 fedora fedora   31 Jul 27 18:18 latest -> 20220727-181710-green-notebooks


# -----------------------------------------------------
# Add a fake password to all the users in live-users.yml.
#[root@ansibler]

    /deployments/common/users/live-users.yml

          ....
          ....

          - name: "DMorris"
            type: "live"
            linuxuid: 10004
       +    password: "super secret"
            publickey: "file:///deployments/common/ssh/keys/dmr.roe.ac.uk.rsa.pub"

          ....
          ....

    #
    # This will create a new Shiro passhash, enabling the create-user sript to login and create notebook clones.
    #

# -----------------------------------------------------
# Re-deploy everything.
#[root@ansibler]

    time \
        source /deployments/hadoop-yarn/bin/deploy.sh

    >   aglais:
    >     status:
    >       deployment:
    >         type: hadoop-yarn
    >         conf: zeppelin-26.43-spark-3.26.43
    >         name: iris-gaia-green-20220727
    >         date: 20220727T182521
    >         hostname: zeppelin.gaia-dmp.uk
    >     spec:
    >       openstack:
    >         cloud:
    >           base: arcus
    >           name: iris-gaia-green

    >   real	23m53.734s
    >   user	8m26.379s
    >   sys	1m38.658s

    #
    # This will pull a copy of the editied notebooks from the data node
    # and created a clone for each of our users.
    #

# -----------------------------------------------------
# Check everything attived in the right place.
#[root@ansibler]

    # Check fstab
    ssh zeppelin \
        '
        date
        hostname
        echo
        cat /etc/fstab
        '

    >   ....
    >   ....
    >   UUID=b1438b9b-2cab-4065-a99a-08a96687f73c /                       ext4    defaults        1 1
    >   /dev/vdb	/mnt	auto	defaults,nofail,comment=cloudconfig	0	2

    #
    # Data shares not mounted :-(
    # Cinder vilumes not mounted :-(
    #
    # Check ther deploy log ..

    >   ....
    >   TASK [Check btrfs tools are installed] *****************************************
    >   fatal: [zeppelin]: FAILED! => {"changed": false, "msg": "Failed to download packages: Curl error (16): Error in the HTTP2 framing layer for https://mirrors.fedoraproject.org/metalink?repo=fedora-31&arch=x86_64 []", "results": []}
    >   ....

    #
    # A dnf call failed on zeppelin. The build continued for the workers,
    # but nothing more happens on the zeppelin node.
    #


# -----------------------------------------------------
# Re-deploy everything.
#[root@ansibler]

    time \
        source /deployments/hadoop-yarn/bin/deploy.sh

    >   aglais:
    >     status:
    >       deployment:
    >         type: hadoop-yarn
    >         conf: zeppelin-26.43-spark-3.26.43
    >         name: iris-gaia-green-20220728
    >         date: 20220728T034829
    >         hostname: zeppelin.gaia-dmp.uk
    >     spec:
    >       openstack:
    >         cloud:
    >           base: arcus
    >           name: iris-gaia-green
    >
real    32m17.566s
user    10m46.422s
sys     2m21.257s
--END--


# -----------------------------------------------------
# Check fstab on the zeppelin node.
#[root@ansibler]

    # Check fstab
    ssh zeppelin \
        '
        date
        hostname
        echo
        cat /etc/fstab
        '

    >   UUID=b1438b9b-2cab-4065-a99a-08a96687f73c   /   ext4    defaults    1 1
    >   /dev/vdb    /mnt            auto    defaults,nofail,comment=cloudconfig	0	2
    >   /dev/vdb    /mnt/local/vdb  ext4    defaults    0 0
    >   /dev/vdc    /mnt/cinder/vdc btrfs   defaults    0 0
    >   10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/5e74d2f7-dba9-40aa-ab90-526c8d0d58e5 /data/gaia/GEDR3_2048  ceph name=aglais-data-gaia-edr3-2048-ro,async,auto,nodev,noexec,nosuid,_netdev,ro   0 0
    >   10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/8fb1b4af-3b70-4343-8e8c-fa6b802047c2 /data/gaia/GDR3_2048   ceph name=aglais-data-gaia-dr3-2048-ro,async,auto,nodev,noexec,nosuid,_netdev,ro    0 0
    >   10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/c5b0aa15-6afa-4f73-a6b2-d5e94fed1b1b /data/wise/ALLWISE     ceph name=aglais-data-wise-allwise-ro,async,auto,nodev,noexec,nosuid,_netdev,ro     0 0
    >   10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/7bf5fe90-7902-4bed-92d9-c798866bb417 /data/panstarrs/PS1    ceph name=aglais-data-panstarrs-ps1-ro,async,auto,nodev,noexec,nosuid,_netdev,ro    0 0
    >   10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/3d98f750-5bb8-4e4c-ba95-2b38c0f0ffd5 /data/twomass/2MASSPSC ceph name=aglais-data-twomass-allsky-ro,async,auto,nodev,noexec,nosuid,_netdev,ro   0 0


# -----------------------------------------------------
# Manually delete all the home shares from our data node.
# (*) this seems the best way to make everything consistent.
#[root@ansibler]

    source /deployments/openstack/bin/settings.sh

    datacloud=iris-gaia-data

    openstack \
        --os-cloud "${datacloud}" \
        share list

    >   +--------------------------------------+---------------------------------+-------+-------------+-----------+-----------+-----------------+------+-------------------+
    >   | ID                                   | Name                            |  Size | Share Proto | Status    | Is Public | Share Type Name | Host | Availability Zone |
    >   +--------------------------------------+---------------------------------+-------+-------------+-----------+-----------+-----------------+------+-------------------+
    >   | 1e1ed68a-e5fe-47a3-a663-7096231a9324 | aglais-data-gaia-dr2-6514       |   512 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | c3c83cf6-5897-4194-b150-a29e83022a13 | aglais-data-gaia-dr3-2048       |  4196 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 5b1ff330-22f6-4bc7-bc03-529a55726c72 | aglais-data-gaia-edr3-11932     |   540 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 298ad303-9d81-4540-b4f0-d099ade46be2 | aglais-data-gaia-edr3-2048      |  1024 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 8ff99245-70fe-4c44-9c61-4979c10e7d06 | aglais-data-gaia-edr3-4096      |  1024 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 2ec7b3d6-8d70-44a0-9424-9d869f18c0f0 | aglais-data-gaia-edr3-8192      |  1024 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | d07a403d-12aa-4b72-9a2e-9136d29721fb | aglais-data-panstarrs-ps1       |   300 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 9faa8e39-ba47-474f-8abd-d6303fb9436e | aglais-data-twomass-allsky      |    40 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 417fb77f-5659-46e3-a074-7c1d7c18a0fe | aglais-data-wise-allwise        |   350 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 79574044-f43f-4992-b953-365fabd4b142 | aglais-tools                    |  1024 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | e3ad95b3-6d7e-484b-8cbc-2e3e521683bf | aglais-user-dcr                 |  1024 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 2f6ef970-27d1-47a1-b7a5-3ac7a9027f21 | aglais-user-nch                 | 50000 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | e4a87621-2e57-4a38-a7fb-283d0731572e | aglais-user-stv                 |  1024 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 493b34ad-cbec-42ca-9308-36bc09b79528 | aglais-user-zrq                 |  1025 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | bc7d4eaa-a90d-4c11-ad3a-1d336bf8c2a8 | iris-gaia-data-home-DCrake      |     1 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 6c39af37-df94-4d75-92ee-05c607da8e3b | iris-gaia-data-home-DMorris     |     1 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 611dffb4-4462-4292-8c6c-7ed4fc4d0e09 | iris-gaia-data-home-DaveMorris  |     1 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 89626586-0237-46bd-8cff-33ae7ce70475 | iris-gaia-data-home-MSemczuk    |     1 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 50be6063-83d6-4596-85b1-ee3a01bb108e | iris-gaia-data-home-NHambly     |     1 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 112f62d0-7007-4f2a-916a-6563383a9a16 | iris-gaia-data-home-SGoughKelly |     1 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | b7a44891-536f-4895-8cef-cf4ffc4bc7ec | iris-gaia-data-home-SVoutsinas  |     1 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | c83c6dea-66a6-4514-82d3-4f86ae29bc3b | iris-gaia-data-home-dcr         |     1 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 662a396b-2702-4aac-9c15-161ad4500b20 | iris-gaia-data-home-nch         |     1 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 3888f48a-5ac1-4717-a32f-025169a109a5 | iris-gaia-data-home-stv         |     1 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 81b82b8c-6453-4e66-8d2e-e6def1a25d90 | iris-gaia-data-home-test-001    |     1 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 480d1014-4df2-4f86-824a-e963dbe48822 | iris-gaia-data-home-test-002    |    10 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | b01c6e61-935f-420d-8d9a-5a73f5399fd5 | iris-gaia-data-user-MSemczuk    |    10 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 9ab1e400-1d13-4969-978c-ac4cd67ebb58 | iris-gaia-data-user-SGoughKelly |    10 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 2a46c6e9-61f7-41f4-801e-46021099cb80 | iris-gaia-data-user-test-001    |     1 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 8f421345-f356-4c2f-b668-7403096333ce | iris-gaia-data-user-test-002    |     1 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   +--------------------------------------+---------------------------------+-------+-------------+-----------+-----------+-----------------+------+-------------------+

    #
    # We want to delete the generated home directories.
    # These have been generated by the create-uset tools at different stages of development.
    # They have never been used by a real user, so the data in them is disposable.
    #

    >   +--------------------------------------+---------------------------------+
    >   | bc7d4eaa-a90d-4c11-ad3a-1d336bf8c2a8 | iris-gaia-data-home-DCrake      |
    >   | 6c39af37-df94-4d75-92ee-05c607da8e3b | iris-gaia-data-home-DMorris     |
    >   | 611dffb4-4462-4292-8c6c-7ed4fc4d0e09 | iris-gaia-data-home-DaveMorris  |
    >   | 89626586-0237-46bd-8cff-33ae7ce70475 | iris-gaia-data-home-MSemczuk    |
    >   | 50be6063-83d6-4596-85b1-ee3a01bb108e | iris-gaia-data-home-NHambly     |
    >   | 112f62d0-7007-4f2a-916a-6563383a9a16 | iris-gaia-data-home-SGoughKelly |
    >   | b7a44891-536f-4895-8cef-cf4ffc4bc7ec | iris-gaia-data-home-SVoutsinas  |
    >   | c83c6dea-66a6-4514-82d3-4f86ae29bc3b | iris-gaia-data-home-dcr         |
    >   | 662a396b-2702-4aac-9c15-161ad4500b20 | iris-gaia-data-home-nch         |
    >   | 3888f48a-5ac1-4717-a32f-025169a109a5 | iris-gaia-data-home-stv         |
    >   +--------------------------------------+---------------------------------+

    # Delete the old home shares left over from development runs.
    sharenames=(
        iris-gaia-data-home-DaveMorris
        iris-gaia-data-home-dcr
        iris-gaia-data-home-nch
        iris-gaia-data-home-stv
        )

    for sharename in ${sharenames[@]}
    do
        echo
        echo "Share [${sharename}]"
        openstack \
            --os-cloud "${datacloud}" \
            share delete \
                "${sharename}"
    done

    # Delete the new home shares left over from development runs.
    sharenames=(
        iris-gaia-data-home-DCrake
        iris-gaia-data-home-DMorris
        iris-gaia-data-home-MSemczuk
        iris-gaia-data-home-NHambly
        iris-gaia-data-home-SGoughKelly
        iris-gaia-data-home-SVoutsinas
        )

    for sharename in ${sharenames[@]}
    do
        echo
        echo "Share [${sharename}]"
        openstack \
            --os-cloud "${datacloud}" \
            share delete \
                "${sharename}"
    done


    #
    # The science data shares stay.
    #

    >   +--------------------------------------+---------------------------------+
    >   | 1e1ed68a-e5fe-47a3-a663-7096231a9324 | aglais-data-gaia-dr2-6514       |
    >   | c3c83cf6-5897-4194-b150-a29e83022a13 | aglais-data-gaia-dr3-2048       |
    >   | 5b1ff330-22f6-4bc7-bc03-529a55726c72 | aglais-data-gaia-edr3-11932     |
    >   | 298ad303-9d81-4540-b4f0-d099ade46be2 | aglais-data-gaia-edr3-2048      |
    >   | 8ff99245-70fe-4c44-9c61-4979c10e7d06 | aglais-data-gaia-edr3-4096      |
    >   | 2ec7b3d6-8d70-44a0-9424-9d869f18c0f0 | aglais-data-gaia-edr3-8192      |
    >   | d07a403d-12aa-4b72-9a2e-9136d29721fb | aglais-data-panstarrs-ps1       |
    >   | 9faa8e39-ba47-474f-8abd-d6303fb9436e | aglais-data-twomass-allsky      |
    >   | 417fb77f-5659-46e3-a074-7c1d7c18a0fe | aglais-data-wise-allwise        |
    >   +--------------------------------------+---------------------------------+

    #
    # The original data shares stay.
    #

    >   +--------------------------------------+---------------------------------+
    >   | e3ad95b3-6d7e-484b-8cbc-2e3e521683bf | aglais-user-dcr                 |
    >   | 2f6ef970-27d1-47a1-b7a5-3ac7a9027f21 | aglais-user-nch                 |
    >   | e4a87621-2e57-4a38-a7fb-283d0731572e | aglais-user-stv                 |
    >   | 493b34ad-cbec-42ca-9308-36bc09b79528 | aglais-user-zrq                 |
    >   +--------------------------------------+---------------------------------+

    #
    # The aglais-tools share contains the svn code for GaiaXPy.
    # Now we have moved GaiaXPy to a pip install, this is no longer needed.
    #
    # We can delete it, but later.
    # https://github.com/wfau/aglais/issues/825#issuecomment-1178440813
    #

    >   +--------------------------------------+---------------------------------+
    >   | 79574044-f43f-4992-b953-365fabd4b142 | aglais-tools                    |
    >   +--------------------------------------+---------------------------------+

    #
    # We can also delete the test shares.
    # We don't know their prevenance so might as well create new ones when we need them.
    #

    >   +--------------------------------------+---------------------------------+
    >   | 81b82b8c-6453-4e66-8d2e-e6def1a25d90 | iris-gaia-data-home-test-001    |
    >   | 480d1014-4df2-4f86-824a-e963dbe48822 | iris-gaia-data-home-test-002    |
    >
    >   | 2a46c6e9-61f7-41f4-801e-46021099cb80 | iris-gaia-data-user-test-001    |
    >   | 8f421345-f356-4c2f-b668-7403096333ce | iris-gaia-data-user-test-002    |
    >   +--------------------------------------+---------------------------------+

    sharenames=(
        iris-gaia-data-home-test-001
        iris-gaia-data-home-test-002
        iris-gaia-data-user-test-001
        iris-gaia-data-user-test-002
        )

    for sharename in ${sharenames[@]}
    do
        echo
        echo "Share [${sharename}]"
        openstack \
            --os-cloud "${datacloud}" \
            share delete \
                "${sharename}"
    done

    #
    # We can also delete the unused user shares.
    # The create-user tools will create new ones.
    #

    sharenames=(
        iris-gaia-data-user-MSemczuk
        iris-gaia-data-user-SGoughKelly
        )

    for sharename in ${sharenames[@]}
    do
        echo
        echo "Share [${sharename}]"
        openstack \
            --os-cloud "${datacloud}" \
            share delete \
                "${sharename}"
    done


    #
    # The remaining shares we want to keep.
    #

    openstack \
        --os-cloud "${datacloud}" \
        share list

    >   +--------------------------------------+-----------------------------+-------+-------------+-----------+-----------+-----------------+------+-------------------+
    >   | ID                                   | Name                        |  Size | Share Proto | Status    | Is Public | Share Type Name | Host | Availability Zone |
    >   +--------------------------------------+-----------------------------+-------+-------------+-----------+-----------+-----------------+------+-------------------+
    >   | 1e1ed68a-e5fe-47a3-a663-7096231a9324 | aglais-data-gaia-dr2-6514   |   512 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | c3c83cf6-5897-4194-b150-a29e83022a13 | aglais-data-gaia-dr3-2048   |  4196 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 5b1ff330-22f6-4bc7-bc03-529a55726c72 | aglais-data-gaia-edr3-11932 |   540 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 298ad303-9d81-4540-b4f0-d099ade46be2 | aglais-data-gaia-edr3-2048  |  1024 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 8ff99245-70fe-4c44-9c61-4979c10e7d06 | aglais-data-gaia-edr3-4096  |  1024 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 2ec7b3d6-8d70-44a0-9424-9d869f18c0f0 | aglais-data-gaia-edr3-8192  |  1024 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | d07a403d-12aa-4b72-9a2e-9136d29721fb | aglais-data-panstarrs-ps1   |   300 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 9faa8e39-ba47-474f-8abd-d6303fb9436e | aglais-data-twomass-allsky  |    40 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 417fb77f-5659-46e3-a074-7c1d7c18a0fe | aglais-data-wise-allwise    |   350 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 79574044-f43f-4992-b953-365fabd4b142 | aglais-tools                |  1024 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | e3ad95b3-6d7e-484b-8cbc-2e3e521683bf | aglais-user-dcr             |  1024 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 2f6ef970-27d1-47a1-b7a5-3ac7a9027f21 | aglais-user-nch             | 50000 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | e4a87621-2e57-4a38-a7fb-283d0731572e | aglais-user-stv             |  1024 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 493b34ad-cbec-42ca-9308-36bc09b79528 | aglais-user-zrq             |  1025 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   +--------------------------------------+-----------------------------+-------+-------------+-----------+-----------+-----------------+------+-------------------+


# -----------------------------------------------------
# At this point we do another re-deploy .. because history.
# (*) technically, I messed up the create-users by Ctrl-C ing and starting again.
# It had already created one of the shares, which then didn't get initialised and .... messy.
# Best way to be sure is nuke it from orbit.
#[root@ansibler]

    time \
        source /deployments/hadoop-yarn/bin/deploy.sh

    >   aglais:
    >     status:
    >       deployment:
    >         type: hadoop-yarn
    >         conf: zeppelin-26.43-spark-3.26.43
    >         name: iris-gaia-green-20220728
    >         date: 20220728T055409
    >         hostname: zeppelin.gaia-dmp.uk
    >     spec:
    >       openstack:
    >         cloud:
    >           base: arcus
    >           name: iris-gaia-green

    >   real    32m18.444s
    >   user    11m35.507s
    >   sys     2m34.110s


# -----------------------------------------------------
# Import our live accounts (with fake password).
#[root@ansibler]

    source /deployments/zeppelin/bin/create-user-tools.sh

    import-live-users

    list-linux-info \
        /tmp/live-users.json

    >   [
    >     {
    >       "username": "DCrake",
    >       "homedir": "/home/DCrake",
    >       "linuxuid": "10001",
    >       "pkeyhash": "3a2afa4552c09330033182326a1e6fe5"
    >     },
    >     {
    >       "username": "NHambly",
    >       "homedir": "/home/NHambly",
    >       "linuxuid": "10002",
    >       "pkeyhash": "f83ced7b4be2bc239a537c92fdb531ce"
    >     },
    >     {
    >       "username": "SVoutsinas",
    >       "homedir": "/home/SVoutsinas",
    >       "linuxuid": "10003",
    >       "pkeyhash": "2b8cf5d662453b38de9c345cb5faef8f"
    >     },
    >     {
    >       "username": "DMorris",
    >       "homedir": "/home/DMorris",
    >       "linuxuid": "10004",
    >       "pkeyhash": "7763ae76c0d07f278465ad0a2162a492"
    >     },
    >     {
    >       "username": "MSemczuk",
    >       "homedir": "/home/MSemczuk",
    >       "linuxuid": "10005",
    >       "pkeyhash": "68b329da9893e34099c7d8ad5cb9c940"
    >     },
    >     {
    >       "username": "SGoughKelly",
    >       "homedir": "/home/SGoughKelly",
    >       "linuxuid": "10006",
    >       "pkeyhash": "68b329da9893e34099c7d8ad5cb9c940"
    >     }
    >   ]


    list-shiro-info \
        /tmp/live-users.json

    >   [
    >     {
    >       "username": "DCrake",
    >       "password": "super secret",
    >       "hashhash": "bd953dd23c647573a3e62fc908729c9b"
    >     },
    >     {
    >       "username": "NHambly",
    >       "password": "super secret",
    >       "hashhash": "657dc7fd4dcfbf5d20e90114b4b1a18e"
    >     },
    >     {
    >       "username": "SVoutsinas",
    >       "password": "super secret",
    >       "hashhash": "4002fbeb02b74883529b56f0992a96de"
    >     },
    >     {
    >       "username": "DMorris",
    >       "password": "super secret",
    >       "hashhash": "291564e5d584e93776c7440753842b58"
    >     },
    >     {
    >       "username": "MSemczuk",
    >       "password": "super secret",
    >       "hashhash": "63f24fb93a21d1e8c6050fbcbad48297"
    >     },
    >     {
    >       "username": "SGoughKelly",
    >       "password": "super secret",
    >       "hashhash": "825f32f4de0769e8dba3600581224db3"
    >     }
    >   ]


    list-ceph-info \
        /tmp/live-users.json

    >   [
    >     {
    >       "username": "DCrake",
    >       "usershare": {
    >         "name": "aglais-user-dcr",
    >         "size": 1024,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       },
    >       "homeshare": {
    >         "name": "iris-gaia-data-home-DCrake",
    >         "size": 1,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       }
    >     },
    >     {
    >       "username": "NHambly",
    >       "usershare": {
    >         "name": "aglais-user-nch",
    >         "size": 50000,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       },
    >       "homeshare": {
    >         "name": "iris-gaia-data-home-NHambly",
    >         "size": 1,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       }
    >     },
    >     {
    >       "username": "SVoutsinas",
    >       "usershare": {
    >         "name": "aglais-user-stv",
    >         "size": 1024,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       },
    >       "homeshare": {
    >         "name": "iris-gaia-data-home-SVoutsinas",
    >         "size": 1,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       }
    >     },
    >     {
    >       "username": "DMorris",
    >       "usershare": {
    >         "name": "aglais-user-zrq",
    >         "size": 1025,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       },
    >       "homeshare": {
    >         "name": "iris-gaia-data-home-DMorris",
    >         "size": 1,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       }
    >     },
    >     {
    >       "username": "MSemczuk",
    >       "usershare": {
    >         "name": "iris-gaia-data-user-MSemczuk",
    >         "size": 10,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       },
    >       "homeshare": {
    >         "name": "iris-gaia-data-home-MSemczuk",
    >         "size": 1,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       }
    >     },
    >     {
    >       "username": "SGoughKelly",
    >       "usershare": {
    >         "name": "iris-gaia-data-user-SGoughKelly",
    >         "size": 10,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       },
    >       "homeshare": {
    >         "name": "iris-gaia-data-home-SGoughKelly",
    >         "size": 1,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       }
    >     }
    >   ]


    #
    # List the shares
    openstack \
        --os-cloud "${datacloud}" \
        share list

    >   +--------------------------------------+---------------------------------+-------+-------------+-----------+-----------+-----------------+------+-------------------+
    >   | ID                                   | Name                            |  Size | Share Proto | Status    | Is Public | Share Type Name | Host | Availability Zone |
    >   +--------------------------------------+---------------------------------+-------+-------------+-----------+-----------+-----------------+------+-------------------+
    >   | 1e1ed68a-e5fe-47a3-a663-7096231a9324 | aglais-data-gaia-dr2-6514       |   512 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | c3c83cf6-5897-4194-b150-a29e83022a13 | aglais-data-gaia-dr3-2048       |  4196 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 5b1ff330-22f6-4bc7-bc03-529a55726c72 | aglais-data-gaia-edr3-11932     |   540 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 298ad303-9d81-4540-b4f0-d099ade46be2 | aglais-data-gaia-edr3-2048      |  1024 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 8ff99245-70fe-4c44-9c61-4979c10e7d06 | aglais-data-gaia-edr3-4096      |  1024 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 2ec7b3d6-8d70-44a0-9424-9d869f18c0f0 | aglais-data-gaia-edr3-8192      |  1024 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | d07a403d-12aa-4b72-9a2e-9136d29721fb | aglais-data-panstarrs-ps1       |   300 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 9faa8e39-ba47-474f-8abd-d6303fb9436e | aglais-data-twomass-allsky      |    40 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 417fb77f-5659-46e3-a074-7c1d7c18a0fe | aglais-data-wise-allwise        |   350 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 79574044-f43f-4992-b953-365fabd4b142 | aglais-tools                    |  1024 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | e3ad95b3-6d7e-484b-8cbc-2e3e521683bf | aglais-user-dcr                 |  1024 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 2f6ef970-27d1-47a1-b7a5-3ac7a9027f21 | aglais-user-nch                 | 50000 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | e4a87621-2e57-4a38-a7fb-283d0731572e | aglais-user-stv                 |  1024 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 493b34ad-cbec-42ca-9308-36bc09b79528 | aglais-user-zrq                 |  1025 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 22dff9b5-2d91-44c1-a8e5-e3521692862c | iris-gaia-data-home-DCrake      |     1 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 55b28681-5efe-4c40-90a0-d3e408632fb7 | iris-gaia-data-home-DMorris     |     1 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | fd4269af-ddeb-4083-ba4e-a0d779a98ec2 | iris-gaia-data-home-MSemczuk    |     1 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 38cc5c54-7bd5-4322-9fdd-95ae3a9212af | iris-gaia-data-home-NHambly     |     1 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 48032a45-81ac-419e-b210-9cf8cf779098 | iris-gaia-data-home-SGoughKelly |     1 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 300e8348-a1bb-4cce-8037-7a086923ec14 | iris-gaia-data-home-SVoutsinas  |     1 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 3e797f3f-ef02-468a-b28b-a1a38f8dedc8 | iris-gaia-data-user-MSemczuk    |    10 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | c029a675-80b7-4866-9cbb-8d39595b98c2 | iris-gaia-data-user-SGoughKelly |    10 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   +--------------------------------------+---------------------------------+-------+-------------+-----------+-----------+-----------------+------+-------------------+


    # 6 new home shares
    >   +--------------------------------------+---------------------------------+-------+-------------+-----------+-----------+-----------------+------+-------------------+
    >   | 22dff9b5-2d91-44c1-a8e5-e3521692862c | iris-gaia-data-home-DCrake      |     1 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 55b28681-5efe-4c40-90a0-d3e408632fb7 | iris-gaia-data-home-DMorris     |     1 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | fd4269af-ddeb-4083-ba4e-a0d779a98ec2 | iris-gaia-data-home-MSemczuk    |     1 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 38cc5c54-7bd5-4322-9fdd-95ae3a9212af | iris-gaia-data-home-NHambly     |     1 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 48032a45-81ac-419e-b210-9cf8cf779098 | iris-gaia-data-home-SGoughKelly |     1 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | 300e8348-a1bb-4cce-8037-7a086923ec14 | iris-gaia-data-home-SVoutsinas  |     1 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   +--------------------------------------+---------------------------------+-------+-------------+-----------+-----------+-----------------+------+-------------------+

    # 2 new user shares
    >   +--------------------------------------+---------------------------------+-------+-------------+-----------+-----------+-----------------+------+-------------------+
    >   | 3e797f3f-ef02-468a-b28b-a1a38f8dedc8 | iris-gaia-data-user-MSemczuk    |    10 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   | c029a675-80b7-4866-9cbb-8d39595b98c2 | iris-gaia-data-user-SGoughKelly |    10 | CEPHFS      | available | True      | ceph01_cephfs   |      | nova              |
    >   +--------------------------------------+---------------------------------+-------+-------------+-----------+-----------+-----------------+------+-------------------+


# -----------------------------------------------------
# Check fstab on the zeppelin node.
#[root@ansibler]

    ssh zeppelin \
        '
        date
        hostname
        echo
        cat /etc/fstab
        '

    >       ssh zeppelin \
    >           '
    >           date
    >           hostname
    >           echo
    >           cat /etc/fstab
    >           '


# -----------------------------------------------------
# Check the contents of the home directories.
#[root@ansibler]

    for username in $(
        jq -r '.users[] | .username' /tmp/live-users.json
        )
    do
        echo
        echo "User [${username}]"
        ssh zeppelin \
            "
            sudo ls -al '/home/${username}'
            echo
            df -h '/home/${username}'
            "
    done

    >   User [DCrake]
    >   total 4
    >   drwxr-x---. 3 DCrake DCrake    1 Jul 28 06:24 .
    >   drwxr-xr-x. 9 root   root   4096 Jul 28 06:29 ..
    >   drwx------. 2 DCrake DCrake    1 Jul 28 06:24 .ssh
    >
    >   Filesystem                                                                                                Size  Used Avail Use% Mounted on
    >   10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/31dddc22-f414-4a7b-a741-b738503f8176  407T  119T  289T  30% /home/DCrake

    >   User [NHambly]
    >   total 4
    >   drwxr-x---. 3 NHambly NHambly    1 Jul 28 06:25 .
    >   drwxr-xr-x. 9 root    root    4096 Jul 28 06:29 ..
    >   drwx------. 2 NHambly NHambly    1 Jul 28 06:25 .ssh
    >
    >   Filesystem                                                                                                Size  Used Avail Use% Mounted on
    >   10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/502cb7c5-8831-46cf-83bf-ecf19e5a7688  407T  119T  289T  30% /home/NHambly

    >   User [SVoutsinas]
    >   total 4
    >   drwxr-x---. 3 SVoutsinas SVoutsinas    1 Jul 28 06:26 .
    >   drwxr-xr-x. 9 root       root       4096 Jul 28 06:29 ..
    >   drwx------. 2 SVoutsinas SVoutsinas    1 Jul 28 06:26 .ssh
    >
    >   Filesystem                                                                                                Size  Used Avail Use% Mounted on
    >   10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/ef48fddd-2c77-4557-820e-2fcfe1a511f2  407T  119T  289T  30% /home/SVoutsinas

    >   User [DMorris]
    >   total 4
    >   drwxr-x---. 3 DMorris DMorris    1 Jul 28 06:27 .
    >   drwxr-xr-x. 9 root    root    4096 Jul 28 06:29 ..
    >   drwx------. 2 DMorris DMorris    1 Jul 28 06:27 .ssh
    >
    >   Filesystem                                                                                                Size  Used Avail Use% Mounted on
    >   10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/48d2f333-28d6-4e5d-bee4-03634334185d  407T  119T  289T  30% /home/DMorris

    >   User [MSemczuk]
    >   total 4
    >   drwxr-x---. 3 MSemczuk MSemczuk    1 Jul 28 06:28 .
    >   drwxr-xr-x. 9 root     root     4096 Jul 28 06:29 ..
    >   drwx------. 2 MSemczuk MSemczuk    1 Jul 28 06:28 .ssh
    >
    >   Filesystem                                                                                                Size  Used Avail Use% Mounted on
    >   10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/e6d53112-2482-4159-b9bb-904239729977  407T  119T  289T  30% /home/MSemczuk

    >   User [SGoughKelly]
    >   total 4
    >   drwxr-x---. 3 SGoughKelly SGoughKelly    1 Jul 28 06:29 .
    >   drwxr-xr-x. 9 root        root        4096 Jul 28 06:29 ..
    >   drwx------. 2 SGoughKelly SGoughKelly    1 Jul 28 06:29 .ssh
    >
    >   Filesystem                                                                                                Size  Used Avail Use% Mounted on
    >   10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/9de8db30-3521-49c9-9bed-f9e49bd60f5b  407T  119T  289T  30% /home/SGoughKelly


# -----------------------------------------------------
# Check the contents of the data directories.
#[root@ansibler]

    for username in $(
        jq -r '.users[] | .username' /tmp/live-users.json
        )
    do
        echo
        echo "User [${username}]"
        ssh zeppelin \
            "
            sudo ls -al '/user/${username}'
            echo
            df -h '/user/${username}'
            "
    done

    >   User [DCrake]
    >   total 4
    >   drwxr-sr-x.  7 fedora users     5 Jan  4  2022 .
    >   drwxr-xr-x.  8 root   root   4096 Jul 28 06:29 ..
    >   drwxrwxr-x.  3 fedora fedora    1 Jul 16  2021 CNN
    >   drwxrwxr-x.  6 fedora fedora    4 Mar 17 13:31 HDBSCAN
    >   drwxrwxr-x. 14 fedora fedora   12 Sep 23  2021 ML_cuts
    >   drwxrwxr-x.  6 fedora fedora    4 Nov  8  2021 WD_detection
    >   drwxrwxr-x.  2 fedora fedora    2 Nov  3  2021 data
    >
    >   Filesystem                                                                                                Size  Used Avail Use% Mounted on
    >   10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/4603a9f6-24dd-4194-8a7a-7096d8502140  407T  119T  289T  30% /user/DCrake
    >
User [NHambly]
total 19844
drwxr-sr-x.  4 fedora users        10 Jul 14 19:12 .
drwxr-xr-x.  8 root   root       4096 Jul 28 06:29 ..
-rw-rw-r--.  1 fedora users     17545 Jul 14 19:12 2MASSJ00531123+6730023-GaiaXPSpectrum.csv
drwxrwxr-x. 11 fedora fedora       13 Jun 13 10:43 CSV
drwxrwxr-x.  3 fedora fedora        1 Jun 24 12:22 PARQUET
-rw-rw-r--.  1 fedora fedora 17538509 May 19 12:49 ScanDirectionStrengthsByHealpix.csv
-rw-r--r--.  1 fedora fedora   432547 Nov 19  2021 XP_CONTINUOUS_RAW.csv
-rw-r--r--.  1 fedora fedora    93811 Nov 22  2021 XP_SAMPLED_RAW.csv
-rw-rw-r--.  1 fedora fedora  2230799 Mar 11 16:48 source-counts-hpx7.asc
-rw-rw-r--.  1 fedora fedora        8 May 19 12:27 splunge.txt
-rw-rw-r--.  1 fedora users         5 Jun 10 11:27 test
-rw-rw-r--.  1 fedora fedora      401 Oct 30  2020 test.log

Filesystem                                                                                                Size  Used Avail Use% Mounted on
10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/ca9d0c81-f7a3-4e53-bea3-9a5725016dee  407T  119T  289T  30% /user/NHambly
    >
User [SVoutsinas]
total 4
drwxr-sr-x. 3 fedora users    1 Jul 28 07:36 .
drwxr-xr-x. 8 root   root  4096 Jul 28 06:29 ..
drwxrwsr-x. 3 fedora users    1 Jul 28 07:37 PARQUET

Filesystem                                                                                                Size  Used Avail Use% Mounted on
10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/ca2c6f07-4e1b-49c7-aeab-a01811e656fb  407T  119T  289T  30% /user/SVoutsinas
    >
User [DMorris]
total 54
drwxr-sr-x. 12 fedora users     14 Jul 27 03:17 .
drwxr-xr-x.  8 root   root    4096 Jul 28 06:29 ..
drwxr-xr-x.  2 fedora users    602 Jul 14 18:39 2MASSJ00531123+6730023-GaiaXPSpectrum.csv
-rw-rw-r--.  1 fedora fedora     0 Aug 26  2021 frog
-rw-rw-r--.  1 fedora fedora  4660 Aug 17  2021 index.html
drwxrwxr-x.  9 fedora fedora     7 Feb 22  2021 notebooks
drwxrwxr-x.  3 fedora fedora     2 Mar 14  2021 owncloud
-rw-rw-r--.  1 fedora fedora   158 Mar 14  2021 owncloud.env
drwxr-xr-x.  2 fedora users    402 Jul 27 01:18 proper-motion
drwxr-xr-x.  2 fedora users    402 Jul 26 23:15 proper-motions
drwxrwxr-x.  6 fedora fedora     4 May 10  2021 repartitioned
drwxr-xr-x.  2 fedora users    402 Jul 14 19:00 source-counts
drwxr-xr-x.  2 fedora users    402 Jul 27 03:19 source-counts-001
-rw-rw-r--.  1 fedora fedora 45209 Dec  6  2021 test.pdf
drwxrwxr-x.  2 fedora fedora     4 Mar 11  2021 transfer
drwxrwxr-x.  3 fedora fedora     1 Aug 26  2021 zeppelin

Filesystem                                                                                                Size  Used Avail Use% Mounted on
10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/0471daf5-5ba4-4fda-8b7c-2bfc7ebb4eff  407T  119T  289T  30% /user/DMorris
    >
User [MSemczuk]
total 4
drwxrwxrwx. 2 root root    0 Jul 28 06:28 .
drwxr-xr-x. 8 root root 4096 Jul 28 06:29 ..

Filesystem                                                                                                Size  Used Avail Use% Mounted on
10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/78b83763-2ce4-4e7d-9af1-1b4cb3e9931d  407T  119T  289T  30% /user/MSemczuk
    >
User [SGoughKelly]
total 4
drwxrwxrwx. 2 root root    0 Jul 28 06:29 .
drwxr-xr-x. 8 root root 4096 Jul 28 06:29 ..

Filesystem                                                                                                Size  Used Avail Use% Mounted on
10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/1c5257d4-177f-442b-a6e2-9d6d992b2488  407T  119T  289T  30% /user/SGoughKelly
--END--


# -----------------------------------------------------
# Check the notebook folders.
#[root@ansibler]

    for username in $(
        jq -r '.users[] | .username' /tmp/live-users.json
        )
    do
        echo
        echo "User [${username}]"
        ssh zeppelin \
            "
            sudo ls -al '/home/fedora/zeppelin/notebook/Users/${username}'
            echo
            sudo ls -al '/home/fedora/zeppelin/notebook/Users/${username}/examples'
            "
    done

    >   User [DCrake]
    >   total 12
    >   drwxrwxr-x. 3 fedora fedora 4096 Jul 28 06:24 .
    >   drwxrwxr-x. 8 fedora fedora 4096 Jul 28 06:29 ..
    >   drwxrwxr-x. 2 fedora fedora 4096 Jul 28 06:25 examples
    >
    >   total 3056
    >   drwxrwxr-x. 2 fedora fedora   4096 Jul 28 06:25 .
    >   drwxrwxr-x. 3 fedora fedora   4096 Jul 28 06:24 ..
    >   -rw-rw-r--. 1 fedora fedora  37262 Jul 28 06:24 1. Start here_2HAFVXM4K.zpln
    >   -rw-rw-r--. 1 fedora fedora 103785 Jul 28 06:24 2. Data holdings_2H8N6EFNW.zpln
    >   -rw-rw-r--. 1 fedora fedora 497439 Jul 28 06:24 3. Source counts over the sky_2HA4ZTV3B.zpln
    >   -rw-rw-r--. 1 fedora fedora 985423 Jul 28 06:25 4. Mean proper motions over the sky_2H92P1SVX.zpln
    >   -rw-rw-r--. 1 fedora fedora 111289 Jul 28 06:25 5. Working with Gaia XP spectra_2H9Z2M4AF.zpln
    >   -rw-rw-r--. 1 fedora fedora 434762 Jul 28 06:25 6. Working with cross-matched surveys_2H8EB178X.zpln
    >   -rw-rw-r--. 1 fedora fedora 820056 Jul 28 06:25 7. Good astrometric solutions via ML Random Forrest classifier_2H8YDP9SW.zpln
    >   -rw-rw-r--. 1 fedora fedora 110214 Jul 28 06:25 8. Tips and tricks_2HBY3DK8K.zpln

    >   User [NHambly]
    >   total 12
    >   drwxrwxr-x. 3 fedora fedora 4096 Jul 28 06:25 .
    >   drwxrwxr-x. 8 fedora fedora 4096 Jul 28 06:29 ..
    >   drwxrwxr-x. 2 fedora fedora 4096 Jul 28 06:26 examples
    >
    >   total 3056
    >   drwxrwxr-x. 2 fedora fedora   4096 Jul 28 06:26 .
    >   drwxrwxr-x. 3 fedora fedora   4096 Jul 28 06:25 ..
    >   -rw-rw-r--. 1 fedora fedora  37271 Jul 28 06:25 1. Start here_2H8TBJWCZ.zpln
    >   -rw-rw-r--. 1 fedora fedora 103793 Jul 28 06:25 2. Data holdings_2H8MV7Y6A.zpln
    >   -rw-rw-r--. 1 fedora fedora 497443 Jul 28 06:25 3. Source counts over the sky_2HBVG187W.zpln
    >   -rw-rw-r--. 1 fedora fedora 985431 Jul 28 06:25 4. Mean proper motions over the sky_2HC1T8BYD.zpln
    >   -rw-rw-r--. 1 fedora fedora 111295 Jul 28 06:25 5. Working with Gaia XP spectra_2H91BNN87.zpln
    >   -rw-rw-r--. 1 fedora fedora 434766 Jul 28 06:25 6. Working with cross-matched surveys_2H8RNABXT.zpln
    >   -rw-rw-r--. 1 fedora fedora 820072 Jul 28 06:25 7. Good astrometric solutions via ML Random Forrest classifier_2HB91UAVQ.zpln
    >   -rw-rw-r--. 1 fedora fedora 110240 Jul 28 06:26 8. Tips and tricks_2H845QGXH.zpln

    >   User [SVoutsinas]
    >   total 12
    >   drwxrwxr-x. 3 fedora fedora 4096 Jul 28 06:26 .
    >   drwxrwxr-x. 8 fedora fedora 4096 Jul 28 06:29 ..
    >   drwxrwxr-x. 2 fedora fedora 4096 Jul 28 06:26 examples
    >
    >   total 3056
    >   drwxrwxr-x. 2 fedora fedora   4096 Jul 28 06:26 .
    >   drwxrwxr-x. 3 fedora fedora   4096 Jul 28 06:26 ..
    >   -rw-rw-r--. 1 fedora fedora  37293 Jul 28 06:26 1. Start here_2HAVV677C.zpln
    >   -rw-rw-r--. 1 fedora fedora 103815 Jul 28 06:26 2. Data holdings_2H9SWYKVV.zpln
    >   -rw-rw-r--. 1 fedora fedora 497457 Jul 28 06:26 3. Source counts over the sky_2H9168ZRG.zpln
    >   -rw-rw-r--. 1 fedora fedora 985452 Jul 28 06:26 4. Mean proper motions over the sky_2HBC79UQU.zpln
    >   -rw-rw-r--. 1 fedora fedora 111310 Jul 28 06:26 5. Working with Gaia XP spectra_2H9SZNW21.zpln
    >   -rw-rw-r--. 1 fedora fedora 434789 Jul 28 06:26 6. Working with cross-matched surveys_2HA342WD8.zpln
    >   -rw-rw-r--. 1 fedora fedora 820123 Jul 28 06:26 7. Good astrometric solutions via ML Random Forrest classifier_2H86PFASM.zpln
    >   -rw-rw-r--. 1 fedora fedora 110306 Jul 28 06:26 8. Tips and tricks_2HAJRUA3G.zpln

    >   User [DMorris]
    >   total 12
    >   drwxrwxr-x. 3 fedora fedora 4096 Jul 28 06:27 .
    >   drwxrwxr-x. 8 fedora fedora 4096 Jul 28 06:29 ..
    >   drwxrwxr-x. 2 fedora fedora 4096 Jul 28 06:27 examples
    >
    >   total 3056
    >   drwxrwxr-x. 2 fedora fedora   4096 Jul 28 06:27 .
    >   drwxrwxr-x. 3 fedora fedora   4096 Jul 28 06:27 ..
    >   -rw-rw-r--. 1 fedora fedora  37271 Jul 28 06:27 1. Start here_2H8KUMF49.zpln
    >   -rw-rw-r--. 1 fedora fedora 103790 Jul 28 06:27 2. Data holdings_2H8T7EST9.zpln
    >   -rw-rw-r--. 1 fedora fedora 497443 Jul 28 06:27 3. Source counts over the sky_2H96K6B7W.zpln
    >   -rw-rw-r--. 1 fedora fedora 985433 Jul 28 06:27 4. Mean proper motions over the sky_2HA4HEPAW.zpln
    >   -rw-rw-r--. 1 fedora fedora 111296 Jul 28 06:27 5. Working with Gaia XP spectra_2HBWC5TET.zpln
    >   -rw-rw-r--. 1 fedora fedora 434767 Jul 28 06:27 6. Working with cross-matched surveys_2HB9SZWVD.zpln
    >   -rw-rw-r--. 1 fedora fedora 820073 Jul 28 06:27 7. Good astrometric solutions via ML Random Forrest classifier_2H9ZR146S.zpln
    >   -rw-rw-r--. 1 fedora fedora 110232 Jul 28 06:27 8. Tips and tricks_2H9FU5JRF.zpln

    >   User [MSemczuk]
    >   total 12
    >   drwxrwxr-x. 3 fedora fedora 4096 Jul 28 06:28 .
    >   drwxrwxr-x. 8 fedora fedora 4096 Jul 28 06:29 ..
    >   drwxrwxr-x. 2 fedora fedora 4096 Jul 28 06:28 examples
    >
    >   total 3056
    >   drwxrwxr-x. 2 fedora fedora   4096 Jul 28 06:28 .
    >   drwxrwxr-x. 3 fedora fedora   4096 Jul 28 06:28 ..
    >   -rw-rw-r--. 1 fedora fedora  37277 Jul 28 06:28 1. Start here_2HBWRA555.zpln
    >   -rw-rw-r--. 1 fedora fedora 103800 Jul 28 06:28 2. Data holdings_2HASAFAC5.zpln
    >   -rw-rw-r--. 1 fedora fedora 497451 Jul 28 06:28 3. Source counts over the sky_2H98SSHDV.zpln
    >   -rw-rw-r--. 1 fedora fedora 985440 Jul 28 06:28 4. Mean proper motions over the sky_2H859CYDC.zpln
    >   -rw-rw-r--. 1 fedora fedora 111300 Jul 28 06:28 5. Working with Gaia XP spectra_2H9MCZKXC.zpln
    >   -rw-rw-r--. 1 fedora fedora 434773 Jul 28 06:28 6. Working with cross-matched surveys_2H9F6QHAX.zpln
    >   -rw-rw-r--. 1 fedora fedora 820086 Jul 28 06:28 7. Good astrometric solutions via ML Random Forrest classifier_2H9UP5P46.zpln
    >   -rw-rw-r--. 1 fedora fedora 110262 Jul 28 06:28 8. Tips and tricks_2HBAJXA3K.zpln

    >   User [SGoughKelly]
    >   total 12
    >   drwxrwxr-x. 3 fedora fedora 4096 Jul 28 06:29 .
    >   drwxrwxr-x. 8 fedora fedora 4096 Jul 28 06:29 ..
    >   drwxrwxr-x. 2 fedora fedora 4096 Jul 28 06:30 examples
    >
    >   total 3056
    >   drwxrwxr-x. 2 fedora fedora   4096 Jul 28 06:30 .
    >   drwxrwxr-x. 3 fedora fedora   4096 Jul 28 06:29 ..
    >   -rw-rw-r--. 1 fedora fedora  37297 Jul 28 06:29 1. Start here_2HBTMY22G.zpln
    >   -rw-rw-r--. 1 fedora fedora 103827 Jul 28 06:29 2. Data holdings_2HAGD4QNR.zpln
    >   -rw-rw-r--. 1 fedora fedora 497463 Jul 28 06:29 3. Source counts over the sky_2HAE2KTK6.zpln
    >   -rw-rw-r--. 1 fedora fedora 985459 Jul 28 06:29 4. Mean proper motions over the sky_2H9JZ6PJN.zpln
    >   -rw-rw-r--. 1 fedora fedora 111316 Jul 28 06:29 5. Working with Gaia XP spectra_2HA25Q49U.zpln
    >   -rw-rw-r--. 1 fedora fedora 434796 Jul 28 06:29 6. Working with cross-matched surveys_2H9HD2SVR.zpln
    >   -rw-rw-r--. 1 fedora fedora 820142 Jul 28 06:29 7. Good astrometric solutions via ML Random Forrest classifier_2HAGG8FB4.zpln
    >   -rw-rw-r--. 1 fedora fedora 110334 Jul 28 06:30 8. Tips and tricks_2HB6UNP8V.zpln


# -----------------------------------------------------
# -----------------------------------------------------
# Backup the cloned notebooks.
#[user@data]

    colour=green

    sshuser=fedora
    sshhost=${colour:?}.aglais.uk

    pushd /var/local/backups
        pushd notebooks

            datetime=$(date '+%Y%m%d-%H%M%S')
            backname="${datetime:?}-${colour:?}-notebooks"

            rsync \
                --perms \
                --times \
                --group \
                --owner \
                --stats \
                --progress \
                --human-readable \
                --checksum \
                --recursive \
                --rsync-path 'sudo rsync' \
                "${sshuser:?}@${sshhost:?}:/home/fedora/zeppelin/notebook/" \
                "${backname:?}"

            if [ -L latest ]
            then
                rm latest
            fi
            ln -s "${backname:?}" latest

            ls -al

        popd
    popd

    >   ....
    >   ....
    >   drwxrwxr-x.  3 fedora fedora 4096 Jul 27 16:42 20220727-181710-green-notebooks
    >   drwxrwxr-x.  4 fedora fedora 4096 Jul 27 11:14 20220727-new-start
    >   drwxrwxr-x.  5 fedora fedora 4096 Jul 28 09:05 20220728-094954-green-notebooks
    >   drwxrwxr-x.  6 fedora fedora 4096 Jul 27 10:43 attic
    >   lrwxrwxrwx.  1 fedora fedora   31 Jul 28 09:50 latest -> 20220728-094954-green-notebooks


# -----------------------------------------------------
# Remove the fake password in live-users.yml.
#[root@ansibler]

    /deployments/common/users/live-users.yml

          ....
          ....

          - name: "DMorris"
            type: "live"
            linuxuid: 10004
       -    password: "super secret"
            publickey: "file:///deployments/common/ssh/keys/dmr.roe.ac.uk.rsa.pub"

          ....
          ....


# -----------------------------------------------------
# Re-deploy everything.
# (*) technically, all we need to do is create the live users again, but just to be sure.
#[root@ansibler]

    time \
        source /deployments/hadoop-yarn/bin/deploy.sh

    >   aglais:
    >     status:
    >       deployment:
    >         type: hadoop-yarn
    >         conf: zeppelin-26.43-spark-3.26.43
    >         name: iris-gaia-green-20220728
    >         date: 20220728T095540
    >         hostname: zeppelin.gaia-dmp.uk
    >     spec:
    >       openstack:
    >         cloud:
    >           base: arcus
    >           name: iris-gaia-green

    >   real    35m38.523s
    >   user    11m44.335s
    >   sys     2m29.689s


# -----------------------------------------------------
# Import our live accounts.
# Without the fake passwords this will use the Shiro hashes from our data node.
# The notebooks should be imported from the backup on the data node.
#[root@ansibler]

    source /deployments/zeppelin/bin/create-user-tools.sh

    import-live-users

    list-linux-info \
        /tmp/live-users.json

    >   [
    >     {
    >       "username": "DCrake",
    >       "homedir": "/home/DCrake",
    >       "linuxuid": "10001",
    >       "pkeyhash": "3a2afa4552c09330033182326a1e6fe5"
    >     },
    >     {
    >       "username": "NHambly",
    >       "homedir": "/home/NHambly",
    >       "linuxuid": "10002",
    >       "pkeyhash": "f83ced7b4be2bc239a537c92fdb531ce"
    >     },
    >     {
    >       "username": "SVoutsinas",
    >       "homedir": "/home/SVoutsinas",
    >       "linuxuid": "10003",
    >       "pkeyhash": "2b8cf5d662453b38de9c345cb5faef8f"
    >     },
    >     {
    >       "username": "DMorris",
    >       "homedir": "/home/DMorris",
    >       "linuxuid": "10004",
    >       "pkeyhash": "7763ae76c0d07f278465ad0a2162a492"
    >     },
    >     {
    >       "username": "MSemczuk",
    >       "homedir": "/home/MSemczuk",
    >       "linuxuid": "10005",
    >       "pkeyhash": "68b329da9893e34099c7d8ad5cb9c940"
    >     },
    >     {
    >       "username": "SGoughKelly",
    >       "homedir": "/home/SGoughKelly",
    >       "linuxuid": "10006",
    >       "pkeyhash": "68b329da9893e34099c7d8ad5cb9c940"
    >     }
    >   ]


    list-shiro-info \
        /tmp/live-users.json

    >   [
    >     {
    >       "username": "DCrake",
    >       "password": "",
    >       "hashhash": "363f543c44ac0b298b10734900419412"
    >     },
    >     {
    >       "username": "NHambly",
    >       "password": "",
    >       "hashhash": "ee67f62b6a095ea2817b67d46d2050c2"
    >     },
    >     {
    >       "username": "SVoutsinas",
    >       "password": "",
    >       "hashhash": "71e07a92016b3cee2fc56b38efaf2ab6"
    >     },
    >     {
    >       "username": "DMorris",
    >       "password": "",
    >       "hashhash": "99106f7237588b98e844d7de497956f4"
    >     },
    >     {
    >       "username": "MSemczuk",
    >       "password": "",
    >       "hashhash": "e192adcffc8436bf403bc79b8e48723e"
    >     },
    >     {
    >       "username": "SGoughKelly",
    >       "password": "",
    >       "hashhash": "0031d1bfe25fb2262eaf0c4f82499101"
    >     }
    >   ]


    list-ceph-info \
        /tmp/live-users.json

    >   [
    >     {
    >       "username": "DCrake",
    >       "usershare": {
    >         "name": "aglais-user-dcr",
    >         "size": 1024,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       },
    >       "homeshare": {
    >         "name": "iris-gaia-data-home-DCrake",
    >         "size": 1,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       }
    >     },
    >     {
    >       "username": "NHambly",
    >       "usershare": {
    >         "name": "aglais-user-nch",
    >         "size": 50000,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       },
    >       "homeshare": {
    >         "name": "iris-gaia-data-home-NHambly",
    >         "size": 1,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       }
    >     },
    >     {
    >       "username": "SVoutsinas",
    >       "usershare": {
    >         "name": "aglais-user-stv",
    >         "size": 1024,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       },
    >       "homeshare": {
    >         "name": "iris-gaia-data-home-SVoutsinas",
    >         "size": 1,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       }
    >     },
    >     {
    >       "username": "DMorris",
    >       "usershare": {
    >         "name": "aglais-user-zrq",
    >         "size": 1025,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       },
    >       "homeshare": {
    >         "name": "iris-gaia-data-home-DMorris",
    >         "size": 1,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       }
    >     },
    >     {
    >       "username": "MSemczuk",
    >       "usershare": {
    >         "name": "iris-gaia-data-user-MSemczuk",
    >         "size": 10,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       },
    >       "homeshare": {
    >         "name": "iris-gaia-data-home-MSemczuk",
    >         "size": 1,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       }
    >     },
    >     {
    >       "username": "SGoughKelly",
    >       "usershare": {
    >         "name": "iris-gaia-data-user-SGoughKelly",
    >         "size": 10,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       },
    >       "homeshare": {
    >         "name": "iris-gaia-data-home-SGoughKelly",
    >         "size": 1,
    >         "cloud": "iris-gaia-data",
    >         "status": "available"
    >       }
    >     }
    >   ]


    list-note-clone \
        /tmp/live-users.json

    >   [
    >     {
    >       "username": "DCrake",
    >       "notebooks": [
    >         "SKIP: Notebooks skipped - null password"
    >       ]
    >     },
    >     {
    >       "username": "NHambly",
    >       "notebooks": [
    >         "SKIP: Notebooks skipped - null password"
    >       ]
    >     },
    >     {
    >       "username": "SVoutsinas",
    >       "notebooks": [
    >         "SKIP: Notebooks skipped - null password"
    >       ]
    >     },
    >     {
    >       "username": "DMorris",
    >       "notebooks": [
    >         "SKIP: Notebooks skipped - null password"
    >       ]
    >     },
    >     {
    >       "username": "MSemczuk",
    >       "notebooks": [
    >         "SKIP: Notebooks skipped - null password"
    >       ]
    >     },
    >     {
    >       "username": "SGoughKelly",
    >       "notebooks": [
    >         "SKIP: Notebooks skipped - null password"
    >       ]
    >     }
    >   ]


# -----------------------------------------------------
# -----------------------------------------------------
# Login and explore my examples ....
#[user@desktop]

    firefox 'http://green.aglais.uk:8080/' &

        #
        # This won't work because port 8080 is no longer open in the firewall ?
        #


# -----------------------------------------------------
# -----------------------------------------------------
# Setup a SSH tunnel SOCKS proxy.
# https://unix.stackexchange.com/questions/34004/how-does-tcp-keepalive-work-in-ssh
# https://unix.stackexchange.com/a/34201
#[root@ansibler]

    ssh \
        -n \
        -f \
        -N \
        -D '*:3000' \
        -o ServerAliveInterval=10 \
        -o ServerAliveCountMax=12 \
        zeppelin


# -----------------------------------------------------
# -----------------------------------------------------
# Test the SOCKS proxy using curl.
#[user@desktop]

    curl \
        --head \
        --socks5-hostname 'localhost:3000' \
        'http://zeppelin:8080/'

    >   HTTP/1.1 200 OK
    >   Date: Thu, 28 Jul 2022 10:42:51 GMT
    >   ....
    >   ....


# -----------------------------------------------------
# -----------------------------------------------------
# Login and explore my examples ....
#[user@desktop]

    firefox 'http://zeppelin:8080/' &


# -----------------------------------------------------
# -----------------------------------------------------

    #
    # Install NginX proxy and add the SSL components.
    # Notes from Stelios ..
    #

# -----------------------------------------------------
# -----------------------------------------------------
# Get the IP address from the ssh config file.
# TODO Save the IP address during the deployment process.
# https://github.com/wfau/aglais/issues/860
#[root@ansibler]

    ipaddress=$(

        sed -n '
            /^Host zeppelin/,/^Host/ {
                /HostName/ {
                    s/^[[:space:]]*HostName[[:space:]]\(.*\)/\1/ p
                    }
                }
            ' ~/.ssh/config

        )

# -----------------------------------------------------
# Update the 'live' DNS record to point to the new system.
#[root@ansibler]

    # This should be done automatically.
    # https://github.com/wfau/aglais/issues/893
    source /deployments/zeppelin/bin/create-user-tools.sh

    ducktoken=$(getsecret 'devops.duckdns.token')

    duckname=aglais-live

    echo "----"
    echo "Updating DuckDNS record"
    curl "https://www.duckdns.org/update/${duckname:?}/${ducktoken:?}/${ipaddress:?}"
    echo
    echo "----"


# -----------------------------------------------------
# -----------------------------------------------------
# Login and explore the examples ....
#[user@desktop]

    firefox --new-window \
        'https://zeppelin.gaia-dmp.uk/' &


# -----------------------------------------------------
# -----------------------------------------------------
# Move our notebook permissions file into our notebook folder.
#[user@zeppelin]

    #
    # Need to create the initial file ny editing the permissions on at least one note.
    #

    pushd /home/fedora/zeppelin

        mv conf/notebook-authorization.json notebook

        ln -s notebook/notebook-authorization.json \
              conf/notebook-authorization.json

        ls -al notebook

    popd

    >   drwxrwxr-x.  5 fedora fedora        4096 Jul 28 12:36  .
    >   drwxr-x---. 14 fedora zeppelinusers 4096 Jul 28 10:27  ..
    >   drwxrwxr-x.  7 fedora fedora        4096 Jul 28 08:40  .git
    >   drwxrwxr-x.  2 fedora fedora        4096 Jul 27 18:07 'Public Examples'
    >   drwxrwxr-x.  8 fedora fedora        4096 Jul 28 09:43  Users
    >   -rw-------.  1 fedora fedora        6170 Jul 28 12:34  notebook-authorization.json


# -----------------------------------------------------
# Check how our notebook-authorization file behaves.
#[user@zeppelin]

    pushd /home/fedora/zeppelin

    jq '.' notebook/notebook-authorization.json | less

    >   {
    >     "authInfo": {
    >       "2HB4V7B17": {
    >         "readers": [],
    >         "owners": [],
    >         "writers": [],
    >         "runners": []
    >       },
    >       "2GZME59KY": {
    >         "readers": [],
    >         "owners": [],
    >         "writers": [],
    >         "runners": []
    >       },
    >   ....
    >   ....


    #
    # Example 1. Start here
    # https://dmp.gaia.ac.uk/#/notebook/2H8CPHH9R

    #
    # Check the permissions on disc.
    jq '
       .authInfo."2H8CPHH9R"
       ' notebook/notebook-authorization.json

    >   {
    >     "readers": [
    >       "DMorris"
    >     ],
    >     "owners": [
    >       "DMorris"
    >     ],
    >     "writers": [
    >       "DMorris"
    >     ],
    >     "runners": [
    >       "DMorris"
    >     ]
    >   }

    #
    # What if we set the permissions on another note via the GUI.
    #

    #
    # Example 2. Data holdings
    # https://dmp.gaia.ac.uk/#/notebook/2H9ZMFDFC

    #
    # Check the permissions on disc.
    jq '
       .authInfo."2H9ZMFDFC"
       ' notebook/notebook-authorization.json

    >   {
    >     "readers": [],
    >     "owners": [],
    >     "writers": [],
    >     "runners": []
    >   }

    #
    # Change the permissions via the Zeppelin GUI.
    # ....

    #
    # Check the permissions in the notebook directory.
    jq '
       .authInfo."2H9ZMFDFC"
       ' notebook/notebook-authorization.json

    >   {
    >     "readers": [],
    >     "owners": [],
    >     "writers": [],
    >     "runners": []
    >   }


    #
    # Check Zeppelin hasn't broken the link.
    # .... it has.
    # The symlink has been replaced by a new file.
    #

    ls -al conf

    >   ....
    >   -rw-------.  1 fedora fedora         6270 Jul 28 12:56 notebook-authorization.json
    >   ....


    #
    # Check the permissions in the conf directory.
    jq '
       .authInfo."2H9ZMFDFC"
       ' conf/notebook-authorization.json


    >   {
    >     "readers": [
    >       "DMorris"
    >     ],
    >     "owners": [
    >       "DMorris"
    >     ],
    >     "writers": [
    >       "DMorris"
    >     ],
    >     "runners": [
    >       "DMorris"
    >     ]
    >   }


    #
    # Yep, thought it might.
    # When it edits the permissions, it edits a version of the data in memory and then writes out a new file.
    # Overwriting (replacing) the symlink we installed.
    #

    #
    # So the simple symlink won't work.
    # We need to handle two things when we make a backup.
    # The directory of notebook files, and the authorization file.
    #
    # Yes, the location is hard coded in their Java class.
    # https://github.com/apache/zeppelin/blob/abc664b852ae7800eb1e5cdcfb6fcb9473e2f492/zeppelin-interpreter/src/main/java/org/apache/zeppelin/conf/ZeppelinConfiguration.java#L578-L580
    # https://github.com/apache/zeppelin/blob/abc664b852ae7800eb1e5cdcfb6fcb9473e2f492/zeppelin-zengine/src/main/java/org/apache/zeppelin/notebook/AuthorizationService.java#L64-L65
    #

    #
    # My guess is a hard link won't work either .. worth a try though.
    #

    rm notebook/notebook-authorization.json

    ln conf/notebook-authorization.json \
       notebook/notebook-authorization.json

    #
    # Check the permissions in the conf directory.
    jq '
       .authInfo."2H9ZMFDFC"
       ' conf/notebook-authorization.json

    >   {
    >     "readers": [
    >       "DMorris"
    >     ],
    >     "owners": [
    >       "DMorris"
    >     ],
    >     "writers": [
    >       "DMorris"
    >     ],
    >     "runners": [
    >       "DMorris"
    >     ]
    >   }


    #
    # Check the permissions in the notebook directory.
    jq '
       .authInfo."2H9ZMFDFC"
       ' notebook/notebook-authorization.json

    >   {
    >     "readers": [
    >       "DMorris"
    >     ],
    >     "owners": [
    >       "DMorris"
    >     ],
    >     "writers": [
    >       "DMorris"
    >     ],
    >     "runners": [
    >       "DMorris"
    >     ]
    >   }

    #
    # Change the permissions via the Zeppelin GUI.
    # ....


    #
    # Check the permissions in the conf directory.
    jq '
       .authInfo."2H9ZMFDFC"
       ' conf/notebook-authorization.json

    >   {
    >     "readers": [],
    >     "owners": [
    >       "DMorris"
    >     ],
    >     "writers": [
    >       "DMorris"
    >     ],
    >     "runners": []
    >   }


    #
    # Check the permissions in the notebook directory.
    jq '
       .authInfo."2H9ZMFDFC"
       ' notebook/notebook-authorization.json

    >   {
    >     "readers": [
    >       "DMorris"
    >     ],
    >     "owners": [
    >       "DMorris"
    >     ],
    >     "writers": [
    >       "DMorris"
    >     ],
    >     "runners": [
    >       "DMorris"
    >     ]
    >   }

    #
    # Link broken :-(
    # Zepplin is openning a new file each time.
    #
    # So we can't link or symlin it.
    # We can't reloacet it.
    #
    # We will have to make it part of our backup and restore process.
    #


# -----------------------------------------------------
# -----------------------------------------------------
# Reset the permissions ...
#[root@ansibler]

    ssh zeppelin

    zeppelinurl=http://localhost:8080

    username="DMorris"
    userpass="prissy symptom denture hardwired"

    cookiefile=$(mktemp)

    # Login to Zeppelin
    curl \
        --silent \
        --show-error \
        --request 'POST' \
        --cookie-jar "${cookiefile}" \
        --data "userName=${username}" \
        --data "password=${userpass}" \
        "${zeppelinurl}/api/login" \
    | jq '.'

    >   {
    >     "status": "OK",
    >     "message": "",
    >     "body": {
    >       "principal": "DMorris",
    >       "ticket": "ca96f76e-5e1e-4ff1-a0a0-1edea5a488f9",
    >       "roles": "[]"
    >     }
    >   }

    curl \
        --silent \
        --show-error \
        --cookie "${cookiefile}" \
        "${zeppelinurl}/api/notebook" \
    | tee /tmp/notebook-list.json \
    | jq '.'

    >   {
    >     "status": "OK",
    >     "message": "",
    >     "body": [
    >       {
    >         "id": "2GRTQZFUM",
    >         "path": "/Public Examples/1. Start here"
    >       },
    >       {
    >         "id": "2GRA39HCN",
    >         "path": "/Public Examples/2. Data holdings"
    >       },
    >       {
    >         "id": "2GQ6WMH9W",
    >         "path": "/Public Examples/3. Source counts over the sky"
    >       },
    >       {
    >         "id": "2GSNYBDWB",
    >         "path": "/Public Examples/4. Mean proper motions over the sky"
    >       },
    >       {
    >         "id": "2H2YRJCKM",
    >         "path": "/Public Examples/5. Working with Gaia XP spectra"
    >       },
    >       {
    >         "id": "2GZME59KY",
    >         "path": "/Public Examples/6. Working with cross-matched surveys"
    >       },
    >       {
    >         "id": "2GQDKZ59J",
    >         "path": "/Public Examples/7. Good astrometric solutions via ML Random Forrest classifier"
    >       },
    >       {
    >         "id": "2GVXKC266",
    >         "path": "/Public Examples/8. Tips and tricks"
    >       },
    >       {
    >         "id": "2H85A6BCQ",
    >         "path": "/Users/DCrake/examples/1. Start here"
    >       },
    >       {
    >         "id": "2H9V3Q9YT",
    >         "path": "/Users/DCrake/examples/2. Data holdings"
    >       },
    >       {
    >         "id": "2H8WURS27",
    >         "path": "/Users/DCrake/examples/3. Source counts over the sky"
    >       },
    >       {
    >         "id": "2H8ERMYVV",
    >         "path": "/Users/DCrake/examples/4. Mean proper motions over the sky"
    >       },
    >       {
    >         "id": "2H9YDAYPD",
    >         "path": "/Users/DCrake/examples/5. Working with Gaia XP spectra"
    >       },
    >       {
    >         "id": "2HBDT3293",
    >         "path": "/Users/DCrake/examples/6. Working with cross-matched surveys"
    >       },
    >       {
    >         "id": "2H8FRZ37Z",
    >         "path": "/Users/DCrake/examples/7. Good astrometric solutions via ML Random Forrest classifier"
    >       },
    >       {
    >         "id": "2HBJ3T4VX",
    >         "path": "/Users/DCrake/examples/8. Tips and tricks"
    >       },
    >       {
    >         "id": "2H8CPHH9R",
    >         "path": "/Users/DMorris/examples/1. Start here"
    >       },
    >       {
    >         "id": "2H9ZMFDFC",
    >         "path": "/Users/DMorris/examples/2. Data holdings"
    >       },
    >       {
    >         "id": "2HBZQDEAW",
    >         "path": "/Users/DMorris/examples/3. Source counts over the sky"
    >       },
    >       {
    >         "id": "2H94R7MY3",
    >         "path": "/Users/DMorris/examples/4. Mean proper motions over the sky"
    >       },
    >       {
    >         "id": "2HB7V15RH",
    >         "path": "/Users/DMorris/examples/5. Working with Gaia XP spectra"
    >       },
    >       {
    >         "id": "2H985A8RG",
    >         "path": "/Users/DMorris/examples/6. Working with cross-matched surveys"
    >       },
    >       {
    >         "id": "2H8ECNSVC",
    >         "path": "/Users/DMorris/examples/7. Good astrometric solutions via ML Random Forrest classifier"
    >       },
    >       {
    >         "id": "2HAE7A1FW",
    >         "path": "/Users/DMorris/examples/8. Tips and tricks"
    >       },
    >       {
    >         "id": "2HAA9GBZU",
    >         "path": "/Users/MSemczuk/examples/1. Start here"
    >       },
    >       {
    >         "id": "2HAY937JJ",
    >         "path": "/Users/MSemczuk/examples/2. Data holdings"
    >       },
    >       {
    >         "id": "2H99BHRHW",
    >         "path": "/Users/MSemczuk/examples/3. Source counts over the sky"
    >       },
    >       {
    >         "id": "2H93JMBFU",
    >         "path": "/Users/MSemczuk/examples/4. Mean proper motions over the sky"
    >       },
    >       {
    >         "id": "2H8MEYTF2",
    >         "path": "/Users/MSemczuk/examples/5. Working with Gaia XP spectra"
    >       },
    >       {
    >         "id": "2HA48SYXX",
    >         "path": "/Users/MSemczuk/examples/6. Working with cross-matched surveys"
    >       },
    >       {
    >         "id": "2H8SA9BXP",
    >         "path": "/Users/MSemczuk/examples/7. Good astrometric solutions via ML Random Forrest classifier"
    >       },
    >       {
    >         "id": "2HABW3WE4",
    >         "path": "/Users/MSemczuk/examples/8. Tips and tricks"
    >       },
    >       {
    >         "id": "2HAP67NNV",
    >         "path": "/Users/NHambly/examples/1. Start here"
    >       },
    >       {
    >         "id": "2HA8S45J3",
    >         "path": "/Users/NHambly/examples/2. Data holdings"
    >       },
    >       {
    >         "id": "2HB4V7B17",
    >         "path": "/Users/NHambly/examples/3. Source counts over the sky"
    >       },
    >       {
    >         "id": "2HBSG56A4",
    >         "path": "/Users/NHambly/examples/4. Mean proper motions over the sky"
    >       },
    >       {
    >         "id": "2H8JR6NY4",
    >         "path": "/Users/NHambly/examples/5. Working with Gaia XP spectra"
    >       },
    >       {
    >         "id": "2HAQZZZT9",
    >         "path": "/Users/NHambly/examples/6. Working with cross-matched surveys"
    >       },
    >       {
    >         "id": "2HA88WC2H",
    >         "path": "/Users/NHambly/examples/7. Good astrometric solutions via ML Random Forrest classifier"
    >       },
    >       {
    >         "id": "2HBJ5Y62X",
    >         "path": "/Users/NHambly/examples/8. Tips and tricks"
    >       },
    >       {
    >         "id": "2HBY8CVF4",
    >         "path": "/Users/SGoughKelly/examples/1. Start here"
    >       },
    >       {
    >         "id": "2H8YTAAUA",
    >         "path": "/Users/SGoughKelly/examples/2. Data holdings"
    >       },
    >       {
    >         "id": "2H8HUVP6W",
    >         "path": "/Users/SGoughKelly/examples/3. Source counts over the sky"
    >       },
    >       {
    >         "id": "2H9HECMBC",
    >         "path": "/Users/SGoughKelly/examples/4. Mean proper motions over the sky"
    >       },
    >       {
    >         "id": "2HA593GRS",
    >         "path": "/Users/SGoughKelly/examples/5. Working with Gaia XP spectra"
    >       },
    >       {
    >         "id": "2H9K1YUJQ",
    >         "path": "/Users/SGoughKelly/examples/6. Working with cross-matched surveys"
    >       },
    >       {
    >         "id": "2H8MPSEC7",
    >         "path": "/Users/SGoughKelly/examples/7. Good astrometric solutions via ML Random Forrest classifier"
    >       },
    >       {
    >         "id": "2HBYP62ZP",
    >         "path": "/Users/SGoughKelly/examples/8. Tips and tricks"
    >       },
    >       {
    >         "id": "2H8GZXMCJ",
    >         "path": "/Users/SVoutsinas/examples/1. Start here"
    >       },
    >       {
    >         "id": "2HANP199N",
    >         "path": "/Users/SVoutsinas/examples/2. Data holdings"
    >       },
    >       {
    >         "id": "2H8JM272S",
    >         "path": "/Users/SVoutsinas/examples/3. Source counts over the sky"
    >       },
    >       {
    >         "id": "2HBZ4U9J6",
    >         "path": "/Users/SVoutsinas/examples/4. Mean proper motions over the sky"
    >       },
    >       {
    >         "id": "2HBJRXF6F",
    >         "path": "/Users/SVoutsinas/examples/5. Working with Gaia XP spectra"
    >       },
    >       {
    >         "id": "2HA7RUPWZ",
    >         "path": "/Users/SVoutsinas/examples/6. Working with cross-matched surveys"
    >       },
    >       {
    >         "id": "2H9HW2QJW",
    >         "path": "/Users/SVoutsinas/examples/7. Good astrometric solutions via ML Random Forrest classifier"
    >       },
    >       {
    >         "id": "2HBQJUMXT",
    >         "path": "/Users/SVoutsinas/examples/8. Tips and tricks"
    >       }
    >     ]
    >   }

    #
    # The only way we can re-construct the ownership is to use the path.
    #

    cp conf/notebook-authorization.json \
       conf/notebook-authorization.bak


    username=DMorris

    jq "
        [
        .body[] | select(.path | startswith(\"/Users/${username}\")) | {id, path}
        ]
        " /tmp/notebook-list.json \
    | tee /tmp/${username}-notebooks.json \
    | jq '.'

    >   [
    >     {
    >       "id": "2H8CPHH9R",
    >       "path": "/Users/DMorris/examples/1. Start here"
    >     },
    >     {
    >       "id": "2H9ZMFDFC",
    >       "path": "/Users/DMorris/examples/2. Data holdings"
    >     },
    >     {
    >       "id": "2HBZQDEAW",
    >       "path": "/Users/DMorris/examples/3. Source counts over the sky"
    >     },
    >     {
    >       "id": "2H94R7MY3",
    >       "path": "/Users/DMorris/examples/4. Mean proper motions over the sky"
    >     },
    >     {
    >       "id": "2HB7V15RH",
    >       "path": "/Users/DMorris/examples/5. Working with Gaia XP spectra"
    >     },
    >     {
    >       "id": "2H985A8RG",
    >       "path": "/Users/DMorris/examples/6. Working with cross-matched surveys"
    >     },
    >     {
    >       "id": "2H8ECNSVC",
    >       "path": "/Users/DMorris/examples/7. Good astrometric solutions via ML Random Forrest classifier"
    >     },
    >     {
    >       "id": "2HAE7A1FW",
    >       "path": "/Users/DMorris/examples/8. Tips and tricks"
    >     }
    >   ]




    noteid=2HA88WC2H
    jq "
        (.authInfo.\"${noteid}\".readers) |= .+ [\"${username}\"]
        |
        (.authInfo.\"${noteid}\".writers) |= .+ [\"${username}\"]
        |
        (.authInfo.\"${noteid}\".owners)  |= .+ [\"${username}\"]
        |
        (.authInfo.\"${noteid}\".runners) |= .+ [\"${username}\"]
        " conf/notebook-authorization.json \
    | sponge conf/notebook-authorization.json

    jq '.' conf/notebook-authorization.json

    >   ....
    >   ....
    >       "2HA88WC2H": {
    >         "readers": [
    >           "DMorris"
    >         ],
    >         "owners": [
    >           "DMorris"
    >         ],
    >         "writers": [
    >           "DMorris"
    >         ],
    >         "runners": [
    >           "DMorris"
    >         ]
    >       },
    >       "2HABW3WE4": {
    >         "readers": [],
    >         "owners": [],
    >         "writers": [],
    >         "runners": []
    >       }
    >     }
    >   }



    usernames=(
        DCrake
        NHambly
        SVoutsinas
        DMorris
        MSemczuk
        SGoughKelly
        )

    for username in ${usernames[@]}
    do
        echo
        echo "Username [${username}]"
        for noteid in $(
            jq -r "
                .body[] | select(.path | startswith(\"/Users/${username}\")) | .id
                " /tmp/notebook-list.json
            )
        do
            echo "Note ID [${noteid}]"
            jq "
                (.authInfo.\"${noteid}\".readers) |= .+ [\"${username}\"]
                |
                (.authInfo.\"${noteid}\".writers) |= .+ [\"${username}\"]
                |
                (.authInfo.\"${noteid}\".owners)  |= .+ [\"${username}\"]
                |
                (.authInfo.\"${noteid}\".runners) |= .+ [\"${username}\"]
                " conf/notebook-authorization.json \
            | sponge conf/notebook-authorization.json
        done
    done

    vi conf/notebook-authorization.json


# -----------------------------------------------------
# -----------------------------------------------------
# Backup notebooks from green.
#[user@data]

    colour=green

    sshuser=fedora
    sshhost=${colour:?}.aglais.uk

    ssh-keyscan "${colour:?}.aglais.uk" 2>/dev/null >> "${HOME}/.ssh/known_hosts"

    pushd /var/local/backups
        pushd notebooks

            datetime=$(date '+%Y%m%d-%H%M%S')
            backname="${datetime:?}-${colour:?}-notebooks"

            mkdir "${backname}"

            rsync \
                --perms \
                --times \
                --group \
                --owner \
                --stats \
                --progress \
                --exclude '~Trash' \
                --human-readable \
                --checksum \
                --recursive \
                --rsync-path 'sudo rsync' \
                "${sshuser:?}@${sshhost:?}:/home/fedora/zeppelin/notebook" \
                "${backname:?}"

            rsync \
                --perms \
                --times \
                --group \
                --owner \
                --stats \
                --progress \
                --human-readable \
                --checksum \
                --recursive \
                --rsync-path 'sudo rsync' \
                "${sshuser:?}@${sshhost:?}:/home/fedora/zeppelin/conf/notebook-authorization.json" \
                "${backname:?}"

            if [ -L latest ]
            then
                rm latest
            fi
            ln -s "${backname:?}" latest

        popd
    popd

    ls -al /var/local/backups/notebooks/latest/

    >   drwxrwxr-x.  5 fedora fedora  4096 Jul 28 17:23 notebook
    >   -rw-------.  1 fedora fedora 11203 Jul 28 16:42 notebook-authorization.json


    ls -al /var/local/backups/notebooks/latest/notebook/

    >   drwxrwxr-x. 7 fedora fedora 4096 Jul 28 14:25  .git
    >   drwxrwxr-x. 2 fedora fedora 4096 Jul 28 15:25 'Public Examples'
    >   drwxrwxr-x. 8 fedora fedora 4096 Jul 28 09:43  Users


# -----------------------------------------------------
# -----------------------------------------------------
# Update the restore script to use the new structure.
#[user@desktop]






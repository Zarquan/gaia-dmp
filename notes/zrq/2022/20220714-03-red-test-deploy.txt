#
# <meta:header>
#   <meta:licence>
#     Copyright (c) 2022, ROE (http://www.roe.ac.uk/)
#
#     This information is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This information is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
#   </meta:licence>
# </meta:header>
#
#zrq-notes-time
#zrq-notes-indent
#zrq-notes-crypto
#zrq-notes-ansible
#zrq-notes-osformat
#zrq-notes-zeppelin
#

    Target:

        Clean deploy on red to test everything.

    Result:

        Work in progress ...


# -----------------------------------------------------
# Create a container to work with.
#[user@desktop]

    source "${HOME:?}/aglais.env"

    podman run \
        --rm \
        --tty \
        --interactive \
        --name ansibler \
        --hostname ansibler \
        --publish 3000:3000 \
        --env "SSH_AUTH_SOCK=/mnt/ssh_auth_sock" \
        --volume "${SSH_AUTH_SOCK}:/mnt/ssh_auth_sock:rw,z" \
        --volume "${HOME:?}/clouds.yaml:/etc/openstack/clouds.yaml:ro,z" \
        --volume "${AGLAIS_CODE:?}/deployments:/deployments:ro,z" \
        ghcr.io/wfau/atolmis/ansible-client:2022.03.19 \
        bash


# -----------------------------------------------------
# Set the target configuration.
#[root@ansibler]

    cloudbase=arcus
    cloudname=iris-gaia-red
    configname=zeppelin-26.43-spark-3.26.43


# -----------------------------------------------------
# Deploy everything.
#[root@ansibler]

    time \
        source /deployments/hadoop-yarn/bin/deploy.sh

    >   real    33m56.967s
    >   user    12m12.485s
    >   sys     2m30.380s


# -----------------------------------------------------
# Create some test users.
#[root@ansibler]

    source /deployments/zeppelin/bin/create-user-tools.sh

    testnames=(
        Halda
        Jaden
        )

    createarrayusers \
        "${testnames[@]}" \
    | tee /tmp/testusers.json \
    | jq '.users[].shirouser | {name: .name, pass: .password}'

    >   {
    >     "name": "Halda",
    >     "pass": "Aes5Ix1xae1xoof9oghe"
    >   }
    >   {
    >     "name": "Jaden",
    >     "pass": "po4thaimo4Wie6angefe"
    >   }


# -----------------------------------------------------
# Try creating a new share
#[root@ansibler]

    /deployments/zeppelin/bin/create-ceph-share.sh \
        "${cloudname:?}" \
        "Halda-test-share-001" \
        10 \
        "/user/Halda/001" \
        "Halda" \
        "users"  \
    | tee /tmp/create-test.json \
    | jq '.'

    >   {
    >     "name": "Halda-test-share-001",
    >     "uuid": "",
    >     "status": "",
    >     "ceph": {
    >       "nodes": "",
    >       "path": "",
    >       "name": "",
    >       "key": ""
    >     },
    >     "mount": {
    >       "path": "/user/Halda/001",
    >       "mode": "rw",
    >       "owner": "Halda",
    >       "group": "users"
    >     },
    >     "openstack": {},
    >     "ansible": {},
    >     "debug": {
    >       "script": "create-ceph-share.sh",
    >       "result": "FAIL",
    >       "messages": [
    >         "FAIL: Failed to create share [Halda-test-share-001], return code [1]",
    >         "ShareSizeExceedsAvailableQuota: Requested share exceeds allowed project/user or share type gigabytes quota. (HTTP 413) (Request-ID: req-b6552617-676a-4afd-ac6a-0458e1ba3fd5)",
    >         "SKIP: Mounting share [Halda-test-share-001][] skipped, status []"
    >       ]
    >     }
    >   }

    #
    # It doesn't exceed the quota, but never mind.
    # A good test of the error handling.
    #
    # Delete a test share to make space.
    # ....
    #


# -----------------------------------------------------
# List the exsiting shares for this project.
#[root@ansibler]

    export OS_SHARE_API_VERSION=2.51

    openstack \
        --os-cloud "${cloudname:?}" \
        share list

    >   +--------------------------------------+------------------+------+-------------+----------------+-----------+-----------------+------+-------------------+
    >   | ID                                   | Name             | Size | Share Proto | Status         | Is Public | Share Type Name | Host | Availability Zone |
    >   +--------------------------------------+------------------+------+-------------+----------------+-----------+-----------------+------+-------------------+
    >   | 5ba0a465-4c1e-4d1b-856e-57e3c4029816 | Halda-test-share |   10 | CEPHFS      | error_deleting | False     | ceph01_cephfs   |      | nova              |
    >   | 2dea2942-28d4-432a-bb58-1edded51e8cc | Jaden-test-share |   10 | CEPHFS      | error_deleting | False     | ceph01_cephfs   |      | nova              |
    >   | b052d0e7-65ec-493d-9bde-9fc31d09836f | Jaden-test-share |   10 | CEPHFS      | error_deleting | False     | ceph01_cephfs   |      | nova              |
    >   | 1845b981-123a-4df5-a1fe-2215bdf353a1 | test-aD6raewu    |    5 | CEPHFS      | error_deleting | False     | ceph01_cephfs   |      | nova              |
    >   +--------------------------------------+------------------+------+-------------+----------------+-----------+-----------------+------+-------------------+


# -----------------------------------------------------
# Delete the test shares.
#[root@ansibler]

    # Only delete shares with the work 'test' in their name.
    ....
    ....


# -----------------------------------------------------
# Try creating a new share
#[root@ansibler]

    /deployments/zeppelin/bin/create-ceph-share.sh \
        "${cloudname:?}" \
        "Jaden-test-share-001" \
        10 \
        "/user/Jaden/001" \
        "Jaden" \
        "users"  \
    | tee /tmp/create-test.json \
    | jq '.'

    >   {
    >     "name": "Jaden-test-share-001",
    >     "uuid": "abe691d9-d35b-41de-8abf-e69c659d1375",
    >     "status": "available",
    >     "ceph": {
    >       "nodes": "10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789",
    >       "path": "/volumes/_nogroup/cb7b1b0d-e79d-46cf-9638-14252f725f1c",
    >       "name": "Jaden-test-share-001-rw",
    >       "key": "AQBx5tBirs36BhAAUS5M+Zh3e2AuMsLFsWx8bg=="
    >     },
    >     "mount": {
    >       "path": "/user/Jaden/001",
    >       "mode": "rw",
    >       "owner": "Jaden",
    >       "group": "users"
    >     },
    >     "openstack": {
    >       "access_rules_status": "active",
    >       "availability_zone": "nova",
    >       "create_share_from_snapshot_support": false,
    >       "created_at": "2022-07-15T04:00:37.000000",
    >       "description": null,
    >       "export_locations": "\npath = 10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/cb7b1b0d-e79d-46cf-9638-14252f725f1c\nid = 02b60b35-1c69-45a9-8c64-e690126edf46\npreferred = False",
    >       "has_replicas": false,
    >       "id": "abe691d9-d35b-41de-8abf-e69c659d1375",
    >       "is_public": true,
    >       "mount_snapshot_support": false,
    >       "name": "Jaden-test-share-001",
    >       "project_id": "0dd8cc5ee5a7455c8748cc06d04c93c3",
    >       "properties": {},
    >       "replication_type": null,
    >       "revert_to_snapshot_support": false,
    >       "share_group_id": null,
    >       "share_network_id": null,
    >       "share_proto": "CEPHFS",
    >       "share_type": "12668f5c-44e4-4b63-abf1-c56002ccc424",
    >       "share_type_name": "ceph01_cephfs",
    >       "size": 10,
    >       "snapshot_id": null,
    >       "snapshot_support": false,
    >       "source_share_group_snapshot_member_id": null,
    >       "status": "available",
    >       "task_state": null,
    >       "user_id": "5fa0c97a6dd14e01a3c7d91dad5c6b17",
    >       "volume_type": "ceph01_cephfs"
    >     },
    >     "ansible": {
    >       "custom_stats": {},
    >       "global_custom_stats": {},
    >       "plays": [
    >         {
    >           "play": {
    >             "duration": {
    >               "end": "2022-07-15T04:01:03.905632Z",
    >               "start": "2022-07-15T04:00:56.822894Z"
    >             },
    >             "id": "ee78dafe-0704-8f26-a721-00000000000b",
    >             "name": "Install and mount a CephFS share"
    >           },
    >           "tasks": [
    >             {
    >               "hosts": {
    >                 "master01": {
    >                   "_ansible_no_log": false,
    >                   "action": "blockinfile",
    >                   "ansible_facts": {
    >                     "discovered_interpreter_python": "/usr/bin/python3"
    >                   },
    >                   "changed": false,
    >                   "diff": [
    >                     {
    >                       "after": "",
    >                       "after_header": "/etc/ceph/ceph.conf (content)",
    >                       "before": "",
    >                       "before_header": "/etc/ceph/ceph.conf (content)"
    >                     },
    >                     {
    >                       "after_header": "/etc/ceph/ceph.conf (file attributes)",
    >                       "before_header": "/etc/ceph/ceph.conf (file attributes)"
    >                     }
    >                   ],
    >                   "invocation": {
    >                     "module_args": {
    >                       "attributes": null,
    >                       "backup": false,
    >                       "block": "[client]\n    client quota = true\n    mon host = 10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789\n",
    >                       "create": true,
    >                       "group": null,
    >                       "insertafter": null,
    >                       "insertbefore": null,
    >                       "marker": "# {mark} ANSIBLE MANAGED BLOCK",
    >                       "marker_begin": "BEGIN",
    >                       "marker_end": "END",
    >                       "mode": null,
    >                       "owner": null,
    >                       "path": "/etc/ceph/ceph.conf",
    >                       "selevel": null,
    >                       "serole": null,
    >                       "setype": null,
    >                       "seuser": null,
    >                       "state": "present",
    >                       "unsafe_writes": false,
    >                       "validate": null
    >                     }
    >                   },
    >                   "msg": ""
    >                 },
    >                 "worker01": {
    >                   "_ansible_no_log": false,
    >                   "action": "blockinfile",
    >                   "ansible_facts": {
    >                     "discovered_interpreter_python": "/usr/bin/python3"
    >                   },
    >                   "changed": false,
    >                   "diff": [
    >                     {
    >                       "after": "",
    >                       "after_header": "/etc/ceph/ceph.conf (content)",
    >                       "before": "",
    >                       "before_header": "/etc/ceph/ceph.conf (content)"
    >                     },
    >                     {
    >                       "after_header": "/etc/ceph/ceph.conf (file attributes)",
    >                       "before_header": "/etc/ceph/ceph.conf (file attributes)"
    >                     }
    >                   ],
    >                   "invocation": {
    >                     "module_args": {
    >                       "attributes": null,
    >                       "backup": false,
    >                       "block": "[client]\n    client quota = true\n    mon host = 10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789\n",
    >                       "create": true,
    >                       "group": null,
    >                       "insertafter": null,
    >                       "insertbefore": null,
    >                       "marker": "# {mark} ANSIBLE MANAGED BLOCK",
    >                       "marker_begin": "BEGIN",
    >                       "marker_end": "END",
    >                       "mode": null,
    >                       "owner": null,
    >                       "path": "/etc/ceph/ceph.conf",
    >                       "selevel": null,
    >                       "serole": null,
    >                       "setype": null,
    >                       "seuser": null,
    >                       "state": "present",
    >                       "unsafe_writes": false,
    >                       "validate": null
    >                     }
    >                   },
    >                   "msg": ""
    >                 },
    >                 "worker02": {
    >                   "_ansible_no_log": false,
    >                   "action": "blockinfile",
    >                   "ansible_facts": {
    >                     "discovered_interpreter_python": "/usr/bin/python3"
    >                   },
    >                   "changed": false,
    >                   "diff": [
    >                     {
    >                       "after": "",
    >                       "after_header": "/etc/ceph/ceph.conf (content)",
    >                       "before": "",
    >                       "before_header": "/etc/ceph/ceph.conf (content)"
    >                     },
    >                     {
    >                       "after_header": "/etc/ceph/ceph.conf (file attributes)",
    >                       "before_header": "/etc/ceph/ceph.conf (file attributes)"
    >                     }
    >                   ],
    >                   "invocation": {
    >                     "module_args": {
    >                       "attributes": null,
    >                       "backup": false,
    >                       "block": "[client]\n    client quota = true\n    mon host = 10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789\n",
    >                       "create": true,
    >                       "group": null,
    >                       "insertafter": null,
    >                       "insertbefore": null,
    >                       "marker": "# {mark} ANSIBLE MANAGED BLOCK",
    >                       "marker_begin": "BEGIN",
    >                       "marker_end": "END",
    >                       "mode": null,
    >                       "owner": null,
    >                       "path": "/etc/ceph/ceph.conf",
    >                       "selevel": null,
    >                       "serole": null,
    >                       "setype": null,
    >                       "seuser": null,
    >                       "state": "present",
    >                       "unsafe_writes": false,
    >                       "validate": null
    >                     }
    >                   },
    >                   "msg": ""
    >                 },
    >                 "worker03": {
    >                   "_ansible_no_log": false,
    >                   "action": "blockinfile",
    >                   "ansible_facts": {
    >                     "discovered_interpreter_python": "/usr/bin/python3"
    >                   },
    >                   "changed": false,
    >                   "diff": [
    >                     {
    >                       "after": "",
    >                       "after_header": "/etc/ceph/ceph.conf (content)",
    >                       "before": "",
    >                       "before_header": "/etc/ceph/ceph.conf (content)"
    >                     },
    >                     {
    >                       "after_header": "/etc/ceph/ceph.conf (file attributes)",
    >                       "before_header": "/etc/ceph/ceph.conf (file attributes)"
    >                     }
    >                   ],
    >                   "invocation": {
    >                     "module_args": {
    >                       "attributes": null,
    >                       "backup": false,
    >                       "block": "[client]\n    client quota = true\n    mon host = 10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789\n",
    >                       "create": true,
    >                       "group": null,
    >                       "insertafter": null,
    >                       "insertbefore": null,
    >                       "marker": "# {mark} ANSIBLE MANAGED BLOCK",
    >                       "marker_begin": "BEGIN",
    >                       "marker_end": "END",
    >                       "mode": null,
    >                       "owner": null,
    >                       "path": "/etc/ceph/ceph.conf",
    >                       "selevel": null,
    >                       "serole": null,
    >                       "setype": null,
    >                       "seuser": null,
    >                       "state": "present",
    >                       "unsafe_writes": false,
    >                       "validate": null
    >                     }
    >                   },
    >                   "msg": ""
    >                 },
    >                 "zeppelin": {
    >                   "_ansible_no_log": false,
    >                   "action": "blockinfile",
    >                   "ansible_facts": {
    >                     "discovered_interpreter_python": "/usr/bin/python3"
    >                   },
    >                   "changed": false,
    >                   "diff": [
    >                     {
    >                       "after": "",
    >                       "after_header": "/etc/ceph/ceph.conf (content)",
    >                       "before": "",
    >                       "before_header": "/etc/ceph/ceph.conf (content)"
    >                     },
    >                     {
    >                       "after_header": "/etc/ceph/ceph.conf (file attributes)",
    >                       "before_header": "/etc/ceph/ceph.conf (file attributes)"
    >                     }
    >                   ],
    >                   "invocation": {
    >                     "module_args": {
    >                       "attributes": null,
    >                       "backup": false,
    >                       "block": "[client]\n    client quota = true\n    mon host = 10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789\n",
    >                       "create": true,
    >                       "group": null,
    >                       "insertafter": null,
    >                       "insertbefore": null,
    >                       "marker": "# {mark} ANSIBLE MANAGED BLOCK",
    >                       "marker_begin": "BEGIN",
    >                       "marker_end": "END",
    >                       "mode": null,
    >                       "owner": null,
    >                       "path": "/etc/ceph/ceph.conf",
    >                       "selevel": null,
    >                       "serole": null,
    >                       "setype": null,
    >                       "seuser": null,
    >                       "state": "present",
    >                       "unsafe_writes": false,
    >                       "validate": null
    >                     }
    >                   },
    >                   "msg": ""
    >                 }
    >               },
    >               "task": {
    >                 "duration": {
    >                   "end": "2022-07-15T04:00:58.834051Z",
    >                   "start": "2022-07-15T04:00:56.841673Z"
    >                 },
    >                 "id": "ee78dafe-0704-8f26-a721-00000000000d",
    >                 "name": "Creating CephFS cfg file [/etc/ceph/ceph.conf]"
    >               }
    >             },
    >             {
    >               "hosts": {
    >                 "master01": {
    >                   "_ansible_no_log": false,
    >                   "action": "blockinfile",
    >                   "changed": true,
    >                   "diff": [
    >                     {
    >                       "after": "",
    >                       "after_header": "/etc/ceph/ceph.client.Jaden-test-share-001-rw.keyring (content)",
    >                       "before": "",
    >                       "before_header": "/etc/ceph/ceph.client.Jaden-test-share-001-rw.keyring (content)"
    >                     },
    >                     {
    >                       "after_header": "/etc/ceph/ceph.client.Jaden-test-share-001-rw.keyring (file attributes)",
    >                       "before_header": "/etc/ceph/ceph.client.Jaden-test-share-001-rw.keyring (file attributes)"
    >                     }
    >                   ],
    >                   "invocation": {
    >                     "module_args": {
    >                       "attributes": null,
    >                       "backup": false,
    >                       "block": "[client.Jaden-test-share-001-rw]\n    key = AQBx5tBirs36BhAAUS5M+Zh3e2AuMsLFsWx8bg==\n",
    >                       "create": true,
    >                       "group": null,
    >                       "insertafter": null,
    >                       "insertbefore": null,
    >                       "marker": "# {mark} ANSIBLE MANAGED BLOCK",
    >                       "marker_begin": "BEGIN",
    >                       "marker_end": "END",
    >                       "mode": null,
    >                       "owner": null,
    >                       "path": "/etc/ceph/ceph.client.Jaden-test-share-001-rw.keyring",
    >                       "selevel": null,
    >                       "serole": null,
    >                       "setype": null,
    >                       "seuser": null,
    >                       "state": "present",
    >                       "unsafe_writes": false,
    >                       "validate": null
    >                     }
    >                   },
    >                   "msg": "File created"
    >                 },
    >                 "worker01": {
    >                   "_ansible_no_log": false,
    >                   "action": "blockinfile",
    >                   "changed": true,
    >                   "diff": [
    >                     {
    >                       "after": "",
    >                       "after_header": "/etc/ceph/ceph.client.Jaden-test-share-001-rw.keyring (content)",
    >                       "before": "",
    >                       "before_header": "/etc/ceph/ceph.client.Jaden-test-share-001-rw.keyring (content)"
    >                     },
    >                     {
    >                       "after_header": "/etc/ceph/ceph.client.Jaden-test-share-001-rw.keyring (file attributes)",
    >                       "before_header": "/etc/ceph/ceph.client.Jaden-test-share-001-rw.keyring (file attributes)"
    >                     }
    >                   ],
    >                   "invocation": {
    >                     "module_args": {
    >                       "attributes": null,
    >                       "backup": false,
    >                       "block": "[client.Jaden-test-share-001-rw]\n    key = AQBx5tBirs36BhAAUS5M+Zh3e2AuMsLFsWx8bg==\n",
    >                       "create": true,
    >                       "group": null,
    >                       "insertafter": null,
    >                       "insertbefore": null,
    >                       "marker": "# {mark} ANSIBLE MANAGED BLOCK",
    >                       "marker_begin": "BEGIN",
    >                       "marker_end": "END",
    >                       "mode": null,
    >                       "owner": null,
    >                       "path": "/etc/ceph/ceph.client.Jaden-test-share-001-rw.keyring",
    >                       "selevel": null,
    >                       "serole": null,
    >                       "setype": null,
    >                       "seuser": null,
    >                       "state": "present",
    >                       "unsafe_writes": false,
    >                       "validate": null
    >                     }
    >                   },
    >                   "msg": "File created"
    >                 },
    >                 "worker02": {
    >                   "_ansible_no_log": false,
    >                   "action": "blockinfile",
    >                   "changed": true,
    >                   "diff": [
    >                     {
    >                       "after": "",
    >                       "after_header": "/etc/ceph/ceph.client.Jaden-test-share-001-rw.keyring (content)",
    >                       "before": "",
    >                       "before_header": "/etc/ceph/ceph.client.Jaden-test-share-001-rw.keyring (content)"
    >                     },
    >                     {
    >                       "after_header": "/etc/ceph/ceph.client.Jaden-test-share-001-rw.keyring (file attributes)",
    >                       "before_header": "/etc/ceph/ceph.client.Jaden-test-share-001-rw.keyring (file attributes)"
    >                     }
    >                   ],
    >                   "invocation": {
    >                     "module_args": {
    >                       "attributes": null,
    >                       "backup": false,
    >                       "block": "[client.Jaden-test-share-001-rw]\n    key = AQBx5tBirs36BhAAUS5M+Zh3e2AuMsLFsWx8bg==\n",
    >                       "create": true,
    >                       "group": null,
    >                       "insertafter": null,
    >                       "insertbefore": null,
    >                       "marker": "# {mark} ANSIBLE MANAGED BLOCK",
    >                       "marker_begin": "BEGIN",
    >                       "marker_end": "END",
    >                       "mode": null,
    >                       "owner": null,
    >                       "path": "/etc/ceph/ceph.client.Jaden-test-share-001-rw.keyring",
    >                       "selevel": null,
    >                       "serole": null,
    >                       "setype": null,
    >                       "seuser": null,
    >                       "state": "present",
    >                       "unsafe_writes": false,
    >                       "validate": null
    >                     }
    >                   },
    >                   "msg": "File created"
    >                 },
    >                 "worker03": {
    >                   "_ansible_no_log": false,
    >                   "action": "blockinfile",
    >                   "changed": true,
    >                   "diff": [
    >                     {
    >                       "after": "",
    >                       "after_header": "/etc/ceph/ceph.client.Jaden-test-share-001-rw.keyring (content)",
    >                       "before": "",
    >                       "before_header": "/etc/ceph/ceph.client.Jaden-test-share-001-rw.keyring (content)"
    >                     },
    >                     {
    >                       "after_header": "/etc/ceph/ceph.client.Jaden-test-share-001-rw.keyring (file attributes)",
    >                       "before_header": "/etc/ceph/ceph.client.Jaden-test-share-001-rw.keyring (file attributes)"
    >                     }
    >                   ],
    >                   "invocation": {
    >                     "module_args": {
    >                       "attributes": null,
    >                       "backup": false,
    >                       "block": "[client.Jaden-test-share-001-rw]\n    key = AQBx5tBirs36BhAAUS5M+Zh3e2AuMsLFsWx8bg==\n",
    >                       "create": true,
    >                       "group": null,
    >                       "insertafter": null,
    >                       "insertbefore": null,
    >                       "marker": "# {mark} ANSIBLE MANAGED BLOCK",
    >                       "marker_begin": "BEGIN",
    >                       "marker_end": "END",
    >                       "mode": null,
    >                       "owner": null,
    >                       "path": "/etc/ceph/ceph.client.Jaden-test-share-001-rw.keyring",
    >                       "selevel": null,
    >                       "serole": null,
    >                       "setype": null,
    >                       "seuser": null,
    >                       "state": "present",
    >                       "unsafe_writes": false,
    >                       "validate": null
    >                     }
    >                   },
    >                   "msg": "File created"
    >                 },
    >                 "zeppelin": {
    >                   "_ansible_no_log": false,
    >                   "action": "blockinfile",
    >                   "changed": true,
    >                   "diff": [
    >                     {
    >                       "after": "",
    >                       "after_header": "/etc/ceph/ceph.client.Jaden-test-share-001-rw.keyring (content)",
    >                       "before": "",
    >                       "before_header": "/etc/ceph/ceph.client.Jaden-test-share-001-rw.keyring (content)"
    >                     },
    >                     {
    >                       "after_header": "/etc/ceph/ceph.client.Jaden-test-share-001-rw.keyring (file attributes)",
    >                       "before_header": "/etc/ceph/ceph.client.Jaden-test-share-001-rw.keyring (file attributes)"
    >                     }
    >                   ],
    >                   "invocation": {
    >                     "module_args": {
    >                       "attributes": null,
    >                       "backup": false,
    >                       "block": "[client.Jaden-test-share-001-rw]\n    key = AQBx5tBirs36BhAAUS5M+Zh3e2AuMsLFsWx8bg==\n",
    >                       "create": true,
    >                       "group": null,
    >                       "insertafter": null,
    >                       "insertbefore": null,
    >                       "marker": "# {mark} ANSIBLE MANAGED BLOCK",
    >                       "marker_begin": "BEGIN",
    >                       "marker_end": "END",
    >                       "mode": null,
    >                       "owner": null,
    >                       "path": "/etc/ceph/ceph.client.Jaden-test-share-001-rw.keyring",
    >                       "selevel": null,
    >                       "serole": null,
    >                       "setype": null,
    >                       "seuser": null,
    >                       "state": "present",
    >                       "unsafe_writes": false,
    >                       "validate": null
    >                     }
    >                   },
    >                   "msg": "File created"
    >                 }
    >               },
    >               "task": {
    >                 "duration": {
    >                   "end": "2022-07-15T04:00:59.944488Z",
    >                   "start": "2022-07-15T04:00:58.847898Z"
    >                 },
    >                 "id": "ee78dafe-0704-8f26-a721-00000000000e",
    >                 "name": "Creating CephFS key file [/etc/ceph/ceph.client.Jaden-test-share-001-rw.keyring]"
    >               }
    >             },
    >             {
    >               "hosts": {
    >                 "master01": {
    >                   "_ansible_no_log": false,
    >                   "action": "mount",
    >                   "backup_file": "",
    >                   "boot": "yes",
    >                   "changed": true,
    >                   "dump": "0",
    >                   "fstab": "/etc/fstab",
    >                   "fstype": "ceph",
    >                   "invocation": {
    >                     "module_args": {
    >                       "backup": false,
    >                       "boot": true,
    >                       "dump": null,
    >                       "fstab": null,
    >                       "fstype": "ceph",
    >                       "opts": "name=Jaden-test-share-001-rw,async,auto,nodev,noexec,nosuid,_netdev,rw",
    >                       "passno": null,
    >                       "path": "/user/Jaden/001",
    >                       "src": "10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/cb7b1b0d-e79d-46cf-9638-14252f725f1c",
    >                       "state": "mounted"
    >                     }
    >                   },
    >                   "name": "/user/Jaden/001",
    >                   "opts": "name=Jaden-test-share-001-rw,async,auto,nodev,noexec,nosuid,_netdev,rw",
    >                   "passno": "0",
    >                   "src": "10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/cb7b1b0d-e79d-46cf-9638-14252f725f1c"
    >                 },
    >                 "worker01": {
    >                   "_ansible_no_log": false,
    >                   "action": "mount",
    >                   "backup_file": "",
    >                   "boot": "yes",
    >                   "changed": true,
    >                   "dump": "0",
    >                   "fstab": "/etc/fstab",
    >                   "fstype": "ceph",
    >                   "invocation": {
    >                     "module_args": {
    >                       "backup": false,
    >                       "boot": true,
    >                       "dump": null,
    >                       "fstab": null,
    >                       "fstype": "ceph",
    >                       "opts": "name=Jaden-test-share-001-rw,async,auto,nodev,noexec,nosuid,_netdev,rw",
    >                       "passno": null,
    >                       "path": "/user/Jaden/001",
    >                       "src": "10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/cb7b1b0d-e79d-46cf-9638-14252f725f1c",
    >                       "state": "mounted"
    >                     }
    >                   },
    >                   "name": "/user/Jaden/001",
    >                   "opts": "name=Jaden-test-share-001-rw,async,auto,nodev,noexec,nosuid,_netdev,rw",
    >                   "passno": "0",
    >                   "src": "10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/cb7b1b0d-e79d-46cf-9638-14252f725f1c"
    >                 },
    >                 "worker02": {
    >                   "_ansible_no_log": false,
    >                   "action": "mount",
    >                   "backup_file": "",
    >                   "boot": "yes",
    >                   "changed": true,
    >                   "dump": "0",
    >                   "fstab": "/etc/fstab",
    >                   "fstype": "ceph",
    >                   "invocation": {
    >                     "module_args": {
    >                       "backup": false,
    >                       "boot": true,
    >                       "dump": null,
    >                       "fstab": null,
    >                       "fstype": "ceph",
    >                       "opts": "name=Jaden-test-share-001-rw,async,auto,nodev,noexec,nosuid,_netdev,rw",
    >                       "passno": null,
    >                       "path": "/user/Jaden/001",
    >                       "src": "10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/cb7b1b0d-e79d-46cf-9638-14252f725f1c",
    >                       "state": "mounted"
    >                     }
    >                   },
    >                   "name": "/user/Jaden/001",
    >                   "opts": "name=Jaden-test-share-001-rw,async,auto,nodev,noexec,nosuid,_netdev,rw",
    >                   "passno": "0",
    >                   "src": "10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/cb7b1b0d-e79d-46cf-9638-14252f725f1c"
    >                 },
    >                 "worker03": {
    >                   "_ansible_no_log": false,
    >                   "action": "mount",
    >                   "backup_file": "",
    >                   "boot": "yes",
    >                   "changed": true,
    >                   "dump": "0",
    >                   "fstab": "/etc/fstab",
    >                   "fstype": "ceph",
    >                   "invocation": {
    >                     "module_args": {
    >                       "backup": false,
    >                       "boot": true,
    >                       "dump": null,
    >                       "fstab": null,
    >                       "fstype": "ceph",
    >                       "opts": "name=Jaden-test-share-001-rw,async,auto,nodev,noexec,nosuid,_netdev,rw",
    >                       "passno": null,
    >                       "path": "/user/Jaden/001",
    >                       "src": "10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/cb7b1b0d-e79d-46cf-9638-14252f725f1c",
    >                       "state": "mounted"
    >                     }
    >                   },
    >                   "name": "/user/Jaden/001",
    >                   "opts": "name=Jaden-test-share-001-rw,async,auto,nodev,noexec,nosuid,_netdev,rw",
    >                   "passno": "0",
    >                   "src": "10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/cb7b1b0d-e79d-46cf-9638-14252f725f1c"
    >                 },
    >                 "zeppelin": {
    >                   "_ansible_no_log": false,
    >                   "action": "mount",
    >                   "backup_file": "",
    >                   "boot": "yes",
    >                   "changed": true,
    >                   "dump": "0",
    >                   "fstab": "/etc/fstab",
    >                   "fstype": "ceph",
    >                   "invocation": {
    >                     "module_args": {
    >                       "backup": false,
    >                       "boot": true,
    >                       "dump": null,
    >                       "fstab": null,
    >                       "fstype": "ceph",
    >                       "opts": "name=Jaden-test-share-001-rw,async,auto,nodev,noexec,nosuid,_netdev,rw",
    >                       "passno": null,
    >                       "path": "/user/Jaden/001",
    >                       "src": "10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/cb7b1b0d-e79d-46cf-9638-14252f725f1c",
    >                       "state": "mounted"
    >                     }
    >                   },
    >                   "name": "/user/Jaden/001",
    >                   "opts": "name=Jaden-test-share-001-rw,async,auto,nodev,noexec,nosuid,_netdev,rw",
    >                   "passno": "0",
    >                   "src": "10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/cb7b1b0d-e79d-46cf-9638-14252f725f1c"
    >                 }
    >               },
    >               "task": {
    >                 "duration": {
    >                   "end": "2022-07-15T04:01:02.734420Z",
    >                   "start": "2022-07-15T04:00:59.957615Z"
    >                 },
    >                 "id": "ee78dafe-0704-8f26-a721-00000000000f",
    >                 "name": "Creating CephFS fstab entry [/user/Jaden/001]"
    >               }
    >             },
    >             {
    >               "hosts": {
    >                 "zeppelin": {
    >                   "_ansible_delegated_vars": {
    >                     "ansible_host": "zeppelin",
    >                     "ansible_port": null,
    >                     "ansible_user": null
    >                   },
    >                   "_ansible_no_log": false,
    >                   "action": "file",
    >                   "changed": true,
    >                   "diff": {
    >                     "after": {
    >                       "group": 100,
    >                       "mode": "02755",
    >                       "owner": 20002,
    >                       "path": "/user/Jaden/001"
    >                     },
    >                     "before": {
    >                       "group": 0,
    >                       "mode": "0777",
    >                       "owner": 0,
    >                       "path": "/user/Jaden/001"
    >                     }
    >                   },
    >                   "gid": 100,
    >                   "group": "users",
    >                   "invocation": {
    >                     "module_args": {
    >                       "_diff_peek": null,
    >                       "_original_basename": null,
    >                       "access_time": null,
    >                       "access_time_format": "%Y%m%d%H%M.%S",
    >                       "attributes": null,
    >                       "follow": true,
    >                       "force": false,
    >                       "group": "users",
    >                       "mode": "u=rwX,g=rXs,o=rX",
    >                       "modification_time": null,
    >                       "modification_time_format": "%Y%m%d%H%M.%S",
    >                       "owner": "Jaden",
    >                       "path": "/user/Jaden/001",
    >                       "recurse": false,
    >                       "selevel": null,
    >                       "serole": null,
    >                       "setype": null,
    >                       "seuser": null,
    >                       "src": null,
    >                       "state": "directory",
    >                       "unsafe_writes": false
    >                     }
    >                   },
    >                   "mode": "02755",
    >                   "owner": "Jaden",
    >                   "path": "/user/Jaden/001",
    >                   "secontext": "system_u:object_r:cephfs_t:s0",
    >                   "size": 0,
    >                   "state": "directory",
    >                   "uid": 20002
    >                 }
    >               },
    >               "task": {
    >                 "duration": {
    >                   "end": "2022-07-15T04:01:03.905632Z",
    >                   "start": "2022-07-15T04:01:02.756373Z"
    >                 },
    >                 "id": "ee78dafe-0704-8f26-a721-000000000010",
    >                 "name": "Setting permissions for [/user/Jaden/001]"
    >               }
    >             }
    >           ]
    >         }
    >       ],
    >       "stats": {
    >         "master01": {
    >           "changed": 2,
    >           "failures": 0,
    >           "ignored": 0,
    >           "ok": 3,
    >           "rescued": 0,
    >           "skipped": 0,
    >           "unreachable": 0
    >         },
    >         "worker01": {
    >           "changed": 2,
    >           "failures": 0,
    >           "ignored": 0,
    >           "ok": 3,
    >           "rescued": 0,
    >           "skipped": 0,
    >           "unreachable": 0
    >         },
    >         "worker02": {
    >           "changed": 2,
    >           "failures": 0,
    >           "ignored": 0,
    >           "ok": 3,
    >           "rescued": 0,
    >           "skipped": 0,
    >           "unreachable": 0
    >         },
    >         "worker03": {
    >           "changed": 2,
    >           "failures": 0,
    >           "ignored": 0,
    >           "ok": 3,
    >           "rescued": 0,
    >           "skipped": 0,
    >           "unreachable": 0
    >         },
    >         "zeppelin": {
    >           "changed": 3,
    >           "failures": 0,
    >           "ignored": 0,
    >           "ok": 4,
    >           "rescued": 0,
    >           "skipped": 0,
    >           "unreachable": 0
    >         }
    >       }
    >     },
    >     "debug": {
    >       "script": "create-ceph-share.sh",
    >       "result": "PASS",
    >       "messages": [
    >         "PASS: Share [Jaden-test-share-001] created [abe691d9-d35b-41de-8abf-e69c659d1375][creating]",
    >         "PASS: Share [Jaden-test-share-001][abe691d9-d35b-41de-8abf-e69c659d1375] status [available]",
    >         "PASS: Share [Jaden-test-share-001][abe691d9-d35b-41de-8abf-e69c659d1375] [ro] access created",
    >         "PASS: Share [Jaden-test-share-001][abe691d9-d35b-41de-8abf-e69c659d1375] [rw] access created",
    >         "PASS: Ansible mount playbook succeded"
    >       ]
    >     }
    >   }


# -----------------------------------------------------
# Check the new share works ...
#[root@ansibler]

    nodes=(
        zeppelin
        master01
        worker01
        worker02
        worker03
        )

    for node in "${nodes[@]}"
    do
        echo
        echo "Node [${node}]"
        ssh "${node}" \
            '
            hostname
            date
            df -h /user/Jaden/001/
            '
    done


    >   Node [zeppelin]
    >   iris-gaia-red-20220714-zeppelin
    >   Fri 15 Jul 2022 04:03:29 AM UTC
    >   Filesystem                                                                                                Size  Used Avail Use% Mounted on
    >   10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/cb7b1b0d-e79d-46cf-9638-14252f725f1c  409T  115T  295T  28% /user/Jaden/001
    >   
    >   Node [master01]
    >   iris-gaia-red-20220714-master01
    >   Fri Jul 15 04:03:30 UTC 2022
    >   Filesystem                                                                                                Size  Used Avail Use% Mounted on
    >   10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/cb7b1b0d-e79d-46cf-9638-14252f725f1c  409T  115T  295T  28% /user/Jaden/001
    >   
    >   Node [worker01]
    >   iris-gaia-red-20220714-worker01
    >   Fri Jul 15 04:03:30 UTC 2022
    >   Filesystem                                                                                                Size  Used Avail Use% Mounted on
    >   10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/cb7b1b0d-e79d-46cf-9638-14252f725f1c  409T  115T  295T  28% /user/Jaden/001
    >   
    >   Node [worker02]
    >   iris-gaia-red-20220714-worker02
    >   Fri Jul 15 04:03:30 UTC 2022
    >   Filesystem                                                                                                Size  Used Avail Use% Mounted on
    >   10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/cb7b1b0d-e79d-46cf-9638-14252f725f1c  409T  115T  295T  28% /user/Jaden/001
    >   
    >   Node [worker03]
    >   iris-gaia-red-20220714-worker03
    >   Fri Jul 15 04:03:31 UTC 2022
    >   Filesystem                                                                                                Size  Used Avail Use% Mounted on
    >   10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/cb7b1b0d-e79d-46cf-9638-14252f725f1c  409T  115T  295T  28% /user/Jaden/001

    # Wow!!
    # https://github.com/kellyjonbrazil/jc#parsers

# -----------------------------------------------------
# Install jc on all the nodes.
# https://github.com/kellyjonbrazil/jc#parsers
#[root@ansibler]

    nodes=(
        zeppelin
        master01
        worker01
        worker02
        worker03
        )

    for node in "${nodes[@]}"
    do
        echo
        echo "Node [${node}]"
        ssh "${node}" \
            '
            hostname
            date
            sudo pip install jc
            '
    done


# -----------------------------------------------------
# Check the new share works ...
#[root@ansibler]

    nodes=(
        zeppelin
        master01
        worker01
        worker02
        worker03
        )

    for node in "${nodes[@]}"
    do
        echo
        ssh "${node}" \
            '
cat << EOF
{
"hostname": "$(hostname)",
"datetime": "$(date --iso-8601=seconds)",
"df": $(df -h /user/Jaden/* | jc --df)
}
EOF
            ' \
        | jq '.'
    done


    >   {
    >     "hostname": "iris-gaia-red-20220714-zeppelin",
    >     "datetime": "2022-07-15T04:29:54+00:00",
    >     "df": [
    >       {
    >         "filesystem": "10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/cb7b1b0d-e79d-46cf-9638-14252f725f1c",
    >         "size": "409T",
    >         "used": 115,
    >         "mounted_on": "/user/Jaden/001",
    >         "available": 295,
    >         "use_percent": 28
    >       }
    >     ]
    >   }
    >   
    >   {
    >     "hostname": "iris-gaia-red-20220714-master01",
    >     "datetime": "2022-07-15T04:29:54+00:00",
    >     "df": [
    >       {
    >         "filesystem": "10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/cb7b1b0d-e79d-46cf-9638-14252f725f1c",
    >         "size": "409T",
    >         "used": 115,
    >         "mounted_on": "/user/Jaden/001",
    >         "available": 295,
    >         "use_percent": 28
    >       }
    >     ]
    >   }
    >   
    >   {
    >     "hostname": "iris-gaia-red-20220714-worker01",
    >     "datetime": "2022-07-15T04:29:54+00:00",
    >     "df": [
    >       {
    >         "filesystem": "10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/cb7b1b0d-e79d-46cf-9638-14252f725f1c",
    >         "size": "409T",
    >         "used": 115,
    >         "mounted_on": "/user/Jaden/001",
    >         "available": 295,
    >         "use_percent": 28
    >       }
    >     ]
    >   }
    >   
    >   {
    >     "hostname": "iris-gaia-red-20220714-worker02",
    >     "datetime": "2022-07-15T04:29:54+00:00",
    >     "df": [
    >       {
    >         "filesystem": "10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/cb7b1b0d-e79d-46cf-9638-14252f725f1c",
    >         "size": "409T",
    >         "used": 115,
    >         "mounted_on": "/user/Jaden/001",
    >         "available": 295,
    >         "use_percent": 28
    >       }
    >     ]
    >   }
    >   
    >   {
    >     "hostname": "iris-gaia-red-20220714-worker03",
    >     "datetime": "2022-07-15T04:29:54+00:00",
    >     "df": [
    >       {
    >         "filesystem": "10.4.200.9:6789,10.4.200.13:6789,10.4.200.17:6789:/volumes/_nogroup/cb7b1b0d-e79d-46cf-9638-14252f725f1c",
    >         "size": "409T",
    >         "used": 115,
    >         "mounted_on": "/user/Jaden/001",
    >         "available": 295,
    >         "use_percent": 28
    >       }
    >     ]
    >   }

